<!DOCTYPE html>
<html lang="{{ 'zh-CN' if lang == 'zh' else 'en' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ i18n.app_title.replace(' GUI', '') }}</title>
    <link href="{{ url_for('static', filename='css/fontawesome.min.css') }}" rel="stylesheet">
    <!-- Prism.js for syntax highlighting -->
    <link href="{{ url_for('static', filename='css/prism-tomorrow.min.css') }}" rel="stylesheet">
    <!-- PDF.js -->
    <script src="{{ url_for('static', filename='js/pdf.min.js') }}"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1e1e1e;
            height: 100vh;
            overflow: hidden;
            color: #cccccc;
        }

        /* User authentication area styles */
        .user-auth-area {
            background: #2d2d30;
            border-bottom: 1px solid #3e3e42;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
            min-height: 50px;
        }

        .user-auth-left {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
            min-width: 300px;
        }

        .logo-group {
            display: flex;
            align-items: center;
        }

        .user-auth-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .api-key-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .api-key-group label {
            color: #cccccc;
            font-size: 0.9em;
            white-space: nowrap;
        }

        .api-key-input {
            padding: 6px 12px;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            background: #1e1e1e;
            color: #cccccc;
            font-size: 0.9em;
            width: 200px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        }

        .api-key-input:focus {
            outline: none;
            border-color: #007acc;
            box-shadow: 0 0 0 2px rgba(0, 122, 204, 0.2);
        }

        .api-key-input::placeholder {
            color: #6a6a6a;
        }

        .connect-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .connect-btn.connect {
            background: #28a745;
            color: white;
        }

        .connect-btn.connect:hover {
            background: #218838;
        }

        .connect-btn.disconnect {
            background: #dc3545;
            color: white;
        }

        .connect-btn.disconnect:hover {
            background: #c82333;
        }

        .connect-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85em;
            color: #9cdcfe;
        }

        .user-status {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .user-status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #6c757d;
        }

        .user-status-indicator.connected {
            background: #28a745;
            animation: pulse-green 2s infinite;
        }

        .user-status-indicator.connected.guest {
            background: #ff5722;
            animation: pulse-red 2s infinite;
        }

        .user-status-indicator.connecting {
            background: #ffc107;
            animation: pulse-orange 1s infinite;
        }

        .user-status-indicator.error {
            background: #dc3545;
        }

        .container {
            display: flex;
            height: calc(100vh - 50px);  /* Subtract auth area height */
            background: #252526;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            min-width: 0;
            min-width: 400px;
        }

        #resizer {
            width: 5px;
            background: #3e3e42;
            cursor: col-resize;
            flex-shrink: 0;
            transition: all 0.2s ease;
            position: relative;
        }

        #resizer:hover {
            background: #569cd6;
            width: 6px;
        }

        #resizer:active {
            background: #007acc;
            width: 6px;
        }

        /* Add visual indicator when dragging */
        #resizer::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 2px;
            height: 30px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 1px;
            pointer-events: none;
            transition: all 0.2s ease;
        }

        #resizer:hover::before {
            background: rgba(255, 255, 255, 0.6);
            height: 40px;
        }

        .sidebar {
            width: 400px;
            background: #252526;
            border-left: 1px solid #3e3e42;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            text-align: center;
            margin-bottom: 15px;
            color: #cccccc;
        }

        .header h1 {
            font-size: 1.2em;
            font-weight: 700;
            margin-bottom: 0;
            color: #569cd6;
        }

        .header p {
            display: none;
        }

        .chat-container {
            flex: 1;
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .chat-header {
            background: #007acc;
            color: white;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #3e3e42;
        }

        .chat-header h3 {
            font-size: 0.95em;
            font-weight: 400;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4CAF50;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        @keyframes pulse-green {
            0% {
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(40, 167, 69, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
            }
        }

        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 87, 34, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(255, 87, 34, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 87, 34, 0);
            }
        }

        @keyframes pulse-orange {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(255, 193, 7, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 193, 7, 0);
            }
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #1e1e1e;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 6px;
            max-width: 95%;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease-in;
            white-space: pre-wrap;
            overflow-wrap: break-word;
        }

        .message-text {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            white-space: pre-wrap;
            word-break: break-all;
            overflow-wrap: anywhere;
            line-height: 1.4;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            background: #0e639c;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 3px;
        }

        .message.system {
            background: #264f78;
            color: #9cdcfe;
            border-left: 3px solid #007acc;
            padding: 6px 8px !important;
            max-width: 95% !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
        }

        .message.info {
            background: #1a1a1a;
            color: #cccccc;
            border-left: 3px solid #569cd6;
        }

        .message.error {
            background: #5a1d1d;
            color: #f48771;
            border-left: 3px solid #f14c4c;
        }

        .message.success {
            background: #0f5132;
            color: #75b798;
            border-left: 3px solid #198754;
        }



        .input-container {
            background: #2d2d30;
            border: 1px solid #3e3e42;
            border-radius: 8px;
            padding: 20px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        #userInput {
            width: 100%;
            min-height: 50px;
            max-height: 120px;
            padding: 15px 20px;
            border: 1px solid #3e3e42;
            border-radius: 6px;
            font-size: 14px;
            resize: vertical;
            transition: all 0.3s ease;
            font-family: inherit;
            background: #1e1e1e;
            color: #cccccc;
        }

        #userInput:focus {
            outline: none;
            border-color: #007acc;
            box-shadow: 0 0 0 2px rgba(0, 122, 204, 0.2);
        }

        #userInput::placeholder {
            color: #6a6a6a;
        }

        .send-button {
            background: #007acc;
            color: white;
            border: none;
            border-radius: 6px;
            width: 50px;
            height: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .send-button:hover {
            background: #005a9e;
            transform: translateY(-1px);
        }

        .send-button:disabled {
            background: #3e3e42;
            cursor: not-allowed;
            transform: none;
        }

        /* Specific button hover effects */
        #planButton:hover:not(:disabled) {
            background: #f57c00;
        }

        #clearChatButton:hover:not(:disabled) {
            background: #5a6268;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #3e3e42;
            background: #2d2d30;
        }

        .sidebar-header h3 {
            margin: 0;
            color: #cccccc;
            font-size: 1.1em;
            font-weight: 500;
        }

        .sidebar-header .action-btn {
            background: transparent;
            border: 1px solid #569cd6;
            color: #569cd6;
            padding: 6px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9em;
        }

        .sidebar-header .action-btn:hover:not(:disabled) {
            background: #569cd6;
            color: white;
        }

        .sidebar-header .action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .sidebar-header .action-btn .fa-spin {
            animation: fa-spin 1s infinite linear;
        }

        .directory-list {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            margin: 0;
        }

        .directory-item {
            background: #1e1e1e;
            border-radius: 6px;
            margin-bottom: 12px;
            padding: 15px;
            border: 1px solid #3e3e42;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .directory-item:hover {
            background: #2d2d30;
            border-color: #569cd6;
            transform: translateY(-1px);
        }

        .directory-item.expanded {
            background: #0f3460;
            border-color: #007acc;
        }

        .directory-item.current {
            background: #2d2d30;
            color: #cccccc;
            border-color: #3e3e42;
            box-shadow: none;
        }

        .directory-item.current .directory-name,
        .directory-item.current .directory-info {
            color: #cccccc;
        }

        .directory-item.current .action-btn {
            color: #9cdcfe;
        }

        .directory-item.current .action-btn:hover {
            background: rgba(156, 220, 254, 0.1);
        }

        .directory-item.selected {
            background: linear-gradient(135deg, #007acc 0%, #005a9e 100%);
            color: white;
            border-color: #007acc;
            box-shadow: 0 3px 10px rgba(0, 122, 204, 0.3);
        }

        .directory-item.selected .directory-name,
        .directory-item.selected .directory-info {
            color: white;
        }

        .directory-item.selected .action-btn {
            color: white;
        }

        .directory-item.selected .action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .directory-item.last {
            border: 2px solid #569cd6;
            background: #0f3460;
        }

        .directory-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .directory-name {
            font-weight: 600;
            color: #cccccc;
            font-size: 0.9em;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-right: 10px;
        }

        .directory-actions {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }

        .action-btn {
            background: none;
            border: none;
            color: #9cdcfe;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .action-btn:hover {
            background: rgba(156, 220, 254, 0.1);
            color: #569cd6;
        }

        .rename-btn {
            color: #ffc107 !important;
        }

        .rename-btn:hover {
            background: rgba(255, 193, 7, 0.1) !important;
            color: #ffc107 !important;
        }

        .delete-btn {
            color: #ff6b6b !important;
        }

        .delete-btn:hover {
            background: rgba(255, 107, 107, 0.1) !important;
            color: #ff5252 !important;
        }

        .directory-info {
            font-size: 0.85em;
            color: #9cdcfe;
            margin-bottom: 10px;
        }

        .file-tree {
            display: none;
            margin-top: 10px;
            padding: 10px;
            border-top: 1px solid #3e3e42;
            background: #1e1e1e;
            border-radius: 4px;
        }

        .file-tree.show {
            display: block;
        }

        .sub-file-tree {
            display: none;
            margin-left: 20px;
        }

        .sub-file-tree.show {
            display: block;
        }

        .sub-folder-toggle {
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }

        .sub-folder-toggle:hover {
            opacity: 1;
            background: rgba(156, 220, 254, 0.2) !important;
            border-radius: 3px;
        }

        .file-item.directory > div[onclick]:hover {
            background: rgba(156, 220, 254, 0.1);
            border-radius: 4px;
            padding: 2px 6px;
            margin: -2px -6px;
        }

        .file-item {
            padding: 5px 0;
            margin-left: 20px;
            font-size: 0.9em;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-item:hover {
            background: rgba(156, 220, 254, 0.2);
            border-radius: 4px;
            padding-left: 5px;
        }

        .file-item.directory {
            font-weight: 500;
            color: #9cdcfe;
        }

        .file-item.previewable {
            color: #ffffff;
        }

        .file-item.previewable:hover {
            color: #ffffff;
            font-weight: 500;
        }

        .file-item i {
            width: 16px;
            text-align: center;
        }

        .file-item.grayed {
            color: #888888 !important;
        }

        .file-item.grayed:hover {
            color: #aaaaaa !important;
        }

        .file-item.grayed.previewable {
            cursor: pointer;
        }

        .file-item.grayed.previewable:hover {
            color: #cccccc !important;
            background: rgba(156, 220, 254, 0.1);
            border-radius: 4px;
            padding-left: 5px;
        }



        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #9cdcfe;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 3px solid #3e3e42;
            border-top: 3px solid #007acc;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .scrollbar-custom {
            scrollbar-width: thin;
            scrollbar-color: #569cd6 #2d2d30;
        }

        .scrollbar-custom::-webkit-scrollbar {
            width: 8px;
        }

        .scrollbar-custom::-webkit-scrollbar-track {
            background: #2d2d30;
            border-radius: 4px;
        }

        .scrollbar-custom::-webkit-scrollbar-thumb {
            background: #569cd6;
            border-radius: 4px;
        }

        .scrollbar-custom::-webkit-scrollbar-thumb:hover {
            background: #007acc;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                height: 100vh;
            }
            
            .sidebar {
                width: 100%;
                height: 40vh;
                border-radius: 0;
                border-right: none;
                border-bottom: 1px solid #3e3e42;
            }
            
            .main-content {
                height: 60vh;
            }
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: #2d2d30;
            margin: 2% auto;
            border: 1px solid #3e3e42;
            border-radius: 8px;
            width: 90%;
            max-width: 1200px;
            height: 90vh;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            background: #007acc;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #3e3e42;
            flex-shrink: 0;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.2em;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            opacity: 0.7;
        }

        .modal-body {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
            background: #1e1e1e;
            color: #cccccc;
            min-height: 0;
        }

        /* Special handling for preview modal */
        #previewModal .modal-content {
            width: 90%;
            max-width: 1200px;
            height: 90%;
            max-height: 800px;
        }

        #previewModal .modal-body {
            padding: 10px;
        }

        /* iframe style optimization */
        #previewContent iframe {
            width: 100%;
            height: calc(90vh - 120px);
            border: none;
            border-radius: 4px;
        }

        /* Upload area styles */
        .upload-area {
            border: 2px dashed #569cd6;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            background: #1e1e1e;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #007acc;
            background: #2d2d30;
        }

        .upload-area.dragover {
            border-color: #007acc;
            background: #2d2d30;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 48px;
            color: #569cd6;
            margin-bottom: 20px;
        }

        .upload-text p {
            margin: 10px 0;
            font-size: 16px;
        }

        .upload-hint {
            font-size: 14px !important;
            color: #9cdcfe !important;
            opacity: 0.8;
        }

        .upload-btn {
            background: #007acc;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
            transition: background 0.3s ease;
        }

        .upload-btn:hover {
            background: #005a9e;
        }

        /* Progress bar styles */
        .upload-progress {
            margin-top: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #3e3e42;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #007acc;
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            margin-top: 10px;
            color: #9cdcfe;
        }

        /* Upload result styles */
        .upload-result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }

        .upload-result .success {
            color: #75b798;
            background: #0f5132;
            padding: 10px;
            border-radius: 4px;
            border-left: 3px solid #198754;
        }

        .upload-result .error {
            color: #f48771;
            background: #5a1d1d;
            padding: 10px;
            border-radius: 4px;
            border-left: 3px solid #f14c4c;
        }

        /* Scroll to bottom hint */
        .scroll-to-bottom-hint {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: #007acc;
            color: white;
            border: none;
            border-radius: 25px;
            width: 50px;
            height: 50px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: 0 4px 12px rgba(0, 122, 204, 0.4);
            transition: all 0.3s ease;
            z-index: 100;
            animation: bounceIn 0.3s ease;
        }

        .scroll-to-bottom-hint:hover {
            background: #005a9e;
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 122, 204, 0.6);
        }

        .scroll-to-bottom-hint.show {
            display: flex;
        }

        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* New message indicator */
        .new-message-indicator {
            position: absolute;
            bottom: 80px;
            right: 20px;
            background: #007acc;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            display: none;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(0, 122, 204, 0.4);
            animation: slideInRight 0.3s ease;
            z-index: 99;
            cursor: pointer;
        }

        .new-message-indicator.show {
            display: flex;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Auto-scroll status indicator */
        .auto-scroll-indicator {
            position: absolute;
            bottom: 130px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
            transition: all 0.3s ease;
            z-index: 98;
            opacity: 0.8;
        }

        .auto-scroll-indicator.disabled {
            background: #9e9e9e;
            box-shadow: 0 2px 8px rgba(158, 158, 158, 0.3);
        }

        .auto-scroll-indicator i {
            animation: bounce 1.5s infinite;
        }

        .auto-scroll-indicator.disabled i {
            animation: none;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-3px);
            }
            60% {
                transform: translateY(-2px);
            }
        }
    </style>
</head>
<body>
    <!-- User Authentication Area -->
    <div class="user-auth-area">
        <div class="user-auth-left">
            <div class="logo-group">
                <img src="{{ url_for('static', filename='logo.png') }}" style="height: 2.2em; margin-right: 10px;" alt="Logo">
                <span style="font-size: 1.2em; font-weight: 700; color: #569cd6;">{{ i18n.app_title.replace(' GUI', '') }}</span>
            </div>
        </div>
        <div class="user-auth-right">
            <div class="api-key-group">
                <label for="modelSelect">
                    <i class="fas fa-brain"></i>
                    {{ i18n.model_label }}
                </label>
                <select id="modelSelect" class="api-key-input" title="{{ i18n.model_tooltip }}" style="width: 220px;">
                    <option value="claude-sonnet-4-0">{{ i18n.model_claude_sonnet }}</option>
                    <option value="gpt-4.1" selected>{{ i18n.model_gpt_4 }}</option>
                </select>
            </div>
            <div class="api-key-group">
                <label for="apiKeyInput">
                    <i class="fas fa-key"></i>
                    {{ i18n.api_key_label }}
                </label>
                <input type="password" id="apiKeyInput" class="api-key-input" 
                       placeholder="{{ i18n.api_key_placeholder }}" 
                       title="{{ i18n.api_key_tooltip }}">
            </div>
            <button id="connectBtn" class="connect-btn connect">
                <i class="fas fa-plug"></i>
                <span>{{ i18n.connect_btn }}</span>
            </button>
            <div class="user-info">
                <div class="user-status">
                    <div class="user-status-indicator" id="userStatusIndicator"></div>
                    <span id="userStatusText">{{ i18n.user_disconnected }}</span>
                </div>
                <span id="userIdentity" style="margin-left: 10px;"></span>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="main-content">
            <div class="header" style="display: none;">
                <h1><img src="{{ url_for('static', filename='lynlogo.png') }}" style="height: 1.8em; vertical-align: middle;" alt="Logo"> {{ i18n.app_title.replace(' GUI', '') }}</h1>
                <p>{{ i18n.app_subtitle }}</p>
            </div>

            <div class="chat-container">
                <div class="chat-header">
                    <h3>
                        <i class="fas fa-comments"></i>
                        {{ i18n.chat_title }}
                    </h3>
                    <div class="status-indicator" id="statusIndicator"></div>
                </div>
                <div class="chat-messages scrollbar-custom" id="chatMessages">
                    <div class="message system">
                        <strong><i class="fas fa-info-circle"></i> {{ i18n.get('system_message', 'Á≥ªÁªüÊ∂àÊÅØ' if lang == 'zh' else 'System Message') }}</strong><br>
                        {{ i18n.get('welcome_message', 'Ê¨¢Ëøé‰ΩøÁî® AGI BotÔºÅËØ∑Âú®‰∏ãÊñπËæìÂÖ•ÊÇ®ÁöÑÈúÄÊ±ÇÔºåÁ≥ªÁªüÂ∞ÜËá™Âä®‰∏∫ÊÇ®Â§ÑÁêÜ‰ªªÂä°„ÄÇ' if lang == 'zh' else 'Welcome to AGI Bot! Please enter your requirements below, and the system will automatically process tasks for you.') }}
                    </div>
                </div>
                
                <!-- Scroll to bottom button -->
                <button class="scroll-to-bottom-hint" id="scrollToBottomBtn" title="{{ i18n.get('scroll_to_bottom', 'ÊªöÂä®Âà∞Â∫ïÈÉ®' if lang == 'zh' else 'Scroll to Bottom') }}">
                    <i class="fas fa-chevron-down"></i>
                </button>
                
                <!-- New message indicator -->
                <div class="new-message-indicator" id="newMessageIndicator">
                    <i class="fas fa-bell"></i>
                    <span id="newMessageCount">1</span> Êù°Êñ∞Ê∂àÊÅØ
                </div>
                
                <!-- Auto-scroll status indicator -->
                <div class="auto-scroll-indicator" id="autoScrollIndicator">
                    <i class="fas fa-arrow-down"></i>
                    <span>Ëá™Âä®ÊªöÂä®</span>
                </div>
            </div>

            <div class="input-container">
                <div class="input-group">
                    <div class="input-wrapper">
                        <textarea 
                            id="userInput" 
                            placeholder="{{ i18n.input_placeholder }}"
                            rows="1"
                        ></textarea>
                    </div>
                    <button class="send-button" id="sendButton" title="{{ i18n.direct_tooltip }}">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                    <button class="send-button" id="planButton" style="background-color: #ff9800;" title="{{ i18n.plan_tooltip }}">
                        <i class="fas fa-list-ul"></i>
                    </button>

                    <button class="send-button" id="newTaskButton" style="background-color: #4caf50;" title="{{ i18n.new_tooltip }}">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="send-button" id="configToggleBtn" style="background-color: #3e3e42;" title="{{ i18n.get('show_config_options', 'ÊòæÁ§∫ÈÖçÁΩÆÈÄâÈ°π' if lang == 'zh' else 'Show Configuration') }}">
                        <i class="fas fa-cog" id="configToggleIcon"></i>
                    </button>
                    <button class="send-button" id="stopButton" style="display: none; background-color: #f44336;">
                        <i class="fas fa-stop"></i>
                    </button>
                    <button class="send-button" id="clearChatButton" style="background-color: #6c757d;" title="{{ i18n.clear_chat_tooltip }}">
                        <i class="fas fa-broom"></i>
                    </button>
                </div>
                
                <!-- GUI Configuration Options -->
                <div id="configContainer" class="config-container" style="margin-top: 10px; padding: 15px; background: #2d2d30; border: 1px solid #3e3e42; border-radius: 8px; display: none;">
                    <div style="margin-bottom: 10px; font-weight: 500; color: #cccccc; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-cog"></i>
                        <span>{{ i18n.get('config_options', 'ÈÖçÁΩÆÈÄâÈ°π' if lang == 'zh' else 'Configuration Options') }}</span>
                    </div>
                    <div class="config-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.85em;">
                        <label class="config-option" style="display: flex; align-items: center; gap: 6px; color: #cccccc; cursor: pointer;">
                            <input type="checkbox" id="enableWebSearch" style="margin: 0;">
                            <span>{{ i18n.get('enable_web_search', 'ÊêúÁ¥¢ÁΩëÁªú' if lang == 'zh' else 'Web Search') }}</span>
                        </label>
                        <label class="config-option" style="display: flex; align-items: center; gap: 6px; color: #cccccc; cursor: pointer;">
                            <input type="checkbox" id="enableKnowledgeBase" checked style="margin: 0;">
                            <span>{{ i18n.get('enable_knowledge_base', 'ÊêúÁ¥¢Áü•ËØÜÂ∫ì' if lang == 'zh' else 'Knowledge Base') }}</span>
                        </label>
                        <label class="config-option" style="display: flex; align-items: center; gap: 6px; color: #cccccc; cursor: pointer;">
                            <input type="checkbox" id="enableMultiAgent" style="margin: 0;">
                            <span>{{ i18n.get('enable_multi_agent', 'ÂêØÂä®Â§öÊô∫ËÉΩ‰Ωì' if lang == 'zh' else 'Multi-Agent') }}</span>
                        </label>
                        <label class="config-option" style="display: flex; align-items: center; gap: 6px; color: #cccccc; cursor: pointer;">
                            <input type="checkbox" id="enableLongTermMemory" checked style="margin: 0;">
                            <span>{{ i18n.get('enable_long_term_memory', 'ÂêØÂä®ÈïøÊúüËÆ∞ÂøÜ' if lang == 'zh' else 'Long-term Memory') }}</span>
                        </label>
                        <label class="config-option" style="display: flex; align-items: center; gap: 6px; color: #cccccc; cursor: pointer;">
                            <input type="checkbox" id="enableMCP" style="margin: 0;">
                            <span>{{ i18n.get('enable_mcp', 'ÂêØÂä®MCP' if lang == 'zh' else 'Enable MCP') }}</span>
                        </label>
                        <label class="config-option" style="display: flex; align-items: center; gap: 6px; color: #cccccc; cursor: pointer;">
                            <input type="checkbox" id="enableJieba" checked style="margin: 0;">
                            <span>{{ i18n.get('enable_jieba', 'ÂêØÁî®‰∏≠ÊñáÂàÜËØç' if lang == 'zh' else 'Chinese Segmentation') }}</span>
                        </label>
                    </div>
                </div>
                
                <div id="taskModeInfo" style="margin-top: 10px; font-size: 0.9em; color: #666; text-align: center;">
                    <!-- Task mode information will be displayed here -->
                </div>
            </div>
        </div>

        <div class="resizer" id="resizer"></div>

        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-folder-open"></i>
                <h3>{{ i18n.get('workspace_title', 'Â∑•‰ΩúÁõÆÂΩï' if lang == 'zh' else 'Workspace') }}</h3>
                <button class="action-btn" onclick="manualRefresh()" title="{{ i18n.refresh_tooltip }}">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            
            <div class="loading" id="sidebarLoading">
                <div class="spinner"></div>
                <p>{{ i18n.loading }}</p>
            </div>
            
            <div class="directory-list scrollbar-custom" id="directoryList">
                <!-- Directory list will be dynamically generated through JavaScript -->
            </div>
        </div>
    </div>

    <!-- File preview modal -->
    <div id="previewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="previewTitle">{{ i18n.get('file_preview', 'Êñá‰ª∂È¢ÑËßà' if lang == 'zh' else 'File Preview') }}</h3>
                <span class="close" id="previewClose">&times;</span>
            </div>
            <div class="modal-body">
                <div id="previewContent"></div>
            </div>
        </div>
    </div>

    <!-- File upload modal -->
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="uploadTitle">{{ i18n.upload_title }}</h3>
                <span class="close" id="uploadClose">&times;</span>
            </div>
            <div class="modal-body">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <div class="upload-text">
                        <p>{{ i18n.get('drag_files', 'ÊãñÊãΩÊñá‰ª∂Âà∞Ê≠§Â§ÑÊàñÁÇπÂáªÈÄâÊã©Êñá‰ª∂' if lang == 'zh' else 'Drag files here or click to select files') }}</p>
                        <p class="upload-hint">{{ i18n.get('upload_hint', 'ÊîØÊåÅÂ§öÊñá‰ª∂‰∏ä‰º†ÔºåÊñá‰ª∂Â∞Ü‰øùÂ≠òÂà∞ÈÄâÂÆöÁõÆÂΩïÁöÑworkspaceÊñá‰ª∂Â§π‰∏≠' if lang == 'zh' else 'Supports multiple file upload, files will be saved to the workspace folder of the selected directory') }}</p>
                    </div>
                    <input type="file" id="fileInput" multiple style="display: none;">
                    <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-folder-open"></i> {{ i18n.get('select_files', 'ÈÄâÊã©Êñá‰ª∂' if lang == 'zh' else 'Select Files') }}
                    </button>
                </div>
                <div class="upload-progress" id="uploadProgress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">‰∏ä‰º†‰∏≠...</div>
                </div>
                <div class="upload-result" id="uploadResult"></div>
            </div>
        </div>
    </div>



    <!-- Rename Directory Modal -->
    <div id="renameModal" class="modal">
        <div class="modal-content" style="width: 80%; max-width: 500px; height: auto;">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> {{ i18n.rename_title }}</h3>
                <span class="close" id="renameClose">&times;</span>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #cccccc; font-weight: 500;">{{ i18n.current_name }}</label>
                    <div id="currentDirName" style="background: #2d2d30; padding: 10px; border-radius: 4px; color: #9cdcfe; font-family: monospace;"></div>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; color: #cccccc; font-weight: 500;">{{ i18n.new_name }}</label>
                    <input type="text" id="newDirName" placeholder="{{ i18n.get('rename_placeholder', 'Enter new directory name...' if lang == 'en' else 'ËæìÂÖ•Êñ∞ÁöÑÁõÆÂΩïÂêçÁß∞...') }}" 
                           style="width: 100%; padding: 10px; background: #1e1e1e; border: 1px solid #3e3e42; border-radius: 4px; color: #cccccc; font-family: monospace;">
                    <div style="margin-top: 5px; font-size: 0.9em; color: #9cdcfe;">
                        <i class="fas fa-info-circle"></i> {{ i18n.rename_info }}
                    </div>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button id="renameCancel" class="action-btn" style="background: #6c757d; color: white; padding: 10px 20px;">
                        <i class="fas fa-times"></i> {{ i18n.cancel }}
                    </button>
                    <button id="renameConfirm" class="action-btn" style="background: #007acc; color: white; padding: 10px 20px;">
                        <i class="fas fa-check"></i> {{ i18n.confirm_rename }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/socket.io.js') }}"></script>
    <script src="{{ url_for('static', filename='js/marked.min.js') }}"></script>
    <script>
        // Internationalization configuration
        const I18N = {{ i18n | tojson }};
        const CURRENT_LANG = '{{ lang }}';
    </script>
    <script>
        // User connection management
        let socket = null;
        let currentUser = null;
        let isConnected = false;
        
        // Socket.IO connection configuration (will be initialized when user connects)
        function createSocket(apiKey) {
            return io({
                reconnection: true,
                reconnectionDelay: 1000,
                reconnectionAttempts: 5,
                timeout: 20000,
                forceNew: true,
                auth: {
                    api_key: apiKey || null
                }
            });
        }
        
        // DOM elements
        const chatMessages = document.getElementById('chatMessages');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const planButton = document.getElementById('planButton');

        const newTaskButton = document.getElementById('newTaskButton');
        const stopButton = document.getElementById('stopButton');
        const clearChatButton = document.getElementById('clearChatButton');
        const statusIndicator = document.getElementById('statusIndicator');
        const directoryList = document.getElementById('directoryList');
        const sidebarLoading = document.getElementById('sidebarLoading');
        
        // User authentication elements
        const apiKeyInput = document.getElementById('apiKeyInput');
        const connectBtn = document.getElementById('connectBtn');
        const userStatusIndicator = document.getElementById('userStatusIndicator');
        const userStatusText = document.getElementById('userStatusText');
        const userIdentity = document.getElementById('userIdentity');

        // State management
        let isTaskRunning = false;
        let selectedDirectory = null;
        let taskMode = 'new'; // 'new', 'continue', 'selected'
        let expandedDirectories = new Set(); // Save expanded directory state
        let collapsedSubDirectories = new Set(); // Save collapsed subdirectory state
        let isUserScrolling = false; // Whether user is manually scrolling
        let autoScrollEnabled = true; // Whether auto-scroll is enabled
        let refreshTimeout = null; // Debounce timer
        let scrollDirection = 'down'; // 'up' or 'down'
        let lastScrollTop = 0;

        // User connection management functions
        function updateUserStatus(status, message, identity = '', isGuest = false) {
            const statusClasses = {
                'disconnected': '',
                'connecting': 'connecting',
                'connected': 'connected',
                'error': 'error'
            };
            
            let className = 'user-status-indicator ' + (statusClasses[status] || '');
            if (status === 'connected' && isGuest) {
                className += ' guest';
                message = I18N.temporary_connection || '‰∏¥Êó∂ËøûÊé•';
            }
            
            userStatusIndicator.className = className;
            userStatusText.textContent = message;
            userIdentity.textContent = identity;
            
            // Update connect button
            if (status === 'connected') {
                connectBtn.className = 'connect-btn disconnect';
                connectBtn.innerHTML = `<i class="fas fa-unlink"></i><span>${I18N.disconnect_btn}</span>`;
                connectBtn.disabled = false;
                isConnected = true;
                
                // Enable UI controls
                enableUI(true);
            } else if (status === 'connecting') {
                connectBtn.disabled = true;
                connectBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i><span>${I18N.connecting}</span>`;
                
                // Disable UI controls
                enableUI(false);
            } else {
                connectBtn.className = 'connect-btn connect';
                connectBtn.innerHTML = `<i class="fas fa-plug"></i><span>${I18N.connect_btn}</span>`;
                connectBtn.disabled = false;
                isConnected = false;
                
                // Disable UI controls
                enableUI(false);
            }
        }
        
        function enableUI(enabled) {
            userInput.disabled = !enabled || isTaskRunning;
            sendButton.disabled = !enabled || isTaskRunning;
            planButton.disabled = !enabled || isTaskRunning;
            newTaskButton.disabled = !enabled || isTaskRunning;
            
            // Enable/disable directory operations
            const actionBtns = document.querySelectorAll('.directory-item .action-btn');
            actionBtns.forEach(btn => {
                btn.disabled = !enabled;
            });
        }
        
        function connectUser() {
            const apiKey = apiKeyInput.value.trim();
            
            updateUserStatus('connecting', I18N.connecting);
            
            // Create socket connection
            socket = createSocket(apiKey);
            currentUser = apiKey || 'default';
            
            // Setup socket event listeners
            setupSocketListeners();
            
            // Attempt to connect
            socket.connect();
        }
        
        function disconnectUser() {
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            
            currentUser = null;
            updateUserStatus('disconnected', I18N.user_disconnected);
            
            // Clear saved session from localStorage
            try {
                localStorage.removeItem('agibot_api_key');
                console.log('üóëÔ∏è Cleared saved session from localStorage');
            } catch (error) {
                console.warn('‚ö†Ô∏è Failed to clear session from localStorage:', error);
            }
            
            // Clear chat messages
            chatMessages.innerHTML = `
                <div class="message system">
                    <strong><i class="fas fa-info-circle"></i> ${I18N.system_message || 'Á≥ªÁªüÊ∂àÊÅØ'}</strong><br>
                    ${I18N.welcome_message || 'Ê¨¢Ëøé‰ΩøÁî® AGI BotÔºÅËØ∑Âú®‰∏ãÊñπËæìÂÖ•ÊÇ®ÁöÑÈúÄÊ±ÇÔºåÁ≥ªÁªüÂ∞ÜËá™Âä®‰∏∫ÊÇ®Â§ÑÁêÜ‰ªªÂä°„ÄÇ'}
                </div>
            `;
            
            // Clear directory list
            directoryList.innerHTML = '';
            selectedDirectory = null;
            taskMode = 'new';
            updateTaskModeInfo();
        }

        // File preview functionality
        const previewModal = document.getElementById('previewModal');
        const previewTitle = document.getElementById('previewTitle');
        const previewContent = document.getElementById('previewContent');
        const previewClose = document.getElementById('previewClose');

        // File upload functionality
        const uploadModal = document.getElementById('uploadModal');
        const uploadTitle = document.getElementById('uploadTitle');
        const uploadClose = document.getElementById('uploadClose');
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const uploadProgress = document.getElementById('uploadProgress');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const uploadResult = document.getElementById('uploadResult');
        
        let currentUploadDir = null;
        let newMessageCount = 0; // New message counter
        
        // Auto-scroll status indicator
        const autoScrollIndicator = document.getElementById('autoScrollIndicator');

        // Setup socket event listeners
        function setupSocketListeners() {
            if (!socket) return;
            
            socket.on('connect', function() {
                const identity = currentUser === 'default' ? I18N.default_user : `${I18N.user_prefix}: ${currentUser.substring(0, 8)}...`;
                updateUserStatus('connected', I18N.user_connected, identity);
                addMessage(I18N.connected, 'system');
                updateStatus('connected');
                updateTaskModeInfo(); // Initialize task mode info display
                
                // Save API key to localStorage for session restoration
                try {
                    if (currentUser && currentUser !== 'default') {
                        localStorage.setItem('agibot_api_key', currentUser);
                        console.log('üíæ API key saved to localStorage for session restoration');
                    } else {
                        // For default user, save a special marker
                        localStorage.setItem('agibot_api_key', '');
                        console.log('üíæ Default user session saved to localStorage');
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Failed to save session to localStorage:', error);
                }
                
                // Refresh directories for this user
                refreshDirectories();
                
                // Ëá™Âä®Âà∑Êñ∞Â∑≤Á¶ÅÁî®ÔºåÂè™‰ΩøÁî®ÊâãÂä®Âà∑Êñ∞
                // startAutoRefresh();
                
                // Ensure scroll to bottom after connection
                setTimeout(() => {
                    scrollToBottom(false);
                }, 100);
                console.log('‚úÖ Socket connected for user:', currentUser);
            });
            
            socket.on('status', function(data) {
                const isGuest = data.is_guest || false;
                const userName = data.user_name || 'unknown';
                let identity = '';
                
                if (isGuest) {
                    identity = I18N.guest_user || 'ËÆøÂÆ¢Áî®Êà∑';
                } else {
                    identity = currentUser === 'default' ? I18N.default_user : `${I18N.user_prefix}: ${currentUser.substring(0, 8)}...`;
                }
                
                updateUserStatus('connected', I18N.user_connected, identity, isGuest);
                console.log('‚úÖ Socket status updated:', data);
            });

            socket.on('disconnect', function(reason) {
                updateUserStatus('disconnected', I18N.user_disconnected);
                addMessage(`${I18N.disconnected} (${reason})`, 'info');
                updateStatus('disconnected');
                
                // Ëá™Âä®Âà∑Êñ∞Â∑≤Á¶ÅÁî®
                // stopAutoRefresh();
                
                console.log('‚ùå Socket disconnected:', reason);
            });

            socket.on('reconnect', function(attemptNumber) {
                const identity = currentUser === 'default' ? I18N.default_user : `${I18N.user_prefix}: ${currentUser.substring(0, 8)}...`;
                updateUserStatus('connected', I18N.user_connected, identity);
                addMessage(`${I18N.reconnected} (${I18N.attempt} ${attemptNumber})`, 'system');
                updateStatus('connected');
                console.log('üîÑ Socket reconnected after', attemptNumber, 'attempts');
            });

            socket.on('reconnect_attempt', function(attemptNumber) {
                updateUserStatus('connecting', `${I18N.user_reconnecting} (${attemptNumber})`);
                console.log('üîÑ Reconnection attempt', attemptNumber);
            });

            socket.on('reconnect_error', function(error) {
                updateUserStatus('error', I18N.user_connection_failed);
                console.log('‚ùå Reconnection error:', error);
            });

            socket.on('reconnect_failed', function() {
                updateUserStatus('error', I18N.user_connection_failed);
                addMessage(I18N.reconnect_failed, 'info');
                console.log('‚ùå Reconnection failed');
            });
            
            socket.on('auth_failed', function(data) {
                updateUserStatus('error', 'ËÆ§ËØÅÂ§±Ë¥•');
                addMessage('ËÆ§ËØÅÂ§±Ë¥•: ' + (data.message || 'Êú™Áü•ÈîôËØØ'), 'error');
                console.log('‚ùå Authentication failed:', data);
            });
            
            socket.on('connect_error', function(error) {
                updateUserStatus('error', 'ËøûÊé•ÈîôËØØ');
                addMessage('ËøûÊé•ÈîôËØØ: ' + error.message, 'error');
                console.log('‚ùå Connection error:', error);
            });

            socket.on('task_started', function(data) {
                addMessage(data.message, 'info');
                setTaskRunning(true);
            });

            socket.on('output', function(data) {
                addMessage(data.message, data.type || 'info');
            });

            socket.on('task_completed', function(data) {
                addMessage(data.message, data.success ? 'success' : 'error');
                setTaskRunning(false);
                
                // After task completion, if there's a selected directory, keep selection state, otherwise switch to continue mode
                if (selectedDirectory) {
                    taskMode = 'selected';
                    // If the completed task directory is the selected directory, auto-expand it
                    if (data.output_dir && data.output_dir === selectedDirectory) {
                        expandedDirectories.add(selectedDirectory);
                    }
                } else {
                    taskMode = 'continue';
                    // If there's a working directory, auto-expand the latest directory
                    if (data.output_dir) {
                        expandedDirectories.add(data.output_dir);
                    }
                }
                updateTaskModeInfo();
                
                // Refresh directory list with longer delay to ensure files are generated
                setTimeout(() => {
                    refreshDirectories();
                }, 2000);
            });

            socket.on('task_stopped', function(data) {
                addMessage(data.message, data.type || 'error');
                setTaskRunning(false);
                // Keep current task mode
                updateTaskModeInfo();
                // Refresh directories after stopping task
                setTimeout(refreshDirectories, 1000);
            });

            socket.on('error', function(data) {
                addMessage(data.message, 'error');
                setTaskRunning(false);
            });

            socket.on('directory_selected', function(data) {
                selectedDirectory = data.dir_name;
                if (selectedDirectory) {
                    taskMode = 'selected';
                    updateTaskModeInfo();
                    refreshDirectories();
                }
            });

            socket.on('directory_created', function(data) {
                if (data.success) {
                    selectedDirectory = data.dir_name;
                    taskMode = 'selected';
                    addMessage(data.message, 'success');
                    updateTaskModeInfo();
                    refreshDirectories();
                } else {
                    addMessage(`${I18N.create_directory_failed}: ${data.error}`, 'error');
                }
            });

            socket.on('chat_cleared', function(data) {
                if (data.success) {
                    addMessage(data.message, 'success');
                } else {
                    addMessage(`${I18N.chat_cleared}: ${data.error}`, 'error');
                }
            });
        }

        // Message handling
        let lastMessageType = null;
        let lastMessageDiv = null;
        
        /**
         * Ê£ÄÊü•ÊòØÂê¶Â∫îËØ•ÊâßË°åËá™Âä®ÊªöÂä®Âà∞Â∫ïÈÉ®
         * @returns {boolean} ÊòØÂê¶Â∫îËØ•Ëá™Âä®ÊªöÂä®
         * @description Êô∫ËÉΩÂà§Êñ≠Ëá™Âä®ÊªöÂä®Êù°‰ª∂Ôºö
         * 1. Ëá™Âä®ÊªöÂä®ÂäüËÉΩÂøÖÈ°ªÂêØÁî®
         * 2. Â¶ÇÊûúÁî®Êà∑Ê≠£Âú®Âêë‰∏äÊªöÂä®‰∏î‰∏çÂú®Â∫ïÈÉ®ÈôÑËøëÔºåÂàô‰∏çËá™Âä®ÊªöÂä®
         * 3. ÂÖ∂‰ªñÊÉÖÂÜµ‰∏ãÂÖÅËÆ∏Ëá™Âä®ÊªöÂä®
         */
        function shouldAutoScroll() {
            // Â¶ÇÊûúËá™Âä®ÊªöÂä®Ë¢´Á¶ÅÁî®ÔºåÁõ¥Êé•ËøîÂõûfalse
            if (!autoScrollEnabled) {
                console.log('üö´ Auto-scroll disabled');
                return false;
            }
            
            // ‰ΩøÁî®Áªü‰∏ÄÁöÑÈòàÂÄºÊ£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÊé•ËøëÂ∫ïÈÉ®
            const isNearBottom = chatMessages.scrollTop + chatMessages.clientHeight >= chatMessages.scrollHeight - SCROLL_THRESHOLD;
            
            // Â¶ÇÊûúÁî®Êà∑Ê≠£Âú®Âêë‰∏äÊªöÂä®‰∏î‰∏çÂú®Â∫ïÈÉ®ÈôÑËøëÔºåÂàô‰∏çÊâßË°åËá™Âä®ÊªöÂä®
            if (isUserScrolling && scrollDirection === 'up' && !isNearBottom) {
                console.log('üö´ User scrolling up away from bottom');
                return false;
            }
            
            // ÂÖ∂‰ªñÊÉÖÂÜµ‰∏ãÔºåÂè™Ë¶ÅËá™Âä®ÊªöÂä®ÂêØÁî®Â∞±ÂÖÅËÆ∏ÊªöÂä®
            console.log('‚úÖ Auto-scroll allowed', {
                autoScrollEnabled,
                isUserScrolling,
                scrollDirection,
                isNearBottom
            });
            return autoScrollEnabled;
        }
        
        // HTML escape function
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function addMessage(message, type = 'info') {
            // Special filtering: hide lines containing specific content
            if (message.trim() === '```' || message.trim() === '```xml') {
                return; // Don't display these lines
            }
            
            const shouldScroll = shouldAutoScroll();
            
            if (['info', 'error', 'success'].includes(type) && lastMessageType === type && lastMessageDiv) {
                // For consecutive messages of the same type, safely add content
                const textSpan = lastMessageDiv.querySelector('.message-text');
                if (textSpan) {
                    textSpan.innerHTML += '<br>' + escapeHtml(message);
                } else {
                    // If no text span found, fallback to original method but with escaping
                    lastMessageDiv.innerHTML += '<br>' + escapeHtml(message);
                }
                if (shouldScroll) {
                    // ‰ΩøÁî®ËäÇÊµÅÁöÑËá™Âä®ÊªöÂä®ÂáΩÊï∞ÔºåÂáèÂ∞ëË∑≥Âä®
                    throttledAutoScroll(true);
                } else {
                    // If can't auto-scroll, show new message indicator
                    showNewMessageIndicator();
                }
                return;
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            // Create text element, use textContent to ensure safe display
            const textSpan = document.createElement('span');
            textSpan.className = 'message-text';
            textSpan.textContent = message;
            
            // Directly add text, no icons
            messageDiv.appendChild(textSpan);
            
            chatMessages.appendChild(messageDiv);
            
            // Only scroll when auto-scroll is enabled
            if (shouldScroll) {
                // ‰ΩøÁî®ËäÇÊµÅÁöÑËá™Âä®ÊªöÂä®ÂáΩÊï∞ÔºåÂáèÂ∞ëË∑≥Âä®
                throttledAutoScroll(true);
            } else {
                // If can't auto-scroll, show new message indicator (except for user messages)
                if (type !== 'user') {
                    showNewMessageIndicator();
                }
            }

            if (['info', 'error', 'success'].includes(type)) {
                lastMessageType = type;
                lastMessageDiv = messageDiv;
            } else {
                lastMessageType = null;
                lastMessageDiv = null;
            }
        }

















        // Status update
        function updateStatus(status) {
            const indicator = statusIndicator;
            indicator.className = 'status-indicator';
            
            if (status === 'connected') {
                indicator.style.background = '#4CAF50';
            } else if (status === 'running') {
                indicator.style.background = '#007acc';
            } else if (status === 'disconnected') {
                indicator.style.background = '#F44336';
            }
        }

        function setTaskRunning(running) {
            isTaskRunning = running;
            userInput.disabled = running;
            
            if (running) {
                sendButton.style.display = 'none';
                planButton.style.display = 'none';
                newTaskButton.style.display = 'none';
                stopButton.style.display = 'flex';
                updateStatus('running');
            } else {
                sendButton.style.display = 'flex';
                planButton.style.display = 'flex';
                newTaskButton.style.display = 'flex';
                stopButton.style.display = 'none';
                updateStatus('connected');
            }
        }

        // Input handling
        async function sendMessage(planMode = false) {
            const message = userInput.value.trim();
            if (!message || isTaskRunning || !socket || !isConnected) return;

            // In new mode, prompt user to create or select directory first
            if (taskMode === 'new') {
                addMessage(I18N.create_or_select_directory, 'error');
                return;
            }

            // Get selected model
            const selectedModel = document.getElementById('modelSelect').value;
            
            // Validate configuration before execution
            try {
                const response = await fetch('/api/validate-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: selectedModel
                    })
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    addMessage(`${I18N.config_error_title}: ${result.error}`, 'error');
                    return;
                }
                
                // Configuration is valid, proceed with execution
                
                // Display execution mode information
                let modeInfo = '';
                if (planMode) {
                    modeInfo = I18N.plan_mode_suffix;
                    addMessage(`${message}${modeInfo}`, 'user');
                    addMessage(I18N.plan_mode_info, 'info');
                } else {
                    addMessage(message, 'user');
                    addMessage(I18N.direct_mode_info, 'info');
                }
                
                // Get GUI configuration options
                const guiConfig = {
                    enable_web_search: document.getElementById('enableWebSearch').checked,
                    enable_knowledge_base: document.getElementById('enableKnowledgeBase').checked,
                    enable_multi_agent: document.getElementById('enableMultiAgent').checked,
                    enable_long_term_memory: document.getElementById('enableLongTermMemory').checked,
                    enable_mcp: document.getElementById('enableMCP').checked,
                    enable_jieba: document.getElementById('enableJieba').checked,
                    // Add model configuration
                    selected_model: selectedModel,
                    model_api_key: result.config.api_key,
                    model_api_base: result.config.api_base
                };
                
                if (taskMode === 'selected' && selectedDirectory) {
                    socket.emit('execute_task', {
                        requirement: message,
                        type: 'selected',
                        plan_mode: planMode,
                        gui_config: guiConfig
                    });
                } else {
                    socket.emit('execute_task', {
                        requirement: message,
                        type: 'continue',
                        plan_mode: planMode,
                        gui_config: guiConfig
                    });
                }

                userInput.value = '';
                resizeTextarea();
                
            } catch (error) {
                console.error('Configuration validation error:', error);
                addMessage(`${I18N.config_error_title}: ÈÖçÁΩÆÈ™åËØÅÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•`, 'error');
            }
        }

        function createNewDirectory() {
            if (isTaskRunning || !socket || !isConnected) return;
            
            socket.emit('create_new_directory');
        }

        function clearChat() {
            if (!socket || !isConnected) return;
            
            // Show confirmation dialog
            if (confirm(I18N.confirm_clear_chat)) {
                // Clear the chat messages immediately for better user experience
                chatMessages.innerHTML = `
                    <div class="message system">
                        <strong><i class="fas fa-info-circle"></i> ${I18N.system_message || 'Á≥ªÁªüÊ∂àÊÅØ'}</strong><br>
                        ${I18N.welcome_message || 'Ê¨¢Ëøé‰ΩøÁî® AGI BotÔºÅËØ∑Âú®‰∏ãÊñπËæìÂÖ•ÊÇ®ÁöÑÈúÄÊ±ÇÔºåÁ≥ªÁªüÂ∞ÜËá™Âä®‰∏∫ÊÇ®Â§ÑÁêÜ‰ªªÂä°„ÄÇ'}
                    </div>
                `;
                
                // Reset message tracking variables
                lastMessageType = null;
                lastMessageDiv = null;
                
                // Reset scroll state
                autoScrollEnabled = true;
                updateAutoScrollIndicator();
                
                // Scroll to bottom
                scrollToBottom(false);
                
                // Notify server
                socket.emit('clear_chat');
            }
        }

        /**
         * Ê£ÄÊü•URLÂèÇÊï∞Âπ∂Ëá™Âä®ÁôªÂΩï
         * ÊîØÊåÅÁöÑURLÂèÇÊï∞Ôºöuser, username, apikey, api_key
         * ‰æãÂ¶ÇÔºöhttp://localhost:5001/?user=testuser
         *      http://localhost:5001/?apikey=abc123
         */
        function checkUrlAutoLogin() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                let apiKey = null;
                
                // Ê£ÄÊü•Â§öÁßçÂèØËÉΩÁöÑÂèÇÊï∞Âêç
                const possibleKeys = ['apikey', 'api_key', 'user', 'username', 'key'];
                for (const key of possibleKeys) {
                    if (urlParams.has(key)) {
                        apiKey = urlParams.get(key);
                        console.log(`üîë Found URL parameter '${key}': ${apiKey.substring(0, 8)}...`);
                        break;
                    }
                }
                
                if (apiKey) {
                    // Â°´ÂÖ•API KeyËæìÂÖ•Ê°Ü
                    apiKeyInput.value = apiKey;
                    
                    // Âª∂Ëøü‰∏ÄÁÇπÊó∂Èó¥Á°Æ‰øùDOMÂÆåÂÖ®Âä†ËΩΩ
                    setTimeout(() => {
                        console.log('üöÄ Auto-connecting with URL parameter...');
                        connectUser();
                        
                        // ÊòæÁ§∫Ëá™Âä®ÁôªÂΩïÊèêÁ§∫
                        setTimeout(() => {
                            addMessage(`üîó ${I18N.auto_login_from_url || 'Â∑≤ÈÄöËøáURLÂèÇÊï∞Ëá™Âä®ÁôªÂΩï'}`, 'info');
                        }, 1000);
                    }, 500);
                    
                    return true; // ËøîÂõûtrueË°®Á§∫ÊâæÂà∞‰∫ÜÂèÇÊï∞Âπ∂Â∞ùËØïËá™Âä®ÁôªÂΩï
                }
            } catch (error) {
                console.error('‚ùå Error parsing URL parameters:', error);
            }
            
            return false; // ËøîÂõûfalseË°®Á§∫Ê≤°ÊúâÊâæÂà∞URLÂèÇÊï∞
        }

        /**
         * Ê£ÄÊü•Âπ∂ÊÅ¢Â§çlocalStorage‰∏≠‰øùÂ≠òÁöÑ‰ºöËØù
         * ÂΩìÈ°µÈù¢Âà∑Êñ∞Êó∂Ëá™Âä®ÊÅ¢Â§ç‰∏äÊ¨°ÁöÑÁôªÂΩïÁä∂ÊÄÅ
         */
        function checkSessionRestore() {
            try {
                const savedApiKey = localStorage.getItem('agibot_api_key');
                
                if (savedApiKey !== null) { // null means no item, empty string is valid for default user
                    console.log('üîÑ Found saved session in localStorage');
                    
                    // Â°´ÂÖ•API KeyËæìÂÖ•Ê°Ü
                    apiKeyInput.value = savedApiKey;
                    
                    // Âª∂Ëøü‰∏ÄÁÇπÊó∂Èó¥Á°Æ‰øùDOMÂÆåÂÖ®Âä†ËΩΩ
                    setTimeout(() => {
                        console.log('üöÄ Auto-connecting with saved session...');
                        connectUser();
                        
                        // ÊòæÁ§∫‰ºöËØùÊÅ¢Â§çÊèêÁ§∫
                        setTimeout(() => {
                            addMessage(`üîÑ ${I18N.session_restored || 'Â∑≤ÊÅ¢Â§ç‰∏äÊ¨°ÁôªÂΩï‰ºöËØù'}`, 'info');
                        }, 1000);
                    }, 500);
                    
                    return true; // ËøîÂõûtrueË°®Á§∫ÊâæÂà∞‰∫Ü‰øùÂ≠òÁöÑ‰ºöËØùÂπ∂Â∞ùËØïÊÅ¢Â§ç
                }
            } catch (error) {
                console.error('‚ùå Error restoring session from localStorage:', error);
            }
            
            return false; // ËøîÂõûfalseË°®Á§∫Ê≤°ÊúâÊâæÂà∞‰øùÂ≠òÁöÑ‰ºöËØù
        }

        async function executeSelectedTask() {
            const message = userInput.value.trim();
            if (!message || isTaskRunning) return;

            if (!selectedDirectory) {
                addMessage(I18N.select_directory_first, 'error');
                return;
            }

            // Get selected model
            const selectedModel = document.getElementById('modelSelect').value;
            
            // Validate configuration before execution
            try {
                const response = await fetch('/api/validate-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        model: selectedModel
                    })
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    addMessage(`${I18N.config_error_title}: ${result.error}`, 'error');
                    return;
                }
                
                // Configuration is valid, proceed with execution
                addMessage(message, 'user');
                
                // Get GUI configuration options
                const guiConfig = {
                    enable_web_search: document.getElementById('enableWebSearch').checked,
                    enable_knowledge_base: document.getElementById('enableKnowledgeBase').checked,
                    enable_multi_agent: document.getElementById('enableMultiAgent').checked,
                    enable_long_term_memory: document.getElementById('enableLongTermMemory').checked,
                    enable_mcp: document.getElementById('enableMCP').checked,
                    enable_jieba: document.getElementById('enableJieba').checked,
                    // Add model configuration
                    selected_model: selectedModel,
                    model_api_key: result.config.api_key,
                    model_api_base: result.config.api_base
                };
                
                socket.emit('execute_task', {
                    requirement: message,
                    type: 'selected',
                    gui_config: guiConfig
                });

                userInput.value = '';
                resizeTextarea();
                
            } catch (error) {
                console.error('Configuration validation error:', error);
                addMessage(`${I18N.config_error_title}: ÈÖçÁΩÆÈ™åËØÅÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•`, 'error');
            }
        }

        function selectDirectory(dirName) {
            if (!socket || !isConnected) return;
            
            // If the same directory is already selected, no need to repeat the operation
            if (selectedDirectory === dirName) {
                console.log(`üìå Directory ${dirName} already selected`);
                return;
            }
            
            console.log(`üéØ Selecting directory: ${dirName}`);
            selectedDirectory = dirName;
            
            // Switch to selected directory mode
            taskMode = 'selected';
            
            // Only select directory, don't automatically switch expand state
            socket.emit('select_directory', {
                dir_name: dirName
            });
            
            // Update UI to show selected state, but don't refresh entire list
            document.querySelectorAll('.directory-item').forEach(item => {
                item.classList.remove('selected');
            });
            const selectedItem = document.querySelector(`[data-dir="${dirName}"]`);
            if (selectedItem) {
                selectedItem.classList.add('selected');
            }
            
            // Update task mode information
            updateTaskModeInfo();
            
            console.log(`‚úÖ Directory selected: ${dirName}, mode: ${taskMode}`);
        }

        function updateTaskModeInfo() {
            const taskModeInfo = document.getElementById('taskModeInfo');
            let baseInfo = '';
            
            if (taskMode === 'selected' && selectedDirectory) {
                baseInfo = `<i class="fas fa-info-circle"></i> ${I18N.selected_dir_info}: <strong>${selectedDirectory}</strong>`;
                taskModeInfo.style.color = '#569cd6';
            } else if (taskMode === 'continue') {
                baseInfo = `<i class="fas fa-info-circle"></i> ${I18N.continue_mode_info}`;
                taskModeInfo.style.color = '#9cdcfe';
            } else if (taskMode === 'new') {
                baseInfo = `<i class="fas fa-plus-circle"></i> ${I18N.new_mode_info}`;
                taskModeInfo.style.color = '#4CAF50';
            } else {
                baseInfo = `<i class="fas fa-plus-circle"></i> ${I18N.create_or_select_directory}`;
                taskModeInfo.style.color = '#9cdcfe';
            }
            
            taskModeInfo.innerHTML = baseInfo;
        }

        function resizeTextarea() {
            userInput.style.height = 'auto';
            userInput.style.height = Math.min(userInput.scrollHeight, 120) + 'px';
        }

        // Event listeners
        connectBtn.addEventListener('click', function() {
            if (isConnected) {
                disconnectUser();
            } else {
                connectUser();
            }
        });

        apiKeyInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                if (!isConnected) {
                    connectUser();
                }
            }
        });

        sendButton.addEventListener('click', () => sendMessage(false));

        planButton.addEventListener('click', () => sendMessage(true));

        newTaskButton.addEventListener('click', createNewDirectory);

        stopButton.addEventListener('click', function() {
            if (socket) {
                socket.emit('stop_task');
            }
        });

        clearChatButton.addEventListener('click', clearChat);

        userInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage(false); // Default to direct execution mode
            }
        });

        userInput.addEventListener('input', resizeTextarea);

        // Chat scroll behavior management
        let scrollTimeout;
        let scrollThrottleTimeout;
        let lastScrollHandlerTime = 0;
        const SCROLL_THRESHOLD = 50; // Áªü‰∏Ä‰ΩøÁî®50pxÈòàÂÄº
        const SCROLL_DEBOUNCE_TIME = 300; // Â¢ûÂä†Èò≤ÊäñÊó∂Èó¥Âà∞300ms
        const SCROLL_THROTTLE_TIME = 100; // Ê∑ªÂä†100msËäÇÊµÅÊó∂Èó¥
        
        let autoScrollPending = false;
        let lastAutoScrollTime = 0;
        const AUTO_SCROLL_THROTTLE_TIME = 150; // Ëá™Âä®ÊªöÂä®ËäÇÊµÅÊó∂Èó¥150ms
        
        // ËäÇÊµÅÁöÑËá™Âä®ÊªöÂä®ÂáΩÊï∞
        function throttledAutoScroll(smooth = true) {
            const now = Date.now();
            if (autoScrollPending || (now - lastAutoScrollTime < AUTO_SCROLL_THROTTLE_TIME)) {
                return; // Â¶ÇÊûúÂ∑≤ÊúâÊªöÂä®Âú®Á≠âÂæÖÊàñË∑ùÁ¶ª‰∏äÊ¨°ÊªöÂä®Êó∂Èó¥Â§™Áü≠ÔºåÂàôË∑≥Ëøá
            }
            
            autoScrollPending = true;
            lastAutoScrollTime = now;
            
            requestAnimationFrame(() => {
                if (smooth) {
                    chatMessages.scrollTo({
                        top: chatMessages.scrollHeight,
                        behavior: 'smooth'
                    });
                } else {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
                autoScrollPending = false;
            });
        }
        
        chatMessages.addEventListener('scroll', function() {
            const now = Date.now();
            
            // ËäÇÊµÅÔºöÈôêÂà∂ÊªöÂä®Â§ÑÁêÜÈ¢ëÁéá
            if (now - lastScrollHandlerTime < SCROLL_THROTTLE_TIME) {
                return;
            }
            lastScrollHandlerTime = now;
            
            // Clear previous timeout
            clearTimeout(scrollTimeout);
            
            // Detect scroll direction
            const currentScrollTop = chatMessages.scrollTop;
            scrollDirection = currentScrollTop > lastScrollTop ? 'down' : 'up';
            lastScrollTop = currentScrollTop;
            
            // Mark user is scrolling
            isUserScrolling = true;
            
            // Check if scrolled near bottom - ‰ΩøÁî®Áªü‰∏ÄÈòàÂÄº
            const isNearBottom = chatMessages.scrollTop + chatMessages.clientHeight >= chatMessages.scrollHeight - SCROLL_THRESHOLD;
            
            // Êô∫ËÉΩËá™Âä®ÊªöÂä®ÊéßÂà∂ÈÄªËæë - ÂáèÂ∞ëÁä∂ÊÄÅÂàáÊç¢È¢ëÁéá
            if (isNearBottom) {
                // Áî®Êà∑ÊªöÂä®Âà∞Â∫ïÈÉ®ÈôÑËøëÔºåËá™Âä®ÂêØÁî®Ëá™Âä®ÊªöÂä®ÂäüËÉΩ
                if (!autoScrollEnabled) {
                    autoScrollEnabled = true;
                    updateAutoScrollIndicator();
                    console.log('üîÑ User scrolled to bottom, enabling auto-scroll');
                }
                hideScrollToBottomHint();
            } else {
                // ÂΩìÁî®Êà∑‰∏ªÂä®Âêë‰∏äÊªöÂä®‰∏îË∑ùÁ¶ªÂ∫ïÈÉ®ËæÉËøúÊó∂ÔºåÁ¶ÅÁî®Ëá™Âä®ÊªöÂä®
                const farFromBottom = chatMessages.scrollTop + chatMessages.clientHeight < chatMessages.scrollHeight - (SCROLL_THRESHOLD * 3);
                if (autoScrollEnabled && scrollDirection === 'up' && farFromBottom) {
                    autoScrollEnabled = false;
                    updateAutoScrollIndicator();
                    console.log('‚¨ÜÔ∏è User scrolled up away from bottom, disabling auto-scroll');
                }
                
                // ‰ªÖÂú®ÈùûËá™Âä®ÊªöÂä®Áä∂ÊÄÅ‰∏ãÊòæÁ§∫ÊªöÂä®ÊèêÁ§∫
                if (!autoScrollEnabled) {
                    showScrollToBottomHint();
                }
            }
            
            // Â¢ûÂä†Èò≤ÊäñÊó∂Èó¥ÔºåÂáèÂ∞ëÁä∂ÊÄÅÈáçÁΩÆÈ¢ëÁéá
            scrollTimeout = setTimeout(() => {
                isUserScrolling = false;
            }, SCROLL_DEBOUNCE_TIME);
        });

        // Scroll hint management
        function showScrollToBottomHint() {
            const scrollBtn = document.getElementById('scrollToBottomBtn');
            if (scrollBtn && !scrollBtn.classList.contains('show')) {
                scrollBtn.classList.add('show');
            }
        }

        function hideScrollToBottomHint() {
            const scrollBtn = document.getElementById('scrollToBottomBtn');
            if (scrollBtn && scrollBtn.classList.contains('show')) {
                scrollBtn.classList.remove('show');
            }
            hideNewMessageIndicator(); // Also hide new message indicator
        }

        function showNewMessageIndicator() {
            if (!autoScrollEnabled) {
                newMessageCount++;
                const indicator = document.getElementById('newMessageIndicator');
                const countSpan = document.getElementById('newMessageCount');
                if (indicator && countSpan) {
                    countSpan.textContent = newMessageCount;
                    indicator.classList.add('show');
                }
            }
        }

        function hideNewMessageIndicator() {
            newMessageCount = 0;
            const indicator = document.getElementById('newMessageIndicator');
            if (indicator && indicator.classList.contains('show')) {
                indicator.classList.remove('show');
            }
        }

        /**
         * Êõ¥Êñ∞Ëá™Âä®ÊªöÂä®Áä∂ÊÄÅÊåáÁ§∫Âô®
         * Ê†πÊçÆÂΩìÂâçËá™Âä®ÊªöÂä®Áä∂ÊÄÅÊõ¥Êñ∞UIÊåáÁ§∫Âô®ÁöÑÊòæÁ§∫ÂíåÊ†∑Âºè
         * @description ÂΩìËá™Âä®ÊªöÂä®ÂêØÁî®Êó∂ÊòæÁ§∫Âêë‰∏ãÁÆ≠Â§¥ÔºåÁ¶ÅÁî®Êó∂ÊòæÁ§∫ÊöÇÂÅúÂõæÊ†á
         */
        function updateAutoScrollIndicator() {
            if (autoScrollIndicator) {
                if (autoScrollEnabled) {
                    autoScrollIndicator.classList.remove('disabled');
                    autoScrollIndicator.innerHTML = `<i class="fas fa-arrow-down"></i><span>${I18N.auto_scroll}</span>`;
                } else {
                    autoScrollIndicator.classList.add('disabled');
                    autoScrollIndicator.innerHTML = `<i class="fas fa-pause"></i><span>${I18N.paused}</span>`;
                }
                console.log(`üîÑ Auto-scroll status updated: ${autoScrollEnabled ? 'ENABLED' : 'DISABLED'}`);
            }
        }

        /**
         * ÊªöÂä®Âà∞ËÅäÂ§©Á™óÂè£Â∫ïÈÉ®
         * @param {boolean} smooth - ÊòØÂê¶‰ΩøÁî®Âπ≥ÊªëÊªöÂä®Âä®ÁîªÔºåÈªòËÆ§‰∏∫true
         * @description ÊâßË°åÊªöÂä®Êìç‰ΩúÂêé‰ºöËá™Âä®ÂêØÁî®Ëá™Âä®ÊªöÂä®ÂäüËÉΩÂπ∂ÈöêËóèÊªöÂä®ÊèêÁ§∫
         */
        function scrollToBottom(smooth = true) {
            if (smooth) {
                throttledAutoScroll(true);
            } else {
                throttledAutoScroll(false);
            }
            autoScrollEnabled = true;
            updateAutoScrollIndicator();
            hideScrollToBottomHint();
        }

        /**
         * ÁªëÂÆöÊªöÂä®Âà∞Â∫ïÈÉ®ÊåâÈíÆÁöÑÁÇπÂáª‰∫ã‰ª∂
         * @description Áî®Êà∑ÁÇπÂáªÊªöÂä®ÊåâÈíÆÊó∂ÔºåÂπ≥ÊªëÊªöÂä®Âà∞ËÅäÂ§©Á™óÂè£Â∫ïÈÉ®
         */
        document.getElementById('scrollToBottomBtn').addEventListener('click', () => {
            scrollToBottom(true);
        });

        /**
         * ÁªëÂÆöÊñ∞Ê∂àÊÅØÊèêÁ§∫ÁöÑÁÇπÂáª‰∫ã‰ª∂  
         * @description Áî®Êà∑ÁÇπÂáªÊñ∞Ê∂àÊÅØÊèêÁ§∫Êó∂ÔºåÂπ≥ÊªëÊªöÂä®Âà∞ËÅäÂ§©Á™óÂè£Â∫ïÈÉ®
         */
        document.getElementById('newMessageIndicator').addEventListener('click', () => {
            scrollToBottom(true);
        });

        /**
         * ÁõÆÂΩïÁÆ°ÁêÜ - Âà∑Êñ∞ÁõÆÂΩïÂàóË°®
         * @description ‰ªéÂêéÁ´ØËé∑ÂèñÊúÄÊñ∞ÁöÑÂ∑•‰ΩúÁõÆÂΩïÂàóË°®Âπ∂Êõ¥Êñ∞UIÊòæÁ§∫
         * ‰øùÊåÅÁî®Êà∑ÁöÑÂ±ïÂºÄ/Êî∂Ëµ∑Áä∂ÊÄÅÔºåÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅÔºåÂ§ÑÁêÜÈîôËØØÊÉÖÂÜµ
         */
        function refreshDirectories() {
            // ‰øùÂ≠òÂΩìÂâçÂ±ïÂºÄÁä∂ÊÄÅÔºåÈÅøÂÖçÂà∑Êñ∞ÂêéÁî®Êà∑Â±ïÂºÄÁöÑÁõÆÂΩïË¢´ÈáçÁΩÆ
            const currentExpanded = new Set(expandedDirectories);
            
            sidebarLoading.classList.add('show');
            directoryList.innerHTML = '';
            
            // Include current user info in API call
            const params = new URLSearchParams();
            if (currentUser && currentUser !== 'default') {
                params.set('api_key', currentUser);
            }
            
            const headers = {};
            if (currentUser && currentUser !== 'default') {
                headers['X-API-Key'] = currentUser;
            }
            
            fetch(`/api/output-dirs?${params}`, {
                headers: headers
            })
                .then(response => response.json())
                .then(data => {
                    sidebarLoading.classList.remove('show');
                    
                    if (data.success) {
                        // ÊÅ¢Â§çÂ±ïÂºÄÁä∂ÊÄÅ
                        expandedDirectories = currentExpanded;
                        renderDirectories(data.directories);
                    } else {
                        directoryList.innerHTML = `
                            <div class="message error">
                                <i class="fas fa-exclamation-triangle"></i>
                                ${I18N.load_directory_failed}: ${data.error}
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    sidebarLoading.classList.remove('show');
                    directoryList.innerHTML = `
                        <div class="message error">
                            <i class="fas fa-exclamation-triangle"></i>
                            ${I18N.network_error}: ${error.message}
                        </div>
                    `;
                });
        }

        /**
         * Ê∏≤ÊüìÁõÆÂΩïÂàóË°®Âà∞UI
         * @param {Array} directories - ÁõÆÂΩïÊï∞ÊçÆÊï∞ÁªÑ
         * @description Ê†πÊçÆÁõÆÂΩïÊï∞ÊçÆÁîüÊàêHTMLÁªìÊûÑÔºåÂåÖÊã¨Ôºö
         * - ÁõÆÂΩïÁä∂ÊÄÅÊ†áËØÜÔºàÂΩìÂâçÊâßË°å„ÄÅÂ∑≤ÈÄâÊã©„ÄÅ‰∏äÊ¨°‰ΩøÁî®Ôºâ
         * - ÁõÆÂΩïÊìç‰ΩúÊåâÈíÆÔºàÂ±ïÂºÄ/Êî∂Ëµ∑„ÄÅ‰∏ä‰º†„ÄÅ‰∏ãËΩΩ„ÄÅÈáçÂëΩÂêç„ÄÅÂà†Èô§Ôºâ
         * - Êñá‰ª∂Ê†ëÂ±ïÂºÄÁä∂ÊÄÅÁÆ°ÁêÜ
         */
        function renderDirectories(directories) {
            if (directories.length === 0) {
                directoryList.innerHTML = `
                    <div class="message system">
                        <i class="fas fa-folder-open"></i>
                        ÊöÇÊó†Â∑•‰ΩúÁõÆÂΩïÔºàÂåÖÂê´workspaceÂ≠êÁõÆÂΩïÁöÑÁõÆÂΩïÔºâ
                    </div>
                `;
                return;
            }

            directoryList.innerHTML = directories.map(dir => {
                let classes = ['directory-item'];
                let statusText = '';
                
                // Ê†πÊçÆÁõÆÂΩïÁä∂ÊÄÅÊ∑ªÂä†Áõ∏Â∫îÁöÑCSSÁ±ªÂíåÁä∂ÊÄÅÊñáÊú¨
                if (dir.is_current) {
                    classes.push('current');
                    statusText += '<span style="font-size: 0.8em; margin-left: 8px;">(ÂΩìÂâçÊâßË°å)</span>';
                }
                if (dir.is_selected) {
                    classes.push('selected');
                    statusText += '<span style="font-size: 0.8em; margin-left: 8px;">(Â∑≤ÈÄâÊã©)</span>';
                }
                if (dir.is_last && !dir.is_current && !dir.is_selected) {
                    classes.push('last');
                    statusText += '<span style="font-size: 0.8em; margin-left: 8px;">(‰∏äÊ¨°‰ΩøÁî®)</span>';
                }
                
                // Ê£ÄÊü•ËØ•ÁõÆÂΩïÊòØÂê¶Â∫îËØ•Â±ïÂºÄÊòæÁ§∫Êñá‰ª∂Ê†ë
                const isExpanded = expandedDirectories.has(dir.name);
                if (isExpanded) {
                    classes.push('expanded');
                }
                
                return `
                    <div class="${classes.join(' ')}" data-dir="${dir.name}">
                        <div class="directory-header">
                            <div class="directory-name" onclick="selectDirectory('${dir.name}')">
                                <i class="fas fa-folder"></i>
                                ${dir.name}
                                ${statusText}
                            </div>
                            <div class="directory-actions">
                                <button class="action-btn" onclick="return toggleDirectory('${dir.name}', event)" title="Â±ïÂºÄ/Êî∂Ëµ∑">
                                    <i class="fas fa-chevron-${isExpanded ? 'up' : 'down'}"></i>
                                </button>
                                <button class="action-btn" onclick="event.stopPropagation(); showUploadModal('${dir.name}')" title="‰∏ä‰º†Êñá‰ª∂Âà∞Workspace">
                                    <i class="fas fa-upload"></i>
                                </button>
                                <button class="action-btn" onclick="event.stopPropagation(); downloadDirectory('${dir.name}')" title="‰∏ãËΩΩÁõÆÂΩï‰∏∫ZIPÔºàÊéíÈô§code_indexÔºâ">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="action-btn rename-btn" onclick="event.stopPropagation(); showRenameDialog('${dir.name}')" title="ÈáçÂëΩÂêçÁõÆÂΩï">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn delete-btn" onclick="event.stopPropagation(); confirmDeleteDirectory('${dir.name}')" title="Âà†Èô§ÁõÆÂΩï">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="directory-info" onclick="selectDirectory('${dir.name}')">
                            <div><i class="fas fa-clock"></i> ${dir.modified_time}</div>
                            <div><i class="fas fa-hdd"></i> ${dir.size}</div>
                        </div>
                        <div class="file-tree ${isExpanded ? 'show' : ''}" id="tree-${dir.name}">
                            ${renderFileTree(dir.files, dir.name)}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderFileTree(files, dirName, indent = 0) {
            return files.map(file => {
                const icon = file.type === 'directory' ? 'fas fa-folder' : getFileIcon(file.name);
                const className = file.type === 'directory' ? 'file-item directory' : 'file-item';
                const sizeInfo = file.size ? ` (${file.size})` : '';
                const isPreviewable = file.type === 'file' && isFilePreviewable(file.name);
                const previewClass = isPreviewable ? ' previewable' : '';
                
                // Ê£ÄÊü•ÊòØÂê¶Âú®ÁâπÂÆöÁõÆÂΩï‰∏ãÔºåÂ¶ÇÊûúÊòØÂàôÊ∑ªÂä†ÁÅ∞Ëâ≤Ê†∑Âºè
                const isInSpecialDir = file.path && (
                    file.path.includes('/web_search_result/') || 
                    file.path.includes('/code_index/') ||
                    file.path.includes('\\web_search_result\\') || 
                    file.path.includes('\\code_index\\')
                );
                const grayedClass = (file.type === 'file' && isInSpecialDir) ? ' grayed' : '';
                
                // ÊûÑÈÄ†Êñá‰ª∂Ë∑ØÂæÑ - ÂêéÁ´ØÁé∞Âú®ËøîÂõûÁõ∏ÂØπË∑ØÂæÑ
                let relativePath = '';
                if (file.path) {
                    // Áõ¥Êé•‰ΩøÁî®ÂêéÁ´ØËøîÂõûÁöÑÁõ∏ÂØπË∑ØÂæÑ
                    relativePath = file.path;
                } else {
                    // Â¶ÇÊûúÊ≤°ÊúâË∑ØÂæÑÔºåÊûÑÈÄ†Ë∑ØÂæÑ
                    relativePath = `${dirName}/${file.name}`;
                }
                
                // ‰∏∫Â≠êÊñá‰ª∂Â§πÁîüÊàêÂîØ‰∏ÄID
                const subDirId = `${dirName}-${file.name}`;
                const hasChildren = file.children && file.children.length > 0;
                // Â≠êÊñá‰ª∂Â§πÈªòËÆ§Â±ïÂºÄÔºåÂè™ÊúâÂú®collapsedSubDirectories‰∏≠ÁöÑÊâçÊî∂Ëµ∑
                const isSubDirExpanded = !collapsedSubDirectories.has(subDirId);
                
                let html = '';
                
                if (file.type === 'directory' && hasChildren) {
                    // Â≠êÊñá‰ª∂Â§πÔºöÂ∏¶Â±ïÂºÄ/Êî∂Ëµ∑ÂäüËÉΩ
                    html = `
                        <div class="file-item directory" style="margin-left: ${indent * 20}px; display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 8px; flex: 1; cursor: pointer;" 
                                 onclick="toggleSubDirectory('${subDirId}', event)">
                                <i class="${icon}"></i>
                                ${file.name}${sizeInfo}
                            </div>
                            <button class="sub-folder-toggle" onclick="toggleSubDirectory('${subDirId}', event)" 
                                    style="background: none; border: none; color: #9cdcfe; cursor: pointer; padding: 2px 6px; margin-right: 10px;">
                                <i class="fas fa-chevron-${isSubDirExpanded ? 'up' : 'down'}" style="font-size: 12px;"></i>
                            </button>
                        </div>
                        <div class="sub-file-tree ${isSubDirExpanded ? 'show' : ''}" id="subtree-${subDirId}">
                            ${renderFileTree(file.children, dirName, indent + 1)}
                        </div>
                    `;
                } else if (file.type === 'directory') {
                    // Á©∫Êñá‰ª∂Â§π
                    html = `
                        <div class="${className}" style="margin-left: ${indent * 20}px">
                            <i class="${icon}"></i>
                            ${file.name}${sizeInfo}
                        </div>
                    `;
                } else {
                    // Êñá‰ª∂
                    html = `
                        <div class="${className}${previewClass}${grayedClass}" style="margin-left: ${indent * 20}px" 
                             ${isPreviewable ? `onclick="previewFile('${relativePath.replace(/'/g, "\\'")}', '${file.name.replace(/'/g, "\\'")}')"` : ''}>
                            <i class="${icon}"></i>
                            ${file.name}${sizeInfo}
                        </div>
                    `;
                }
                
                return html;
            }).join('');
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const iconMap = {
                'html': 'fab fa-html5',
                'htm': 'fab fa-html5',
                'css': 'fab fa-css3-alt',
                'js': 'fab fa-js-square',
                'py': 'fab fa-python',
                'md': 'fab fa-markdown',
                'json': 'fas fa-code',
                'txt': 'fas fa-file-alt',
                'log': 'fas fa-file-alt',
                'yaml': 'fas fa-code',
                'yml': 'fas fa-code',
                'png': 'fas fa-image',
                'jpg': 'fas fa-image',
                'jpeg': 'fas fa-image',
                'gif': 'fas fa-image',
                'svg': 'fas fa-image',
                'bmp': 'fas fa-image',
                'webp': 'fas fa-image',
                'ico': 'fas fa-image'
            };
            return iconMap[ext] || 'fas fa-file';
        }

        function isFilePreviewable(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            return ['html', 'htm', 'md', 'markdown', 'py', 'js', 'jsx', 'ts', 'tsx', 'css', 'json', 
                    'txt', 'log', 'yaml', 'yml', 'pdf', 'c', 'cpp', 'cc', 'cxx', 'h', 'hpp', 
                    'java', 'go', 'rs', 'php', 'rb', 'sh', 'bash', 'zsh', 'fish', 'ps1', 'bat', 
                    'cmd', 'xml', 'sql', 'r', 'scala', 'kt', 'swift', 'dart', 'lua', 'perl', 'pl', 
                    'vim', 'dockerfile', 'makefile', 'cmake', 'gradle', 'properties', 'ini', 'cfg', 
                    'conf', 'toml', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'csv',
                    'png', 'jpg', 'jpeg', 'gif', 'svg', 'bmp', 'webp', 'ico'].includes(ext);
        }

        function toggleDirectory(dirName, event) {
            // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            
            console.log(`üîÑ Toggle directory: ${dirName}`);
            console.log(`üîç Event details:`, event);
            
            // Ëé∑ÂèñDOMÂÖÉÁ¥†
            const tree = document.getElementById(`tree-${dirName}`);
            const button = document.querySelector(`[data-dir="${dirName}"] .directory-actions button[title="Â±ïÂºÄ/Êî∂Ëµ∑"]`);
            const icon = button ? button.querySelector('i') : null;
            
            console.log(`üîç DOM elements:`, {
                tree: tree,
                treeId: `tree-${dirName}`,
                button: button,
                icon: icon,
                treeClasses: tree ? tree.className : 'null',
                treeStyle: tree ? tree.style.cssText : 'null'
            });
            
            if (!tree) {
                console.error(`‚ùå Tree element not found: tree-${dirName}`);
                // Â∞ùËØïÊü•ÊâæÊâÄÊúâÂèØËÉΩÁöÑtreeÂÖÉÁ¥†
                const allTrees = document.querySelectorAll('[id^="tree-"]');
                console.log(`üîç All tree elements found:`, Array.from(allTrees).map(t => t.id));
                return false;
            }
            
            // Ê£ÄÊü•ÂΩìÂâçÁä∂ÊÄÅ
            const isCurrentlyExpanded = tree.classList.contains('show');
            console.log(`üìä Current state: ${dirName} expanded = ${isCurrentlyExpanded}`);
            console.log(`üìä Tree computed style:`, window.getComputedStyle(tree).display);
            
            if (isCurrentlyExpanded) {
                // Êî∂Ëµ∑
                tree.classList.remove('show');
                expandedDirectories.delete(dirName);
                if (icon) {
                    icon.className = 'fas fa-chevron-down';
                }
                console.log(`üì• Collapsed: ${dirName}`);
                console.log(`üì• After collapse - display:`, window.getComputedStyle(tree).display);
            } else {
                // Â±ïÂºÄ
                tree.classList.add('show');
                expandedDirectories.add(dirName);
                if (icon) {
                    icon.className = 'fas fa-chevron-up';
                }
                console.log(`üì§ Expanded: ${dirName}`);
                console.log(`üì§ After expand - display:`, window.getComputedStyle(tree).display);
            }
            
            console.log(`‚úÖ Toggle complete. Tree classes: ${tree.className}`);
            console.log(`‚úÖ Expanded dirs: [${Array.from(expandedDirectories).join(', ')}]`);
            return false;
        }

        function toggleSubDirectory(subDirId, event) {
            // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            
            console.log(`üîÑ Toggle sub-directory: ${subDirId}`);
            
            // Ëé∑ÂèñDOMÂÖÉÁ¥†
            const subTree = document.getElementById(`subtree-${subDirId}`);
            const button = event.target.closest('.sub-folder-toggle');
            const icon = button ? button.querySelector('i') : null;
            
            console.log(`üîç Sub-directory DOM elements:`, {
                subTree: subTree,
                subTreeId: `subtree-${subDirId}`,
                button: button,
                icon: icon,
                subTreeClasses: subTree ? subTree.className : 'null'
            });
            
            if (!subTree) {
                console.error(`‚ùå Sub-tree element not found: subtree-${subDirId}`);
                return false;
            }
            
            // Ê£ÄÊü•ÂΩìÂâçÁä∂ÊÄÅ
            const isCurrentlyExpanded = subTree.classList.contains('show');
            console.log(`üìä Sub-directory current state: ${subDirId} expanded = ${isCurrentlyExpanded}`);
            
            if (isCurrentlyExpanded) {
                // Êî∂Ëµ∑Â≠êÊñá‰ª∂Â§π
                subTree.classList.remove('show');
                collapsedSubDirectories.add(subDirId);
                if (icon) {
                    icon.className = 'fas fa-chevron-down';
                }
                console.log(`üì• Collapsed sub-directory: ${subDirId}`);
            } else {
                // Â±ïÂºÄÂ≠êÊñá‰ª∂Â§π
                subTree.classList.add('show');
                collapsedSubDirectories.delete(subDirId);
                if (icon) {
                    icon.className = 'fas fa-chevron-up';
                }
                console.log(`üì§ Expanded sub-directory: ${subDirId}`);
            }
            
            console.log(`‚úÖ Sub-directory toggle complete. Classes: ${subTree.className}`);
            console.log(`‚úÖ Collapsed sub-dirs: [${Array.from(collapsedSubDirectories).join(', ')}]`);
            return false;
        }

        function downloadDirectory(dirName) {
            // Build URL with API key parameter - use currentUser like other API calls
            let downloadUrl = `/api/download/${dirName}`;
            if (currentUser && currentUser !== 'default') {
                downloadUrl += `?api_key=${encodeURIComponent(currentUser)}`;
            }
            
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.download = `${dirName}.zip`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }



        function confirmDeleteDirectory(dirName) {
            const isCurrentDir = document.querySelector(`[data-dir="${dirName}"]`).classList.contains('current');
            const isSelectedDir = document.querySelector(`[data-dir="${dirName}"]`).classList.contains('selected');
            
            let warningMessage = `Á°ÆÂÆöË¶ÅÂà†Èô§ÁõÆÂΩï "${dirName}" ÂêóÔºü\n\nÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄÔºåÂ∞ÜÊ∞∏‰πÖÂà†Èô§ËØ•ÁõÆÂΩïÂèäÂÖ∂ÊâÄÊúâÂÜÖÂÆπ„ÄÇ`;
            
            if (isCurrentDir) {
                warningMessage += '\n\n‚ö†Ô∏è Ë≠¶ÂëäÔºöËøôÊòØÂΩìÂâçÊ≠£Âú®ÊâßË°åÁöÑÁõÆÂΩïÔºÅ';
            }
            if (isSelectedDir) {
                warningMessage += '\n\n‚ö†Ô∏è Ë≠¶ÂëäÔºöËøôÊòØÂΩìÂâçÈÄâÊã©ÁöÑÁõÆÂΩïÔºÅ';
            }
            
            if (confirm(warningMessage)) {
                deleteDirectory(dirName);
            }
        }

        function deleteDirectory(dirName) {
            console.log(`üóëÔ∏è Deleting directory: ${dirName}`);
            
            // ÊòæÁ§∫Âà†Èô§‰∏≠Áä∂ÊÄÅ
            const dirElement = document.querySelector(`[data-dir="${dirName}"]`);
            if (dirElement) {
                dirElement.style.opacity = '0.5';
                dirElement.style.pointerEvents = 'none';
                
                // Âú®ÁõÆÂΩïÂêçÂêéÊ∑ªÂä†Âà†Èô§‰∏≠ÊèêÁ§∫
                const nameElement = dirElement.querySelector('.directory-name');
                if (nameElement && !nameElement.querySelector('.deleting-indicator')) {
                    const indicator = document.createElement('span');
                    indicator.className = 'deleting-indicator';
                    indicator.style.cssText = 'color: #ff6b6b; font-size: 0.8em; margin-left: 8px;';
                    indicator.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${I18N.deleting}`;
                    nameElement.appendChild(indicator);
                }
            }
            
            const headers = {};
            if (currentUser && currentUser !== 'default') {
                headers['X-API-Key'] = currentUser;
            }
            
            fetch(`/api/delete-directory/${dirName}`, {
                method: 'DELETE',
                headers: headers
            })
            .then(response => response.json())
            .then(data => {
                console.log('üóëÔ∏è Delete response:', data);
                if (data.success) {
                    console.log(`‚úÖ Directory deleted successfully: ${dirName}`);
                    // ‰ªéDOM‰∏≠ÁßªÈô§ÁõÆÂΩïÂÖÉÁ¥†
                    if (dirElement) {
                        dirElement.remove();
                    }
                    // Ê∏ÖÁêÜÁõ∏ÂÖ≥Áä∂ÊÄÅ
                    expandedDirectories.delete(dirName);
                    // Ê∏ÖÁêÜÂ≠êÁõÆÂΩïÁä∂ÊÄÅ
                    Array.from(collapsedSubDirectories).forEach(subDirId => {
                        if (subDirId.startsWith(dirName + '-')) {
                            collapsedSubDirectories.delete(subDirId);
                        }
                    });
                    // Â¶ÇÊûúÂà†Èô§ÁöÑÊòØÂΩìÂâçÈÄâÊã©ÁöÑÁõÆÂΩïÔºåÊ∏ÖÁêÜÁä∂ÊÄÅ
                    if (selectedDirectory === dirName) {
                        selectedDirectory = null;
                        taskMode = 'continue';
                        updateTaskModeInfo();
                    }
                    
                    alert(`ÁõÆÂΩï "${dirName}" Â∑≤ÊàêÂäüÂà†Èô§`);
                } else {
                    console.error('‚ùå Delete failed:', data.error);
                    alert(`Âà†Èô§Â§±Ë¥•: ${data.error}`);
                    // ÊÅ¢Â§çÁõÆÂΩïÂÖÉÁ¥†Áä∂ÊÄÅ
                    if (dirElement) {
                        dirElement.style.opacity = '1';
                        dirElement.style.pointerEvents = 'auto';
                        const indicator = dirElement.querySelector('.deleting-indicator');
                        if (indicator) {
                            indicator.remove();
                        }
                    }
                }
            })
            .catch(error => {
                console.error('‚ùå Delete error:', error);
                alert(`Âà†Èô§Âá∫Èîô: ${error.message}`);
                // ÊÅ¢Â§çÁõÆÂΩïÂÖÉÁ¥†Áä∂ÊÄÅ
                if (dirElement) {
                    dirElement.style.opacity = '1';
                    dirElement.style.pointerEvents = 'auto';
                    const indicator = dirElement.querySelector('.deleting-indicator');
                    if (indicator) {
                        indicator.remove();
                    }
                }
            });
        }

        // Êñá‰ª∂È¢ÑËßàÂäüËÉΩ
        function previewFile(filePath, fileName) {
            console.log('üîç Preview file called with:', filePath, fileName);
            console.log('üîç Preview modal elements:', {
                previewModal: previewModal,
                previewTitle: previewTitle,
                previewContent: previewContent
            });
            
            if (!previewModal || !previewTitle || !previewContent) {
                console.error('‚ùå Preview modal elements not found');
                return;
            }
            
            // Â≠òÂÇ®ÂΩìÂâçÊñá‰ª∂Ë∑ØÂæÑÔºåÁî®‰∫éOfficeÈ¢ÑËßàËøîÂõûÂäüËÉΩ
            currentFilePath = filePath;
            
            previewTitle.textContent = `${I18N.preview}: ${fileName}`;
            previewContent.innerHTML = `<div style="text-align: center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> ${I18N.loading}</div>`;
            previewModal.style.display = 'block';
            
            console.log('üîç Making API request to:', `/api/file/${filePath}`);

            const headers = {};
            if (currentUser && currentUser !== 'default') {
                headers['X-API-Key'] = currentUser;
            }

            fetch(`/api/file/${filePath}`, {
                headers: headers
            })
                .then(response => {
                    console.log('üîç API response status:', response.status, response.statusText);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('üîç Preview response data:', data);
                    if (data.success) {
                        displayFileContent(data, fileName);
                    } else {
                        console.error('‚ùå Preview failed:', data.error);
                        previewContent.innerHTML = `<div style="color: red; text-align: center; padding: 20px;">
                            <i class="fas fa-exclamation-triangle"></i> 
                            È¢ÑËßàÂ§±Ë¥•: ${data.error}
                        </div>`;
                    }
                })
                .catch(error => {
                    console.error('‚ùå Preview error:', error);
                    previewContent.innerHTML = `<div style="color: red; text-align: center; padding: 20px;">
                        <i class="fas fa-exclamation-triangle"></i> 
                        ${I18N.network_error}: ${error.message}
                    </div>`;
                });
        }

        function displayFileContent(data, fileName) {
            const { content, type, language, size, file_path } = data;
            
            if (type === 'html') {
                // Â§ÑÁêÜËΩ¨‰πâÂ≠óÁ¨¶ÔºåÁÑ∂ÂêéËΩ¨‰πâÂºïÂè∑
                const processedContent = processFileContent(content).replace(/"/g, '&quot;');
                previewContent.innerHTML = `
                    <div style="background: #f8f8f8; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 12px; color: #666;">
                        Êñá‰ª∂Â§ßÂ∞è: ${size} | Á±ªÂûã: HTML
                    </div>
                    <iframe srcdoc="${processedContent}" style="width: 100%; height: calc(90vh - 160px); border: none; border-radius: 4px; background: white;"></iframe>
                `;
            } else if (type === 'markdown') {
                // Â§ÑÁêÜËΩ¨‰πâÂ≠óÁ¨¶
                const processedContent = processFileContent(content);
                const htmlContent = marked.parse(processedContent);
                previewContent.innerHTML = `
                    <div style="background: #2d2d30; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 12px; color: #9cdcfe;">
                        Êñá‰ª∂Â§ßÂ∞è: ${size} | Á±ªÂûã: Markdown
                    </div>
                    <div style="background: #1e1e1e; color: #cccccc; padding: 20px; border-radius: 5px; line-height: 1.6; max-height: calc(90vh - 160px); overflow-y: auto;">
                        ${htmlContent}
                    </div>
                `;
            } else if (type === 'pdf') {
                previewContent.innerHTML = `
                    <div style="background: #f8f8f8; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 12px; color: #666;">
                        Êñá‰ª∂Â§ßÂ∞è: ${size} | Á±ªÂûã: PDF
                    </div>
                    <div id="pdfContainer" style="width: 100%; height: calc(90vh - 160px); border: 1px solid #ddd; border-radius: 4px; overflow: auto; background: #f5f5f5;">
                        <div style="text-align: center; padding: 20px;">
                            <i class="fas fa-spinner fa-spin"></i> Ê≠£Âú®Âä†ËΩΩPDF...
                        </div>
                    </div>
                `;
                loadPDF(file_path);
            } else if (type === 'office') {
                const { file_ext } = data;
                previewContent.innerHTML = `
                    <div style="background: #f8f8f8; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 12px; color: #666;">
                        Êñá‰ª∂Â§ßÂ∞è: ${size} | Á±ªÂûã: ${file_ext.toUpperCase()} OfficeÊñáÊ°£
                    </div>
                    <div id="officeContainer" style="width: 100%; height: calc(90vh - 160px); border: 1px solid #ddd; border-radius: 4px; overflow: auto; background: #f5f5f5;">
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <i class="fas fa-file-alt" style="font-size: 48px; margin-bottom: 20px; color: #007acc;"></i>
                            <h3 style="margin-bottom: 20px;">OfficeÊñáÊ°£È¢ÑËßà</h3>
                            <p style="margin-bottom: 20px;">ÈÄâÊã©‰ª•‰∏ãÊñπÂºèÈ¢ÑËßàOfficeÊñáÊ°£Ôºö</p>
                            <div style="display: flex; flex-direction: column; gap: 15px; align-items: center;">
                                <button onclick="previewOfficeCloud('${file_path}')" style="padding: 12px 24px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; min-width: 200px;">
                                    <i class="fas fa-cloud-upload-alt"></i> ‰∫ëÂ≠òÂÇ®È¢ÑËßà
                                </button>
                                <a href="/api/download-file/${file_path}" download style="padding: 12px 24px; background: #6c757d; color: white; text-decoration: none; border-radius: 5px; font-size: 14px; min-width: 200px; text-align: center; display: inline-block;">
                                    <i class="fas fa-download"></i> ‰∏ãËΩΩÊñá‰ª∂
                                </a>
                            </div>
                            <div style="margin-top: 30px; padding: 20px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; text-align: left; max-width: 600px;">
                                <h4 style="color: #856404; margin-bottom: 10px;"><i class="fas fa-info-circle"></i> È¢ÑËßàËØ¥Êòé</h4>
                                <ul style="color: #856404; margin: 0; padding-left: 20px;">
                                    <li><strong>‰∫ëÂ≠òÂÇ®È¢ÑËßà</strong>: ÂÖà‰∏ä‰º†Âà∞‰∫ëÂ≠òÂÇ®ÔºåÂÜç‰ΩøÁî®Âú®Á∫øÈ¢ÑËßàÊúçÂä°</li>
                                    <li><strong>‰∏ãËΩΩÊñá‰ª∂</strong>: ‰∏ãËΩΩÂà∞Êú¨Âú∞‰ΩøÁî®OfficeËΩØ‰ª∂ÊâìÂºÄ</li>
                                </ul>
                                <div style="margin-top: 15px; padding: 10px; background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 3px;">
                                    <small><i class="fas fa-lightbulb"></i> <strong>ÊèêÁ§∫</strong>: Â¶ÇÊûúÊüê‰∏™È¢ÑËßàÊúçÂä°Êó†Ê≥ïÊ≠£Â∏∏Â∑•‰ΩúÔºåËØ∑Â∞ùËØïÂÖ∂‰ªñÈÄâÈ°π„ÄÇ‰∏çÂêåÊúçÂä°ÂØπÊñáÊ°£Ê†ºÂºèÁöÑÊîØÊåÅÁ®ãÂ∫¶ÂèØËÉΩ‰∏çÂêå„ÄÇ</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (type === 'csv') {
                // CSVÊñá‰ª∂Ë°®Ê†ºÈ¢ÑËßà
                const { headers, data: csvRows, total_rows, displayed_rows, truncated, encoding } = data;
                
                // ÂàõÂª∫Ë°®Ê†ºHTML
                let tableHtml = '<table id="csvTable" style="width: 100%; border-collapse: collapse; background: white; font-size: 13px; color: #333;">';
                
                // Ë°®Â§¥
                if (headers && headers.length > 0) {
                    tableHtml += '<thead><tr style="background: #f8f9fa; position: sticky; top: 0; z-index: 10;">';
                    headers.forEach((header, index) => {
                        const escapedHeader = escapeHtml(header || `Âàó${index + 1}`);
                        tableHtml += `<th onclick="sortCSVTable(${index})" style="border: 1px solid #dee2e6; padding: 12px 8px; text-align: left; font-weight: 600; cursor: pointer; user-select: none; position: relative; min-width: 120px; color: #333;" title="ÁÇπÂáªÊéíÂ∫è">${escapedHeader}<span style="margin-left: 5px; color: #6c757d;">‚áÖ</span></th>`;
                    });
                    tableHtml += '</tr></thead>';
                }
                
                // Ë°®Ê†ºÊï∞ÊçÆ
                tableHtml += '<tbody id="csvTableBody">';
                if (csvRows && csvRows.length > 0) {
                    csvRows.forEach((row, rowIndex) => {
                        const rowStyle = rowIndex % 2 === 0 ? 'background: #ffffff;' : 'background: #f8f9fa;';
                        tableHtml += `<tr style="${rowStyle}">`;
                        
                        // Á°Æ‰øùÊØèË°åÈÉΩÊúâË∂≥Â§üÁöÑÂàó
                        const maxCols = Math.max(headers.length, row.length);
                        for (let i = 0; i < maxCols; i++) {
                            const cellValue = row[i] || '';
                            const escapedValue = escapeHtml(cellValue);
                            tableHtml += `<td style="border: 1px solid #dee2e6; padding: 8px; vertical-align: top; word-break: break-word; max-width: 300px; color: #333;" title="${escapedValue}">${escapedValue}</td>`;
                        }
                        tableHtml += '</tr>';
                    });
                } else {
                    tableHtml += `<tr><td colspan="${headers.length}" style="text-align: center; padding: 40px; color: #6c757d; font-style: italic;">ÊöÇÊó†Êï∞ÊçÆ</td></tr>`;
                }
                tableHtml += '</tbody></table>';
                
                // ÂàõÂª∫ÊêúÁ¥¢ÂíåÂ∑•ÂÖ∑Ê†è
                const searchHtml = `
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 5px 5px 0 0; border-bottom: 1px solid #dee2e6; display: flex; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <div style="flex: 1; min-width: 200px;">
                            <input type="text" id="csvSearchInput" placeholder="ÊêúÁ¥¢Ë°®Ê†ºÂÜÖÂÆπ..." 
                                style="width: 100%; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px;"
                                oninput="filterCSVTable()">
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                            <button onclick="exportCSVTable()" style="padding: 8px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 5px;">
                                <i class="fas fa-download"></i> ÂØºÂá∫
                            </button>
                            <span style="font-size: 12px; color: #6c757d;">
                                ÊòæÁ§∫ ${displayed_rows}/${total_rows} Ë°å
                                ${truncated ? '(Â∑≤Êà™Êñ≠)' : ''}
                                ${encoding ? `| ÁºñÁ†Å: ${encoding.toUpperCase()}` : ''}
                            </span>
                        </div>
                    </div>
                `;
                
                previewContent.innerHTML = `
                    <div style="background: #f8f8f8; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 12px; color: #666;">
                        Êñá‰ª∂Â§ßÂ∞è: ${size} | Á±ªÂûã: CSVË°®Ê†º | ÊÄªË°åÊï∞: ${total_rows} | ÂàóÊï∞: ${headers.length}
                        ${truncated ? ' | ‚ö†Ô∏è Â§ßÊñá‰ª∂Â∑≤Êà™Êñ≠ÊòæÁ§∫' : ''}
                    </div>
                    <div style="border: 1px solid #dee2e6; border-radius: 5px; overflow: hidden; max-height: calc(90vh - 160px); display: flex; flex-direction: column;">
                        ${searchHtml}
                        <div style="flex: 1; overflow: auto;">
                            ${tableHtml}
                        </div>
                    </div>
                `;
                
                // Â≠òÂÇ®ÂéüÂßãÊï∞ÊçÆÁî®‰∫éÊêúÁ¥¢ÂíåÊéíÂ∫è
                window.csvData = {
                    headers: headers,
                    originalData: csvRows,
                    currentData: csvRows,
                    sortColumn: -1,
                    sortDirection: 'asc'
                };
                
            } else if (type === 'code') {
                // ÁâπÊÆäÂ§ÑÁêÜtxtÂíålogÊñá‰ª∂ÔºåÊèê‰æõÊõ¥Â•ΩÁöÑÈòÖËØª‰ΩìÈ™å
                if (language === 'text' || language === 'log') {
                    // ÂÖàÂ§ÑÁêÜËΩ¨‰πâÂ≠óÁ¨¶ÔºåÂÜçËøõË°åHTMLËΩ¨‰πâ
                    const processedContent = escapeHtml(processFileContent(content));
                    previewContent.innerHTML = `
                        <div style="background: #f8f8f8; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 12px; color: #666;">
                            Êñá‰ª∂Â§ßÂ∞è: ${size} | Á±ªÂûã: ${language.toUpperCase()}
                        </div>
                        <div style="background: #1e1e1e; color: #cccccc; padding: 20px; border-radius: 5px; overflow: auto; font-size: 14px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word; font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; max-height: calc(90vh - 160px);">${processedContent}</div>
                    `;
                } else {
                    // ‰ΩøÁî®Prism.jsËøõË°åËØ≠Ê≥ïÈ´ò‰∫Æ
                    // ÂÖàÂ§ÑÁêÜËΩ¨‰πâÂ≠óÁ¨¶ÔºåÂÜçËøõË°åHTMLËΩ¨‰πâ
                    const processedContent = escapeHtml(processFileContent(content));
                    previewContent.innerHTML = `
                        <div style="background: #f8f8f8; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 12px; color: #666;">
                            Êñá‰ª∂Â§ßÂ∞è: ${size} | ËØ≠Ë®Ä: ${language}
                        </div>
                        <div style="max-height: calc(90vh - 160px); overflow: auto; border-radius: 5px;">
                            <pre class="language-${language}" style="margin: 0; font-size: 14px; line-height: 1.4;"><code class="language-${language}">${processedContent}</code></pre>
                        </div>
                    `;
                    
                    // Ëß¶ÂèëPrism.jsËØ≠Ê≥ïÈ´ò‰∫Æ
                    setTimeout(() => {
                        if (typeof Prism !== 'undefined') {
                            Prism.highlightAll();
                        }
                    }, 100);
                }
            } else if (type === 'image') {
                // Image file preview
                const { data: imageData, image_info } = data;
                const { width, height, format } = image_info;
                
                previewContent.innerHTML = `
                    <div style="background: #f8f8f8; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 12px; color: #666;">
                        Êñá‰ª∂Â§ßÂ∞è: ${size} | Á±ªÂûã: ÂõæÁâá (${format}) | Â∞∫ÂØ∏: ${width} √ó ${height}
                    </div>
                    <div style="text-align: center; padding: 20px; max-height: calc(90vh - 160px); overflow: auto;">
                        <img src="${imageData}" 
                             alt="${fileName}" 
                             style="max-width: 100%; max-height: calc(90vh - 200px); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); background: white; padding: 10px;"
                             onerror="this.style.display='none'; this.parentNode.innerHTML='<div style=&quot;color: red; padding: 40px;&quot;><i class=&quot;fas fa-exclamation-triangle&quot;></i><br/>ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•</div>';" />
                        <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                            <a href="/api/download-file/${file_path}" download style="padding: 8px 16px; background: #007acc; color: white; text-decoration: none; border-radius: 4px; font-size: 12px; display: flex; align-items: center; gap: 5px;">
                                <i class="fas fa-download"></i> ‰∏ãËΩΩÂõæÁâá
                            </a>
                            <button onclick="zoomImage()" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 5px;">
                                <i class="fas fa-search-plus"></i> ÊîæÂ§ßÊü•Áúã
                            </button>
                        </div>
                    </div>
                `;
            }
        }
        
        function zoomImage() {
            const img = previewContent.querySelector('img');
            if (!img) return;
            
            // Create fullscreen overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.9); z-index: 10000; display: flex; 
                align-items: center; justify-content: center; cursor: zoom-out;
            `;
            
            const fullImg = document.createElement('img');
            fullImg.src = img.src;
            fullImg.style.cssText = `
                max-width: 95%; max-height: 95%; object-fit: contain;
                border-radius: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            `;
            
            overlay.appendChild(fullImg);
            overlay.onclick = () => document.body.removeChild(overlay);
            
            document.body.appendChild(overlay);
        }

        function loadPDF(filePath) {
            if (typeof pdfjsLib === 'undefined') {
                document.getElementById('pdfContainer').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: red;">
                        <i class="fas fa-exclamation-triangle"></i> PDF.js Êú™Âä†ËΩΩÔºåÊó†Ê≥ïÈ¢ÑËßàPDFÊñá‰ª∂
                    </div>
                `;
                return;
            }

            const pdfUrl = `/api/pdf/${filePath}`;
            
            pdfjsLib.getDocument(pdfUrl).promise.then(function(pdf) {
                const container = document.getElementById('pdfContainer');
                container.innerHTML = '';
                
                // ÂàõÂª∫È°µÈù¢ÂØºËà™
                const nav = document.createElement('div');
                nav.style.cssText = 'background: #333; color: white; padding: 10px; text-align: center; position: sticky; top: 0; z-index: 10;';
                nav.innerHTML = `
                    <button onclick="previousPage()" style="margin-right: 10px; padding: 5px 10px; background: #007acc; color: white; border: none; border-radius: 3px; cursor: pointer;">‰∏ä‰∏ÄÈ°µ</button>
                    <span id="pageInfo">Á¨¨ 1 È°µÔºåÂÖ± ${pdf.numPages} È°µ</span>
                    <button onclick="nextPage()" style="margin-left: 10px; padding: 5px 10px; background: #007acc; color: white; border: none; border-radius: 3px; cursor: pointer;">‰∏ã‰∏ÄÈ°µ</button>
                    <a href="/api/download-file/${filePath}" download style="margin-left: 15px; padding: 5px 10px; background: #28a745; color: white; text-decoration: none; border-radius: 3px; font-size: 12px;">
                        <i class="fas fa-download"></i> ‰∏ãËΩΩPDF
                    </a>
                `;
                container.appendChild(nav);
                
                // ÂàõÂª∫È°µÈù¢ÂÆπÂô®
                const pagesContainer = document.createElement('div');
                pagesContainer.id = 'pdfPages';
                pagesContainer.style.cssText = 'padding: 20px; text-align: center;';
                container.appendChild(pagesContainer);
                
                // Â≠òÂÇ®PDFÂØπË±°ÂíåÂΩìÂâçÈ°µÁ†Å
                window.currentPDF = pdf;
                window.currentPage = 1;
                
                // Ê∏≤ÊüìÁ¨¨‰∏ÄÈ°µ
                renderPDFPage(1);
                
            }).catch(function(error) {
                console.error('PDFÂä†ËΩΩÂ§±Ë¥•:', error);
                document.getElementById('pdfContainer').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: red;">
                        <i class="fas fa-exclamation-triangle"></i> PDFÂä†ËΩΩÂ§±Ë¥•: ${error.message}
                    </div>
                `;
            });
        }

        function renderPDFPage(pageNum) {
            if (!window.currentPDF) return;
            
            window.currentPDF.getPage(pageNum).then(function(page) {
                const scale = 1.5;
                const viewport = page.getViewport({ scale: scale });
                
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                canvas.style.cssText = 'max-width: 100%; height: auto; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 20px;';
                
                const renderContext = {
                    canvasContext: context,
                    viewport: viewport
                };
                
                const pagesContainer = document.getElementById('pdfPages');
                pagesContainer.innerHTML = '';
                pagesContainer.appendChild(canvas);
                
                page.render(renderContext);
                
                // Êõ¥Êñ∞È°µÈù¢‰ø°ÊÅØ
                document.getElementById('pageInfo').textContent = I18N.page_info.replace('{0}', pageNum).replace('{1}', window.currentPDF.numPages);
            });
        }

        function previousPage() {
            if (window.currentPage > 1) {
                window.currentPage--;
                renderPDFPage(window.currentPage);
            }
        }

        function nextPage() {
            if (window.currentPage < window.currentPDF.numPages) {
                window.currentPage++;
                renderPDFPage(window.currentPage);
            }
        }

        // OfficeÊñáÊ°£È¢ÑËßàÂáΩÊï∞
        function previewOfficeCloud(filePath) {
            // ‰∫ëÂ≠òÂÇ®È¢ÑËßà - ÂÖà‰∏ä‰º†Âà∞‰∫ëÂ≠òÂÇ®ÔºåÂÜç‰ΩøÁî®Âú®Á∫øÈ¢ÑËßàÊúçÂä°
            const container = document.getElementById('officeContainer');
            
            // ÊòæÁ§∫‰∏ä‰º†ËøõÂ∫¶
            container.innerHTML = `
                <div style="background: #28a745; color: white; padding: 10px; text-align: center; position: sticky; top: 0; z-index: 10;">
                    <span>‰∫ëÂ≠òÂÇ®È¢ÑËßà</span>
                    <button onclick="resetOfficePreview()" style="float: right; padding: 5px 10px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 3px; cursor: pointer;">ËøîÂõû</button>
                </div>
                <div style="text-align: center; padding: 40px; color: #666;">
                    <div style="margin-bottom: 20px;">
                        <i class="fas fa-cloud-upload-alt fa-spin" style="font-size: 48px; color: #28a745;"></i>
                    </div>
                    <h3 style="margin-bottom: 20px;">Ê≠£Âú®‰∏ä‰º†Êñá‰ª∂Âà∞‰∫ëÂ≠òÂÇ®...</h3>
                    <p style="margin-bottom: 20px; color: #666;">ËØ∑Á®çÂÄôÔºåÊñá‰ª∂‰∏ä‰º†ÂÆåÊàêÂêéÂ∞ÜËá™Âä®ÂºÄÂßãÈ¢ÑËßà</p>
                    <div style="background: #e9ecef; border-radius: 10px; height: 20px; overflow: hidden; margin: 20px auto; max-width: 400px;">
                        <div id="uploadProgress" style="background: #28a745; height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                    </div>
                    <div id="uploadStatus" style="font-size: 14px; color: #666;">ÂáÜÂ§á‰∏ä‰º†...</div>
                </div>
            `;
            
            // Ê®°ÊãüËøõÂ∫¶Êù°
            let progress = 0;
            const progressBar = document.getElementById('uploadProgress');
            const statusText = document.getElementById('uploadStatus');
            
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 90) progress = 90;
                progressBar.style.width = progress + '%';
                statusText.textContent = `‰∏ä‰º†ËøõÂ∫¶: ${Math.round(progress)}%`;
            }, 200);
            
            // ‰∏ä‰º†Êñá‰ª∂Âà∞‰∫ëÂ≠òÂÇ®
            const headers = {};
            if (currentUser && currentUser !== 'default') {
                headers['X-API-Key'] = currentUser;
            }
            
            fetch(`/api/upload-to-cloud/${filePath}`, {
                headers: headers
            })
                .then(response => response.json())
                .then(data => {
                    clearInterval(progressInterval);
                    progressBar.style.width = '100%';
                    statusText.textContent = '‰∏ä‰º†ÂÆåÊàêÔºÅ';
                    
                    if (data.success) {
                        // ‰∏ä‰º†ÊàêÂäüÔºå‰ΩøÁî®‰∫ëURLËøõË°åÈ¢ÑËßà
                        setTimeout(() => {
                            const cloudUrl = data.cloud_url;
                            const serviceName = data.service;
                            const expires = data.expires;
                            
                            // ÈÄâÊã©ÂêàÈÄÇÁöÑÈ¢ÑËßàÊúçÂä°
                            let previewUrl;
                            if (serviceName === 'Local Test') {
                                // Êú¨Âú∞ÊµãËØïÊ®°ÂºèÔºöÊòæÁ§∫ÊèêÁ§∫‰ø°ÊÅØËÄå‰∏çÊòØÈ¢ÑËßà
                                container.innerHTML = `
                                    <div style="background: #28a745; color: white; padding: 10px; text-align: center; position: sticky; top: 0; z-index: 10;">
                                        <span>‰∫ëÂ≠òÂÇ®È¢ÑËßà (${serviceName}) - ${expires}</span>
                                        <button onclick="resetOfficePreview()" style="float: right; padding: 5px 10px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 3px; cursor: pointer;">ËøîÂõû</button>
                                    </div>
                                    <div style="text-align: center; padding: 40px; color: #666;">
                                        <i class="fas fa-check-circle" style="font-size: 48px; margin-bottom: 20px; color: #28a745;"></i>
                                        <h3 style="margin-bottom: 20px; color: #28a745;">‰∫ëÂ≠òÂÇ®‰∏ä‰º†ÊàêÂäüÔºÅ</h3>
                                        <p style="margin-bottom: 20px;">Êñá‰ª∂Â∑≤ÊàêÂäü"‰∏ä‰º†"Âà∞Êú¨Âú∞ÊµãËØïÊúçÂä°</p>
                                        <div style="background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 20px; margin: 20px auto; border-radius: 5px; max-width: 600px; text-align: left;">
                                            <h4 style="margin-bottom: 15px;"><i class="fas fa-info-circle"></i> ÊµãËØïÊ®°ÂºèËØ¥Êòé</h4>
                                            <ul style="margin: 0; padding-left: 20px;">
                                                <li><strong>ÂΩìÂâç‰∏∫Êú¨Âú∞ÊµãËØïÊ®°Âºè</strong>ÔºöÊ®°Êãü‰∫ëÂ≠òÂÇ®‰∏ä‰º†ÊàêÂäü</li>
                                                <li><strong>ÂÆûÈôÖÈÉ®ÁΩ≤Êó∂</strong>ÔºöÊñá‰ª∂‰ºö‰∏ä‰º†Âà∞ÁúüÂÆûÁöÑ‰∫ëÂ≠òÂÇ®ÊúçÂä°</li>
                                                <li><strong>È¢ÑËßàÂäüËÉΩ</strong>Ôºö‰∫ëÂ≠òÂÇ®ÁöÑÊñá‰ª∂ÂèØ‰ª•ÈÄöËøáGoogle DocsÁ≠âÊúçÂä°È¢ÑËßà</li>
                                                <li><strong>ÁΩëÁªúË¶ÅÊ±Ç</strong>ÔºöÈúÄË¶ÅÂ§ñÁΩëËÆøÈóÆÊâçËÉΩ‰ΩøÁî®Âú®Á∫øÈ¢ÑËßàÊúçÂä°</li>
                                            </ul>
                                        </div>
                                        <div style="display: flex; flex-direction: column; gap: 15px; align-items: center; margin-top: 30px;">
                                            <a href="${cloudUrl}" target="_blank" style="padding: 12px 24px; background: #007acc; color: white; text-decoration: none; border-radius: 5px; font-size: 14px; min-width: 200px; text-align: center; display: inline-block;">
                                                <i class="fas fa-external-link-alt"></i> Âú®Êñ∞Á™óÂè£‰∏≠ÊâìÂºÄÊñá‰ª∂
                                            </a>
                                            <button onclick="resetOfficePreview()" style="padding: 12px 24px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; min-width: 200px;">
                                                <i class="fas fa-arrow-left"></i> ËøîÂõûÈáçÊñ∞ÈÄâÊã©
                                            </button>
                                        </div>
                                    </div>
                                `;
                                return; // Áõ¥Êé•ËøîÂõûÔºå‰∏çÁªßÁª≠ÊâßË°åiframeÈ¢ÑËßàÈÄªËæë
                            } else if (serviceName === 'File.io' || serviceName === '0x0.st' || serviceName === 'tmpfiles.org') {
                                // ‰ΩøÁî®WPSÂú®Á∫øÈ¢ÑËßà‰∫ëÂ≠òÂÇ®ÁöÑÊñá‰ª∂
                                previewUrl = `https://wwo.wps.cn/office/w?url=${encodeURIComponent(cloudUrl)}`;
                            } else {
                                previewUrl = cloudUrl;
                            }
                            
                            container.innerHTML = `
                                <div style="background: #28a745; color: white; padding: 10px; text-align: center; position: sticky; top: 0; z-index: 10;">
                                    <span>WPS‰∫ëÈ¢ÑËßà (${serviceName}) - ÊúâÊïàÊúü: ${expires}</span>
                                    <button onclick="resetOfficePreview()" style="float: right; padding: 5px 10px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 3px; cursor: pointer;">ËøîÂõû</button>
                                </div>
                                <iframe src="${previewUrl}" style="width: 100%; height: calc(100% - 50px); border: none;" frameborder="0" onload="handleCloudPreviewLoad(this)" onerror="handleCloudPreviewError(this, '${serviceName}')">
                                    <div style="text-align: center; padding: 20px; color: red;">
                                        <i class="fas fa-exclamation-triangle"></i> 
                                        ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅiframeÔºåÊó†Ê≥ïÈ¢ÑËßàOfficeÊñáÊ°£
                                    </div>
                                </iframe>
                                <div style="background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 10px; margin: 10px; border-radius: 5px; font-size: 12px;">
                                    <i class="fas fa-info-circle"></i> 
                                    <strong>‰∫ëÂ≠òÂÇ®‰ø°ÊÅØ:</strong> Êñá‰ª∂Â∑≤‰∏ä‰º†Âà∞ ${serviceName}Ôºå‰ΩøÁî®WPSÂú®Á∫øÈ¢ÑËßàÔºåÈìæÊé•ÊúâÊïàÊúü‰∏∫ ${expires}„ÄÇ
                                    <a href="${cloudUrl}" target="_blank" style="color: #155724; margin-left: 10px;">
                                        <i class="fas fa-external-link-alt"></i> Áõ¥Êé•ËÆøÈóÆ‰∫ëÊñá‰ª∂
                                    </a>
                                </div>
                            `;
                        }, 1000);
                    } else {
                        // ‰∏ä‰º†Â§±Ë¥•
                        container.innerHTML = `
                            <div style="background: #28a745; color: white; padding: 10px; text-align: center; position: sticky; top: 0; z-index: 10;">
                                <span>‰∫ëÂ≠òÂÇ®È¢ÑËßà</span>
                                <button onclick="resetOfficePreview()" style="float: right; padding: 5px 10px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 3px; cursor: pointer;">ËøîÂõû</button>
                            </div>
                            <div style="text-align: center; padding: 40px; color: #666;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px; color: #dc3545;"></i>
                                <h3 style="margin-bottom: 20px; color: #dc3545;">‰∫ëÂ≠òÂÇ®‰∏ä‰º†Â§±Ë¥•</h3>
                                <p style="margin-bottom: 20px;">ÈîôËØØ‰ø°ÊÅØ: ${data.error}</p>
                                <div style="display: flex; flex-direction: column; gap: 15px; align-items: center;">
                                    <button onclick="previewOfficeCloud('${filePath}')" style="padding: 12px 24px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; min-width: 200px;">
                                        <i class="fas fa-redo"></i> ÈáçËØï‰∏ä‰º†
                                    </button>
                                    <button onclick="resetOfficePreview()" style="padding: 12px 24px; background: #007acc; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; min-width: 200px;">
                                        <i class="fas fa-arrow-left"></i> ËøîÂõûÈáçÊñ∞ÈÄâÊã©
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    clearInterval(progressInterval);
                    console.error('‰∫ëÂ≠òÂÇ®‰∏ä‰º†Â§±Ë¥•:', error);
                    container.innerHTML = `
                        <div style="background: #28a745; color: white; padding: 10px; text-align: center; position: sticky; top: 0; z-index: 10;">
                            <span>‰∫ëÂ≠òÂÇ®È¢ÑËßà</span>
                            <button onclick="resetOfficePreview()" style="float: right; padding: 5px 10px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 3px; cursor: pointer;">ËøîÂõû</button>
                        </div>
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px; color: #dc3545;"></i>
                            <h3 style="margin-bottom: 20px; color: #dc3545;">ÁΩëÁªúÈîôËØØ</h3>
                            <p style="margin-bottom: 20px;">Êó†Ê≥ïËøûÊé•Âà∞‰∫ëÂ≠òÂÇ®ÊúçÂä°ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•</p>
                            <div style="display: flex; flex-direction: column; gap: 15px; align-items: center;">
                                <button onclick="previewOfficeCloud('${filePath}')" style="padding: 12px 24px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; min-width: 200px;">
                                    <i class="fas fa-redo"></i> ÈáçËØï‰∏ä‰º†
                                </button>
                                <button onclick="resetOfficePreview()" style="padding: 12px 24px; background: #007acc; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; min-width: 200px;">
                                    <i class="fas fa-arrow-left"></i> ËøîÂõûÈáçÊñ∞ÈÄâÊã©
                                </button>
                            </div>
                        </div>
                    `;
                });
        }



        // ÈáçÁΩÆOfficeÈ¢ÑËßàÁïåÈù¢
        function resetOfficePreview() {
            const container = document.getElementById('officeContainer');
            if (container) {
                // ÈáçÊñ∞ÊòæÁ§∫ÈÄâÊã©ÁïåÈù¢
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-file-alt" style="font-size: 48px; margin-bottom: 20px; color: #007acc;"></i>
                        <h3 style="margin-bottom: 20px;">OfficeÊñáÊ°£È¢ÑËßà</h3>
                        <p style="margin-bottom: 20px;">ÈÄâÊã©‰ª•‰∏ãÊñπÂºèÈ¢ÑËßàOfficeÊñáÊ°£Ôºö</p>
                        <div style="display: flex; flex-direction: column; gap: 15px; align-items: center;">
                            <button onclick="previewOfficeCloud('${currentFilePath}')" style="padding: 12px 24px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; min-width: 200px;">
                                <i class="fas fa-cloud-upload-alt"></i> ‰∫ëÂ≠òÂÇ®È¢ÑËßà
                            </button>
                            <a href="/api/download-file/${currentFilePath}" download style="padding: 12px 24px; background: #6c757d; color: white; text-decoration: none; border-radius: 5px; font-size: 14px; min-width: 200px; text-align: center; display: inline-block;">
                                <i class="fas fa-download"></i> ‰∏ãËΩΩÊñá‰ª∂
                            </a>
                        </div>
                    </div>
                `;
            }
        }

        // Â§ÑÁêÜ‰∫ëÈ¢ÑËßàÂä†ËΩΩÊàêÂäü
        function handleCloudPreviewLoad(iframe) {
            console.log('‚úÖ Cloud preview loaded successfully');
            // ÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†Âä†ËΩΩÊàêÂäüÁöÑÂ§ÑÁêÜÈÄªËæë
        }

        // Â§ÑÁêÜ‰∫ëÈ¢ÑËßàÂä†ËΩΩÈîôËØØ
        function handleCloudPreviewError(iframe, serviceName) {
            console.error(`‚ùå Cloud preview (${serviceName}) failed to load`);
            const container = iframe.parentElement;
            container.innerHTML = `
                <div style="background: #28a745; color: white; padding: 10px; text-align: center; position: sticky; top: 0; z-index: 10;">
                    <span>‰∫ëÂ≠òÂÇ®È¢ÑËßà</span>
                    <button onclick="resetOfficePreview()" style="float: right; padding: 5px 10px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 3px; cursor: pointer;">ËøîÂõû</button>
                </div>
                <div style="text-align: center; padding: 40px; color: #666;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px; color: #dc3545;"></i>
                    <h3 style="margin-bottom: 20px; color: #dc3545;">‰∫ëÈ¢ÑËßàÂ§±Ë¥•</h3>
                    <p style="margin-bottom: 20px;">Êñá‰ª∂Â∑≤ÊàêÂäü‰∏ä‰º†Âà∞ ${serviceName}Ôºå‰ΩÜÈ¢ÑËßàÊúçÂä°Êó†Ê≥ïÂä†ËΩΩ</p>
                    <div style="display: flex; flex-direction: column; gap: 15px; align-items: center;">
                        <button onclick="resetOfficePreview()" style="padding: 12px 24px; background: #007acc; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; min-width: 200px;">
                            <i class="fas fa-arrow-left"></i> ËøîÂõûÈáçÊñ∞ÈÄâÊã©
                        </button>
                        <a href="/api/download-file/${currentFilePath}" download style="padding: 12px 24px; background: #28a745; color: white; text-decoration: none; border-radius: 5px; font-size: 14px; min-width: 200px; text-align: center; display: inline-block;">
                            <i class="fas fa-download"></i> ‰∏ãËΩΩÊñá‰ª∂
                        </a>
                    </div>
                </div>
            `;
        }

        // Â≠òÂÇ®ÂΩìÂâçÊñá‰ª∂Ë∑ØÂæÑÔºåÁî®‰∫éËøîÂõûÊó∂ÈáçÊñ∞ÊûÑÂª∫ÁïåÈù¢
        let currentFilePath = '';

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Â§ÑÁêÜÊñá‰ª∂ÂÜÖÂÆπ‰∏≠ÁöÑËΩ¨‰πâÂ≠óÁ¨¶
        function processFileContent(content) {
            return content
                .replace(/\\n/g, '\n')      // Êç¢Ë°åÁ¨¶
                .replace(/\\t/g, '\t')      // Âà∂Ë°®Á¨¶
                .replace(/\\r/g, '\r')      // ÂõûËΩ¶Á¨¶
                .replace(/\\\\/g, '\\');    // ÂèçÊñúÊù†
        }

        // ÂÖ≥Èó≠È¢ÑËßàÊ®°ÊÄÅÊ°Ü
        previewClose.onclick = function() {
            previewModal.style.display = 'none';
        }



        // ÈáçÂëΩÂêçÂäüËÉΩ
        const renameModal = document.getElementById('renameModal');
        const renameClose = document.getElementById('renameClose');
        const currentDirName = document.getElementById('currentDirName');
        const newDirName = document.getElementById('newDirName');
        const renameConfirm = document.getElementById('renameConfirm');
        const renameCancel = document.getElementById('renameCancel');
        
        let currentRenamingDir = null;

        function showRenameDialog(dirName) {
            currentRenamingDir = dirName;
            currentDirName.textContent = dirName;
            newDirName.value = dirName; // Áõ¥Êé•‰ΩøÁî®ÂéüÂêçÁß∞Ôºå‰∏çÂÅö‰ªª‰ΩïÂ§ÑÁêÜ
            newDirName.focus();
            newDirName.select();
            renameModal.style.display = 'block';
        }

        function hideRenameDialog() {
            renameModal.style.display = 'none';
            currentRenamingDir = null;
            newDirName.value = '';
        }

        function performRename() {
            if (!currentRenamingDir) return;
            
            const newName = newDirName.value.trim();
            if (!newName) {
                alert('ËØ∑ËæìÂÖ•Êñ∞ÁöÑÁõÆÂΩïÂêçÁß∞');
                return;
            }
            
            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            renameConfirm.disabled = true;
            renameConfirm.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${I18N.renaming}`;
            
            const headers = {
                'Content-Type': 'application/json'
            };
            
            const body = {
                new_name: newName
            };
            
            if (currentUser && currentUser !== 'default') {
                headers['X-API-Key'] = currentUser;
                body.api_key = currentUser;
            }
            
            fetch(`/api/rename-directory/${encodeURIComponent(currentRenamingDir)}`, {
                method: 'PUT',
                headers: headers,
                body: JSON.stringify(body)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addMessage(data.message, 'success');
                    
                    // Êõ¥Êñ∞ÂâçÁ´ØÁä∂ÊÄÅ
                    if (selectedDirectory === currentRenamingDir) {
                        selectedDirectory = data.new_name;
                        updateTaskModeInfo();
                    }
                    
                    // Âà∑Êñ∞ÁõÆÂΩïÂàóË°®
                    refreshDirectories();
                    hideRenameDialog();
                } else {
                    addMessage(`${I18N.rename_failed}: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('‚ùå Rename error:', error);
                addMessage(`${I18N.rename_error}: ${error.message}`, 'error');
            })
            .finally(() => {
                // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                renameConfirm.disabled = false;
                renameConfirm.innerHTML = `<i class="fas fa-check"></i> ${I18N.confirm_rename}`;
            });
        }

        // ÈáçÂëΩÂêç‰∫ã‰ª∂ÁõëÂê¨
        renameConfirm.onclick = performRename;
        renameCancel.onclick = hideRenameDialog;
        renameClose.onclick = hideRenameDialog;

        newDirName.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                performRename();
            } else if (e.key === 'Escape') {
                e.preventDefault();
                hideRenameDialog();
            }
        });

        window.onclick = function(event) {
            if (event.target === previewModal) {
                previewModal.style.display = 'none';
            }
            if (event.target === uploadModal) {
                uploadModal.style.display = 'none';
            }

            if (event.target === renameModal) {
                hideRenameDialog();
            }
        }

        // ÈîÆÁõòÂø´Êç∑ÈîÆ
        document.addEventListener('keydown', function(e) {
            // Ctrl+R Êàñ F5 Âà∑Êñ∞ÁõÆÂΩï
            if ((e.ctrlKey && e.key === 'r') || e.key === 'F5') {
                e.preventDefault();
                manualRefresh();
            }
            
            // Esc ÈîÆÂÖ≥Èó≠È¢ÑËßàÊ®°ÊÄÅÊ°Ü
            if (e.key === 'Escape' && previewModal.style.display === 'block') {
                previewModal.style.display = 'none';
            }
            
            // End ÈîÆÊªöÂä®Âà∞Â∫ïÈÉ®
            if (e.key === 'End' && e.target === chatMessages) {
                e.preventDefault();
                scrollToBottom(true);
            }
            
            // Ctrl+End Âº∫Âà∂ÊªöÂä®Âà∞Â∫ïÈÉ®Âπ∂ÂêØÁî®Ëá™Âä®ÊªöÂä®
            if (e.ctrlKey && e.key === 'End') {
                e.preventDefault();
                scrollToBottom(true);
            }
        });

        /**
         * È°µÈù¢ÂàùÂßãÂåñÂáΩÊï∞
         * @description È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÊâßË°åÁöÑÂàùÂßãÂåñÊìç‰ΩúÔºö
         * - ÂàùÂßãÂåñÁî®Êà∑ÁïåÈù¢Áä∂ÊÄÅ
         * - ËÆæÁΩÆËæìÂÖ•Ê°ÜÁÑ¶ÁÇπ
         * - Êõ¥Êñ∞‰ªªÂä°Ê®°Âºè‰ø°ÊÅØ
         * - ÂàùÂßãÂåñÂàÜÈöîÊù°ÊãñÊãΩÂäüËÉΩ
         * - ÂêØÂä®Ëá™Âä®Âà∑Êñ∞ÂÆöÊó∂Âô®
         * - ÊªöÂä®Âà∞ËÅäÂ§©Á™óÂè£Â∫ïÈÉ®
         */
        document.addEventListener('DOMContentLoaded', function() {
            // ÂàùÂßãÂåñÁî®Êà∑Áä∂ÊÄÅ
            updateUserStatus('disconnected', I18N.user_disconnected);
            enableUI(false);
            
            // Ê£ÄÊü•URLÂèÇÊï∞Âπ∂Ëá™Âä®ÁôªÂΩïÔºà‰ºòÂÖàÁ∫ßÊúÄÈ´òÔºâ
            const urlAutoLogin = checkUrlAutoLogin();
            
            // Â¶ÇÊûúÊ≤°ÊúâURLÂèÇÊï∞ÔºåÊ£ÄÊü•localStorage‰∏≠ÁöÑ‰øùÂ≠ò‰ºöËØù
            if (!urlAutoLogin) {
                const sessionRestored = checkSessionRestore();
                
                // Âè™ÊúâÂú®Ê≤°ÊúâËá™Âä®ÁôªÂΩïÂíå‰ºöËØùÊÅ¢Â§çÊó∂ÊâçËÆæÁΩÆËæìÂÖ•Ê°ÜÁÑ¶ÁÇπ
                if (!sessionRestored && !isConnected) {
                    setTimeout(() => {
                        apiKeyInput.focus();
                    }, 100);
                }
            }
            
            updateTaskModeInfo();
            initResizer();
            
            // ËÆæÁΩÆGUIÈÖçÁΩÆÈÄâÈ°πÁöÑÈªòËÆ§ÂÄº
            document.getElementById('enableWebSearch').checked = false;      // ÊêúÁ¥¢ÁΩëÁªúÈªòËÆ§‰∏çÈÄâÊã©
            document.getElementById('enableKnowledgeBase').checked = true;   // ÊêúÁ¥¢Áü•ËØÜÂ∫ìÈªòËÆ§ÈÄâÊã©
            
            document.getElementById('enableMultiAgent').checked = false;     // ÂêØÂä®Â§öÊô∫ËÉΩ‰ΩìÈªòËÆ§‰∏çÈÄâÊã©
            document.getElementById('enableLongTermMemory').checked = true;  // ÂêØÂä®ÈïøÊúüËÆ∞ÂøÜÈªòËÆ§ÈÄâÊã©
            document.getElementById('enableMCP').checked = false;            // ÂêØÂä®MCPÈªòËÆ§‰∏çÈÄâÊã©
            document.getElementById('enableJieba').checked = true;           // ÂêØÁî®‰∏≠ÊñáÂàÜËØçÈªòËÆ§ÈÄâÊã©
            
            // Ëá™Âä®‰ª•GuestË∫´‰ªΩËøûÊé• (‰∏¥Êó∂Á¶ÅÁî®Áî®‰∫éË∞ÉËØï)
            console.log('üîç Page loaded, auto-connect disabled for debugging');
            // connectUser();
            
            // ÂàùÂßãÂåñÈÖçÁΩÆÈÄâÈ°πÂàáÊç¢ÂäüËÉΩ
            initConfigToggle();
            
            // ÂàùÂßãÂåñÊó∂ÊªöÂä®Âà∞Â∫ïÈÉ®ÔºàÂª∂Ëøü100msÁ°Æ‰øùDOMÊ∏≤ÊüìÂÆåÊàêÔºâ
            setTimeout(() => {
                scrollToBottom(false);
            }, 100);
        });

        /**
         * ÂàùÂßãÂåñÈÖçÁΩÆÈÄâÈ°πÂàáÊç¢ÂäüËÉΩ
         */
        function initConfigToggle() {
            const toggleBtn = document.getElementById('configToggleBtn');
            const configContainer = document.getElementById('configContainer');
            const toggleIcon = document.getElementById('configToggleIcon');
            
            let isConfigVisible = false;
            
            toggleBtn.addEventListener('click', function() {
                isConfigVisible = !isConfigVisible;
                
                if (isConfigVisible) {
                    configContainer.style.display = 'block';
                    toggleBtn.style.backgroundColor = '#569cd6';
                    toggleBtn.title = I18N.hide_config_options || 'ÈöêËóèÈÖçÁΩÆÈÄâÈ°π';
                    toggleIcon.style.transform = 'rotate(180deg)';
                } else {
                    configContainer.style.display = 'none';
                    toggleBtn.style.backgroundColor = '#3e3e42';
                    toggleBtn.title = I18N.show_config_options || 'ÊòæÁ§∫ÈÖçÁΩÆÈÄâÈ°π';
                    toggleIcon.style.transform = 'rotate(0deg)';
                }
            });
            
            // ËÆæÁΩÆÂõæÊ†áËøáÊ∏°ÊïàÊûú
            toggleIcon.style.transition = 'transform 0.3s ease';
        }

        /**
         * Ëá™Âä®Âà∑Êñ∞ÂäüËÉΩÂ∑≤Á¶ÅÁî®
         * @description ÂéüÊúâÁöÑËá™Âä®Âà∑Êñ∞ÂÆöÊó∂Âô®ÂäüËÉΩÂ∑≤Ë¢´ÁßªÈô§ÔºåÂè™‰øùÁïôÊâãÂä®Âà∑Êñ∞
         * - Áî®Êà∑ÂèØ‰ª•ÈÄöËøáÁÇπÂáªÂà∑Êñ∞ÊåâÈíÆÊâãÂä®Âà∑Êñ∞ÁõÆÂΩïÂàóË°®
         */
        
        // Ëá™Âä®Âà∑Êñ∞Áõ∏ÂÖ≥‰ª£Á†ÅÂ∑≤Á¶ÅÁî®
        /*
        let autoRefreshInterval = null;
        function startAutoRefresh() {
            // Â¶ÇÊûúÂ∑≤ÁªèÊúâÂÆöÊó∂Âô®Âú®ËøêË°åÔºåÂÖàÊ∏ÖÈô§ÂÆÉ
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            // ÊØè5ÁßíËá™Âä®Âà∑Êñ∞‰∏ÄÊ¨°ÁõÆÂΩïÂàóË°®
            autoRefreshInterval = setInterval(() => {
                refreshDirectories();
            }, 5000);
            console.log('‚úÖ Auto-refresh started: refreshing directories every 5 seconds');
        }
        
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                console.log('üõë Auto-refresh stopped');
            }
        }
        */

        // ÂàÜÈöîÊù°ÊãñÊãΩÂäüËÉΩ
        function initResizer() {
            const resizer = document.getElementById('resizer');
            const sidebar = document.getElementById('sidebar');
            const container = document.querySelector('.container');
            let isResizing = false;
            let startX = 0;
            let startWidth = 0;

            resizer.addEventListener('mousedown', function(e) {
                e.preventDefault();
                isResizing = true;
                startX = e.clientX;
                startWidth = parseInt(document.defaultView.getComputedStyle(sidebar).width, 10);
                
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
                
                // Ê∑ªÂä†ËßÜËßâÂèçÈ¶à
                resizer.style.background = '#007acc';
            });

            function handleMouseMove(e) {
                if (!isResizing) return;
                e.preventDefault();
                
                const dx = startX - e.clientX; // ÂêëÂ∑¶ÊãñÊãΩ‰∏∫Ê≠£ÂÄº
                const newWidth = startWidth + dx;
                
                // ÈôêÂà∂‰æßËæπÊ†èÂÆΩÂ∫¶
                const minWidth = 250;
                const maxWidth = 600;
                const constrainedWidth = Math.max(minWidth, Math.min(maxWidth, newWidth));
                
                sidebar.style.width = constrainedWidth + 'px';
            }

            function handleMouseUp(e) {
                if (!isResizing) return;
                e.preventDefault();
                
                isResizing = false;
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
                
                // ÁßªÈô§ËßÜËßâÂèçÈ¶à
                resizer.style.background = '';
            }
        }

        // ÊâãÂä®Âà∑Êñ∞ÁõÆÂΩï
        function manualRefresh() {
            const refreshBtn = document.querySelector('.sidebar-header .action-btn');
            const icon = refreshBtn.querySelector('i');
            
            // Ê∑ªÂä†ÊóãËΩ¨Âä®Áîª
            icon.classList.add('fa-spin');
            refreshBtn.disabled = true;
            
            // ‰øùÂ≠òÂΩìÂâçÂ±ïÂºÄÁä∂ÊÄÅ
            const currentExpanded = new Set(expandedDirectories);
            
            const headers = {
                'Content-Type': 'application/json'
            };
            
            const body = {};
            if (currentUser && currentUser !== 'default') {
                headers['X-API-Key'] = currentUser;
                body.api_key = currentUser;
            }
            
            fetch('/api/refresh-dirs', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(body)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // ÊÅ¢Â§çÂ±ïÂºÄÁä∂ÊÄÅ
                    expandedDirectories = currentExpanded;
                    renderDirectories(data.directories);
                    // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØÔºàÊõ¥ÁÆÄÊ¥ÅÔºâ
                    console.log('Directory refreshed');
                } else {
                    addMessage(`${I18N.refresh_failed}: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                addMessage(`${I18N.refresh_failed}: ${error.message}`, 'error');
            })
            .finally(() => {
                // ÁßªÈô§ÊóãËΩ¨Âä®Áîª
                icon.classList.remove('fa-spin');
                refreshBtn.disabled = false;
            });
        }

        // ‰∏ä‰º†ÂäüËÉΩ
        function showUploadModal(dirName) {
            currentUploadDir = dirName;
            uploadTitle.textContent = `${I18N.upload_to} ${dirName}${I18N.workspace}`;
            uploadResult.innerHTML = '';
            uploadProgress.style.display = 'none';
            progressFill.style.width = '0%';
            uploadModal.style.display = 'block';
        }

        // ÂÖ≥Èó≠‰∏ä‰º†Ê®°ÊÄÅÊ°Ü
        uploadClose.onclick = function() {
            uploadModal.style.display = 'none';
        }

        // Êñá‰ª∂ÈÄâÊã©Â§ÑÁêÜ
        fileInput.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                uploadFiles(Array.from(e.target.files));
            }
        });

        // ÊãñÊãΩÂäüËÉΩ
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = Array.from(e.dataTransfer.files);
            if (files.length > 0) {
                uploadFiles(files);
            }
        });

        // ‰∏ä‰º†Êñá‰ª∂ÂáΩÊï∞
        function uploadFiles(files) {
            if (!currentUploadDir) {
                uploadResult.innerHTML = `<div class="error">${I18N.select_directory_error}</div>`;
                return;
            }

            const formData = new FormData();
            files.forEach(file => {
                formData.append('files', file);
            });
            
            // Add API key to form data
            if (currentUser && currentUser !== 'default') {
                formData.append('api_key', currentUser);
            }

            // ÊòæÁ§∫ËøõÂ∫¶Êù°
            uploadProgress.style.display = 'block';
            uploadResult.innerHTML = '';
            progressText.textContent = I18N.uploading_files.replace('{0}', files.length);

            // ÂàõÂª∫XMLHttpRequest‰ª•ÊîØÊåÅËøõÂ∫¶ÁõëÊéß
            const xhr = new XMLHttpRequest();
            
            xhr.upload.addEventListener('progress', function(e) {
                if (e.lengthComputable) {
                    const percentComplete = (e.loaded / e.total) * 100;
                    progressFill.style.width = percentComplete + '%';
                    progressText.textContent = I18N.upload_progress.replace('{0}', Math.round(percentComplete));
                }
            });

            xhr.addEventListener('load', function() {
                uploadProgress.style.display = 'none';
                
                if (xhr.status === 200) {
                    const response = JSON.parse(xhr.responseText);
                    if (response.success) {
                        uploadResult.innerHTML = `
                            <div class="success">
                                <i class="fas fa-check-circle"></i> ${response.message}
                                <br><small>Êñá‰ª∂: ${response.files.join(', ')}</small>
                            </div>
                        `;
                        // Ê∏ÖÁ©∫Êñá‰ª∂ËæìÂÖ•
                        fileInput.value = '';
                        // Âà∑Êñ∞ÁõÆÂΩïÂàóË°®
                        setTimeout(() => {
                            refreshDirectories();
                        }, 1000);
                    } else {
                        uploadResult.innerHTML = `<div class="error"><i class="fas fa-exclamation-triangle"></i> ${response.error}</div>`;
                    }
                } else {
                    uploadResult.innerHTML = `<div class="error"><i class="fas fa-exclamation-triangle"></i> ${I18N.upload_failed_http.replace('{0}', xhr.status)}</div>`;
                }
            });

            xhr.addEventListener('error', function() {
                uploadProgress.style.display = 'none';
                uploadResult.innerHTML = `<div class="error"><i class="fas fa-exclamation-triangle"></i> ${I18N.upload_network_error}</div>`;
            });

            xhr.open('POST', `/api/upload/${currentUploadDir}`);
            xhr.send(formData);
        }

        // CSVË°®Ê†ºÁõ∏ÂÖ≥ÂäüËÉΩ
        function sortCSVTable(columnIndex) {
            if (!window.csvData) return;
            
            const { headers, currentData, sortColumn, sortDirection } = window.csvData;
            
            // Á°ÆÂÆöÊéíÂ∫èÊñπÂêë
            let newDirection = 'asc';
            if (sortColumn === columnIndex) {
                newDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            }
            
            // ÊéíÂ∫èÊï∞ÊçÆ
            const sortedData = [...currentData].sort((a, b) => {
                const aVal = (a[columnIndex] || '').toString().toLowerCase();
                const bVal = (b[columnIndex] || '').toString().toLowerCase();
                
                // Â∞ùËØïÊï∞Â≠óÊØîËæÉ
                const aNum = parseFloat(aVal);
                const bNum = parseFloat(bVal);
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return newDirection === 'asc' ? aNum - bNum : bNum - aNum;
                }
                
                // Â≠óÁ¨¶‰∏≤ÊØîËæÉ
                if (newDirection === 'asc') {
                    return aVal.localeCompare(bVal);
                } else {
                    return bVal.localeCompare(aVal);
                }
            });
            
            // Êõ¥Êñ∞Áä∂ÊÄÅ
            window.csvData.currentData = sortedData;
            window.csvData.sortColumn = columnIndex;
            window.csvData.sortDirection = newDirection;
            
            // ÈáçÊñ∞Ê∏≤ÊüìË°®Ê†º
            renderCSVTableBody(sortedData);
            
            // Êõ¥Êñ∞Ë°®Â§¥ÊéíÂ∫èÊåáÁ§∫Âô®
            updateSortIndicators(columnIndex, newDirection);
        }
        
        function updateSortIndicators(sortColumn, sortDirection) {
            const headers = document.querySelectorAll('#csvTable th');
            headers.forEach((th, index) => {
                const span = th.querySelector('span');
                if (span) {
                    if (index === sortColumn) {
                        span.textContent = sortDirection === 'asc' ? '‚Üë' : '‚Üì';
                        span.style.color = '#007acc';
                    } else {
                        span.textContent = '‚áÖ';
                        span.style.color = '#6c757d';
                    }
                }
            });
        }
        
        function renderCSVTableBody(data) {
            if (!window.csvData) return;
            
            const tbody = document.getElementById('csvTableBody');
            const { headers } = window.csvData;
            
            if (!tbody || !headers) return;
            
            let html = '';
            if (data && data.length > 0) {
                data.forEach((row, rowIndex) => {
                    const rowStyle = rowIndex % 2 === 0 ? 'background: #ffffff;' : 'background: #f8f9fa;';
                    html += `<tr style="${rowStyle}">`;
                    
                    const maxCols = Math.max(headers.length, row.length);
                    for (let i = 0; i < maxCols; i++) {
                        const cellValue = row[i] || '';
                        const escapedValue = escapeHtml(cellValue);
                        html += `<td style="border: 1px solid #dee2e6; padding: 8px; vertical-align: top; word-break: break-word; max-width: 300px; color: #333;" title="${escapedValue}">${escapedValue}</td>`;
                    }
                    html += '</tr>';
                });
            } else {
                html = `<tr><td colspan="${headers.length}" style="text-align: center; padding: 40px; color: #6c757d; font-style: italic;">Êó†ÂåπÈÖçÁªìÊûú</td></tr>`;
            }
            
            tbody.innerHTML = html;
        }
        
        function filterCSVTable() {
            if (!window.csvData) return;
            
            const searchInput = document.getElementById('csvSearchInput');
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            if (!searchTerm) {
                // ÊòæÁ§∫ÊâÄÊúâÊï∞ÊçÆ
                window.csvData.currentData = window.csvData.originalData;
                renderCSVTableBody(window.csvData.originalData);
                return;
            }
            
            // ËøáÊª§Êï∞ÊçÆ
            const filteredData = window.csvData.originalData.filter(row => {
                return row.some(cell => {
                    const cellValue = (cell || '').toString().toLowerCase();
                    return cellValue.includes(searchTerm);
                });
            });
            
            window.csvData.currentData = filteredData;
            renderCSVTableBody(filteredData);
        }
        
        function exportCSVTable() {
            if (!window.csvData) return;
            
            const { headers, currentData } = window.csvData;
            
            // ÂàõÂª∫CSVÂÜÖÂÆπ
            let csvContent = '';
            
            // Ê∑ªÂä†Ë°®Â§¥
            if (headers && headers.length > 0) {
                csvContent += headers.map(header => `"${(header || '').replace(/"/g, '""')}"`).join(',') + '\n';
            }
            
            // Ê∑ªÂä†Êï∞ÊçÆË°å
            currentData.forEach(row => {
                const csvRow = row.map(cell => {
                    const cellValue = (cell || '').toString();
                    return `"${cellValue.replace(/"/g, '""')}"`;
                }).join(',');
                csvContent += csvRow + '\n';
            });
            
            // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'exported_data.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                // ÂêéÂ§áÊñπÊ°àÔºöÊâìÂºÄÊñ∞Á™óÂè£ÊòæÁ§∫CSVÂÜÖÂÆπ
                const newWindow = window.open();
                newWindow.document.write('<pre>' + escapeHtml(csvContent) + '</pre>');
            }
        }

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÁöÑÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            updateTaskModeInfo(); // Á°Æ‰øù‰ªªÂä°Ê®°Âºè‰ø°ÊÅØÊ≠£Á°ÆÊòæÁ§∫
            updateAutoScrollIndicator(); // ÂàùÂßãÂåñËá™Âä®ÊªöÂä®Áä∂ÊÄÅÊåáÁ§∫Âô®
        });

    </script>
    
    <!-- Prism.js for syntax highlighting -->
    <script src="{{ url_for('static', filename='js/prism-core.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/prism-autoloader.min.js') }}"></script>
    <script>
        // Configure Prism.js autoloader
        Prism.plugins.autoloader.languages_path = '{{ url_for("static", filename="js/prism-components/") }}';
        
        // Configure PDF.js
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = '{{ url_for("static", filename="js/pdf.worker.min.js") }}';
        }
    </script>
</body>
</html> 