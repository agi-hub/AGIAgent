<!DOCTYPE html>
<html lang="{{ 'zh-CN' if lang == 'zh' else 'en' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ i18n.app_title.replace(' GUI', '') }}</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Prism.js for syntax highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1e1e1e;
            height: 100vh;
            overflow: hidden;
            color: #cccccc;
        }

        .container {
            display: flex;
            height: 100vh;
            background: #252526;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            min-width: 0;
            min-width: 400px;
        }

        #resizer {
            width: 5px;
            background: #3e3e42;
            cursor: col-resize;
            flex-shrink: 0;
            transition: all 0.2s ease;
            position: relative;
        }

        #resizer:hover {
            background: #569cd6;
            width: 6px;
        }

        #resizer:active {
            background: #007acc;
            width: 6px;
        }

        /* Add visual indicator when dragging */
        #resizer::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 2px;
            height: 30px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 1px;
            pointer-events: none;
            transition: all 0.2s ease;
        }

        #resizer:hover::before {
            background: rgba(255, 255, 255, 0.6);
            height: 40px;
        }

        .sidebar {
            width: 400px;
            background: #252526;
            border-left: 1px solid #3e3e42;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            text-align: center;
            margin-bottom: 15px;
            color: #cccccc;
        }

        .header h1 {
            font-size: 1.2em;
            font-weight: 700;
            margin-bottom: 0;
            color: #569cd6;
        }

        .header p {
            display: none;
        }

        .chat-container {
            flex: 1;
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .chat-header {
            background: #007acc;
            color: white;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #3e3e42;
        }

        .chat-header h3 {
            font-size: 0.95em;
            font-weight: 400;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4CAF50;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #1e1e1e;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 6px;
            max-width: 80%;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease-in;
            white-space: pre-wrap;
            overflow-wrap: break-word;
        }

        .message-text {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            white-space: pre-wrap;
            word-break: break-all;
            overflow-wrap: anywhere;
            line-height: 1.4;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            background: #0e639c;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 3px;
        }

        .message.system {
            background: #264f78;
            color: #9cdcfe;
            border-left: 3px solid #007acc;
            padding: 6px 8px !important;
            max-width: 95% !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
        }

        .message.info {
            background: #1a1a1a;
            color: #cccccc;
            border-left: 3px solid #569cd6;
        }

        .message.error {
            background: #5a1d1d;
            color: #f48771;
            border-left: 3px solid #f14c4c;
        }

        .message.success {
            background: #0f5132;
            color: #75b798;
            border-left: 3px solid #198754;
        }

        /* Tool execution message styles */
        .message.tool {
            background: #2d2d30;
            color: #cccccc;
            border-left: 3px solid #ffa500;
            border-radius: 8px;
            overflow: hidden;
            max-width: 100%;
        }

        .tool-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: rgba(255, 165, 0, 0.1);
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid rgba(255, 165, 0, 0.2);
        }

        .tool-header:hover {
            background: rgba(255, 165, 0, 0.15);
        }

        .tool-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .tool-icon {
            color: #ffa500;
            font-size: 16px;
        }

        .tool-name {
            font-weight: 600;
            color: #ffa500;
            font-size: 14px;
        }

        .tool-params {
            font-size: 12px;
            color: #9cdcfe;
            opacity: 0.8;
            margin-left: 8px;
        }

        .tool-toggle {
            color: #cccccc;
            font-size: 14px;
            transition: transform 0.2s ease;
        }

        .tool-toggle.expanded {
            transform: rotate(180deg);
        }

        .tool-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: #1e1e1e;
        }

        .tool-content.expanded {
            max-height: 500px;
            overflow-y: auto;
        }

        .tool-content-inner {
            padding: 16px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
            white-space: pre-wrap;
            word-break: break-all;
            color: #cccccc;
        }

        .tool-status {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 500;
            margin-left: 8px;
        }

        .tool-status.success {
            background: rgba(75, 181, 67, 0.2);
            color: #4bb543;
        }

        .tool-status.error {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
        }

        .tool-status.running {
            background: rgba(255, 165, 0, 0.2);
            color: #ffa500;
            animation: pulse 2s infinite;
        }

        .tool-status.success {
            background: rgba(75, 181, 67, 0.2);
            color: #4bb543;
        }

        .tool-status.error {
            background: rgba(244, 67, 54, 0.2);
            color: #f44336;
        }

        /* å·¥å…·è°ƒç”¨æ¶ˆæ¯æ ·å¼ */
        .message.function-call {
            background: #2d2d30;
            color: #cccccc;
            border-left: 3px solid #007acc;
            border-radius: 8px;
            overflow: hidden;
            max-width: 100%;
        }

        .function-call-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: rgba(0, 122, 204, 0.1);
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid rgba(0, 122, 204, 0.2);
        }

        .function-call-header:hover {
            background: rgba(0, 122, 204, 0.15);
        }

        .function-call-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .function-call-icon {
            color: #007acc;
            font-size: 16px;
        }

        .function-call-name {
            font-weight: 600;
            color: #007acc;
            font-size: 14px;
        }

        .function-call-toggle {
            color: #cccccc;
            font-size: 14px;
            transition: transform 0.2s ease;
        }

        .function-call-toggle.expanded {
            transform: rotate(180deg);
        }

        .function-call-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: #1e1e1e;
        }

        .function-call-content.expanded {
            max-height: 500px;
            overflow-y: auto;
        }

        .function-call-content-inner {
            padding: 16px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.4;
            white-space: pre-wrap;
            word-break: break-all;
            color: #cccccc;
        }

        .function-call-status {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 500;
            margin-left: 8px;
        }

        .function-call-status.success {
            background: rgba(0, 122, 204, 0.2);
            color: #007acc;
        }

        .function-call-status.calling {
            background: rgba(0, 122, 204, 0.2);
            color: #007acc;
            animation: pulse 2s infinite;
        }

        .input-container {
            background: #2d2d30;
            border: 1px solid #3e3e42;
            border-radius: 8px;
            padding: 20px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        #userInput {
            width: 100%;
            min-height: 50px;
            max-height: 120px;
            padding: 15px 20px;
            border: 1px solid #3e3e42;
            border-radius: 6px;
            font-size: 14px;
            resize: vertical;
            transition: all 0.3s ease;
            font-family: inherit;
            background: #1e1e1e;
            color: #cccccc;
        }

        #userInput:focus {
            outline: none;
            border-color: #007acc;
            box-shadow: 0 0 0 2px rgba(0, 122, 204, 0.2);
        }

        #userInput::placeholder {
            color: #6a6a6a;
        }

        .send-button {
            background: #007acc;
            color: white;
            border: none;
            border-radius: 6px;
            width: 50px;
            height: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .send-button:hover {
            background: #005a9e;
            transform: translateY(-1px);
        }

        .send-button:disabled {
            background: #3e3e42;
            cursor: not-allowed;
            transform: none;
        }

        /* ç‰¹å®šæŒ‰é’®çš„æ‚¬åœæ•ˆæœ */
        #planButton:hover:not(:disabled) {
            background: #f57c00;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #3e3e42;
            background: #2d2d30;
        }

        .sidebar-header h3 {
            margin: 0;
            color: #cccccc;
            font-size: 1.1em;
            font-weight: 500;
        }

        .sidebar-header .action-btn {
            background: transparent;
            border: 1px solid #569cd6;
            color: #569cd6;
            padding: 6px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9em;
        }

        .sidebar-header .action-btn:hover:not(:disabled) {
            background: #569cd6;
            color: white;
        }

        .sidebar-header .action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .sidebar-header .action-btn .fa-spin {
            animation: fa-spin 1s infinite linear;
        }

        .directory-list {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            margin: 0;
        }

        .directory-item {
            background: #1e1e1e;
            border-radius: 6px;
            margin-bottom: 12px;
            padding: 15px;
            border: 1px solid #3e3e42;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .directory-item:hover {
            background: #2d2d30;
            border-color: #569cd6;
            transform: translateY(-1px);
        }

        .directory-item.expanded {
            background: #0f3460;
            border-color: #007acc;
        }

        .directory-item.current {
            background: #2d2d30;
            color: #cccccc;
            border-color: #3e3e42;
            box-shadow: none;
        }

        .directory-item.current .directory-name,
        .directory-item.current .directory-info {
            color: #cccccc;
        }

        .directory-item.current .action-btn {
            color: #9cdcfe;
        }

        .directory-item.current .action-btn:hover {
            background: rgba(156, 220, 254, 0.1);
        }

        .directory-item.selected {
            background: linear-gradient(135deg, #007acc 0%, #005a9e 100%);
            color: white;
            border-color: #007acc;
            box-shadow: 0 3px 10px rgba(0, 122, 204, 0.3);
        }

        .directory-item.selected .directory-name,
        .directory-item.selected .directory-info {
            color: white;
        }

        .directory-item.selected .action-btn {
            color: white;
        }

        .directory-item.selected .action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .directory-item.last {
            border: 2px solid #569cd6;
            background: #0f3460;
        }

        .directory-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .directory-name {
            font-weight: 600;
            color: #cccccc;
            font-size: 0.9em;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-right: 10px;
        }

        .directory-actions {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }

        .action-btn {
            background: none;
            border: none;
            color: #9cdcfe;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .action-btn:hover {
            background: rgba(156, 220, 254, 0.1);
            color: #569cd6;
        }

        .rename-btn {
            color: #ffc107 !important;
        }

        .rename-btn:hover {
            background: rgba(255, 193, 7, 0.1) !important;
            color: #ffc107 !important;
        }

        .delete-btn {
            color: #ff6b6b !important;
        }

        .delete-btn:hover {
            background: rgba(255, 107, 107, 0.1) !important;
            color: #ff5252 !important;
        }

        .directory-info {
            font-size: 0.85em;
            color: #9cdcfe;
            margin-bottom: 10px;
        }

        .file-tree {
            display: none;
            margin-top: 10px;
            padding: 10px;
            border-top: 1px solid #3e3e42;
            background: #1e1e1e;
            border-radius: 4px;
        }

        .file-tree.show {
            display: block;
        }

        .sub-file-tree {
            display: none;
            margin-left: 20px;
        }

        .sub-file-tree.show {
            display: block;
        }

        .sub-folder-toggle {
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }

        .sub-folder-toggle:hover {
            opacity: 1;
            background: rgba(156, 220, 254, 0.2) !important;
            border-radius: 3px;
        }

        .file-item.directory > div[onclick]:hover {
            background: rgba(156, 220, 254, 0.1);
            border-radius: 4px;
            padding: 2px 6px;
            margin: -2px -6px;
        }

        .file-item {
            padding: 5px 0;
            margin-left: 20px;
            font-size: 0.9em;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-item:hover {
            background: rgba(156, 220, 254, 0.2);
            border-radius: 4px;
            padding-left: 5px;
        }

        .file-item.directory {
            font-weight: 500;
            color: #9cdcfe;
        }

        .file-item.previewable {
            color: #ffffff;
        }

        .file-item.previewable:hover {
            color: #ffffff;
            font-weight: 500;
        }

        .file-item i {
            width: 16px;
            text-align: center;
        }

        .file-item.grayed {
            color: #888888 !important;
        }

        .file-item.grayed:hover {
            color: #aaaaaa !important;
        }

        .file-item.grayed.previewable {
            cursor: pointer;
        }

        .file-item.grayed.previewable:hover {
            color: #cccccc !important;
            background: rgba(156, 220, 254, 0.1);
            border-radius: 4px;
            padding-left: 5px;
        }



        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #9cdcfe;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 3px solid #3e3e42;
            border-top: 3px solid #007acc;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .scrollbar-custom {
            scrollbar-width: thin;
            scrollbar-color: #569cd6 #2d2d30;
        }

        .scrollbar-custom::-webkit-scrollbar {
            width: 8px;
        }

        .scrollbar-custom::-webkit-scrollbar-track {
            background: #2d2d30;
            border-radius: 4px;
        }

        .scrollbar-custom::-webkit-scrollbar-thumb {
            background: #569cd6;
            border-radius: 4px;
        }

        .scrollbar-custom::-webkit-scrollbar-thumb:hover {
            background: #007acc;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                height: 100vh;
            }
            
            .sidebar {
                width: 100%;
                height: 40vh;
                border-radius: 0;
                border-right: none;
                border-bottom: 1px solid #3e3e42;
            }
            
            .main-content {
                height: 60vh;
            }
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: #2d2d30;
            margin: 2% auto;
            border: 1px solid #3e3e42;
            border-radius: 8px;
            width: 90%;
            max-width: 1200px;
            height: 90vh;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            background: #007acc;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #3e3e42;
            flex-shrink: 0;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.2em;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            opacity: 0.7;
        }

        .modal-body {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
            background: #1e1e1e;
            color: #cccccc;
            min-height: 0;
        }

        /* ç‰¹æ®Šå¤„ç†é¢„è§ˆæ¨¡æ€æ¡† */
        #previewModal .modal-content {
            width: 90%;
            max-width: 1200px;
            height: 90%;
            max-height: 800px;
        }

        #previewModal .modal-body {
            padding: 10px;
        }

        /* iframe æ ·å¼ä¼˜åŒ– */
        #previewContent iframe {
            width: 100%;
            height: calc(90vh - 120px);
            border: none;
            border-radius: 4px;
        }

        /* ä¸Šä¼ åŒºåŸŸæ ·å¼ */
        .upload-area {
            border: 2px dashed #569cd6;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            background: #1e1e1e;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #007acc;
            background: #2d2d30;
        }

        .upload-area.dragover {
            border-color: #007acc;
            background: #2d2d30;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 48px;
            color: #569cd6;
            margin-bottom: 20px;
        }

        .upload-text p {
            margin: 10px 0;
            font-size: 16px;
        }

        .upload-hint {
            font-size: 14px !important;
            color: #9cdcfe !important;
            opacity: 0.8;
        }

        .upload-btn {
            background: #007acc;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
            transition: background 0.3s ease;
        }

        .upload-btn:hover {
            background: #005a9e;
        }

        /* è¿›åº¦æ¡æ ·å¼ */
        .upload-progress {
            margin-top: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #3e3e42;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #007acc;
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            margin-top: 10px;
            color: #9cdcfe;
        }

        /* ä¸Šä¼ ç»“æœæ ·å¼ */
        .upload-result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }

        .upload-result .success {
            color: #75b798;
            background: #0f5132;
            padding: 10px;
            border-radius: 4px;
            border-left: 3px solid #198754;
        }

        .upload-result .error {
            color: #f48771;
            background: #5a1d1d;
            padding: 10px;
            border-radius: 4px;
            border-left: 3px solid #f14c4c;
        }

        /* æ»šåŠ¨åˆ°åº•éƒ¨æç¤º */
        .scroll-to-bottom-hint {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: #007acc;
            color: white;
            border: none;
            border-radius: 25px;
            width: 50px;
            height: 50px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: 0 4px 12px rgba(0, 122, 204, 0.4);
            transition: all 0.3s ease;
            z-index: 100;
            animation: bounceIn 0.3s ease;
        }

        .scroll-to-bottom-hint:hover {
            background: #005a9e;
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 122, 204, 0.6);
        }

        .scroll-to-bottom-hint.show {
            display: flex;
        }

        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* æ–°æ¶ˆæ¯æç¤º */
        .new-message-indicator {
            position: absolute;
            bottom: 80px;
            right: 20px;
            background: #007acc;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            display: none;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(0, 122, 204, 0.4);
            animation: slideInRight 0.3s ease;
            z-index: 99;
            cursor: pointer;
        }

        .new-message-indicator.show {
            display: flex;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* è‡ªåŠ¨æ»šåŠ¨çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .auto-scroll-indicator {
            position: absolute;
            bottom: 130px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
            transition: all 0.3s ease;
            z-index: 98;
            opacity: 0.8;
        }

        .auto-scroll-indicator.disabled {
            background: #9e9e9e;
            box-shadow: 0 2px 8px rgba(158, 158, 158, 0.3);
        }

        .auto-scroll-indicator i {
            animation: bounce 1.5s infinite;
        }

        .auto-scroll-indicator.disabled i {
            animation: none;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-3px);
            }
            60% {
                transform: translateY(-2px);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-content">
            <div class="header">
                <h1><i class="fas fa-robot"></i> {{ i18n.app_title.replace(' GUI', '') }}</h1>
                <p>{{ i18n.app_subtitle }}</p>
            </div>

            <div class="chat-container">
                <div class="chat-header">
                    <h3>
                        <i class="fas fa-comments"></i>
                        {{ i18n.chat_title }}
                    </h3>
                    <div class="status-indicator" id="statusIndicator"></div>
                </div>
                <div class="chat-messages scrollbar-custom" id="chatMessages">
                    <div class="message system">
                        <strong><i class="fas fa-info-circle"></i> {{ i18n.get('system_message', 'ç³»ç»Ÿæ¶ˆæ¯' if lang == 'zh' else 'System Message') }}</strong><br>
                        {{ i18n.get('welcome_message', 'æ¬¢è¿ä½¿ç”¨ AGI Botï¼è¯·åœ¨ä¸‹æ–¹è¾“å…¥æ‚¨çš„éœ€æ±‚ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ä¸ºæ‚¨å¤„ç†ä»»åŠ¡ã€‚' if lang == 'zh' else 'Welcome to AGI Bot! Please enter your requirements below, and the system will automatically process tasks for you.') }}
                    </div>
                </div>
                
                <!-- æ»šåŠ¨åˆ°åº•éƒ¨æŒ‰é’® -->
                <button class="scroll-to-bottom-hint" id="scrollToBottomBtn" title="{{ i18n.get('scroll_to_bottom', 'æ»šåŠ¨åˆ°åº•éƒ¨' if lang == 'zh' else 'Scroll to Bottom') }}">
                    <i class="fas fa-chevron-down"></i>
                </button>
                
                <!-- æ–°æ¶ˆæ¯æç¤º -->
                <div class="new-message-indicator" id="newMessageIndicator">
                    <i class="fas fa-bell"></i>
                    <span id="newMessageCount">1</span> æ¡æ–°æ¶ˆæ¯
                </div>
                
                <!-- è‡ªåŠ¨æ»šåŠ¨çŠ¶æ€æŒ‡ç¤ºå™¨ -->
                <div class="auto-scroll-indicator" id="autoScrollIndicator">
                    <i class="fas fa-arrow-down"></i>
                    <span>è‡ªåŠ¨æ»šåŠ¨</span>
                </div>
            </div>

            <div class="input-container">
                <div class="input-group">
                    <div class="input-wrapper">
                        <textarea 
                            id="userInput" 
                            placeholder="{{ i18n.input_placeholder }}"
                            rows="1"
                        ></textarea>
                    </div>
                    <button class="send-button" id="sendButton" title="{{ i18n.direct_tooltip }}">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                    <button class="send-button" id="planButton" style="background-color: #ff9800;" title="{{ i18n.plan_tooltip }}">
                        <i class="fas fa-list-ul"></i>
                    </button>

                    <button class="send-button" id="newTaskButton" style="background-color: #4caf50;" title="{{ i18n.new_tooltip }}">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="send-button" id="stopButton" style="display: none; background-color: #f44336;">
                        <i class="fas fa-stop"></i>
                    </button>
                </div>
                <div id="taskModeInfo" style="margin-top: 10px; font-size: 0.9em; color: #666; text-align: center;">
                    <!-- ä»»åŠ¡æ¨¡å¼ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
        </div>

        <div class="resizer" id="resizer"></div>

        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-folder-open"></i>
                <h3>{{ i18n.get('workspace_title', 'å·¥ä½œç›®å½•' if lang == 'zh' else 'Workspace') }}</h3>
                <button class="action-btn" onclick="manualRefresh()" title="{{ i18n.refresh_tooltip }}">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            
            <div class="loading" id="sidebarLoading">
                <div class="spinner"></div>
                <p>{{ i18n.loading }}</p>
            </div>
            
            <div class="directory-list scrollbar-custom" id="directoryList">
                <!-- ç›®å½•åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- æ–‡ä»¶é¢„è§ˆæ¨¡æ€æ¡† -->
    <div id="previewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="previewTitle">{{ i18n.get('file_preview', 'æ–‡ä»¶é¢„è§ˆ' if lang == 'zh' else 'File Preview') }}</h3>
                <span class="close" id="previewClose">&times;</span>
            </div>
            <div class="modal-body">
                <div id="previewContent"></div>
            </div>
        </div>
    </div>

    <!-- æ–‡ä»¶ä¸Šä¼ æ¨¡æ€æ¡† -->
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="uploadTitle">{{ i18n.upload_title }}</h3>
                <span class="close" id="uploadClose">&times;</span>
            </div>
            <div class="modal-body">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <div class="upload-text">
                        <p>{{ i18n.get('drag_files', 'æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶' if lang == 'zh' else 'Drag files here or click to select files') }}</p>
                        <p class="upload-hint">{{ i18n.get('upload_hint', 'æ”¯æŒå¤šæ–‡ä»¶ä¸Šä¼ ï¼Œæ–‡ä»¶å°†ä¿å­˜åˆ°é€‰å®šç›®å½•çš„workspaceæ–‡ä»¶å¤¹ä¸­' if lang == 'zh' else 'Supports multiple file upload, files will be saved to the workspace folder of the selected directory') }}</p>
                    </div>
                    <input type="file" id="fileInput" multiple style="display: none;">
                    <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-folder-open"></i> {{ i18n.get('select_files', 'é€‰æ‹©æ–‡ä»¶' if lang == 'zh' else 'Select Files') }}
                    </button>
                </div>
                <div class="upload-progress" id="uploadProgress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">ä¸Šä¼ ä¸­...</div>
                </div>
                <div class="upload-result" id="uploadResult"></div>
            </div>
        </div>
    </div>



    <!-- é‡å‘½åç›®å½•æ¨¡æ€æ¡† -->
    <div id="renameModal" class="modal">
        <div class="modal-content" style="width: 80%; max-width: 500px; height: auto;">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> {{ i18n.rename_title }}</h3>
                <span class="close" id="renameClose">&times;</span>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #cccccc; font-weight: 500;">å½“å‰åç§°ï¼š</label>
                    <div id="currentDirName" style="background: #2d2d30; padding: 10px; border-radius: 4px; color: #9cdcfe; font-family: monospace;"></div>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; color: #cccccc; font-weight: 500;">æ–°åç§°ï¼š</label>
                    <input type="text" id="newDirName" placeholder="{{ i18n.get('rename_placeholder', 'è¾“å…¥æ–°çš„ç›®å½•åç§°...' if lang == 'zh' else 'Enter new directory name...') }}" 
                           style="width: 100%; padding: 10px; background: #1e1e1e; border: 1px solid #3e3e42; border-radius: 4px; color: #cccccc; font-family: monospace;">
                    <div style="margin-top: 5px; font-size: 0.9em; color: #9cdcfe;">
                        <i class="fas fa-info-circle"></i> å°†ä½¿ç”¨æ‚¨è¾“å…¥çš„åç§°ä½œä¸ºç›®å½•å
                    </div>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button id="renameCancel" class="action-btn" style="background: #6c757d; color: white; padding: 10px 20px;">
                        <i class="fas fa-times"></i> å–æ¶ˆ
                    </button>
                    <button id="renameConfirm" class="action-btn" style="background: #007acc; color: white; padding: 10px 20px;">
                        <i class="fas fa-check"></i> ç¡®è®¤é‡å‘½å
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js"></script>
    <script>
        // å›½é™…åŒ–é…ç½®
        const I18N = {{ i18n | tojson }};
        const CURRENT_LANG = '{{ lang }}';
    </script>
    <script>
        // Socket.IOè¿æ¥é…ç½®
        const socket = io({
            reconnection: true,
            reconnectionDelay: 1000,
            reconnectionAttempts: 5,
            timeout: 20000,
            forceNew: true
        });
        
        // DOMå…ƒç´ 
        const chatMessages = document.getElementById('chatMessages');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const planButton = document.getElementById('planButton');

        const newTaskButton = document.getElementById('newTaskButton');
        const stopButton = document.getElementById('stopButton');
        const statusIndicator = document.getElementById('statusIndicator');
        const directoryList = document.getElementById('directoryList');
        const sidebarLoading = document.getElementById('sidebarLoading');

        // çŠ¶æ€ç®¡ç†
        let isTaskRunning = false;
        let selectedDirectory = null;
        let taskMode = 'new'; // 'new', 'continue', 'selected'
        let expandedDirectories = new Set(); // ä¿å­˜å±•å¼€çš„ç›®å½•çŠ¶æ€
        let collapsedSubDirectories = new Set(); // ä¿å­˜æ”¶èµ·çš„å­ç›®å½•çŠ¶æ€
        let isUserScrolling = false; // ç”¨æˆ·æ˜¯å¦æ­£åœ¨æ‰‹åŠ¨æ»šåŠ¨
        let autoScrollEnabled = true; // æ˜¯å¦å¯ç”¨è‡ªåŠ¨æ»šåŠ¨
        let refreshTimeout = null; // é˜²æŠ–å®šæ—¶å™¨

        // æ–‡ä»¶é¢„è§ˆåŠŸèƒ½
        const previewModal = document.getElementById('previewModal');
        const previewTitle = document.getElementById('previewTitle');
        const previewContent = document.getElementById('previewContent');
        const previewClose = document.getElementById('previewClose');

        // æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
        const uploadModal = document.getElementById('uploadModal');
        const uploadTitle = document.getElementById('uploadTitle');
        const uploadClose = document.getElementById('uploadClose');
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const uploadProgress = document.getElementById('uploadProgress');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const uploadResult = document.getElementById('uploadResult');
        
        let currentUploadDir = null;
        let newMessageCount = 0; // æ–°æ¶ˆæ¯è®¡æ•°å™¨
        
        // è‡ªåŠ¨æ»šåŠ¨çŠ¶æ€æŒ‡ç¤ºå™¨
        const autoScrollIndicator = document.getElementById('autoScrollIndicator');

        // Socketäº‹ä»¶ç›‘å¬
        socket.on('connect', function() {
            addMessage(I18N.connected, 'system');
            updateStatus('connected');
            updateTaskModeInfo(); // åˆå§‹åŒ–ä»»åŠ¡æ¨¡å¼ä¿¡æ¯æ˜¾ç¤º
            // ç¡®ä¿è¿æ¥åæ»šåŠ¨åˆ°åº•éƒ¨
            setTimeout(() => {
                scrollToBottom(false);
            }, 100);
            console.log('âœ… Socket connected');
        });

        socket.on('disconnect', function(reason) {
            addMessage(`${I18N.disconnected} (${reason})`, 'info');
            updateStatus('disconnected');
            console.log('âŒ Socket disconnected:', reason);
        });

        socket.on('reconnect', function(attemptNumber) {
            addMessage(`${I18N.reconnected} (${I18N.attempt} ${attemptNumber})`, 'system');
            updateStatus('connected');
            console.log('ğŸ”„ Socket reconnected after', attemptNumber, 'attempts');
        });

        socket.on('reconnect_attempt', function(attemptNumber) {
            console.log('ğŸ”„ Reconnection attempt', attemptNumber);
        });

        socket.on('reconnect_error', function(error) {
            console.log('âŒ Reconnection error:', error);
        });

        socket.on('reconnect_failed', function() {
            addMessage(I18N.reconnect_failed, 'info');
            console.log('âŒ Reconnection failed');
        });

        socket.on('task_started', function(data) {
            addMessage(data.message, 'info');
            setTaskRunning(true);
        });

        socket.on('output', function(data) {
            addMessage(data.message, data.type || 'info');
        });

        socket.on('task_completed', function(data) {
            addMessage(data.message, data.success ? 'success' : 'error');
            setTaskRunning(false);
            
            // ä»»åŠ¡å®Œæˆåï¼Œå¦‚æœæœ‰é€‰æ‹©çš„ç›®å½•ï¼Œä¿æŒé€‰æ‹©çŠ¶æ€ï¼Œå¦åˆ™åˆ‡æ¢åˆ°ç»§ç»­æ¨¡å¼
            if (selectedDirectory) {
                taskMode = 'selected';
                // å¦‚æœä»»åŠ¡å®Œæˆçš„ç›®å½•æ˜¯é€‰æ‹©çš„ç›®å½•ï¼Œè‡ªåŠ¨å±•å¼€å®ƒ
                if (data.output_dir && data.output_dir === selectedDirectory) {
                    expandedDirectories.add(selectedDirectory);
                }
            } else {
                taskMode = 'continue';
                // å¦‚æœæœ‰å·¥ä½œç›®å½•ï¼Œè‡ªåŠ¨å±•å¼€æœ€æ–°çš„ç›®å½•
                if (data.output_dir) {
                    expandedDirectories.add(data.output_dir);
                }
            }
            updateTaskModeInfo();
            
            // åˆ·æ–°ç›®å½•åˆ—è¡¨ï¼Œå»¶è¿Ÿç¨é•¿ä¸€äº›ç¡®ä¿æ–‡ä»¶å·²ç”Ÿæˆ
            setTimeout(() => {
                refreshDirectories();
            }, 2000);
        });

        socket.on('task_stopped', function(data) {
            addMessage(data.message, data.type || 'error');
            setTaskRunning(false);
            // ä¿æŒå½“å‰çš„ä»»åŠ¡æ¨¡å¼
            updateTaskModeInfo();
            // åœæ­¢ä»»åŠ¡åä¹Ÿåˆ·æ–°ä¸€ä¸‹ç›®å½•
            setTimeout(refreshDirectories, 1000);
        });

        socket.on('error', function(data) {
            addMessage(data.message, 'error');
            setTaskRunning(false);
        });



        socket.on('directory_selected', function(data) {
            selectedDirectory = data.dir_name;
            if (selectedDirectory) {
                taskMode = 'selected';
                updateTaskModeInfo();
                refreshDirectories();
            }
        });

        socket.on('directory_created', function(data) {
            if (data.success) {
                selectedDirectory = data.dir_name;
                taskMode = 'selected';
                addMessage(data.message, 'success');
                updateTaskModeInfo();
                refreshDirectories();
            } else {
                addMessage(`${I18N.create_directory_failed}: ${data.error}`, 'error');
            }
        });

        // æ¶ˆæ¯å¤„ç†
        let lastMessageType = null;
        let lastMessageDiv = null;
        
        // æ£€æŸ¥æ˜¯å¦åº”è¯¥è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
        function shouldAutoScroll() {
            // å¦‚æœè‡ªåŠ¨æ»šåŠ¨è¢«ç¦ç”¨ï¼Œä¸æ»šåŠ¨
            if (!autoScrollEnabled) {
                console.log('ğŸš« Auto-scroll disabled');
                return false;
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»åœ¨åº•éƒ¨é™„è¿‘ï¼ˆå®¹å·®30pxï¼Œå¢åŠ å®¹å·®ï¼‰
            const threshold = 30;
            const isNearBottom = chatMessages.scrollTop + chatMessages.clientHeight >= chatMessages.scrollHeight - threshold;
            
            // å¦‚æœç”¨æˆ·æ­£åœ¨å‘ä¸Šæ»šåŠ¨ä¸”ä¸åœ¨åº•éƒ¨é™„è¿‘ï¼Œä¸è‡ªåŠ¨æ»šåŠ¨
            if (isUserScrolling && scrollDirection === 'up' && !isNearBottom) {
                console.log('ğŸš« User scrolling up away from bottom');
                return false;
            }
            
            // å…¶ä»–æƒ…å†µä¸‹ï¼Œåªè¦è‡ªåŠ¨æ»šåŠ¨å¯ç”¨å°±å…è®¸æ»šåŠ¨
            console.log('âœ… Auto-scroll allowed', {
                autoScrollEnabled,
                isUserScrolling,
                scrollDirection,
                isNearBottom
            });
            return autoScrollEnabled;
        }
        
        // HTMLè½¬ä¹‰å‡½æ•°
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function addMessage(message, type = 'info') {
            // ç‰¹æ®Šè¿‡æ»¤ï¼šéšè—åŒ…å«ç‰¹å®šå†…å®¹çš„è¡Œ
            if (message.trim() === '```' || message.trim() === '```xml') {
                return; // ä¸æ˜¾ç¤ºè¿™äº›è¡Œ
            }
            
            // è°ƒè¯•æ—¥å¿—ï¼šè®°å½•XMLæ ‡ç­¾å’Œå·¥å…·è°ƒç”¨çŠ¶æ€
            if (message.trim().startsWith('<') || message.trim() === 'function_calls') {
                console.log('XML/Tag detected:', {
                    message: message.trim(),
                    insideFunctionCalls: insideFunctionCalls,
                    currentFunctionCall: currentFunctionCall ? {
                        isActive: currentFunctionCall.isActive,
                        toolNames: currentFunctionCall.toolNames,
                        status: currentFunctionCall.status
                    } : null
                });
            }
            
            const shouldScroll = shouldAutoScroll();
            
            // æ£€æµ‹å·¥å…·æ‰§è¡Œæ¶ˆæ¯
            const toolMatch = detectToolMessage(message);
            if (toolMatch) {
                // æ£€æŸ¥æ˜¯å¦æ˜¯å·¥å…·è°ƒç”¨ç›¸å…³æ¶ˆæ¯
                if (['function_calls_start', 'function_calls_end'].includes(toolMatch.type)) {
                    addFunctionCallMessage(toolMatch, shouldScroll);
                    return;
                } else {
                    addToolMessage(toolMatch, shouldScroll);
                    return;
                }
            }
            
            // å¦‚æœå½“å‰å·¥å…·å·²å®Œæˆä¸”è¿™ä¸æ˜¯å·¥å…·ç›¸å…³æ¶ˆæ¯ï¼Œç»“æŸå·¥å…·æ¶ˆæ¯
            if (currentToolMessage && (currentToolMessage.status === 'completed' || currentToolMessage.status === 'error')) {
                finalizeToolMessage(shouldScroll);
            }
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯å·¥å…·è°ƒç”¨ç›¸å…³çš„XMLæ ‡ç­¾ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
            const isXmlTag = message.trim().match(/^<(\/?)(\w+)(\s[^>]*)?>/) || 
                           message.trim().match(/^<parameter name="[^"]+">/) ||
                           message.trim() === '</parameter>' ||
                           message.trim() === '</invoke>' ||
                           message.trim() === '<function_calls>' ||
                           message.trim() === '</function_calls>';
            
            // å¦‚æœæ˜¯XMLæ ‡ç­¾ä¸”å½“å‰æœ‰æ´»è·ƒçš„å·¥å…·è°ƒç”¨æ¡†ï¼Œå°†XMLæ ‡ç­¾æ·»åŠ åˆ°å·¥å…·è°ƒç”¨æ¡†
            if (isXmlTag && currentFunctionCall && currentFunctionCall.isActive) {
                functionCallBuffer.push(message);
                
                // æå–å·¥å…·åç§°ï¼ˆå¦‚æœæ˜¯invokeæ ‡ç­¾ï¼‰
                const invokeMatch = message.match(/^<invoke name="([^"]+)">$/);
                if (invokeMatch && !currentFunctionCall.toolNames.includes(invokeMatch[1])) {
                    currentFunctionCall.toolNames.push(invokeMatch[1]);
                }
                
                // åˆ›å»ºæˆ–æ›´æ–°UI
                if (!currentFunctionCall.element) {
                    createOrUpdateFunctionCallUI(shouldScroll);
                } else {
                    createOrUpdateFunctionCallUI(shouldScroll);
                }
                return;
            }
            
            // ç®€åŒ–çš„å·¥å…·è°ƒç”¨æ¶ˆæ¯å¤„ç†ï¼šå¦‚æœåœ¨<function_calls>æ ‡ç­¾å†…ä¸”å·¥å…·è°ƒç”¨æ¡†å¤„äºæ´»è·ƒçŠ¶æ€ï¼Œå°±æ·»åŠ åˆ°å·¥å…·è°ƒç”¨æ¡†
            if (insideFunctionCalls && currentFunctionCall && currentFunctionCall.isActive) {
                // è¿‡æ»¤ç‰¹æ®Šå†…å®¹åå†æ·»åŠ åˆ°å·¥å…·è°ƒç”¨ç¼“å†²åŒº
                if (message.trim() !== '```' && message.trim() !== '```xml') {
                    functionCallBuffer.push(message);
                }
                
                // åˆ›å»ºæˆ–æ›´æ–°UI
                if (!currentFunctionCall.element) {
                    createOrUpdateFunctionCallUI(shouldScroll);
                } else {
                    createOrUpdateFunctionCallUI(shouldScroll);
                }
                return;
            }

            // é¢å¤–æ£€æŸ¥ï¼šå¦‚æœæœ‰æ´»è·ƒçš„å·¥å…·è°ƒç”¨æ¡†ä¸”æ¶ˆæ¯çœ‹èµ·æ¥åƒå‚æ•°å†…å®¹ï¼Œæ·»åŠ åˆ°å·¥å…·è°ƒç”¨æ¡†
            if (currentFunctionCall && currentFunctionCall.isActive && !message.match(/^</) && !message.match(/^>/) && message.trim() !== '') {
                // æ£€æŸ¥æ˜¯å¦åœ¨å‚æ•°æ ‡ç­¾å†…ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
                var lastBuffer = functionCallBuffer.slice(-3).join('\n');
                var inParameter = lastBuffer.includes('<parameter name="code_edit">') || 
                                 lastBuffer.includes('<parameter name="instructions">') || 
                                 lastBuffer.includes('<parameter name="old_string">') || 
                                 lastBuffer.includes('<parameter name="new_string">');
                
                // å¦‚æœåœ¨å‚æ•°å†…æˆ–æ¶ˆæ¯çœ‹èµ·æ¥åƒä»£ç å†…å®¹ï¼Œæ·»åŠ åˆ°å·¥å…·è°ƒç”¨æ¡†
                if (inParameter || message.length > 30 || message.match(/^\s*(def |class |import |function|var|const)/)) {
                    functionCallBuffer.push(message);
                    if (!currentFunctionCall.element) {
                        createOrUpdateFunctionCallUI(shouldScroll);
                    } else {
                        createOrUpdateFunctionCallUI(shouldScroll);
                    }
                    return;
                }
            }

            // ä¿®æ”¹é€»è¾‘ï¼šåªæœ‰åœ¨å·¥å…·æ¡†è¿˜åœ¨æ´»è·ƒçŠ¶æ€æ—¶æ‰å°†æ¶ˆæ¯æ·»åŠ åˆ°å·¥å…·æ¡†ä¸­
            // ä¸€æ—¦æ”¶åˆ°</tool_execute>æ ‡è®°ï¼Œå·¥å…·æ¡†å°±ä¸å†æ¥æ”¶æ–°æ¶ˆæ¯
            if (currentToolMessage && currentToolMessage.isActive && isToolRelatedMessage(message)) {
                // è¿‡æ»¤ç‰¹æ®Šå†…å®¹åå†æ·»åŠ åˆ°å·¥å…·ç¼“å†²åŒº
                if (message.trim() !== '```' && message.trim() !== '```xml') {
                    toolMessageBuffer.push(message);
                }
                if (!currentToolMessage.element) {
                    createOrUpdateToolMessageUI(shouldScroll);
                } else {
                    createOrUpdateToolMessageUI(shouldScroll);
                }
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯å­¤ç«‹çš„"function_calls"æ–‡æœ¬ï¼Œè¿™é€šå¸¸è¡¨ç¤ºå·¥å…·è°ƒç”¨ç»“æŸ
            if (message.trim() === 'function_calls' && currentFunctionCall && currentFunctionCall.isActive) {
                // ç»“æŸå½“å‰çš„å·¥å…·è°ƒç”¨æ¡†
                currentFunctionCall.status = 'completed';
                currentFunctionCall.isActive = false;
                insideFunctionCalls = false;
                
                // åˆ›å»ºæˆ–æ›´æ–°UI
                if (!currentFunctionCall.element) {
                    createOrUpdateFunctionCallUI(shouldScroll);
                } else {
                    createOrUpdateFunctionCallUI(shouldScroll);
                }
                
                // å®Œæˆå·¥å…·è°ƒç”¨æ¶ˆæ¯
                finalizeFunctionCallMessage(shouldScroll);
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦åˆšåˆšå®Œæˆäº†å·¥å…·æ‰§è¡Œæˆ–å·¥å…·è°ƒç”¨ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å¼ºåˆ¶åˆ›å»ºæ–°çš„æ¶ˆæ¯æ¡†
            const justFinishedTool = currentToolMessage && !currentToolMessage.isActive;
            const justFinishedFunctionCall = currentFunctionCall && !currentFunctionCall.isActive;
            
            if (['info', 'error', 'success'].includes(type) && lastMessageType === type && lastMessageDiv && !justFinishedTool && !justFinishedFunctionCall) {
                // å¯¹äºè¿ç»­çš„åŒç±»å‹æ¶ˆæ¯ï¼Œå®‰å…¨åœ°æ·»åŠ å†…å®¹
                const textSpan = lastMessageDiv.querySelector('.message-text');
                if (textSpan) {
                    textSpan.innerHTML += '<br>' + escapeHtml(message);
                } else {
                    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°text spanï¼Œå›é€€åˆ°åŸæ¥çš„æ–¹æ³•ä½†è¦è½¬ä¹‰
                    lastMessageDiv.innerHTML += '<br>' + escapeHtml(message);
                }
                if (shouldScroll) {
                    // ä½¿ç”¨requestAnimationFrameç¡®ä¿DOMæ›´æ–°å®Œæˆåå†æ»šåŠ¨
                    requestAnimationFrame(() => {
                        chatMessages.scrollTo({
                            top: chatMessages.scrollHeight,
                            behavior: 'smooth'
                        });
                    });
                } else {
                    // å¦‚æœä¸èƒ½è‡ªåŠ¨æ»šåŠ¨ï¼Œæ˜¾ç¤ºæ–°æ¶ˆæ¯æç¤º
                    showNewMessageIndicator();
                }
                return;
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            // åˆ›å»ºæ–‡æœ¬å…ƒç´ ï¼Œä½¿ç”¨textContentç¡®ä¿å®‰å…¨æ˜¾ç¤º
            const textSpan = document.createElement('span');
            textSpan.className = 'message-text';
            textSpan.textContent = message;
            
            // ç›´æ¥æ·»åŠ æ–‡æœ¬ï¼Œä¸æ·»åŠ å›¾æ ‡
            messageDiv.appendChild(textSpan);
            
            chatMessages.appendChild(messageDiv);
            
            // åªåœ¨åº”è¯¥è‡ªåŠ¨æ»šåŠ¨æ—¶æ‰æ»šåŠ¨
            if (shouldScroll) {
                // ä½¿ç”¨requestAnimationFrameç¡®ä¿DOMæ›´æ–°å®Œæˆåå†æ»šåŠ¨
                requestAnimationFrame(() => {
                    chatMessages.scrollTo({
                        top: chatMessages.scrollHeight,
                        behavior: 'smooth'
                    });
                });
            } else {
                // å¦‚æœä¸èƒ½è‡ªåŠ¨æ»šåŠ¨ï¼Œæ˜¾ç¤ºæ–°æ¶ˆæ¯æç¤ºï¼ˆé™¤äº†ç”¨æˆ·æ¶ˆæ¯ï¼‰
                if (type !== 'user') {
                    showNewMessageIndicator();
                }
            }

            if (['info', 'error', 'success'].includes(type)) {
                lastMessageType = type;
                lastMessageDiv = messageDiv;
            } else {
                lastMessageType = null;
                lastMessageDiv = null;
            }
        }



        // å·¥å…·æ¶ˆæ¯æ£€æµ‹å’Œå¤„ç†
        function detectToolMessage(message) {
            // æ£€æµ‹å·¥å…·æ‰§è¡Œå¼€å§‹æ ‡ç­¾ - "<tool_execute tool_name="read_file" tool_number="1">"
            const toolStartMatch = message.match(/^<tool_execute tool_name="([^"]+)" tool_number="(\d+)">$/);
            if (toolStartMatch) {
                return {
                    type: 'tool_start',
                    toolName: toolStartMatch[1],
                    toolNumber: toolStartMatch[2],
                    fullMessage: message
                };
            }

            // æ£€æµ‹å·¥å…·æ‰§è¡Œç»“æŸæ ‡ç­¾ - "</tool_execute>"
            if (message.trim() === '</tool_execute>') {
                return {
                    type: 'tool_end',
                    fullMessage: message
                };
            }

            // æ£€æµ‹å·¥å…·æ‰§è¡Œå¼€å§‹æ¶ˆæ¯ - "Executing tool 2: read_file" æˆ– "- Executing tool 1: list_dir"
            const executingMatch = message.match(/^-?\s*Executing tool (\d+): (\w+)$/);
            if (executingMatch) {
                return {
                    type: 'executing',
                    toolNumber: executingMatch[1],
                    toolName: executingMatch[2],
                    fullMessage: message
                };
            }

            // æ£€æµ‹å·¥å…·æ‰§è¡Œè¯¦ç»†ä¿¡æ¯ - "Executing tool: read_file with params: [...]"
            const detailMatch = message.match(/^Executing tool: (\w+) with params: (.+)$/);
            if (detailMatch) {
                return {
                    type: 'detail',
                    toolName: detailMatch[1],
                    params: detailMatch[2],
                    fullMessage: message
                };
            }

            // æ£€æµ‹å·¥å…·æ‰§è¡Œç»“æœå¼€å§‹ - "ğŸ› ï¸ Tool 2 execution result (read_file):"
            const resultMatch = message.match(/^ğŸ› ï¸ Tool (\d+) execution result \((\w+)\):$/);
            if (resultMatch) {
                return {
                    type: 'result_start',
                    toolNumber: resultMatch[1],
                    toolName: resultMatch[2],
                    fullMessage: message
                };
            }

            // æ£€æµ‹ç»“æœåˆ†éš”çº¿
            const separatorMatch = message.match(/^={40,}$/);
            if (separatorMatch) {
                return {
                    type: 'separator',
                    fullMessage: message
                };
            }

            // æ£€æµ‹å·¥å…·ç›¸å…³çš„emojiæ¶ˆæ¯
            const emojiMatch = message.match(/^[ğŸ“–ğŸ¯ğŸ“‚ğŸ”âœ…ğŸ“ŠğŸ“„ğŸ› ï¸]/);
            if (emojiMatch) {
                return {
                    type: 'tool_info',
                    fullMessage: message
                };
            }

            // æ£€æµ‹çŠ¶æ€æ¶ˆæ¯ - "Status: success"
            const statusMatch = message.match(/^Status: (\w+)$/);
            if (statusMatch) {
                return {
                    type: 'status',
                    status: statusMatch[1],
                    fullMessage: message
                };
            }

            // æ£€æµ‹æ–‡ä»¶ä¿¡æ¯ - "File: xxx"
            const fileMatch = message.match(/^File: (.+)$/);
            if (fileMatch) {
                return {
                    type: 'file_info',
                    fullMessage: message
                };
            }

            // æ£€æµ‹å†…å®¹ä¿¡æ¯ - "Content:"
            if (message === 'Content:') {
                return {
                    type: 'content_start',
                    fullMessage: message
                };
            }

            // æ£€æµ‹å·¥å…·æè¿°ä¿¡æ¯ - ä»¥å·¥å…·åå¼€å¤´çš„æè¿°è¡Œ
            const toolDescMatch = message.match(/^(\w+): (.+)$/);
            if (toolDescMatch && currentToolMessage && toolDescMatch[1].toLowerCase() === currentToolMessage.toolName.toLowerCase()) {
                return {
                    type: 'tool_desc',
                    fullMessage: message
                };
            }

            // æ£€æµ‹ç»“æ„åŒ–æ•°æ® - ä»¥ç‰¹å®šå…³é”®è¯å¼€å¤´çš„è¡Œ
            const structuredMatch = message.match(/^(path|directories|files|query|target_directories|explanation):\s*(.*)$/);
            if (structuredMatch && currentToolMessage) {
                return {
                    type: 'structured_data',
                    fullMessage: message
                };
            }

            // æ£€æµ‹æ•°ç»„æ•°æ® - ä»¥ [ å¼€å¤´æˆ–åŒ…å«æ•°ç»„æ ¼å¼çš„è¡Œ
            if ((message.trim().startsWith('[') || message.trim().startsWith('"')) && currentToolMessage) {
                return {
                    type: 'array_data',
                    fullMessage: message
                };
            }

            // æ£€æµ‹æ•°ç»„ç»“æŸ - ä»¥ ] ç»“å°¾çš„è¡Œ
            if (message.trim().endsWith(']') && currentToolMessage) {
                return {
                    type: 'array_end',
                    fullMessage: message
                };
            }

            // æ£€æµ‹æœç´¢ç»“æœå¼€å§‹ - "Results (X items):"
            const resultsMatch = message.match(/^Results \((\d+) items?\):$/);
            if (resultsMatch && currentToolMessage) {
                return {
                    type: 'results_start',
                    itemCount: resultsMatch[1],
                    fullMessage: message
                };
            }

            // æ£€æµ‹æœç´¢ç»“æœé¡¹ - "1. filename - content..."
            const resultItemMatch = message.match(/^\s*\d+\.\s+(.+)$/);
            if (resultItemMatch && currentToolMessage) {
                return {
                    type: 'result_item',
                    fullMessage: message
                };
            }

            // æ£€æµ‹å·¥å…·è°ƒç”¨å¼€å§‹æ ‡ç­¾ - "<function_calls>"
            if (message.trim() === '<function_calls>') {
                // å¦‚æœæ£€æµ‹åˆ°æ–°çš„function_callså¼€å§‹ï¼Œç¡®ä¿ä¹‹å‰çš„çŠ¶æ€è¢«æ¸…ç†
                if (currentFunctionCall && currentFunctionCall.isActive) {
                    console.log('Warning: New function_calls detected while previous one is still active');
                }
                return {
                    type: 'function_calls_start',
                    fullMessage: message
                };
            }

            // æ£€æµ‹å·¥å…·è°ƒç”¨ç»“æŸæ ‡ç­¾ - "</function_calls>"
            if (message.trim() === '</function_calls>') {
                return {
                    type: 'function_calls_end',
                    fullMessage: message
                };
            }

            // æ£€æµ‹å­¤ç«‹çš„"function_calls"æ–‡æœ¬ - è¿™é€šå¸¸è¡¨ç¤ºå·¥å…·è°ƒç”¨ç»“æŸ
            if (message.trim() === 'function_calls') {
                if (insideFunctionCalls) {
                    return {
                        type: 'function_calls_end',
                        fullMessage: message
                    };
                } else {
                    // å¦‚æœä¸åœ¨function_callså†…éƒ¨ï¼Œè¿™å¯èƒ½æ˜¯ä¸€ä¸ªé”™è¯¯çš„ç»“æŸæ ‡è®°ï¼Œå¿½ç•¥å®ƒ
                    return null;
                }
            }

            return null;
        }

        let currentToolMessage = null;
        let toolMessageBuffer = [];
        let toolTimeoutId = null;

        // å·¥å…·è°ƒç”¨æ¡†ç›¸å…³å˜é‡
        let currentFunctionCall = null;
        let functionCallBuffer = [];
        let insideFunctionCalls = false; // ç®€åŒ–ï¼šåªè·Ÿè¸ªæ˜¯å¦åœ¨<function_calls>æ ‡ç­¾å†…éƒ¨

        // åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦ä¸å½“å‰å·¥å…·è°ƒç”¨ç›¸å…³ - ç®€åŒ–ç‰ˆæœ¬
        function isFunctionCallRelatedMessage(message) {
            // ç®€å•é€»è¾‘ï¼šå¦‚æœåœ¨<function_calls>å’Œ</function_calls>ä¹‹é—´ï¼Œå°±æ˜¯ç›¸å…³æ¶ˆæ¯
            return insideFunctionCalls;
        }

        // åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦ä¸å½“å‰å·¥å…·ç›¸å…³
        function isToolRelatedMessage(message) {
            // æ£€æŸ¥æ˜¯å¦æ˜¯å·¥å…·æ ‡ç­¾
            const toolMatch = detectToolMessage(message);
            if (toolMatch && ['tool_start', 'tool_end'].includes(toolMatch.type)) {
                return true;
            }
            
            if (!currentToolMessage || !currentToolMessage.isActive) return false;
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯å·¥å…·ç›¸å…³çš„å„ç§æ¶ˆæ¯ç±»å‹
            if (toolMatch && ['tool_info', 'file_info', 'content_start', 'separator', 'tool_desc', 'structured_data', 'array_data', 'array_end', 'status', 'result_start', 'executing', 'detail', 'results_start', 'result_item'].includes(toolMatch.type)) {
                return true;
            }
            
            // åªæœ‰åœ¨å·¥å…·æ´»è·ƒä¸”è¿è¡Œä¸­æ—¶ï¼Œæ‰è€ƒè™‘å°†æ™®é€šæ–‡æœ¬æ¶ˆæ¯æ·»åŠ åˆ°å·¥å…·æ¡†
            if (currentToolMessage.status === 'running') {
                // æ£€æŸ¥æ˜¯å¦æ˜¯æ–°çš„å·¥å…·æ‰§è¡Œå¼€å§‹
                const isNewTool = message.match(/^<tool_execute/) || message.match(/^-?\s*Executing tool \d+:/);
                if (isNewTool) {
                    return false; // æ–°å·¥å…·å¼€å§‹ï¼Œå½“å‰å·¥å…·åº”è¯¥ç»“æŸ
                }
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯æ˜æ˜¾çš„å·¥å…·è¾“å‡ºå†…å®¹ï¼ˆæ›´å®½æ¾çš„åˆ¤æ–­ä»¥åŒ…å«æ–‡ä»¶å†…å®¹ï¼‰
                const isToolOutput = message.match(/^[ğŸ“–ğŸ¯ğŸ“‚ğŸ”âœ…ğŸ“ŠğŸ“„ğŸ› ï¸]/) || 
                                   message.match(/^(path|directories|files|query|target_directories|explanation):\s*/) ||
                                   message.match(/^Status:\s*/) ||
                                   message.match(/^File:\s*/) ||
                                   message === 'Content:' ||
                                   message.match(/^={40,}$/) ||
                                   (message.trim().startsWith('[') && message.trim().endsWith(']')) ||
                                   (message.trim().startsWith('"') && message.trim().endsWith('"'));
                
                // å¦‚æœå·²ç»æ£€æµ‹åˆ°"Content:"ï¼Œé‚£ä¹ˆåç»­çš„æ–‡æœ¬è¡Œä¹Ÿåº”è¯¥è¢«è®¤ä¸ºæ˜¯å·¥å…·ç›¸å…³çš„
                // ç›´åˆ°é‡åˆ°æ–°çš„å·¥å…·å¼€å§‹æˆ–æ˜ç¡®çš„ç»“æŸæ ‡è®°
                if (!isToolOutput && toolMessageBuffer.length > 0) {
                    const hasContentStart = toolMessageBuffer.some(msg => msg === 'Content:');
                    if (hasContentStart) {
                        // æ£€æŸ¥æ˜¯å¦æ˜¯æ˜æ˜¾çš„éå·¥å…·å†…å®¹ï¼ˆå¦‚æ–°çš„ç”¨æˆ·è¾“å…¥æˆ–ç³»ç»Ÿæ¶ˆæ¯ï¼‰
                        const isNonToolContent = message.match(/^(ç”¨æˆ·|User|ç³»ç»Ÿ|System|ğŸ¤–|ğŸ“|âš¡|Task|Creating|Normal|Initialized|Starting|Received|ğŸ”§|Found|Execute|Auto-approving|Running|Working|Output|Command|ğŸ“¤|âœ…|âŒ|âš ï¸|ğŸ‰|ğŸ“‹|ğŸš€|ğŸ›‘|ğŸ”„|ğŸ”—|ğŸ’¾|ğŸ“|ğŸ”|ğŸ“Š|ğŸ¯|ğŸ“‹)/) ||
                                                 message.match(/^(LLM|Model|API|Workspace|Language|Streaming|Cache|History|Subtask|Log|Detailed|Processing|Calling|Round|Warning|Expected|No tool|task completed|work is done|finished|å®Œæˆäº†|ä»»åŠ¡å®Œæˆ)/) ||
                                                 message.match(/^(execution started|execution completed|execution rounds|directory|Workspace directory|Detailed summary)/) ||
                                                 message.match(/^[A-Z][a-z]+ [a-z]+ [a-z]+:/) || // è‹±æ–‡å¥å­æ¨¡å¼
                                                 message.match(/^[ä¸€-é¾Ÿ][ä¸€-é¾Ÿ]+[ï¼š:]/) || // ä¸­æ–‡å¥å­æ¨¡å¼
                                                 message.length > 200; // å¾ˆé•¿çš„æ¶ˆæ¯é€šå¸¸ä¸æ˜¯å·¥å…·è¾“å‡º
                        
                        return !isNonToolContent;
                    }
                }
                
                return isToolOutput;
            }
            
            return false;
        }

        function addFunctionCallMessage(toolMatch, shouldScroll) {
            if (toolMatch.type === 'function_calls_start') {
                // å¼€å§‹æ”¶é›†å·¥å…·è°ƒç”¨å†…å®¹
                insideFunctionCalls = true;
                
                // å¦‚æœæœ‰ä¹‹å‰çš„å·¥å…·è°ƒç”¨ï¼Œå…ˆå®Œæˆå®ƒ
                if (currentFunctionCall) {
                    finalizeFunctionCallMessage(shouldScroll);
                }
                
                currentFunctionCall = {
                    toolNames: [],
                    status: 'calling',
                    element: null,
                    isActive: true
                };
                functionCallBuffer = []; // ä¸åŒ…å«å¼€å§‹æ ‡ç­¾æœ¬èº«
                
                // æ¸…é™¤æ¶ˆæ¯å¼•ç”¨ï¼Œç¡®ä¿åç»­æ¶ˆæ¯åˆ›å»ºæ–°çš„æ¶ˆæ¯æ¡†
                lastMessageType = null;
                lastMessageDiv = null;
                
            } else if (toolMatch.type === 'function_calls_end') {
                // ç»“æŸæ”¶é›†å·¥å…·è°ƒç”¨å†…å®¹
                insideFunctionCalls = false;
                
                if (currentFunctionCall) {
                    currentFunctionCall.status = 'completed';
                    currentFunctionCall.isActive = false;
                    
                    // åˆ›å»ºæˆ–æ›´æ–°UI
                    if (!currentFunctionCall.element) {
                        createOrUpdateFunctionCallUI(shouldScroll);
                    } else {
                        // æœ€ç»ˆæ›´æ–°çŠ¶æ€
                        createOrUpdateFunctionCallUI(shouldScroll);
                    }
                    
                    // ç«‹å³å®Œæˆå·¥å…·è°ƒç”¨æ¶ˆæ¯ï¼Œä¸å»¶è¿Ÿ
                    finalizeFunctionCallMessage(shouldScroll);
                }
                
                // æ¸…é™¤æ¶ˆæ¯å¼•ç”¨ï¼Œç¡®ä¿åç»­æ¶ˆæ¯åˆ›å»ºæ–°çš„æ¶ˆæ¯æ¡†
                lastMessageType = null;
                lastMessageDiv = null;
            }
        }

        function addToolMessage(toolMatch, shouldScroll) {
            if (toolMatch.type === 'tool_start') {
                // å¼€å§‹æ–°çš„å·¥å…·æ¶ˆæ¯
                if (currentToolMessage) {
                    // å®Œæˆä¹‹å‰çš„å·¥å…·æ¶ˆæ¯
                    finalizeToolMessage(shouldScroll);
                }
                
                currentToolMessage = {
                    toolNumber: toolMatch.toolNumber,
                    toolName: toolMatch.toolName,
                    params: '',
                    content: [],
                    status: 'running',
                    element: null,
                    isActive: true  // æ ‡è®°å·¥å…·æ¡†æ˜¯å¦è¿˜åœ¨æ¥æ”¶æ¶ˆæ¯
                };
                toolMessageBuffer = []; // ä¸åŒ…å«æ ‡ç­¾æœ¬èº«
                
                // ç«‹å³æ¸…é™¤æœ€åä¸€ä¸ªæ¶ˆæ¯çš„å¼•ç”¨ï¼Œç¡®ä¿å·¥å…·æ¡†åˆ›å»ºåçš„æ–°æ¶ˆæ¯åˆ›å»ºæ–°çš„æ¶ˆæ¯æ¡†
                lastMessageType = null;
                lastMessageDiv = null;
                
                // ä¸ç«‹å³åˆ›å»ºUIï¼Œç­‰å¾…æ”¶é›†ä¸€äº›å†…å®¹åå†åˆ›å»º
                
            } else if (toolMatch.type === 'tool_end' && currentToolMessage) {
                // å·¥å…·æ‰§è¡Œç»“æŸï¼Œä½†å»¶è¿Ÿè®¾ç½®isActiveä¸ºfalseï¼Œç¡®ä¿å·¥å…·ç»“æœèƒ½è¢«åŒ…å«è¿›æ¥
                currentToolMessage.status = 'completed';
                
                // å¦‚æœè¿˜æ²¡æœ‰åˆ›å»ºUIï¼Œç°åœ¨åˆ›å»º
                if (!currentToolMessage.element) {
                    createOrUpdateToolMessageUI(shouldScroll);
                }
                
                // å»¶è¿Ÿè®¾ç½®å·¥å…·æ¡†ä¸ºéæ´»è·ƒçŠ¶æ€ï¼Œç»™å·¥å…·ç»“æœä¸€äº›æ—¶é—´è¢«åŒ…å«è¿›æ¥
                setTimeout(() => {
                    if (currentToolMessage) {
                        currentToolMessage.isActive = false;
                        // æ¸…é™¤æœ€åä¸€ä¸ªæ¶ˆæ¯çš„å¼•ç”¨ï¼Œç¡®ä¿åç»­æ¶ˆæ¯åˆ›å»ºæ–°çš„æ¶ˆæ¯æ¡†
                        lastMessageType = null;
                        lastMessageDiv = null;
                        
                        // å®Œæˆå·¥å…·æ¶ˆæ¯
                        finalizeToolMessage(shouldScroll);
                    }
                }, 500); // å¢åŠ å»¶è¿Ÿæ—¶é—´åˆ°500msï¼Œç¡®ä¿å·¥å…·ç»“æœèƒ½è¢«åŒ…å«
                
            } else if (currentToolMessage && currentToolMessage.isActive) {
                // åªæœ‰åœ¨å·¥å…·æ¡†è¿˜åœ¨æ´»è·ƒçŠ¶æ€æ—¶æ‰æ·»åŠ å†…å®¹åˆ°ç¼“å†²åŒº
                if (toolMatch.type === 'executing') {
                    // æ·»åŠ æ‰§è¡Œä¿¡æ¯ï¼ˆåœ¨tool_startä¹‹åï¼‰
                    if (toolMatch.fullMessage.trim() !== '```' && toolMatch.fullMessage.trim() !== '```xml') {
                        toolMessageBuffer.push(toolMatch.fullMessage);
                    }
                    // ç¬¬ä¸€æ¬¡æ”¶åˆ°æ‰§è¡Œä¿¡æ¯æ—¶åˆ›å»ºUI
                    if (!currentToolMessage.element) {
                        createOrUpdateToolMessageUI(shouldScroll);
                    }
                    
                } else if (toolMatch.type === 'detail') {
                    // æ·»åŠ å‚æ•°ä¿¡æ¯
                    currentToolMessage.params = toolMatch.params;
                    if (toolMatch.fullMessage.trim() !== '```' && toolMatch.fullMessage.trim() !== '```xml') {
                        toolMessageBuffer.push(toolMatch.fullMessage);
                    }
                    if (!currentToolMessage.element) {
                        createOrUpdateToolMessageUI(shouldScroll);
                    } else {
                        createOrUpdateToolMessageUI(shouldScroll);
                    }
                    
                } else if (toolMatch.type === 'result_start') {
                    // å·¥å…·æ‰§è¡Œç»“æœå¼€å§‹
                    if (toolMatch.fullMessage.trim() !== '```' && toolMatch.fullMessage.trim() !== '```xml') {
                        toolMessageBuffer.push(toolMatch.fullMessage);
                    }
                    if (!currentToolMessage.element) {
                        createOrUpdateToolMessageUI(shouldScroll);
                    } else {
                        createOrUpdateToolMessageUI(shouldScroll);
                    }
                    
                } else if (toolMatch.type === 'status') {
                    // æ›´æ–°çŠ¶æ€
                    const newStatus = toolMatch.status === 'success' ? 'completed' : 'error';
                    if (currentToolMessage.status !== 'completed') {
                        currentToolMessage.status = newStatus;
                    }
                    if (toolMatch.fullMessage.trim() !== '```' && toolMatch.fullMessage.trim() !== '```xml') {
                        toolMessageBuffer.push(toolMatch.fullMessage);
                    }
                    if (!currentToolMessage.element) {
                        createOrUpdateToolMessageUI(shouldScroll);
                    } else {
                        createOrUpdateToolMessageUI(shouldScroll);
                    }
                    
                } else if (['tool_info', 'file_info', 'content_start', 'separator', 'tool_desc', 'structured_data', 'array_data', 'array_end', 'results_start', 'result_item'].includes(toolMatch.type)) {
                    // æ·»åŠ å·¥å…·ä¿¡æ¯åˆ°ç¼“å†²åŒº
                    if (toolMatch.fullMessage.trim() !== '```' && toolMatch.fullMessage.trim() !== '```xml') {
                        toolMessageBuffer.push(toolMatch.fullMessage);
                    }
                    if (!currentToolMessage.element) {
                        createOrUpdateToolMessageUI(shouldScroll);
                    } else {
                        createOrUpdateToolMessageUI(shouldScroll);
                    }
                    
                } else {
                    // å…¶ä»–ç±»å‹çš„æ¶ˆæ¯
                    if (toolMatch.fullMessage.trim() !== '```' && toolMatch.fullMessage.trim() !== '```xml') {
                        toolMessageBuffer.push(toolMatch.fullMessage);
                    }
                    if (!currentToolMessage.element) {
                        createOrUpdateToolMessageUI(shouldScroll);
                    } else {
                        createOrUpdateToolMessageUI(shouldScroll);
                    }
                }
            }
            // å¦‚æœå·¥å…·æ¡†ä¸å†æ´»è·ƒï¼ˆisActiveä¸ºfalseï¼‰ï¼Œåˆ™ä¸å†å‘å·¥å…·æ¡†æ·»åŠ ä»»ä½•å†…å®¹
            // è¿™äº›æ¶ˆæ¯å°†ä½œä¸ºæ™®é€šæ¶ˆæ¯æ˜¾ç¤ºåœ¨å·¥å…·æ¡†ä¹‹å
        }

        // å·¥å…·åç§°çš„ä¸­è‹±æ–‡æ˜ å°„
        const TOOL_DISPLAY_NAMES = {
            'read_file': {
                'zh': 'è¯»å–æ–‡ä»¶',
                'en': 'Read File'
            },
            'edit_file': {
                'zh': 'ç¼–è¾‘æ–‡ä»¶',
                'en': 'Edit File'
            },
            'codebase_search': {
                'zh': 'ä»£ç æœç´¢',
                'en': 'Code Search'
            },
            'web_search': {
                'zh': 'ç½‘ç»œæœç´¢',
                'en': 'Web Search'
            },
            'grep_search': {
                'zh': 'æ–‡æœ¬æœç´¢',
                'en': 'Text Search'
            },
            'file_search': {
                'zh': 'æ–‡ä»¶æœç´¢',
                'en': 'File Search'
            },
            'list_dir': {
                'zh': 'åˆ—è¡¨ç›®å½•',
                'en': 'List Directory'
            },
            'run_terminal_cmd': {
                'zh': 'å‘½ä»¤',
                'en': 'Command'
            },
            'delete_file': {
                'zh': 'åˆ é™¤æ–‡ä»¶',
                'en': 'Delete File'
            },
            'create_diagram': {
                'zh': 'åˆ›å»ºå›¾è¡¨',
                'en': 'Create Diagram'
            },
            'edit_notebook': {
                'zh': 'ç¼–è¾‘ç¬”è®°æœ¬',
                'en': 'Edit Notebook'
            },
            'search_replace': {
                'zh': 'æœç´¢æ›¿æ¢',
                'en': 'Search Replace'
            },
            'reapply': {
                'zh': 'é‡æ–°åº”ç”¨',
                'en': 'Reapply'
            }
        };

        // è·å–å·¥å…·çš„æ˜¾ç¤ºåç§°
        function getToolDisplayName(toolName) {
            const lang = CURRENT_LANG || 'zh';
            const displayNames = TOOL_DISPLAY_NAMES[toolName];
            return displayNames ? displayNames[lang] : toolName;
        }

        // æå–å·¥å…·å…³é”®å‚æ•°çš„ç»Ÿä¸€å‡½æ•°
        function extractToolKeyInfo(toolName, content) {
            if (!content || !toolName) return '';
            
            try {
                const contentStr = typeof content === 'string' ? content : content.join('\n');
                
                switch (toolName.toLowerCase()) {
                    case 'read_file':
                    case 'edit_file':
                        // æå–æ–‡ä»¶è·¯å¾„
                        const fileMatch = contentStr.match(/<parameter name="target_file">\s*([^<]+)\s*<\/parameter>/i) ||
                                         contentStr.match(/target_file['":\s]*([^,}\n]+)/i) ||
                                         contentStr.match(/file_path['":\s]*([^,}\n]+)/i);
                        if (fileMatch) {
                            const filePath = fileMatch[1].replace(/['"]/g, '').trim();
                            const fileName = filePath.split('/').pop() || filePath;
                            return `: ${fileName}`;
                        }
                        break;
                        
                    case 'codebase_search':
                        // æå–æœç´¢æŸ¥è¯¢
                        const codeSearchMatch = contentStr.match(/<parameter name="query">\s*([^<]+)\s*<\/parameter>/i) ||
                                               contentStr.match(/query['":\s]*([^,}\n]+)/i);
                        if (codeSearchMatch) {
                            const query = codeSearchMatch[1].replace(/['"]/g, '').trim();
                            return `: "${query}"`;
                        }
                        break;
                        
                    case 'web_search':
                        // æå–æœç´¢è¯
                        const webSearchMatch = contentStr.match(/<parameter name="search_term">\s*([^<]+)\s*<\/parameter>/i) ||
                                              contentStr.match(/search_term['":\s]*([^,}\n]+)/i);
                        if (webSearchMatch) {
                            const searchTerm = webSearchMatch[1].replace(/['"]/g, '').trim();
                            return `: "${searchTerm}"`;
                        }
                        break;
                        
                    case 'grep_search':
                        // æå–æœç´¢æ¨¡å¼
                        const grepMatch = contentStr.match(/<parameter name="query">\s*([^<]+)\s*<\/parameter>/i) ||
                                         contentStr.match(/query['":\s]*([^,}\n]+)/i);
                        if (grepMatch) {
                            const pattern = grepMatch[1].replace(/['"]/g, '').trim();
                            return `: "${pattern}"`;
                        }
                        break;
                        
                    case 'file_search':
                        // æå–æ–‡ä»¶æœç´¢æŸ¥è¯¢
                        const fileSearchMatch = contentStr.match(/<parameter name="query">\s*([^<]+)\s*<\/parameter>/i) ||
                                               contentStr.match(/query['":\s]*([^,}\n]+)/i);
                        if (fileSearchMatch) {
                            const query = fileSearchMatch[1].replace(/['"]/g, '').trim();
                            return `: "${query}"`;
                        }
                        break;
                        
                    case 'list_dir':
                        // æå–ç›®å½•è·¯å¾„
                        const dirMatch = contentStr.match(/<parameter name="relative_workspace_path">\s*([^<]+)\s*<\/parameter>/i);
                        if (dirMatch) {
                            let dirPath = dirMatch[1].trim();
                            // æ¸…ç†å¼•å·å’Œç‰¹æ®Šå­—ç¬¦
                            dirPath = dirPath.replace(/^["']|["']$/g, '').replace(/[\[\]]/g, '');
                            return dirPath ? `: ${dirPath}` : ': .';
                        }
                        // å¦‚æœXMLæ ¼å¼æ²¡åŒ¹é…åˆ°ï¼Œå°è¯•ç®€å•çš„é”®å€¼å¯¹æ ¼å¼
                        const simpleMatch = contentStr.match(/relative_workspace_path.*?["']([^"']+)["']/i);
                        if (simpleMatch) {
                            return simpleMatch[1] ? `: ${simpleMatch[1]}` : ': .';
                        }
                        break;
                        
                    case 'run_terminal_cmd':
                        // æå–å‘½ä»¤
                        const cmdMatch = contentStr.match(/<parameter name="command">\s*([^<]+)\s*<\/parameter>/i) ||
                                        contentStr.match(/command['":\s]*([^,}\n]+)/i);
                        if (cmdMatch) {
                            const command = cmdMatch[1].replace(/['"]/g, '').trim();
                            // åªæ˜¾ç¤ºå‘½ä»¤çš„å‰30ä¸ªå­—ç¬¦
                            const shortCmd = command.length > 30 ? command.substring(0, 30) + '...' : command;
                            return `: ${shortCmd}`;
                        }
                        break;
                }
            } catch (e) {
                console.log('Error extracting tool key info:', e);
            }
            
            return '';
        }

        // ä¸ºå·¥å…·æ‰§è¡Œæ¡†ç”Ÿæˆä¼˜åŒ–çš„æ˜¾ç¤ºåç§°
        function getOptimizedToolName(toolName, params) {
            if (!toolName) return '';
            
            const lang = CURRENT_LANG || 'zh';
            const prefix = lang === 'zh' ? 'æ‰§è¡Œ' : 'Executing';
            const displayName = getToolDisplayName(toolName);
            const keyInfo = extractToolKeyInfo(toolName, params);
            return `${prefix} ${displayName}${keyInfo}`;
        }

        // ä¸ºå·¥å…·è°ƒç”¨æ¡†ç”Ÿæˆä¼˜åŒ–çš„æ˜¾ç¤ºåç§°
        function getOptimizedFunctionCallName(toolNames, buffer) {
            const lang = CURRENT_LANG || 'zh';
            const prefix = lang === 'zh' ? 'è°ƒç”¨' : 'Calling';
            
            if (!toolNames || toolNames.length === 0) {
                return prefix;
            }
            
            if (toolNames.length === 1) {
                const displayName = getToolDisplayName(toolNames[0]);
                const keyInfo = extractToolKeyInfo(toolNames[0], buffer);
                return `${prefix} ${displayName}${keyInfo}`;
            } else {
                // å¤šä¸ªå·¥å…·æ—¶ï¼Œå°è¯•ä¸ºæ¯ä¸ªå·¥å…·æå–å…³é”®ä¿¡æ¯
                const toolInfos = toolNames.map(toolName => {
                    const displayName = getToolDisplayName(toolName);
                    const keyInfo = extractToolKeyInfo(toolName, buffer);
                    return `${displayName}${keyInfo}`;
                });
                
                // å¦‚æœæ€»é•¿åº¦ä¸è¶…è¿‡50å­—ç¬¦ï¼Œæ˜¾ç¤ºæ‰€æœ‰å·¥å…·ä¿¡æ¯
                const allInfo = toolInfos.join(', ');
                if (allInfo.length <= 50) {
                    return `${prefix} ${allInfo}`;
                } else {
                    const toolsText = lang === 'zh' ? 'ä¸ªå·¥å…·' : ' tools';
                    return `${prefix} ${toolNames.length}${toolsText}`;
                }
            }
        }

        function createOrUpdateToolMessageUI(shouldScroll) {
            if (!currentToolMessage.element) {
                // åˆ›å»ºå·¥å…·æ¶ˆæ¯å…ƒç´ 
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message tool';
                
                // åˆ›å»ºå¤´éƒ¨
                const header = document.createElement('div');
                header.className = 'tool-header';
                header.onclick = () => toggleToolContent(messageDiv);
                
                const headerLeft = document.createElement('div');
                headerLeft.className = 'tool-header-left';
                
                const icon = document.createElement('i');
                icon.className = 'fas fa-tools tool-icon';
                
                const toolName = document.createElement('span');
                toolName.className = 'tool-name';
                
                // ä½¿ç”¨ä¼˜åŒ–çš„å·¥å…·åç§°æ˜¾ç¤º
                toolName.textContent = getOptimizedToolName(currentToolMessage.toolName, currentToolMessage.params);
                
                headerLeft.appendChild(icon);
                headerLeft.appendChild(toolName);
                
                const toggle = document.createElement('i');
                toggle.className = 'fas fa-chevron-down tool-toggle';
                
                header.appendChild(headerLeft);
                header.appendChild(toggle);
                
                // åˆ›å»ºå†…å®¹åŒºåŸŸ
                const content = document.createElement('div');
                content.className = 'tool-content';
                
                const contentInner = document.createElement('div');
                contentInner.className = 'tool-content-inner';
                contentInner.textContent = toolMessageBuffer.join('\n');
                
                content.appendChild(contentInner);
                
                messageDiv.appendChild(header);
                messageDiv.appendChild(content);
                
                chatMessages.appendChild(messageDiv);
                currentToolMessage.element = messageDiv;
                
                // å·¥å…·æ¡†åˆ›å»ºåï¼Œç«‹å³æ¸…é™¤æ¶ˆæ¯å¼•ç”¨ï¼Œç¡®ä¿åç»­æ¶ˆæ¯åˆ›å»ºæ–°çš„æ¶ˆæ¯æ¡†
                lastMessageType = null;
                lastMessageDiv = null;
                
            } else {
                // æ›´æ–°ç°æœ‰å…ƒç´ 
                const contentInner = currentToolMessage.element.querySelector('.tool-content-inner');
                if (contentInner) {
                    contentInner.textContent = toolMessageBuffer.join('\n');
                }
                
                // çŠ¶æ€å›¾æ ‡å’Œå‚æ•°ä¿¡æ¯å·²ç§»é™¤ï¼Œä¸éœ€è¦æ›´æ–°
                
                // æ›´æ–°å·¥å…·åç§°
                const toolNameElement = currentToolMessage.element.querySelector('.tool-name');
                if (toolNameElement) {
                    toolNameElement.textContent = getOptimizedToolName(currentToolMessage.toolName, currentToolMessage.params);
                }
            }
            
            // æ»šåŠ¨å¤„ç†
            if (shouldScroll) {
                requestAnimationFrame(() => {
                    chatMessages.scrollTo({
                        top: chatMessages.scrollHeight,
                        behavior: 'smooth'
                    });
                });
            } else {
                showNewMessageIndicator();
            }
        }

        function finalizeToolMessage(shouldScroll) {
            if (currentToolMessage && currentToolMessage.element) {
                // æœ€ç»ˆæ›´æ–°å·¥å…·æ¶ˆæ¯
                createOrUpdateToolMessageUI(shouldScroll);
            }
            currentToolMessage = null;
            toolMessageBuffer = [];
            // æ¸…é™¤æœ€åä¸€ä¸ªæ¶ˆæ¯çš„å¼•ç”¨ï¼Œç¡®ä¿å·¥å…·å®Œæˆåçš„æ–°æ¶ˆæ¯åˆ›å»ºæ–°çš„æ¶ˆæ¯æ¡†
            lastMessageType = null;
            lastMessageDiv = null;
        }

        function createOrUpdateFunctionCallUI(shouldScroll) {
            if (!currentFunctionCall.element) {
                // åˆ›å»ºå·¥å…·è°ƒç”¨æ¶ˆæ¯å…ƒç´ 
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message function-call';
                
                // åˆ›å»ºå¤´éƒ¨
                const header = document.createElement('div');
                header.className = 'function-call-header';
                header.onclick = () => toggleFunctionCallContent(messageDiv);
                
                const headerLeft = document.createElement('div');
                headerLeft.className = 'function-call-header-left';
                
                const icon = document.createElement('i');
                icon.className = 'fas fa-code function-call-icon';
                
                const toolName = document.createElement('span');
                toolName.className = 'function-call-name';
                
                // ä½¿ç”¨ä¼˜åŒ–çš„å·¥å…·è°ƒç”¨åç§°æ˜¾ç¤º
                toolName.textContent = getOptimizedFunctionCallName(currentFunctionCall.toolNames, functionCallBuffer);
                
                const status = document.createElement('span');
                const statusClass = currentFunctionCall.status === 'completed' ? 'success' : 'calling';
                status.className = `function-call-status ${statusClass}`;
                status.textContent = currentFunctionCall.status === 'completed' ? 'ğŸ“¤' : 'ğŸ“';
                
                headerLeft.appendChild(icon);
                headerLeft.appendChild(toolName);
                headerLeft.appendChild(status);
                
                const toggle = document.createElement('i');
                toggle.className = 'fas fa-chevron-down function-call-toggle';
                
                header.appendChild(headerLeft);
                header.appendChild(toggle);
                
                // åˆ›å»ºå†…å®¹åŒºåŸŸ
                const content = document.createElement('div');
                content.className = 'function-call-content';
                
                const contentInner = document.createElement('div');
                contentInner.className = 'function-call-content-inner';
                contentInner.textContent = functionCallBuffer.join('\n');
                
                content.appendChild(contentInner);
                
                messageDiv.appendChild(header);
                messageDiv.appendChild(content);
                
                chatMessages.appendChild(messageDiv);
                currentFunctionCall.element = messageDiv;
                
                // å·¥å…·è°ƒç”¨æ¡†åˆ›å»ºåï¼Œç«‹å³æ¸…é™¤æ¶ˆæ¯å¼•ç”¨ï¼Œç¡®ä¿åç»­æ¶ˆæ¯åˆ›å»ºæ–°çš„æ¶ˆæ¯æ¡†
                lastMessageType = null;
                lastMessageDiv = null;
                
            } else {
                // æ›´æ–°ç°æœ‰å…ƒç´ 
                const contentInner = currentFunctionCall.element.querySelector('.function-call-content-inner');
                if (contentInner) {
                    contentInner.textContent = functionCallBuffer.join('\n');
                }
                
                // æ›´æ–°çŠ¶æ€
                const status = currentFunctionCall.element.querySelector('.function-call-status');
                if (status) {
                    const statusClass = currentFunctionCall.status === 'completed' ? 'success' : 'calling';
                    status.className = `function-call-status ${statusClass}`;
                    status.textContent = currentFunctionCall.status === 'completed' ? 'ğŸ“¤' : 'ğŸ“';
                }
                
                // æ›´æ–°å·¥å…·åç§°
                const toolName = currentFunctionCall.element.querySelector('.function-call-name');
                if (toolName) {
                    toolName.textContent = getOptimizedFunctionCallName(currentFunctionCall.toolNames, functionCallBuffer);
                }
            }
            
            // æ»šåŠ¨å¤„ç†
            if (shouldScroll) {
                requestAnimationFrame(() => {
                    chatMessages.scrollTo({
                        top: chatMessages.scrollHeight,
                        behavior: 'smooth'
                    });
                });
            } else {
                showNewMessageIndicator();
            }
        }

        function finalizeFunctionCallMessage(shouldScroll) {
            if (currentFunctionCall && currentFunctionCall.element) {
                // æœ€ç»ˆæ›´æ–°å·¥å…·è°ƒç”¨æ¶ˆæ¯
                createOrUpdateFunctionCallUI(shouldScroll);
            }
            
            // å®Œå…¨é‡ç½®æ‰€æœ‰å·¥å…·è°ƒç”¨ç›¸å…³çŠ¶æ€
            currentFunctionCall = null;
            functionCallBuffer = [];
            insideFunctionCalls = false;
            
            // æ¸…é™¤æœ€åä¸€ä¸ªæ¶ˆæ¯çš„å¼•ç”¨ï¼Œç¡®ä¿å·¥å…·è°ƒç”¨å®Œæˆåçš„æ–°æ¶ˆæ¯åˆ›å»ºæ–°çš„æ¶ˆæ¯æ¡†
            lastMessageType = null;
            lastMessageDiv = null;
        }

        function toggleFunctionCallContent(messageElement) {
            const content = messageElement.querySelector('.function-call-content');
            const toggle = messageElement.querySelector('.function-call-toggle');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                toggle.classList.remove('expanded');
            } else {
                content.classList.add('expanded');
                toggle.classList.add('expanded');
            }
        }

        function toggleToolContent(messageElement) {
            const content = messageElement.querySelector('.tool-content');
            const toggle = messageElement.querySelector('.tool-toggle');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                toggle.classList.remove('expanded');
            } else {
                content.classList.add('expanded');
                toggle.classList.add('expanded');
            }
        }

        // çŠ¶æ€æ›´æ–°
        function updateStatus(status) {
            const indicator = statusIndicator;
            indicator.className = 'status-indicator';
            
            if (status === 'connected') {
                indicator.style.background = '#4CAF50';
            } else if (status === 'running') {
                indicator.style.background = '#007acc';
            } else if (status === 'disconnected') {
                indicator.style.background = '#F44336';
            }
        }

        function setTaskRunning(running) {
            isTaskRunning = running;
            userInput.disabled = running;
            
            if (running) {
                sendButton.style.display = 'none';
                planButton.style.display = 'none';
                newTaskButton.style.display = 'none';
                stopButton.style.display = 'flex';
                updateStatus('running');
            } else {
                sendButton.style.display = 'flex';
                planButton.style.display = 'flex';
                newTaskButton.style.display = 'flex';
                stopButton.style.display = 'none';
                updateStatus('connected');
            }
        }

        // è¾“å…¥å¤„ç†
        function sendMessage(planMode = false) {
            const message = userInput.value.trim();
            if (!message || isTaskRunning) return;

            // åœ¨æ–°å»ºæ¨¡å¼ä¸‹ï¼Œæç¤ºç”¨æˆ·å…ˆåˆ›å»ºæˆ–é€‰æ‹©ç›®å½•
            if (taskMode === 'new') {
                addMessage(I18N.create_or_select_directory, 'error');
                return;
            }

            // æ˜¾ç¤ºæ‰§è¡Œæ¨¡å¼ä¿¡æ¯
            let modeInfo = '';
            if (planMode) {
                modeInfo = I18N.plan_mode_suffix;
                addMessage(`${message}${modeInfo}`, 'user');
                addMessage(I18N.plan_mode_info, 'info');
            } else {
                addMessage(message, 'user');
                addMessage(I18N.direct_mode_info, 'info');
            }
            
            if (taskMode === 'selected' && selectedDirectory) {
                socket.emit('execute_task', {
                    requirement: message,
                    type: 'selected',
                    plan_mode: planMode
                });
            } else {
                socket.emit('execute_task', {
                    requirement: message,
                    type: 'continue',
                    plan_mode: planMode
                });
            }

            userInput.value = '';
            resizeTextarea();
        }

        function createNewDirectory() {
            if (isTaskRunning) return;
            
            socket.emit('create_new_directory');
        }

        function executeSelectedTask() {
            const message = userInput.value.trim();
            if (!message || isTaskRunning) return;

            if (!selectedDirectory) {
                addMessage(I18N.select_directory_first, 'error');
                return;
            }

            addMessage(message, 'user');
            
            socket.emit('execute_task', {
                requirement: message,
                type: 'selected'
            });

            userInput.value = '';
            resizeTextarea();
        }

        function selectDirectory(dirName) {
            // å¦‚æœå·²ç»é€‰æ‹©äº†ç›¸åŒçš„ç›®å½•ï¼Œä¸éœ€è¦é‡å¤æ“ä½œ
            if (selectedDirectory === dirName) {
                console.log(`ğŸ“Œ Directory ${dirName} already selected`);
                return;
            }
            
            console.log(`ğŸ¯ Selecting directory: ${dirName}`);
            selectedDirectory = dirName;
            
            // åˆ‡æ¢åˆ°é€‰æ‹©ç›®å½•æ¨¡å¼
            taskMode = 'selected';
            
            // åªé€‰æ‹©ç›®å½•ï¼Œä¸è‡ªåŠ¨åˆ‡æ¢å±•å¼€çŠ¶æ€
            socket.emit('select_directory', {
                dir_name: dirName
            });
            
            // æ›´æ–°UIæ˜¾ç¤ºé€‰ä¸­çŠ¶æ€ï¼Œä½†ä¸åˆ·æ–°æ•´ä¸ªåˆ—è¡¨
            document.querySelectorAll('.directory-item').forEach(item => {
                item.classList.remove('selected');
            });
            const selectedItem = document.querySelector(`[data-dir="${dirName}"]`);
            if (selectedItem) {
                selectedItem.classList.add('selected');
            }
            
            // æ›´æ–°ä»»åŠ¡æ¨¡å¼ä¿¡æ¯
            updateTaskModeInfo();
            
            console.log(`âœ… Directory selected: ${dirName}, mode: ${taskMode}`);
        }

        function updateTaskModeInfo() {
            const taskModeInfo = document.getElementById('taskModeInfo');
            let baseInfo = '';
            
            if (taskMode === 'selected' && selectedDirectory) {
                baseInfo = `<i class="fas fa-info-circle"></i> ${I18N.selected_dir_info}: <strong>${selectedDirectory}</strong>`;
                taskModeInfo.style.color = '#569cd6';
            } else if (taskMode === 'continue') {
                baseInfo = `<i class="fas fa-info-circle"></i> ${I18N.continue_mode_info}`;
                taskModeInfo.style.color = '#9cdcfe';
            } else if (taskMode === 'new') {
                baseInfo = `<i class="fas fa-plus-circle"></i> ${I18N.new_mode_info}`;
                taskModeInfo.style.color = '#4CAF50';
            } else {
                baseInfo = `<i class="fas fa-plus-circle"></i> ${I18N.create_or_select_directory}`;
                taskModeInfo.style.color = '#9cdcfe';
            }
            
            taskModeInfo.innerHTML = baseInfo;
        }

        function resizeTextarea() {
            userInput.style.height = 'auto';
            userInput.style.height = Math.min(userInput.scrollHeight, 120) + 'px';
        }

        // äº‹ä»¶ç›‘å¬
        sendButton.addEventListener('click', () => sendMessage(false));

        planButton.addEventListener('click', () => sendMessage(true));

        newTaskButton.addEventListener('click', createNewDirectory);

        stopButton.addEventListener('click', function() {
            socket.emit('stop_task');
        });

        userInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage(false); // Default to direct execution mode
            }
        });

        userInput.addEventListener('input', resizeTextarea);

        // èŠå¤©æ»šåŠ¨è¡Œä¸ºç®¡ç†
        let scrollTimeout;
        let lastScrollTop = 0;
        let scrollDirection = 'down'; // 'up' æˆ– 'down'
        
        chatMessages.addEventListener('scroll', function() {
            // æ¸…é™¤ä¹‹å‰çš„è¶…æ—¶
            clearTimeout(scrollTimeout);
            
            // æ£€æµ‹æ»šåŠ¨æ–¹å‘
            const currentScrollTop = chatMessages.scrollTop;
            scrollDirection = currentScrollTop > lastScrollTop ? 'down' : 'up';
            lastScrollTop = currentScrollTop;
            
            // æ ‡è®°ç”¨æˆ·æ­£åœ¨æ»šåŠ¨
            isUserScrolling = true;
            
            // æ£€æŸ¥æ˜¯å¦æ»šåŠ¨åˆ°åº•éƒ¨é™„è¿‘
            const threshold = 20;
            const isNearBottom = chatMessages.scrollTop + chatMessages.clientHeight >= chatMessages.scrollHeight - threshold;
            
            // æ™ºèƒ½è‡ªåŠ¨æ»šåŠ¨æ§åˆ¶
            if (isNearBottom) {
                // ç”¨æˆ·æ»šåŠ¨åˆ°åº•éƒ¨é™„è¿‘ï¼Œå¯ç”¨è‡ªåŠ¨æ»šåŠ¨
                if (!autoScrollEnabled) {
                    autoScrollEnabled = true;
                    updateAutoScrollIndicator();
                    console.log('ğŸ”„ User scrolled to bottom, enabling auto-scroll');
                }
                hideScrollToBottomHint();
            } else {
                // ç”¨æˆ·æ˜ç¡®å‘ä¸Šæ»šåŠ¨ä¸”è·ç¦»åº•éƒ¨è¾ƒè¿œæ—¶ï¼Œç¦ç”¨è‡ªåŠ¨æ»šåŠ¨
                const farFromBottom = chatMessages.scrollTop + chatMessages.clientHeight < chatMessages.scrollHeight - 100;
                if (autoScrollEnabled && scrollDirection === 'up' && farFromBottom) {
                    autoScrollEnabled = false;
                    updateAutoScrollIndicator();
                    console.log('â¬†ï¸ User scrolled up away from bottom, disabling auto-scroll');
                }
                
                // åªæœ‰åœ¨ä¸æ˜¯è‡ªåŠ¨æ»šåŠ¨çŠ¶æ€æ—¶æ‰æ˜¾ç¤ºæ»šåŠ¨æç¤º
                if (!autoScrollEnabled) {
                    showScrollToBottomHint();
                }
            }
            
            // 150msåé‡ç½®æ»šåŠ¨çŠ¶æ€ï¼ˆè¿›ä¸€æ­¥å‡å°‘å»¶è¿Ÿä»¥æé«˜è‡ªåŠ¨æ»šåŠ¨å“åº”æ€§ï¼‰
            scrollTimeout = setTimeout(() => {
                isUserScrolling = false;
            }, 150);
        });

        // æ»šåŠ¨æç¤ºç®¡ç†
        function showScrollToBottomHint() {
            const scrollBtn = document.getElementById('scrollToBottomBtn');
            if (scrollBtn && !scrollBtn.classList.contains('show')) {
                scrollBtn.classList.add('show');
            }
        }

        function hideScrollToBottomHint() {
            const scrollBtn = document.getElementById('scrollToBottomBtn');
            if (scrollBtn && scrollBtn.classList.contains('show')) {
                scrollBtn.classList.remove('show');
            }
            hideNewMessageIndicator(); // åŒæ—¶éšè—æ–°æ¶ˆæ¯æç¤º
        }

        function showNewMessageIndicator() {
            if (!autoScrollEnabled) {
                newMessageCount++;
                const indicator = document.getElementById('newMessageIndicator');
                const countSpan = document.getElementById('newMessageCount');
                if (indicator && countSpan) {
                    countSpan.textContent = newMessageCount;
                    indicator.classList.add('show');
                }
            }
        }

        function hideNewMessageIndicator() {
            newMessageCount = 0;
            const indicator = document.getElementById('newMessageIndicator');
            if (indicator && indicator.classList.contains('show')) {
                indicator.classList.remove('show');
            }
        }

        // æ›´æ–°è‡ªåŠ¨æ»šåŠ¨çŠ¶æ€æŒ‡ç¤ºå™¨
        function updateAutoScrollIndicator() {
            if (autoScrollIndicator) {
                if (autoScrollEnabled) {
                    autoScrollIndicator.classList.remove('disabled');
                    autoScrollIndicator.innerHTML = `<i class="fas fa-arrow-down"></i><span>${I18N.auto_scroll}</span>`;
                } else {
                    autoScrollIndicator.classList.add('disabled');
                    autoScrollIndicator.innerHTML = `<i class="fas fa-pause"></i><span>${I18N.paused}</span>`;
                }
                console.log(`ğŸ”„ Auto-scroll status updated: ${autoScrollEnabled ? 'ENABLED' : 'DISABLED'}`);
            }
        }

        // æ»šåŠ¨åˆ°åº•éƒ¨åŠŸèƒ½
        function scrollToBottom(smooth = true) {
            if (smooth) {
                chatMessages.scrollTo({
                    top: chatMessages.scrollHeight,
                    behavior: 'smooth'
                });
            } else {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            autoScrollEnabled = true;
            updateAutoScrollIndicator();
            hideScrollToBottomHint();
        }

        // ç»‘å®šæ»šåŠ¨åˆ°åº•éƒ¨æŒ‰é’®äº‹ä»¶
        document.getElementById('scrollToBottomBtn').addEventListener('click', () => {
            scrollToBottom(true);
        });

        // ç»‘å®šæ–°æ¶ˆæ¯æç¤ºç‚¹å‡»äº‹ä»¶
        document.getElementById('newMessageIndicator').addEventListener('click', () => {
            scrollToBottom(true);
        });

        // ç›®å½•ç®¡ç†
        function refreshDirectories() {
            // ä¿å­˜å½“å‰å±•å¼€çŠ¶æ€
            const currentExpanded = new Set(expandedDirectories);
            
            sidebarLoading.classList.add('show');
            directoryList.innerHTML = '';
            
            fetch('/api/output-dirs')
                .then(response => response.json())
                .then(data => {
                    sidebarLoading.classList.remove('show');
                    
                    if (data.success) {
                        // æ¢å¤å±•å¼€çŠ¶æ€
                        expandedDirectories = currentExpanded;
                        renderDirectories(data.directories);
                    } else {
                        directoryList.innerHTML = `
                            <div class="message error">
                                <i class="fas fa-exclamation-triangle"></i>
                                ${I18N.load_directory_failed}: ${data.error}
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    sidebarLoading.classList.remove('show');
                    directoryList.innerHTML = `
                        <div class="message error">
                            <i class="fas fa-exclamation-triangle"></i>
                            ${I18N.network_error}: ${error.message}
                        </div>
                    `;
                });
        }

        function renderDirectories(directories) {
            if (directories.length === 0) {
                directoryList.innerHTML = `
                    <div class="message system">
                        <i class="fas fa-folder-open"></i>
                        æš‚æ— å·¥ä½œç›®å½•ï¼ˆåŒ…å«workspaceå­ç›®å½•çš„ç›®å½•ï¼‰
                    </div>
                `;
                return;
            }

            directoryList.innerHTML = directories.map(dir => {
                let classes = ['directory-item'];
                let statusText = '';
                
                if (dir.is_current) {
                    classes.push('current');
                    statusText += '<span style="font-size: 0.8em; margin-left: 8px;">(å½“å‰æ‰§è¡Œ)</span>';
                }
                if (dir.is_selected) {
                    classes.push('selected');
                    statusText += '<span style="font-size: 0.8em; margin-left: 8px;">(å·²é€‰æ‹©)</span>';
                }
                if (dir.is_last && !dir.is_current && !dir.is_selected) {
                    classes.push('last');
                    statusText += '<span style="font-size: 0.8em; margin-left: 8px;">(ä¸Šæ¬¡ä½¿ç”¨)</span>';
                }
                
                // æ£€æŸ¥æ˜¯å¦åº”è¯¥å±•å¼€
                const isExpanded = expandedDirectories.has(dir.name);
                if (isExpanded) {
                    classes.push('expanded');
                }
                
                return `
                    <div class="${classes.join(' ')}" data-dir="${dir.name}">
                        <div class="directory-header">
                            <div class="directory-name" onclick="selectDirectory('${dir.name}')">
                                <i class="fas fa-folder"></i>
                                ${dir.name}
                                ${statusText}
                            </div>
                            <div class="directory-actions">
                                <button class="action-btn" onclick="return toggleDirectory('${dir.name}', event)" title="å±•å¼€/æ”¶èµ·">
                                    <i class="fas fa-chevron-${isExpanded ? 'up' : 'down'}"></i>
                                </button>
                                <button class="action-btn" onclick="event.stopPropagation(); showUploadModal('${dir.name}')" title="ä¸Šä¼ æ–‡ä»¶åˆ°Workspace">
                                    <i class="fas fa-upload"></i>
                                </button>
                                <button class="action-btn" onclick="event.stopPropagation(); downloadDirectory('${dir.name}')" title="ä¸‹è½½ç›®å½•ä¸ºZIPï¼ˆæ’é™¤workspace_code_indexï¼‰">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="action-btn rename-btn" onclick="event.stopPropagation(); showRenameDialog('${dir.name}')" title="é‡å‘½åç›®å½•">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn delete-btn" onclick="event.stopPropagation(); confirmDeleteDirectory('${dir.name}')" title="åˆ é™¤ç›®å½•">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="directory-info" onclick="selectDirectory('${dir.name}')">
                            <div><i class="fas fa-clock"></i> ${dir.modified_time}</div>
                            <div><i class="fas fa-hdd"></i> ${dir.size}</div>
                        </div>
                        <div class="file-tree ${isExpanded ? 'show' : ''}" id="tree-${dir.name}">
                            ${renderFileTree(dir.files, dir.name)}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderFileTree(files, dirName, indent = 0) {
            return files.map(file => {
                const icon = file.type === 'directory' ? 'fas fa-folder' : getFileIcon(file.name);
                const className = file.type === 'directory' ? 'file-item directory' : 'file-item';
                const sizeInfo = file.size ? ` (${file.size})` : '';
                const isPreviewable = file.type === 'file' && isFilePreviewable(file.name);
                const previewClass = isPreviewable ? ' previewable' : '';
                
                // æ£€æŸ¥æ˜¯å¦åœ¨ç‰¹å®šç›®å½•ä¸‹ï¼Œå¦‚æœæ˜¯åˆ™æ·»åŠ ç°è‰²æ ·å¼
                const isInSpecialDir = file.path && (
                    file.path.includes('/web_search_result/') || 
                    file.path.includes('/workspace_code_index/') ||
                    file.path.includes('\\web_search_result\\') || 
                    file.path.includes('\\workspace_code_index\\')
                );
                const grayedClass = (file.type === 'file' && isInSpecialDir) ? ' grayed' : '';
                
                // æ„é€ æ–‡ä»¶è·¯å¾„ - åç«¯ç°åœ¨è¿”å›ç›¸å¯¹è·¯å¾„
                let relativePath = '';
                if (file.path) {
                    // ç›´æ¥ä½¿ç”¨åç«¯è¿”å›çš„ç›¸å¯¹è·¯å¾„
                    relativePath = file.path;
                } else {
                    // å¦‚æœæ²¡æœ‰è·¯å¾„ï¼Œæ„é€ è·¯å¾„
                    relativePath = `${dirName}/${file.name}`;
                }
                
                // ä¸ºå­æ–‡ä»¶å¤¹ç”Ÿæˆå”¯ä¸€ID
                const subDirId = `${dirName}-${file.name}`;
                const hasChildren = file.children && file.children.length > 0;
                // å­æ–‡ä»¶å¤¹é»˜è®¤å±•å¼€ï¼Œåªæœ‰åœ¨collapsedSubDirectoriesä¸­çš„æ‰æ”¶èµ·
                const isSubDirExpanded = !collapsedSubDirectories.has(subDirId);
                
                let html = '';
                
                if (file.type === 'directory' && hasChildren) {
                    // å­æ–‡ä»¶å¤¹ï¼šå¸¦å±•å¼€/æ”¶èµ·åŠŸèƒ½
                    html = `
                        <div class="file-item directory" style="margin-left: ${indent * 20}px; display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 8px; flex: 1; cursor: pointer;" 
                                 onclick="toggleSubDirectory('${subDirId}', event)">
                                <i class="${icon}"></i>
                                ${file.name}${sizeInfo}
                            </div>
                            <button class="sub-folder-toggle" onclick="toggleSubDirectory('${subDirId}', event)" 
                                    style="background: none; border: none; color: #9cdcfe; cursor: pointer; padding: 2px 6px; margin-right: 10px;">
                                <i class="fas fa-chevron-${isSubDirExpanded ? 'up' : 'down'}" style="font-size: 12px;"></i>
                            </button>
                        </div>
                        <div class="sub-file-tree ${isSubDirExpanded ? 'show' : ''}" id="subtree-${subDirId}">
                            ${renderFileTree(file.children, dirName, indent + 1)}
                        </div>
                    `;
                } else if (file.type === 'directory') {
                    // ç©ºæ–‡ä»¶å¤¹
                    html = `
                        <div class="${className}" style="margin-left: ${indent * 20}px">
                            <i class="${icon}"></i>
                            ${file.name}${sizeInfo}
                        </div>
                    `;
                } else {
                    // æ–‡ä»¶
                    html = `
                        <div class="${className}${previewClass}${grayedClass}" style="margin-left: ${indent * 20}px" 
                             ${isPreviewable ? `onclick="previewFile('${relativePath.replace(/'/g, "\\'")}', '${file.name.replace(/'/g, "\\'")}')"` : ''}>
                            <i class="${icon}"></i>
                            ${file.name}${sizeInfo}
                        </div>
                    `;
                }
                
                return html;
            }).join('');
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const iconMap = {
                'html': 'fab fa-html5',
                'htm': 'fab fa-html5',
                'css': 'fab fa-css3-alt',
                'js': 'fab fa-js-square',
                'py': 'fab fa-python',
                'md': 'fab fa-markdown',
                'json': 'fas fa-code',
                'txt': 'fas fa-file-alt',
                'log': 'fas fa-file-alt',
                'yaml': 'fas fa-code',
                'yml': 'fas fa-code'
            };
            return iconMap[ext] || 'fas fa-file';
        }

        function isFilePreviewable(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            return ['html', 'htm', 'md', 'markdown', 'py', 'js', 'jsx', 'ts', 'tsx', 'css', 'json', 
                    'txt', 'log', 'yaml', 'yml', 'pdf', 'c', 'cpp', 'cc', 'cxx', 'h', 'hpp', 
                    'java', 'go', 'rs', 'php', 'rb', 'sh', 'bash', 'zsh', 'fish', 'ps1', 'bat', 
                    'cmd', 'xml', 'sql', 'r', 'scala', 'kt', 'swift', 'dart', 'lua', 'perl', 'pl', 
                    'vim', 'dockerfile', 'makefile', 'cmake', 'gradle', 'properties', 'ini', 'cfg', 
                    'conf', 'toml', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'csv'].includes(ext);
        }

        function toggleDirectory(dirName, event) {
            // é˜»æ­¢äº‹ä»¶å†’æ³¡
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            
            console.log(`ğŸ”„ Toggle directory: ${dirName}`);
            console.log(`ğŸ” Event details:`, event);
            
            // è·å–DOMå…ƒç´ 
            const tree = document.getElementById(`tree-${dirName}`);
            const button = document.querySelector(`[data-dir="${dirName}"] .directory-actions button[title="å±•å¼€/æ”¶èµ·"]`);
            const icon = button ? button.querySelector('i') : null;
            
            console.log(`ğŸ” DOM elements:`, {
                tree: tree,
                treeId: `tree-${dirName}`,
                button: button,
                icon: icon,
                treeClasses: tree ? tree.className : 'null',
                treeStyle: tree ? tree.style.cssText : 'null'
            });
            
            if (!tree) {
                console.error(`âŒ Tree element not found: tree-${dirName}`);
                // å°è¯•æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„treeå…ƒç´ 
                const allTrees = document.querySelectorAll('[id^="tree-"]');
                console.log(`ğŸ” All tree elements found:`, Array.from(allTrees).map(t => t.id));
                return false;
            }
            
            // æ£€æŸ¥å½“å‰çŠ¶æ€
            const isCurrentlyExpanded = tree.classList.contains('show');
            console.log(`ğŸ“Š Current state: ${dirName} expanded = ${isCurrentlyExpanded}`);
            console.log(`ğŸ“Š Tree computed style:`, window.getComputedStyle(tree).display);
            
            if (isCurrentlyExpanded) {
                // æ”¶èµ·
                tree.classList.remove('show');
                expandedDirectories.delete(dirName);
                if (icon) {
                    icon.className = 'fas fa-chevron-down';
                }
                console.log(`ğŸ“¥ Collapsed: ${dirName}`);
                console.log(`ğŸ“¥ After collapse - display:`, window.getComputedStyle(tree).display);
            } else {
                // å±•å¼€
                tree.classList.add('show');
                expandedDirectories.add(dirName);
                if (icon) {
                    icon.className = 'fas fa-chevron-up';
                }
                console.log(`ğŸ“¤ Expanded: ${dirName}`);
                console.log(`ğŸ“¤ After expand - display:`, window.getComputedStyle(tree).display);
            }
            
            console.log(`âœ… Toggle complete. Tree classes: ${tree.className}`);
            console.log(`âœ… Expanded dirs: [${Array.from(expandedDirectories).join(', ')}]`);
            return false;
        }

        function toggleSubDirectory(subDirId, event) {
            // é˜»æ­¢äº‹ä»¶å†’æ³¡
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            
            console.log(`ğŸ”„ Toggle sub-directory: ${subDirId}`);
            
            // è·å–DOMå…ƒç´ 
            const subTree = document.getElementById(`subtree-${subDirId}`);
            const button = event.target.closest('.sub-folder-toggle');
            const icon = button ? button.querySelector('i') : null;
            
            console.log(`ğŸ” Sub-directory DOM elements:`, {
                subTree: subTree,
                subTreeId: `subtree-${subDirId}`,
                button: button,
                icon: icon,
                subTreeClasses: subTree ? subTree.className : 'null'
            });
            
            if (!subTree) {
                console.error(`âŒ Sub-tree element not found: subtree-${subDirId}`);
                return false;
            }
            
            // æ£€æŸ¥å½“å‰çŠ¶æ€
            const isCurrentlyExpanded = subTree.classList.contains('show');
            console.log(`ğŸ“Š Sub-directory current state: ${subDirId} expanded = ${isCurrentlyExpanded}`);
            
            if (isCurrentlyExpanded) {
                // æ”¶èµ·å­æ–‡ä»¶å¤¹
                subTree.classList.remove('show');
                collapsedSubDirectories.add(subDirId);
                if (icon) {
                    icon.className = 'fas fa-chevron-down';
                }
                console.log(`ğŸ“¥ Collapsed sub-directory: ${subDirId}`);
            } else {
                // å±•å¼€å­æ–‡ä»¶å¤¹
                subTree.classList.add('show');
                collapsedSubDirectories.delete(subDirId);
                if (icon) {
                    icon.className = 'fas fa-chevron-up';
                }
                console.log(`ğŸ“¤ Expanded sub-directory: ${subDirId}`);
            }
            
            console.log(`âœ… Sub-directory toggle complete. Classes: ${subTree.className}`);
            console.log(`âœ… Collapsed sub-dirs: [${Array.from(collapsedSubDirectories).join(', ')}]`);
            return false;
        }

        function downloadDirectory(dirName) {
            const link = document.createElement('a');
            link.href = `/api/download/${dirName}`;
            link.download = `${dirName}.zip`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }



        function confirmDeleteDirectory(dirName) {
            const isCurrentDir = document.querySelector(`[data-dir="${dirName}"]`).classList.contains('current');
            const isSelectedDir = document.querySelector(`[data-dir="${dirName}"]`).classList.contains('selected');
            
            let warningMessage = `ç¡®å®šè¦åˆ é™¤ç›®å½• "${dirName}" å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œå°†æ°¸ä¹…åˆ é™¤è¯¥ç›®å½•åŠå…¶æ‰€æœ‰å†…å®¹ã€‚`;
            
            if (isCurrentDir) {
                warningMessage += '\n\nâš ï¸ è­¦å‘Šï¼šè¿™æ˜¯å½“å‰æ­£åœ¨æ‰§è¡Œçš„ç›®å½•ï¼';
            }
            if (isSelectedDir) {
                warningMessage += '\n\nâš ï¸ è­¦å‘Šï¼šè¿™æ˜¯å½“å‰é€‰æ‹©çš„ç›®å½•ï¼';
            }
            
            if (confirm(warningMessage)) {
                deleteDirectory(dirName);
            }
        }

        function deleteDirectory(dirName) {
            console.log(`ğŸ—‘ï¸ Deleting directory: ${dirName}`);
            
            // æ˜¾ç¤ºåˆ é™¤ä¸­çŠ¶æ€
            const dirElement = document.querySelector(`[data-dir="${dirName}"]`);
            if (dirElement) {
                dirElement.style.opacity = '0.5';
                dirElement.style.pointerEvents = 'none';
                
                // åœ¨ç›®å½•ååæ·»åŠ åˆ é™¤ä¸­æç¤º
                const nameElement = dirElement.querySelector('.directory-name');
                if (nameElement && !nameElement.querySelector('.deleting-indicator')) {
                    const indicator = document.createElement('span');
                    indicator.className = 'deleting-indicator';
                    indicator.style.cssText = 'color: #ff6b6b; font-size: 0.8em; margin-left: 8px;';
                    indicator.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${I18N.deleting}`;
                    nameElement.appendChild(indicator);
                }
            }
            
            fetch(`/api/delete-directory/${dirName}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                console.log('ğŸ—‘ï¸ Delete response:', data);
                if (data.success) {
                    console.log(`âœ… Directory deleted successfully: ${dirName}`);
                    // ä»DOMä¸­ç§»é™¤ç›®å½•å…ƒç´ 
                    if (dirElement) {
                        dirElement.remove();
                    }
                    // æ¸…ç†ç›¸å…³çŠ¶æ€
                    expandedDirectories.delete(dirName);
                    // æ¸…ç†å­ç›®å½•çŠ¶æ€
                    Array.from(collapsedSubDirectories).forEach(subDirId => {
                        if (subDirId.startsWith(dirName + '-')) {
                            collapsedSubDirectories.delete(subDirId);
                        }
                    });
                    // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é€‰æ‹©çš„ç›®å½•ï¼Œæ¸…ç†çŠ¶æ€
                    if (selectedDirectory === dirName) {
                        selectedDirectory = null;
                        taskMode = 'continue';
                        updateTaskModeInfo();
                    }
                    
                    alert(`ç›®å½• "${dirName}" å·²æˆåŠŸåˆ é™¤`);
                } else {
                    console.error('âŒ Delete failed:', data.error);
                    alert(`åˆ é™¤å¤±è´¥: ${data.error}`);
                    // æ¢å¤ç›®å½•å…ƒç´ çŠ¶æ€
                    if (dirElement) {
                        dirElement.style.opacity = '1';
                        dirElement.style.pointerEvents = 'auto';
                        const indicator = dirElement.querySelector('.deleting-indicator');
                        if (indicator) {
                            indicator.remove();
                        }
                    }
                }
            })
            .catch(error => {
                console.error('âŒ Delete error:', error);
                alert(`åˆ é™¤å‡ºé”™: ${error.message}`);
                // æ¢å¤ç›®å½•å…ƒç´ çŠ¶æ€
                if (dirElement) {
                    dirElement.style.opacity = '1';
                    dirElement.style.pointerEvents = 'auto';
                    const indicator = dirElement.querySelector('.deleting-indicator');
                    if (indicator) {
                        indicator.remove();
                    }
                }
            });
        }

        // æ–‡ä»¶é¢„è§ˆåŠŸèƒ½
        function previewFile(filePath, fileName) {
            console.log('ğŸ” Preview file called with:', filePath, fileName);
            console.log('ğŸ” Preview modal elements:', {
                previewModal: previewModal,
                previewTitle: previewTitle,
                previewContent: previewContent
            });
            
            if (!previewModal || !previewTitle || !previewContent) {
                console.error('âŒ Preview modal elements not found');
                return;
            }
            
            // å­˜å‚¨å½“å‰æ–‡ä»¶è·¯å¾„ï¼Œç”¨äºOfficeé¢„è§ˆè¿”å›åŠŸèƒ½
            currentFilePath = filePath;
            
            previewTitle.textContent = `${I18N.preview}: ${fileName}`;
            previewContent.innerHTML = `<div style="text-align: center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> ${I18N.loading}</div>`;
            previewModal.style.display = 'block';
            
            console.log('ğŸ” Making API request to:', `/api/file/${filePath}`);

            fetch(`/api/file/${filePath}`)
                .then(response => {
                    console.log('ğŸ” API response status:', response.status, response.statusText);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('ğŸ” Preview response data:', data);
                    if (data.success) {
                        displayFileContent(data, fileName);
                    } else {
                        console.error('âŒ Preview failed:', data.error);
                        previewContent.innerHTML = `<div style="color: red; text-align: center; padding: 20px;">
                            <i class="fas fa-exclamation-triangle"></i> 
                            é¢„è§ˆå¤±è´¥: ${data.error}
                        </div>`;
                    }
                })
                .catch(error => {
                    console.error('âŒ Preview error:', error);
                    previewContent.innerHTML = `<div style="color: red; text-align: center; padding: 20px;">
                        <i class="fas fa-exclamation-triangle"></i> 
                        ${I18N.network_error}: ${error.message}
                    </div>`;
                });
        }

        function displayFileContent(data, fileName) {
            const { content, type, language, size, file_path } = data;
            
            if (type === 'html') {
                // å¤„ç†è½¬ä¹‰å­—ç¬¦ï¼Œç„¶åè½¬ä¹‰å¼•å·
                const processedContent = processFileContent(content).replace(/"/g, '&quot;');
                previewContent.innerHTML = `
                    <div style="background: #f8f8f8; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 12px; color: #666;">
                        æ–‡ä»¶å¤§å°: ${size} | ç±»å‹: HTML
                    </div>
                    <iframe srcdoc="${processedContent}" style="width: 100%; height: calc(90vh - 160px); border: none; border-radius: 4px; background: white;"></iframe>
                `;
            } else if (type === 'markdown') {
                // å¤„ç†è½¬ä¹‰å­—ç¬¦
                const processedContent = processFileContent(content);
                const htmlContent = marked.parse(processedContent);
                previewContent.innerHTML = `
                    <div style="background: #2d2d30; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 12px; color: #9cdcfe;">
                        æ–‡ä»¶å¤§å°: ${size} | ç±»å‹: Markdown
                    </div>
                    <div style="background: #1e1e1e; color: #cccccc; padding: 20px; border-radius: 5px; line-height: 1.6; max-height: calc(90vh - 160px); overflow-y: auto;">
                        ${htmlContent}
                    </div>
                `;
            } else if (type === 'pdf') {
                previewContent.innerHTML = `
                    <div style="background: #f8f8f8; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 12px; color: #666;">
                        æ–‡ä»¶å¤§å°: ${size} | ç±»å‹: PDF
                    </div>
                    <div id="pdfContainer" style="width: 100%; height: calc(90vh - 160px); border: 1px solid #ddd; border-radius: 4px; overflow: auto; background: #f5f5f5;">
                        <div style="text-align: center; padding: 20px;">
                            <i class="fas fa-spinner fa-spin"></i> æ­£åœ¨åŠ è½½PDF...
                        </div>
                    </div>
                `;
                loadPDF(file_path);
            } else if (type === 'office') {
                const { file_ext } = data;
                previewContent.innerHTML = `
                    <div style="background: #f8f8f8; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 12px; color: #666;">
                        æ–‡ä»¶å¤§å°: ${size} | ç±»å‹: ${file_ext.toUpperCase()} Officeæ–‡æ¡£
                    </div>
                    <div id="officeContainer" style="width: 100%; height: calc(90vh - 160px); border: 1px solid #ddd; border-radius: 4px; overflow: auto; background: #f5f5f5;">
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <i class="fas fa-file-alt" style="font-size: 48px; margin-bottom: 20px; color: #007acc;"></i>
                            <h3 style="margin-bottom: 20px;">Officeæ–‡æ¡£é¢„è§ˆ</h3>
                            <p style="margin-bottom: 20px;">é€‰æ‹©ä»¥ä¸‹æ–¹å¼é¢„è§ˆOfficeæ–‡æ¡£ï¼š</p>
                            <div style="display: flex; flex-direction: column; gap: 15px; align-items: center;">
                                <button onclick="previewOfficeCloud('${file_path}')" style="padding: 12px 24px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; min-width: 200px;">
                                    <i class="fas fa-cloud-upload-alt"></i> äº‘å­˜å‚¨é¢„è§ˆ
                                </button>
                                <a href="/api/download-file/${file_path}" download style="padding: 12px 24px; background: #6c757d; color: white; text-decoration: none; border-radius: 5px; font-size: 14px; min-width: 200px; text-align: center; display: inline-block;">
                                    <i class="fas fa-download"></i> ä¸‹è½½æ–‡ä»¶
                                </a>
                            </div>
                            <div style="margin-top: 30px; padding: 20px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; text-align: left; max-width: 600px;">
                                <h4 style="color: #856404; margin-bottom: 10px;"><i class="fas fa-info-circle"></i> é¢„è§ˆè¯´æ˜</h4>
                                <ul style="color: #856404; margin: 0; padding-left: 20px;">
                                    <li><strong>äº‘å­˜å‚¨é¢„è§ˆ</strong>: å…ˆä¸Šä¼ åˆ°äº‘å­˜å‚¨ï¼Œå†ä½¿ç”¨åœ¨çº¿é¢„è§ˆæœåŠ¡</li>
                                    <li><strong>ä¸‹è½½æ–‡ä»¶</strong>: ä¸‹è½½åˆ°æœ¬åœ°ä½¿ç”¨Officeè½¯ä»¶æ‰“å¼€</li>
                                </ul>
                                <div style="margin-top: 15px; padding: 10px; background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 3px;">
                                    <small><i class="fas fa-lightbulb"></i> <strong>æç¤º</strong>: å¦‚æœæŸä¸ªé¢„è§ˆæœåŠ¡æ— æ³•æ­£å¸¸å·¥ä½œï¼Œè¯·å°è¯•å…¶ä»–é€‰é¡¹ã€‚ä¸åŒæœåŠ¡å¯¹æ–‡æ¡£æ ¼å¼çš„æ”¯æŒç¨‹åº¦å¯èƒ½ä¸åŒã€‚</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (type === 'csv') {
                // CSVæ–‡ä»¶è¡¨æ ¼é¢„è§ˆ
                const { headers, data: csvRows, total_rows, displayed_rows, truncated, encoding } = data;
                
                // åˆ›å»ºè¡¨æ ¼HTML
                let tableHtml = '<table id="csvTable" style="width: 100%; border-collapse: collapse; background: white; font-size: 13px; color: #333;">';
                
                // è¡¨å¤´
                if (headers && headers.length > 0) {
                    tableHtml += '<thead><tr style="background: #f8f9fa; position: sticky; top: 0; z-index: 10;">';
                    headers.forEach((header, index) => {
                        const escapedHeader = escapeHtml(header || `åˆ—${index + 1}`);
                        tableHtml += `<th onclick="sortCSVTable(${index})" style="border: 1px solid #dee2e6; padding: 12px 8px; text-align: left; font-weight: 600; cursor: pointer; user-select: none; position: relative; min-width: 120px; color: #333;" title="ç‚¹å‡»æ’åº">${escapedHeader}<span style="margin-left: 5px; color: #6c757d;">â‡…</span></th>`;
                    });
                    tableHtml += '</tr></thead>';
                }
                
                // è¡¨æ ¼æ•°æ®
                tableHtml += '<tbody id="csvTableBody">';
                if (csvRows && csvRows.length > 0) {
                    csvRows.forEach((row, rowIndex) => {
                        const rowStyle = rowIndex % 2 === 0 ? 'background: #ffffff;' : 'background: #f8f9fa;';
                        tableHtml += `<tr style="${rowStyle}">`;
                        
                        // ç¡®ä¿æ¯è¡Œéƒ½æœ‰è¶³å¤Ÿçš„åˆ—
                        const maxCols = Math.max(headers.length, row.length);
                        for (let i = 0; i < maxCols; i++) {
                            const cellValue = row[i] || '';
                            const escapedValue = escapeHtml(cellValue);
                            tableHtml += `<td style="border: 1px solid #dee2e6; padding: 8px; vertical-align: top; word-break: break-word; max-width: 300px; color: #333;" title="${escapedValue}">${escapedValue}</td>`;
                        }
                        tableHtml += '</tr>';
                    });
                } else {
                    tableHtml += `<tr><td colspan="${headers.length}" style="text-align: center; padding: 40px; color: #6c757d; font-style: italic;">æš‚æ— æ•°æ®</td></tr>`;
                }
                tableHtml += '</tbody></table>';
                
                // åˆ›å»ºæœç´¢å’Œå·¥å…·æ 
                const searchHtml = `
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 5px 5px 0 0; border-bottom: 1px solid #dee2e6; display: flex; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <div style="flex: 1; min-width: 200px;">
                            <input type="text" id="csvSearchInput" placeholder="æœç´¢è¡¨æ ¼å†…å®¹..." 
                                style="width: 100%; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px;"
                                oninput="filterCSVTable()">
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                            <button onclick="exportCSVTable()" style="padding: 8px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 5px;">
                                <i class="fas fa-download"></i> å¯¼å‡º
                            </button>
                            <span style="font-size: 12px; color: #6c757d;">
                                æ˜¾ç¤º ${displayed_rows}/${total_rows} è¡Œ
                                ${truncated ? '(å·²æˆªæ–­)' : ''}
                                ${encoding ? `| ç¼–ç : ${encoding.toUpperCase()}` : ''}
                            </span>
                        </div>
                    </div>
                `;
                
                previewContent.innerHTML = `
                    <div style="background: #f8f8f8; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 12px; color: #666;">
                        æ–‡ä»¶å¤§å°: ${size} | ç±»å‹: CSVè¡¨æ ¼ | æ€»è¡Œæ•°: ${total_rows} | åˆ—æ•°: ${headers.length}
                        ${truncated ? ' | âš ï¸ å¤§æ–‡ä»¶å·²æˆªæ–­æ˜¾ç¤º' : ''}
                    </div>
                    <div style="border: 1px solid #dee2e6; border-radius: 5px; overflow: hidden; max-height: calc(90vh - 160px); display: flex; flex-direction: column;">
                        ${searchHtml}
                        <div style="flex: 1; overflow: auto;">
                            ${tableHtml}
                        </div>
                    </div>
                `;
                
                // å­˜å‚¨åŸå§‹æ•°æ®ç”¨äºæœç´¢å’Œæ’åº
                window.csvData = {
                    headers: headers,
                    originalData: csvRows,
                    currentData: csvRows,
                    sortColumn: -1,
                    sortDirection: 'asc'
                };
                
            } else if (type === 'code') {
                // ç‰¹æ®Šå¤„ç†txtå’Œlogæ–‡ä»¶ï¼Œæä¾›æ›´å¥½çš„é˜…è¯»ä½“éªŒ
                if (language === 'text' || language === 'log') {
                    // å…ˆå¤„ç†è½¬ä¹‰å­—ç¬¦ï¼Œå†è¿›è¡ŒHTMLè½¬ä¹‰
                    const processedContent = escapeHtml(processFileContent(content));
                    previewContent.innerHTML = `
                        <div style="background: #f8f8f8; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 12px; color: #666;">
                            æ–‡ä»¶å¤§å°: ${size} | ç±»å‹: ${language.toUpperCase()}
                        </div>
                        <div style="background: #1e1e1e; color: #cccccc; padding: 20px; border-radius: 5px; overflow: auto; font-size: 14px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word; font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; max-height: calc(90vh - 160px);">${processedContent}</div>
                    `;
                } else {
                    // ä½¿ç”¨Prism.jsè¿›è¡Œè¯­æ³•é«˜äº®
                    // å…ˆå¤„ç†è½¬ä¹‰å­—ç¬¦ï¼Œå†è¿›è¡ŒHTMLè½¬ä¹‰
                    const processedContent = escapeHtml(processFileContent(content));
                    previewContent.innerHTML = `
                        <div style="background: #f8f8f8; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 12px; color: #666;">
                            æ–‡ä»¶å¤§å°: ${size} | è¯­è¨€: ${language}
                        </div>
                        <div style="max-height: calc(90vh - 160px); overflow: auto; border-radius: 5px;">
                            <pre class="language-${language}" style="margin: 0; font-size: 14px; line-height: 1.4;"><code class="language-${language}">${processedContent}</code></pre>
                        </div>
                    `;
                    
                    // è§¦å‘Prism.jsè¯­æ³•é«˜äº®
                    setTimeout(() => {
                        if (typeof Prism !== 'undefined') {
                            Prism.highlightAll();
                        }
                    }, 100);
                }
            }
        }

        function loadPDF(filePath) {
            if (typeof pdfjsLib === 'undefined') {
                document.getElementById('pdfContainer').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: red;">
                        <i class="fas fa-exclamation-triangle"></i> PDF.js æœªåŠ è½½ï¼Œæ— æ³•é¢„è§ˆPDFæ–‡ä»¶
                    </div>
                `;
                return;
            }

            const pdfUrl = `/api/pdf/${filePath}`;
            
            pdfjsLib.getDocument(pdfUrl).promise.then(function(pdf) {
                const container = document.getElementById('pdfContainer');
                container.innerHTML = '';
                
                // åˆ›å»ºé¡µé¢å¯¼èˆª
                const nav = document.createElement('div');
                nav.style.cssText = 'background: #333; color: white; padding: 10px; text-align: center; position: sticky; top: 0; z-index: 10;';
                nav.innerHTML = `
                    <button onclick="previousPage()" style="margin-right: 10px; padding: 5px 10px; background: #007acc; color: white; border: none; border-radius: 3px; cursor: pointer;">ä¸Šä¸€é¡µ</button>
                    <span id="pageInfo">ç¬¬ 1 é¡µï¼Œå…± ${pdf.numPages} é¡µ</span>
                    <button onclick="nextPage()" style="margin-left: 10px; padding: 5px 10px; background: #007acc; color: white; border: none; border-radius: 3px; cursor: pointer;">ä¸‹ä¸€é¡µ</button>
                    <a href="/api/download-file/${filePath}" download style="margin-left: 15px; padding: 5px 10px; background: #28a745; color: white; text-decoration: none; border-radius: 3px; font-size: 12px;">
                        <i class="fas fa-download"></i> ä¸‹è½½PDF
                    </a>
                `;
                container.appendChild(nav);
                
                // åˆ›å»ºé¡µé¢å®¹å™¨
                const pagesContainer = document.createElement('div');
                pagesContainer.id = 'pdfPages';
                pagesContainer.style.cssText = 'padding: 20px; text-align: center;';
                container.appendChild(pagesContainer);
                
                // å­˜å‚¨PDFå¯¹è±¡å’Œå½“å‰é¡µç 
                window.currentPDF = pdf;
                window.currentPage = 1;
                
                // æ¸²æŸ“ç¬¬ä¸€é¡µ
                renderPDFPage(1);
                
            }).catch(function(error) {
                console.error('PDFåŠ è½½å¤±è´¥:', error);
                document.getElementById('pdfContainer').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: red;">
                        <i class="fas fa-exclamation-triangle"></i> PDFåŠ è½½å¤±è´¥: ${error.message}
                    </div>
                `;
            });
        }

        function renderPDFPage(pageNum) {
            if (!window.currentPDF) return;
            
            window.currentPDF.getPage(pageNum).then(function(page) {
                const scale = 1.5;
                const viewport = page.getViewport({ scale: scale });
                
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                canvas.style.cssText = 'max-width: 100%; height: auto; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 20px;';
                
                const renderContext = {
                    canvasContext: context,
                    viewport: viewport
                };
                
                const pagesContainer = document.getElementById('pdfPages');
                pagesContainer.innerHTML = '';
                pagesContainer.appendChild(canvas);
                
                page.render(renderContext);
                
                // æ›´æ–°é¡µé¢ä¿¡æ¯
                document.getElementById('pageInfo').textContent = I18N.page_info.replace('{0}', pageNum).replace('{1}', window.currentPDF.numPages);
            });
        }

        function previousPage() {
            if (window.currentPage > 1) {
                window.currentPage--;
                renderPDFPage(window.currentPage);
            }
        }

        function nextPage() {
            if (window.currentPage < window.currentPDF.numPages) {
                window.currentPage++;
                renderPDFPage(window.currentPage);
            }
        }

        // Officeæ–‡æ¡£é¢„è§ˆå‡½æ•°
        function previewOfficeCloud(filePath) {
            // äº‘å­˜å‚¨é¢„è§ˆ - å…ˆä¸Šä¼ åˆ°äº‘å­˜å‚¨ï¼Œå†ä½¿ç”¨åœ¨çº¿é¢„è§ˆæœåŠ¡
            const container = document.getElementById('officeContainer');
            
            // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
            container.innerHTML = `
                <div style="background: #28a745; color: white; padding: 10px; text-align: center; position: sticky; top: 0; z-index: 10;">
                    <span>äº‘å­˜å‚¨é¢„è§ˆ</span>
                    <button onclick="resetOfficePreview()" style="float: right; padding: 5px 10px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 3px; cursor: pointer;">è¿”å›</button>
                </div>
                <div style="text-align: center; padding: 40px; color: #666;">
                    <div style="margin-bottom: 20px;">
                        <i class="fas fa-cloud-upload-alt fa-spin" style="font-size: 48px; color: #28a745;"></i>
                    </div>
                    <h3 style="margin-bottom: 20px;">æ­£åœ¨ä¸Šä¼ æ–‡ä»¶åˆ°äº‘å­˜å‚¨...</h3>
                    <p style="margin-bottom: 20px; color: #666;">è¯·ç¨å€™ï¼Œæ–‡ä»¶ä¸Šä¼ å®Œæˆåå°†è‡ªåŠ¨å¼€å§‹é¢„è§ˆ</p>
                    <div style="background: #e9ecef; border-radius: 10px; height: 20px; overflow: hidden; margin: 20px auto; max-width: 400px;">
                        <div id="uploadProgress" style="background: #28a745; height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                    </div>
                    <div id="uploadStatus" style="font-size: 14px; color: #666;">å‡†å¤‡ä¸Šä¼ ...</div>
                </div>
            `;
            
            // æ¨¡æ‹Ÿè¿›åº¦æ¡
            let progress = 0;
            const progressBar = document.getElementById('uploadProgress');
            const statusText = document.getElementById('uploadStatus');
            
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 90) progress = 90;
                progressBar.style.width = progress + '%';
                statusText.textContent = `ä¸Šä¼ è¿›åº¦: ${Math.round(progress)}%`;
            }, 200);
            
            // ä¸Šä¼ æ–‡ä»¶åˆ°äº‘å­˜å‚¨
            fetch(`/api/upload-to-cloud/${filePath}`)
                .then(response => response.json())
                .then(data => {
                    clearInterval(progressInterval);
                    progressBar.style.width = '100%';
                    statusText.textContent = 'ä¸Šä¼ å®Œæˆï¼';
                    
                    if (data.success) {
                        // ä¸Šä¼ æˆåŠŸï¼Œä½¿ç”¨äº‘URLè¿›è¡Œé¢„è§ˆ
                        setTimeout(() => {
                            const cloudUrl = data.cloud_url;
                            const serviceName = data.service;
                            const expires = data.expires;
                            
                            // é€‰æ‹©åˆé€‚çš„é¢„è§ˆæœåŠ¡
                            let previewUrl;
                            if (serviceName === 'Local Test') {
                                // æœ¬åœ°æµ‹è¯•æ¨¡å¼ï¼šæ˜¾ç¤ºæç¤ºä¿¡æ¯è€Œä¸æ˜¯é¢„è§ˆ
                                container.innerHTML = `
                                    <div style="background: #28a745; color: white; padding: 10px; text-align: center; position: sticky; top: 0; z-index: 10;">
                                        <span>äº‘å­˜å‚¨é¢„è§ˆ (${serviceName}) - ${expires}</span>
                                        <button onclick="resetOfficePreview()" style="float: right; padding: 5px 10px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 3px; cursor: pointer;">è¿”å›</button>
                                    </div>
                                    <div style="text-align: center; padding: 40px; color: #666;">
                                        <i class="fas fa-check-circle" style="font-size: 48px; margin-bottom: 20px; color: #28a745;"></i>
                                        <h3 style="margin-bottom: 20px; color: #28a745;">äº‘å­˜å‚¨ä¸Šä¼ æˆåŠŸï¼</h3>
                                        <p style="margin-bottom: 20px;">æ–‡ä»¶å·²æˆåŠŸ"ä¸Šä¼ "åˆ°æœ¬åœ°æµ‹è¯•æœåŠ¡</p>
                                        <div style="background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 20px; margin: 20px auto; border-radius: 5px; max-width: 600px; text-align: left;">
                                            <h4 style="margin-bottom: 15px;"><i class="fas fa-info-circle"></i> æµ‹è¯•æ¨¡å¼è¯´æ˜</h4>
                                            <ul style="margin: 0; padding-left: 20px;">
                                                <li><strong>å½“å‰ä¸ºæœ¬åœ°æµ‹è¯•æ¨¡å¼</strong>ï¼šæ¨¡æ‹Ÿäº‘å­˜å‚¨ä¸Šä¼ æˆåŠŸ</li>
                                                <li><strong>å®é™…éƒ¨ç½²æ—¶</strong>ï¼šæ–‡ä»¶ä¼šä¸Šä¼ åˆ°çœŸå®çš„äº‘å­˜å‚¨æœåŠ¡</li>
                                                <li><strong>é¢„è§ˆåŠŸèƒ½</strong>ï¼šäº‘å­˜å‚¨çš„æ–‡ä»¶å¯ä»¥é€šè¿‡Google Docsç­‰æœåŠ¡é¢„è§ˆ</li>
                                                <li><strong>ç½‘ç»œè¦æ±‚</strong>ï¼šéœ€è¦å¤–ç½‘è®¿é—®æ‰èƒ½ä½¿ç”¨åœ¨çº¿é¢„è§ˆæœåŠ¡</li>
                                            </ul>
                                        </div>
                                        <div style="display: flex; flex-direction: column; gap: 15px; align-items: center; margin-top: 30px;">
                                            <a href="${cloudUrl}" target="_blank" style="padding: 12px 24px; background: #007acc; color: white; text-decoration: none; border-radius: 5px; font-size: 14px; min-width: 200px; text-align: center; display: inline-block;">
                                                <i class="fas fa-external-link-alt"></i> åœ¨æ–°çª—å£ä¸­æ‰“å¼€æ–‡ä»¶
                                            </a>
                                            <button onclick="resetOfficePreview()" style="padding: 12px 24px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; min-width: 200px;">
                                                <i class="fas fa-arrow-left"></i> è¿”å›é‡æ–°é€‰æ‹©
                                            </button>
                                        </div>
                                    </div>
                                `;
                                return; // ç›´æ¥è¿”å›ï¼Œä¸ç»§ç»­æ‰§è¡Œiframeé¢„è§ˆé€»è¾‘
                            } else if (serviceName === 'File.io' || serviceName === '0x0.st' || serviceName === 'tmpfiles.org') {
                                // ä½¿ç”¨WPSåœ¨çº¿é¢„è§ˆäº‘å­˜å‚¨çš„æ–‡ä»¶
                                previewUrl = `https://wwo.wps.cn/office/w?url=${encodeURIComponent(cloudUrl)}`;
                            } else {
                                previewUrl = cloudUrl;
                            }
                            
                            container.innerHTML = `
                                <div style="background: #28a745; color: white; padding: 10px; text-align: center; position: sticky; top: 0; z-index: 10;">
                                    <span>WPSäº‘é¢„è§ˆ (${serviceName}) - æœ‰æ•ˆæœŸ: ${expires}</span>
                                    <button onclick="resetOfficePreview()" style="float: right; padding: 5px 10px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 3px; cursor: pointer;">è¿”å›</button>
                                </div>
                                <iframe src="${previewUrl}" style="width: 100%; height: calc(100% - 50px); border: none;" frameborder="0" onload="handleCloudPreviewLoad(this)" onerror="handleCloudPreviewError(this, '${serviceName}')">
                                    <div style="text-align: center; padding: 20px; color: red;">
                                        <i class="fas fa-exclamation-triangle"></i> 
                                        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒiframeï¼Œæ— æ³•é¢„è§ˆOfficeæ–‡æ¡£
                                    </div>
                                </iframe>
                                <div style="background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 10px; margin: 10px; border-radius: 5px; font-size: 12px;">
                                    <i class="fas fa-info-circle"></i> 
                                    <strong>äº‘å­˜å‚¨ä¿¡æ¯:</strong> æ–‡ä»¶å·²ä¸Šä¼ åˆ° ${serviceName}ï¼Œä½¿ç”¨WPSåœ¨çº¿é¢„è§ˆï¼Œé“¾æ¥æœ‰æ•ˆæœŸä¸º ${expires}ã€‚
                                    <a href="${cloudUrl}" target="_blank" style="color: #155724; margin-left: 10px;">
                                        <i class="fas fa-external-link-alt"></i> ç›´æ¥è®¿é—®äº‘æ–‡ä»¶
                                    </a>
                                </div>
                            `;
                        }, 1000);
                    } else {
                        // ä¸Šä¼ å¤±è´¥
                        container.innerHTML = `
                            <div style="background: #28a745; color: white; padding: 10px; text-align: center; position: sticky; top: 0; z-index: 10;">
                                <span>äº‘å­˜å‚¨é¢„è§ˆ</span>
                                <button onclick="resetOfficePreview()" style="float: right; padding: 5px 10px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 3px; cursor: pointer;">è¿”å›</button>
                            </div>
                            <div style="text-align: center; padding: 40px; color: #666;">
                                <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px; color: #dc3545;"></i>
                                <h3 style="margin-bottom: 20px; color: #dc3545;">äº‘å­˜å‚¨ä¸Šä¼ å¤±è´¥</h3>
                                <p style="margin-bottom: 20px;">é”™è¯¯ä¿¡æ¯: ${data.error}</p>
                                <div style="display: flex; flex-direction: column; gap: 15px; align-items: center;">
                                    <button onclick="previewOfficeCloud('${filePath}')" style="padding: 12px 24px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; min-width: 200px;">
                                        <i class="fas fa-redo"></i> é‡è¯•ä¸Šä¼ 
                                    </button>
                                    <button onclick="resetOfficePreview()" style="padding: 12px 24px; background: #007acc; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; min-width: 200px;">
                                        <i class="fas fa-arrow-left"></i> è¿”å›é‡æ–°é€‰æ‹©
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    clearInterval(progressInterval);
                    console.error('äº‘å­˜å‚¨ä¸Šä¼ å¤±è´¥:', error);
                    container.innerHTML = `
                        <div style="background: #28a745; color: white; padding: 10px; text-align: center; position: sticky; top: 0; z-index: 10;">
                            <span>äº‘å­˜å‚¨é¢„è§ˆ</span>
                            <button onclick="resetOfficePreview()" style="float: right; padding: 5px 10px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 3px; cursor: pointer;">è¿”å›</button>
                        </div>
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px; color: #dc3545;"></i>
                            <h3 style="margin-bottom: 20px; color: #dc3545;">ç½‘ç»œé”™è¯¯</h3>
                            <p style="margin-bottom: 20px;">æ— æ³•è¿æ¥åˆ°äº‘å­˜å‚¨æœåŠ¡ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</p>
                            <div style="display: flex; flex-direction: column; gap: 15px; align-items: center;">
                                <button onclick="previewOfficeCloud('${filePath}')" style="padding: 12px 24px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; min-width: 200px;">
                                    <i class="fas fa-redo"></i> é‡è¯•ä¸Šä¼ 
                                </button>
                                <button onclick="resetOfficePreview()" style="padding: 12px 24px; background: #007acc; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; min-width: 200px;">
                                    <i class="fas fa-arrow-left"></i> è¿”å›é‡æ–°é€‰æ‹©
                                </button>
                            </div>
                        </div>
                    `;
                });
        }



        // é‡ç½®Officeé¢„è§ˆç•Œé¢
        function resetOfficePreview() {
            const container = document.getElementById('officeContainer');
            if (container) {
                // é‡æ–°æ˜¾ç¤ºé€‰æ‹©ç•Œé¢
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-file-alt" style="font-size: 48px; margin-bottom: 20px; color: #007acc;"></i>
                        <h3 style="margin-bottom: 20px;">Officeæ–‡æ¡£é¢„è§ˆ</h3>
                        <p style="margin-bottom: 20px;">é€‰æ‹©ä»¥ä¸‹æ–¹å¼é¢„è§ˆOfficeæ–‡æ¡£ï¼š</p>
                        <div style="display: flex; flex-direction: column; gap: 15px; align-items: center;">
                            <button onclick="previewOfficeCloud('${currentFilePath}')" style="padding: 12px 24px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; min-width: 200px;">
                                <i class="fas fa-cloud-upload-alt"></i> äº‘å­˜å‚¨é¢„è§ˆ
                            </button>
                            <a href="/api/download-file/${currentFilePath}" download style="padding: 12px 24px; background: #6c757d; color: white; text-decoration: none; border-radius: 5px; font-size: 14px; min-width: 200px; text-align: center; display: inline-block;">
                                <i class="fas fa-download"></i> ä¸‹è½½æ–‡ä»¶
                            </a>
                        </div>
                    </div>
                `;
            }
        }

        // å¤„ç†äº‘é¢„è§ˆåŠ è½½æˆåŠŸ
        function handleCloudPreviewLoad(iframe) {
            console.log('âœ… Cloud preview loaded successfully');
            // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ åŠ è½½æˆåŠŸçš„å¤„ç†é€»è¾‘
        }

        // å¤„ç†äº‘é¢„è§ˆåŠ è½½é”™è¯¯
        function handleCloudPreviewError(iframe, serviceName) {
            console.error(`âŒ Cloud preview (${serviceName}) failed to load`);
            const container = iframe.parentElement;
            container.innerHTML = `
                <div style="background: #28a745; color: white; padding: 10px; text-align: center; position: sticky; top: 0; z-index: 10;">
                    <span>äº‘å­˜å‚¨é¢„è§ˆ</span>
                    <button onclick="resetOfficePreview()" style="float: right; padding: 5px 10px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 3px; cursor: pointer;">è¿”å›</button>
                </div>
                <div style="text-align: center; padding: 40px; color: #666;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 48px; margin-bottom: 20px; color: #dc3545;"></i>
                    <h3 style="margin-bottom: 20px; color: #dc3545;">äº‘é¢„è§ˆå¤±è´¥</h3>
                    <p style="margin-bottom: 20px;">æ–‡ä»¶å·²æˆåŠŸä¸Šä¼ åˆ° ${serviceName}ï¼Œä½†é¢„è§ˆæœåŠ¡æ— æ³•åŠ è½½</p>
                    <div style="display: flex; flex-direction: column; gap: 15px; align-items: center;">
                        <button onclick="resetOfficePreview()" style="padding: 12px 24px; background: #007acc; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; min-width: 200px;">
                            <i class="fas fa-arrow-left"></i> è¿”å›é‡æ–°é€‰æ‹©
                        </button>
                        <a href="/api/download-file/${currentFilePath}" download style="padding: 12px 24px; background: #28a745; color: white; text-decoration: none; border-radius: 5px; font-size: 14px; min-width: 200px; text-align: center; display: inline-block;">
                            <i class="fas fa-download"></i> ä¸‹è½½æ–‡ä»¶
                        </a>
                    </div>
                </div>
            `;
        }

        // å­˜å‚¨å½“å‰æ–‡ä»¶è·¯å¾„ï¼Œç”¨äºè¿”å›æ—¶é‡æ–°æ„å»ºç•Œé¢
        let currentFilePath = '';

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // å¤„ç†æ–‡ä»¶å†…å®¹ä¸­çš„è½¬ä¹‰å­—ç¬¦
        function processFileContent(content) {
            return content
                .replace(/\\n/g, '\n')      // æ¢è¡Œç¬¦
                .replace(/\\t/g, '\t')      // åˆ¶è¡¨ç¬¦
                .replace(/\\r/g, '\r')      // å›è½¦ç¬¦
                .replace(/\\\\/g, '\\');    // åæ–œæ 
        }

        // å…³é—­é¢„è§ˆæ¨¡æ€æ¡†
        previewClose.onclick = function() {
            previewModal.style.display = 'none';
        }



        // é‡å‘½ååŠŸèƒ½
        const renameModal = document.getElementById('renameModal');
        const renameClose = document.getElementById('renameClose');
        const currentDirName = document.getElementById('currentDirName');
        const newDirName = document.getElementById('newDirName');
        const renameConfirm = document.getElementById('renameConfirm');
        const renameCancel = document.getElementById('renameCancel');
        
        let currentRenamingDir = null;

        function showRenameDialog(dirName) {
            currentRenamingDir = dirName;
            currentDirName.textContent = dirName;
            newDirName.value = dirName; // ç›´æ¥ä½¿ç”¨åŸåç§°ï¼Œä¸åšä»»ä½•å¤„ç†
            newDirName.focus();
            newDirName.select();
            renameModal.style.display = 'block';
        }

        function hideRenameDialog() {
            renameModal.style.display = 'none';
            currentRenamingDir = null;
            newDirName.value = '';
        }

        function performRename() {
            if (!currentRenamingDir) return;
            
            const newName = newDirName.value.trim();
            if (!newName) {
                alert('è¯·è¾“å…¥æ–°çš„ç›®å½•åç§°');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            renameConfirm.disabled = true;
            renameConfirm.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${I18N.renaming}`;
            
            fetch(`/api/rename-directory/${encodeURIComponent(currentRenamingDir)}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    new_name: newName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addMessage(data.message, 'success');
                    
                    // æ›´æ–°å‰ç«¯çŠ¶æ€
                    if (selectedDirectory === currentRenamingDir) {
                        selectedDirectory = data.new_name;
                        updateTaskModeInfo();
                    }
                    
                    // åˆ·æ–°ç›®å½•åˆ—è¡¨
                    refreshDirectories();
                    hideRenameDialog();
                } else {
                    addMessage(`${I18N.rename_failed}: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('âŒ Rename error:', error);
                addMessage(`${I18N.rename_error}: ${error.message}`, 'error');
            })
            .finally(() => {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                renameConfirm.disabled = false;
                renameConfirm.innerHTML = `<i class="fas fa-check"></i> ${I18N.confirm_rename}`;
            });
        }

        // é‡å‘½åäº‹ä»¶ç›‘å¬
        renameConfirm.onclick = performRename;
        renameCancel.onclick = hideRenameDialog;
        renameClose.onclick = hideRenameDialog;

        newDirName.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                performRename();
            } else if (e.key === 'Escape') {
                e.preventDefault();
                hideRenameDialog();
            }
        });

        window.onclick = function(event) {
            if (event.target === previewModal) {
                previewModal.style.display = 'none';
            }
            if (event.target === uploadModal) {
                uploadModal.style.display = 'none';
            }

            if (event.target === renameModal) {
                hideRenameDialog();
            }
        }

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(e) {
            // Ctrl+R æˆ– F5 åˆ·æ–°ç›®å½•
            if ((e.ctrlKey && e.key === 'r') || e.key === 'F5') {
                e.preventDefault();
                manualRefresh();
            }
            
            // Esc é”®å…³é—­é¢„è§ˆæ¨¡æ€æ¡†
            if (e.key === 'Escape' && previewModal.style.display === 'block') {
                previewModal.style.display = 'none';
            }
            
            // End é”®æ»šåŠ¨åˆ°åº•éƒ¨
            if (e.key === 'End' && e.target === chatMessages) {
                e.preventDefault();
                scrollToBottom(true);
            }
            
            // Ctrl+End å¼ºåˆ¶æ»šåŠ¨åˆ°åº•éƒ¨å¹¶å¯ç”¨è‡ªåŠ¨æ»šåŠ¨
            if (e.ctrlKey && e.key === 'End') {
                e.preventDefault();
                scrollToBottom(true);
            }
        });

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            refreshDirectories();
            userInput.focus();
            updateTaskModeInfo();
            initResizer();
            startAutoRefresh();
            
            // åˆå§‹åŒ–æ—¶æ»šåŠ¨åˆ°åº•éƒ¨
            setTimeout(() => {
                scrollToBottom(false);
            }, 100);
        });

        // è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½
        function startAutoRefresh() {
            // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡ç›®å½•åˆ—è¡¨ï¼ˆä»…åœ¨æœ‰ä»»åŠ¡è¿è¡Œæ—¶ï¼‰
            setInterval(() => {
                if (isTaskRunning) {
                    refreshDirectories();
                }
            }, 30000);
            
            // æ¯5åˆ†é’Ÿåˆ·æ–°ä¸€æ¬¡ï¼ˆæ— è®ºæ˜¯å¦æœ‰ä»»åŠ¡è¿è¡Œï¼‰
            setInterval(() => {
                refreshDirectories();
            }, 300000);
        }

        // åˆ†éš”æ¡æ‹–æ‹½åŠŸèƒ½
        function initResizer() {
            const resizer = document.getElementById('resizer');
            const sidebar = document.getElementById('sidebar');
            const container = document.querySelector('.container');
            let isResizing = false;
            let startX = 0;
            let startWidth = 0;

            resizer.addEventListener('mousedown', function(e) {
                e.preventDefault();
                isResizing = true;
                startX = e.clientX;
                startWidth = parseInt(document.defaultView.getComputedStyle(sidebar).width, 10);
                
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
                
                // æ·»åŠ è§†è§‰åé¦ˆ
                resizer.style.background = '#007acc';
            });

            function handleMouseMove(e) {
                if (!isResizing) return;
                e.preventDefault();
                
                const dx = startX - e.clientX; // å‘å·¦æ‹–æ‹½ä¸ºæ­£å€¼
                const newWidth = startWidth + dx;
                
                // é™åˆ¶ä¾§è¾¹æ å®½åº¦
                const minWidth = 250;
                const maxWidth = 600;
                const constrainedWidth = Math.max(minWidth, Math.min(maxWidth, newWidth));
                
                sidebar.style.width = constrainedWidth + 'px';
            }

            function handleMouseUp(e) {
                if (!isResizing) return;
                e.preventDefault();
                
                isResizing = false;
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
                
                // ç§»é™¤è§†è§‰åé¦ˆ
                resizer.style.background = '';
            }
        }

        // æ‰‹åŠ¨åˆ·æ–°ç›®å½•
        function manualRefresh() {
            const refreshBtn = document.querySelector('.sidebar-header .action-btn');
            const icon = refreshBtn.querySelector('i');
            
            // æ·»åŠ æ—‹è½¬åŠ¨ç”»
            icon.classList.add('fa-spin');
            refreshBtn.disabled = true;
            
            // ä¿å­˜å½“å‰å±•å¼€çŠ¶æ€
            const currentExpanded = new Set(expandedDirectories);
            
            fetch('/api/refresh-dirs', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // æ¢å¤å±•å¼€çŠ¶æ€
                    expandedDirectories = currentExpanded;
                    renderDirectories(data.directories);
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯ï¼ˆæ›´ç®€æ´ï¼‰
                    console.log('Directory refreshed');
                } else {
                    addMessage(`${I18N.refresh_failed}: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                addMessage(`${I18N.refresh_failed}: ${error.message}`, 'error');
            })
            .finally(() => {
                // ç§»é™¤æ—‹è½¬åŠ¨ç”»
                icon.classList.remove('fa-spin');
                refreshBtn.disabled = false;
            });
        }

        // ä¸Šä¼ åŠŸèƒ½
        function showUploadModal(dirName) {
            currentUploadDir = dirName;
            uploadTitle.textContent = `${I18N.upload_to} ${dirName}${I18N.workspace}`;
            uploadResult.innerHTML = '';
            uploadProgress.style.display = 'none';
            progressFill.style.width = '0%';
            uploadModal.style.display = 'block';
        }

        // å…³é—­ä¸Šä¼ æ¨¡æ€æ¡†
        uploadClose.onclick = function() {
            uploadModal.style.display = 'none';
        }

        // æ–‡ä»¶é€‰æ‹©å¤„ç†
        fileInput.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                uploadFiles(Array.from(e.target.files));
            }
        });

        // æ‹–æ‹½åŠŸèƒ½
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = Array.from(e.dataTransfer.files);
            if (files.length > 0) {
                uploadFiles(files);
            }
        });

        // ä¸Šä¼ æ–‡ä»¶å‡½æ•°
        function uploadFiles(files) {
            if (!currentUploadDir) {
                uploadResult.innerHTML = `<div class="error">${I18N.select_directory_error}</div>`;
                return;
            }

            const formData = new FormData();
            files.forEach(file => {
                formData.append('files', file);
            });

            // æ˜¾ç¤ºè¿›åº¦æ¡
            uploadProgress.style.display = 'block';
            uploadResult.innerHTML = '';
            progressText.textContent = I18N.uploading_files.replace('{0}', files.length);

            // åˆ›å»ºXMLHttpRequestä»¥æ”¯æŒè¿›åº¦ç›‘æ§
            const xhr = new XMLHttpRequest();
            
            xhr.upload.addEventListener('progress', function(e) {
                if (e.lengthComputable) {
                    const percentComplete = (e.loaded / e.total) * 100;
                    progressFill.style.width = percentComplete + '%';
                    progressText.textContent = I18N.upload_progress.replace('{0}', Math.round(percentComplete));
                }
            });

            xhr.addEventListener('load', function() {
                uploadProgress.style.display = 'none';
                
                if (xhr.status === 200) {
                    const response = JSON.parse(xhr.responseText);
                    if (response.success) {
                        uploadResult.innerHTML = `
                            <div class="success">
                                <i class="fas fa-check-circle"></i> ${response.message}
                                <br><small>æ–‡ä»¶: ${response.files.join(', ')}</small>
                            </div>
                        `;
                        // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
                        fileInput.value = '';
                        // åˆ·æ–°ç›®å½•åˆ—è¡¨
                        setTimeout(() => {
                            refreshDirectories();
                        }, 1000);
                    } else {
                        uploadResult.innerHTML = `<div class="error"><i class="fas fa-exclamation-triangle"></i> ${response.error}</div>`;
                    }
                } else {
                    uploadResult.innerHTML = `<div class="error"><i class="fas fa-exclamation-triangle"></i> ${I18N.upload_failed_http.replace('{0}', xhr.status)}</div>`;
                }
            });

            xhr.addEventListener('error', function() {
                uploadProgress.style.display = 'none';
                uploadResult.innerHTML = `<div class="error"><i class="fas fa-exclamation-triangle"></i> ${I18N.upload_network_error}</div>`;
            });

            xhr.open('POST', `/api/upload/${currentUploadDir}`);
            xhr.send(formData);
        }

        // CSVè¡¨æ ¼ç›¸å…³åŠŸèƒ½
        function sortCSVTable(columnIndex) {
            if (!window.csvData) return;
            
            const { headers, currentData, sortColumn, sortDirection } = window.csvData;
            
            // ç¡®å®šæ’åºæ–¹å‘
            let newDirection = 'asc';
            if (sortColumn === columnIndex) {
                newDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            }
            
            // æ’åºæ•°æ®
            const sortedData = [...currentData].sort((a, b) => {
                const aVal = (a[columnIndex] || '').toString().toLowerCase();
                const bVal = (b[columnIndex] || '').toString().toLowerCase();
                
                // å°è¯•æ•°å­—æ¯”è¾ƒ
                const aNum = parseFloat(aVal);
                const bNum = parseFloat(bVal);
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return newDirection === 'asc' ? aNum - bNum : bNum - aNum;
                }
                
                // å­—ç¬¦ä¸²æ¯”è¾ƒ
                if (newDirection === 'asc') {
                    return aVal.localeCompare(bVal);
                } else {
                    return bVal.localeCompare(aVal);
                }
            });
            
            // æ›´æ–°çŠ¶æ€
            window.csvData.currentData = sortedData;
            window.csvData.sortColumn = columnIndex;
            window.csvData.sortDirection = newDirection;
            
            // é‡æ–°æ¸²æŸ“è¡¨æ ¼
            renderCSVTableBody(sortedData);
            
            // æ›´æ–°è¡¨å¤´æ’åºæŒ‡ç¤ºå™¨
            updateSortIndicators(columnIndex, newDirection);
        }
        
        function updateSortIndicators(sortColumn, sortDirection) {
            const headers = document.querySelectorAll('#csvTable th');
            headers.forEach((th, index) => {
                const span = th.querySelector('span');
                if (span) {
                    if (index === sortColumn) {
                        span.textContent = sortDirection === 'asc' ? 'â†‘' : 'â†“';
                        span.style.color = '#007acc';
                    } else {
                        span.textContent = 'â‡…';
                        span.style.color = '#6c757d';
                    }
                }
            });
        }
        
        function renderCSVTableBody(data) {
            if (!window.csvData) return;
            
            const tbody = document.getElementById('csvTableBody');
            const { headers } = window.csvData;
            
            if (!tbody || !headers) return;
            
            let html = '';
            if (data && data.length > 0) {
                data.forEach((row, rowIndex) => {
                    const rowStyle = rowIndex % 2 === 0 ? 'background: #ffffff;' : 'background: #f8f9fa;';
                    html += `<tr style="${rowStyle}">`;
                    
                    const maxCols = Math.max(headers.length, row.length);
                    for (let i = 0; i < maxCols; i++) {
                        const cellValue = row[i] || '';
                        const escapedValue = escapeHtml(cellValue);
                        html += `<td style="border: 1px solid #dee2e6; padding: 8px; vertical-align: top; word-break: break-word; max-width: 300px; color: #333;" title="${escapedValue}">${escapedValue}</td>`;
                    }
                    html += '</tr>';
                });
            } else {
                html = `<tr><td colspan="${headers.length}" style="text-align: center; padding: 40px; color: #6c757d; font-style: italic;">æ— åŒ¹é…ç»“æœ</td></tr>`;
            }
            
            tbody.innerHTML = html;
        }
        
        function filterCSVTable() {
            if (!window.csvData) return;
            
            const searchInput = document.getElementById('csvSearchInput');
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            if (!searchTerm) {
                // æ˜¾ç¤ºæ‰€æœ‰æ•°æ®
                window.csvData.currentData = window.csvData.originalData;
                renderCSVTableBody(window.csvData.originalData);
                return;
            }
            
            // è¿‡æ»¤æ•°æ®
            const filteredData = window.csvData.originalData.filter(row => {
                return row.some(cell => {
                    const cellValue = (cell || '').toString().toLowerCase();
                    return cellValue.includes(searchTerm);
                });
            });
            
            window.csvData.currentData = filteredData;
            renderCSVTableBody(filteredData);
        }
        
        function exportCSVTable() {
            if (!window.csvData) return;
            
            const { headers, currentData } = window.csvData;
            
            // åˆ›å»ºCSVå†…å®¹
            let csvContent = '';
            
            // æ·»åŠ è¡¨å¤´
            if (headers && headers.length > 0) {
                csvContent += headers.map(header => `"${(header || '').replace(/"/g, '""')}"`).join(',') + '\n';
            }
            
            // æ·»åŠ æ•°æ®è¡Œ
            currentData.forEach(row => {
                const csvRow = row.map(cell => {
                    const cellValue = (cell || '').toString();
                    return `"${cellValue.replace(/"/g, '""')}"`;
                }).join(',');
                csvContent += csvRow + '\n';
            });
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'exported_data.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                // åå¤‡æ–¹æ¡ˆï¼šæ‰“å¼€æ–°çª—å£æ˜¾ç¤ºCSVå†…å®¹
                const newWindow = window.open();
                newWindow.document.write('<pre>' + escapeHtml(csvContent) + '</pre>');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateTaskModeInfo(); // ç¡®ä¿ä»»åŠ¡æ¨¡å¼ä¿¡æ¯æ­£ç¡®æ˜¾ç¤º
            updateAutoScrollIndicator(); // åˆå§‹åŒ–è‡ªåŠ¨æ»šåŠ¨çŠ¶æ€æŒ‡ç¤ºå™¨
        });
    </script>
    
    <!-- Prism.js for syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
        // Configure Prism.js autoloader
        Prism.plugins.autoloader.languages_path = 'https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/';
        
        // Configure PDF.js
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
    </script>
</body>
</html> 