<!DOCTYPE html>
<html lang="{{ 'zh-CN' if lang == 'zh' else 'en' }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ i18n.app_title.replace(' GUI', '') }}</title>
    <link href="{{ url_for('static', filename='css/fontawesome.min.css') }}" rel="stylesheet">
    <!-- Prism.js for syntax highlighting -->
    <link href="{{ url_for('static', filename='css/prism-tomorrow.min.css') }}" rel="stylesheet">
    <!-- Custom Prism.js override styles for better visibility -->
    <style>
        /* Override Prism.js with dark theme for code preview */
        .preview-modal code[class*="language-"],
        .preview-modal pre[class*="language-"] {
            color: #ffffff !important;
            background: #1e1e1e !important;
            font-weight: normal !important;
        }
        
        .preview-modal pre[class*="language-"] {
            background: #1e1e1e !important;
            border: 1px solid #404040 !important;
        }
        
        .preview-modal :not(pre) > code[class*="language-"] {
            background: #2d2d2d !important;
            color: #ffffff !important;
            font-weight: normal !important;
        }
        
        /* Syntax highlighting tokens with vibrant colors for dark theme */
        .preview-modal .token.comment,
        .preview-modal .token.prolog,
        .preview-modal .token.doctype,
        .preview-modal .token.cdata {
            color: #6a9955 !important;
        }
        
        .preview-modal .token.punctuation {
            color: #d4d4d4 !important;
        }
        
        .preview-modal .token.property,
        .preview-modal .token.tag,
        .preview-modal .token.constant,
        .preview-modal .token.symbol,
        .preview-modal .token.deleted {
            color: #569cd6 !important;
        }
        
        .preview-modal .token.boolean,
        .preview-modal .token.number {
            color: #b5cea8 !important;
        }
        
        .preview-modal .token.selector,
        .preview-modal .token.attr-name,
        .preview-modal .token.string,
        .preview-modal .token.char,
        .preview-modal .token.builtin,
        .preview-modal .token.inserted {
            color: #ce9178 !important;
        }
        
        .preview-modal .token.operator,
        .preview-modal .token.entity,
        .preview-modal .token.url,
        .preview-modal .language-css .token.string,
        .preview-modal .style .token.string {
            color: #d4d4d4 !important;
        }
        
        .preview-modal .token.atrule,
        .preview-modal .token.attr-value,
        .preview-modal .token.keyword {
            color: #c586c0 !important;
        }
        
        .preview-modal .token.function,
        .preview-modal .token.class-name {
            color: #dcdcaa !important;
        }
        
        .preview-modal .token.regex,
        .preview-modal .token.important,
        .preview-modal .token.variable {
            color: #9cdcfe !important;
        }
        
        .preview-modal .token.important,
        .preview-modal .token.bold {
            font-weight: bold !important;
        }
        
        .preview-modal .token.italic {
            font-style: italic !important;
        }
    </style>
    <!-- PDF.js -->
    <script src="{{ url_for('static', filename='js/pdf.min.js') }}"></script>
    <!-- MathJax for mathematical formulas with fallback -->
    <script>
        // MathJaxé…ç½®
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            startup: {
                ready() {
                    MathJax.startup.defaultReady();
                    console.log('âœ… MathJax loaded successfully from CDN');
                    window.mathJaxAvailable = true;
                }
            }
        };

        // MathJaxåŠ è½½çŠ¶æ€
        window.mathJaxAvailable = false;
        window.mathJaxLoadAttempted = false;

        // Fallback: ç®€å•çš„æ•°å­¦å…¬å¼æ–‡æœ¬æ›¿æ¢
        function fallbackMathRendering(element) {
            if (!element) return;
            
            // ç®€å•çš„LaTeXåˆ°æ–‡æœ¬çš„è½¬æ¢
            const mathReplacements = {
                // å¸Œè…Šå­—æ¯
                '\\\\alpha': 'Î±', '\\\\beta': 'Î²', '\\\\gamma': 'Î³', '\\\\delta': 'Î´',
                '\\\\epsilon': 'Îµ', '\\\\theta': 'Î¸', '\\\\lambda': 'Î»', '\\\\mu': 'Î¼',
                '\\\\pi': 'Ï€', '\\\\sigma': 'Ïƒ', '\\\\phi': 'Ï†', '\\\\omega': 'Ï‰',
                
                // æ•°å­¦ç¬¦å·
                '\\\\sum': 'âˆ‘', '\\\\prod': 'âˆ', '\\\\int': 'âˆ«',
                '\\\\infty': 'âˆ', '\\\\pm': 'Â±', '\\\\mp': 'âˆ“',
                '\\\\leq': 'â‰¤', '\\\\geq': 'â‰¥', '\\\\neq': 'â‰ ',
                '\\\\approx': 'â‰ˆ', '\\\\equiv': 'â‰¡',
                
                // ä¸Šä¸‹æ ‡ç®€åŒ–å¤„ç†
                '\\\\^\\{([^}]+)\\}': '^($1)',
                '_\\{([^}]+)\\}': '_($1)',
                
                // åˆ†æ•°ç®€åŒ–
                '\\\\frac\\{([^}]+)\\}\\{([^}]+)\\}': '($1)/($2)',
                
                // å¹³æ–¹æ ¹
                '\\\\sqrt\\{([^}]+)\\}': 'âˆš($1)',
                
                // ç§»é™¤å¤šä½™çš„åæ–œæ å’ŒèŠ±æ‹¬å·
                '\\\\\\\\': '\\\\',
                '\\{': '',
                '\\}': ''
            };
            
            let content = element.innerHTML;
            
            // å¤„ç†è¡Œå†…æ•°å­¦å…¬å¼ $...$
            content = content.replace(/\$([^$]+)\$/g, function(match, formula) {
                let processed = formula;
                for (let pattern in mathReplacements) {
                    processed = processed.replace(new RegExp(pattern, 'g'), mathReplacements[pattern]);
                }
                return '<span style="font-style: italic; color: #0066cc; background: #f0f8ff; padding: 1px 3px; border-radius: 2px;" title="">' + processed + '</span>';
            });
            
            // å¤„ç†å—çº§æ•°å­¦å…¬å¼ $$...$$
            content = content.replace(/\$\$([^$]+)\$\$/g, function(match, formula) {
                let processed = formula;
                for (let pattern in mathReplacements) {
                    processed = processed.replace(new RegExp(pattern, 'g'), mathReplacements[pattern]);
                }
                return '<div style="text-align: center; font-style: italic; color: #0066cc; background: #f0f8ff; padding: 8px; margin: 10px 0; border-radius: 4px; border-left: 3px solid #0066cc;" title="">' + processed + '</div>';
            });
            
            element.innerHTML = content;
        }

        // æ™ºèƒ½æ•°å­¦æ¸²æŸ“å‡½æ•°
        function renderMath(element) {
            if (window.mathJaxAvailable && typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
                // ä½¿ç”¨MathJaxæ¸²æŸ“
                return MathJax.typesetPromise([element]).catch(function (err) {
                    console.warn('âŒ MathJax rendering failed, using fallback:', err);
                    fallbackMathRendering(element);
                });
            } else {
                // ä½¿ç”¨fallbackæ¸²æŸ“
                console.log('ğŸ“ Using fallback math rendering (MathJax unavailable)');
                fallbackMathRendering(element);
                return Promise.resolve();
            }
        }

        // æ£€æµ‹MathJaxåŠ è½½çŠ¶æ€
        function checkMathJaxStatus() {
            setTimeout(function() {
                if (!window.mathJaxAvailable && window.mathJaxLoadAttempted) {
                    console.warn('âš ï¸ MathJax failed to load from CDN, fallback mode activated');
                    // é™é»˜å¤„ç†ï¼Œä¸æ˜¾ç¤ºç”¨æˆ·æç¤º
                }
            }, 3000); // 3ç§’åæ£€æŸ¥
        }
    </script>
    
    <!-- å°è¯•åŠ è½½MathJax CDN -->
    <script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mtml-chtml.js" 
            onload="window.mathJaxLoadAttempted = true; checkMathJaxStatus();"
            onerror="window.mathJaxLoadAttempted = true; console.error('âŒ Failed to load MathJax from primary CDN'); checkMathJaxStatus();"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1e1e1e;
            height: 100vh;
            overflow: hidden;
            color: #cccccc;
        }

        /* User authentication area styles */
        .user-auth-area {
            background: #2d2d30;
            border-bottom: 1px solid #3e3e42;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
            min-height: 50px;
        }

        .user-auth-left {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
            min-width: 300px;
        }

        .logo-group {
            display: flex;
            align-items: center;
        }

        .user-auth-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .api-key-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .api-key-group label {
            color: #cccccc;
            font-size: 0.9em;
            white-space: nowrap;
        }

        .api-key-input {
            padding: 6px 12px;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            background: #1e1e1e;
            color: #cccccc;
            font-size: 0.9em;
            width: 200px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        }

        .api-key-input:focus {
            outline: none;
            border-color: #007acc;
            box-shadow: 0 0 0 2px rgba(0, 122, 204, 0.2);
        }

        .api-key-input::placeholder {
            color: #6a6a6a;
        }

        .connect-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .connect-btn.connect {
            background: #28a745;
            color: white;
        }

        .connect-btn.connect:hover {
            background: #218838;
        }

        .connect-btn.disconnect {
            background: #dc3545;
            color: white;
        }

        .connect-btn.disconnect:hover {
            background: #c82333;
        }

        .connect-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85em;
            color: #9cdcfe;
        }

        .user-status {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .user-status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #6c757d;
        }

        .user-status-indicator.connected {
            background: #28a745;
            animation: pulse-green 2s infinite;
        }

        .user-status-indicator.connected.guest {
            background: #ff5722;
            animation: pulse-red 2s infinite;
        }

        .user-status-indicator.connecting {
            background: #ffc107;
            animation: pulse-orange 1s infinite;
        }

        .user-status-indicator.error {
            background: #dc3545;
        }

        .container {
            display: flex;
            height: calc(100vh - 50px);  /* Subtract auth area height */
            background: #252526;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            min-width: 0;
            min-width: 400px;
        }

        #resizer {
            width: 5px;
            background: #3e3e42;
            cursor: col-resize;
            flex-shrink: 0;
            transition: all 0.2s ease;
            position: relative;
        }

        #resizer:hover {
            background: #569cd6;
            width: 6px;
        }

        #resizer:active {
            background: #007acc;
            width: 6px;
        }

        /* Add visual indicator when dragging */
        #resizer::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 2px;
            height: 30px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 1px;
            pointer-events: none;
            transition: all 0.2s ease;
        }

        #resizer:hover::before {
            background: rgba(255, 255, 255, 0.6);
            height: 40px;
        }

        .sidebar {
            width: 400px;
            background: #252526;
            border-left: 1px solid #3e3e42;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            text-align: center;
            margin-bottom: 15px;
            color: #cccccc;
        }

        .header h1 {
            font-size: 1.2em;
            font-weight: 700;
            margin-bottom: 0;
            color: #569cd6;
        }

        .header p {
            display: none;
        }

        .chat-container {
            flex: 1;
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .chat-header {
            background: #007acc;
            color: white;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #3e3e42;
        }

        .chat-header h3 {
            font-size: 0.95em;
            font-weight: 400;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4CAF50;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        @keyframes pulse-green {
            0% {
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(40, 167, 69, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
            }
        }

        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 87, 34, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(255, 87, 34, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 87, 34, 0);
            }
        }

        @keyframes pulse-orange {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(255, 193, 7, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(255, 193, 7, 0);
            }
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #1e1e1e;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 6px;
            max-width: 95%;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease-in;
            white-space: pre-wrap;
            overflow-wrap: break-word;
        }

        .message-text {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            white-space: pre-wrap;
            word-break: break-all;
            overflow-wrap: anywhere;
            line-height: 1.4;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            background: #0e639c;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 3px;
        }

        .message.system {
            background: #264f78;
            color: #9cdcfe;
            border-left: 3px solid #007acc;
            padding: 6px 8px !important;
            max-width: 95% !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
        }

        .message.info {
            background: #1a1a1a;
            color: #cccccc;
            border-left: 3px solid #569cd6;
        }

        .message.error {
            background: #5a1d1d;
            color: #f48771;
            border-left: 3px solid #f14c4c;
        }

        .message.success {
            background: #0f5132;
            color: #75b798;
            border-left: 3px solid #198754;
        }

        .message.normal {
            background: transparent;
            color: #cccccc;
            border: none;
            padding: 2px 0;
        }



        .input-container {
            background: #2d2d30;
            border: 1px solid #3e3e42;
            border-radius: 8px;
            padding: 20px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        .button-row {
            display: flex;
            gap: 10px;
            flex-direction: row;
            align-items: center;
        }

        #userInput {
            width: 100%;
            min-height: 50px;
            max-height: 120px;
            padding: 15px 20px;
            border: 1px solid #3e3e42;
            border-radius: 6px;
            font-size: 16px;
            resize: vertical;
            transition: all 0.3s ease;
            font-family: inherit;
            background: #1e1e1e;
            color: #cccccc;
        }

        #userInput:focus {
            outline: none;
            border-color: #007acc;
            box-shadow: 0 0 0 2px rgba(0, 122, 204, 0.2);
        }

        #userInput::placeholder {
            color: #6a6a6a;
        }

        .send-button {
            background: #007acc;
            color: white;
            border: none;
            border-radius: 6px;
            width: 50px;
            height: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .send-button:hover {
            background: #005a9e;
            transform: translateY(-1px);
        }

        .send-button:disabled {
            background: #3e3e42;
            cursor: not-allowed;
            transform: none;
        }

        /* Specific button hover effects */
        #planButton:hover:not(:disabled) {
            background: #f57c00;
        }

        #clearChatButton:hover:not(:disabled) {
            background: #5a6268;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #3e3e42;
            background: #2d2d30;
        }

        .sidebar-header h3 {
            margin: 0;
            color: #cccccc;
            font-size: 1.1em;
            font-weight: 500;
        }

        .sidebar-header .action-btn {
            background: transparent;
            border: 1px solid #569cd6;
            color: #569cd6;
            padding: 6px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9em;
        }

        .sidebar-header .action-btn:hover:not(:disabled) {
            background: #569cd6;
            color: white;
        }

        .sidebar-header .action-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .sidebar-header .action-btn .fa-spin {
            animation: fa-spin 1s infinite linear;
        }

        .directory-list {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            margin: 0;
        }

        .directory-item {
            background: #1e1e1e;
            border-radius: 6px;
            margin-bottom: 12px;
            padding: 15px;
            border: 1px solid #3e3e42;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .directory-item:hover {
            background: #2d2d30;
            border-color: #569cd6;
            transform: translateY(-1px);
        }

        .directory-item.expanded {
            background: #0f3460;
            border-color: #007acc;
        }

        .directory-item.current {
            background: #2d2d30;
            color: #cccccc;
            border-color: #3e3e42;
            box-shadow: none;
        }

        .directory-item.current .directory-name,
        .directory-item.current .directory-info {
            color: #cccccc;
        }

        .directory-item.current .action-btn {
            color: #9cdcfe;
        }

        .directory-item.current .action-btn:hover {
            background: rgba(156, 220, 254, 0.1);
        }

        .directory-item.selected {
            background: linear-gradient(135deg, #007acc 0%, #005a9e 100%);
            color: white;
            border-color: #007acc;
            box-shadow: 0 3px 10px rgba(0, 122, 204, 0.3);
        }

        .directory-item.selected .directory-name,
        .directory-item.selected .directory-info {
            color: white;
        }

        .directory-item.selected .action-btn {
            color: white;
        }

        .directory-item.selected .action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .directory-item.last {
            border: 2px solid #569cd6;
            background: #0f3460;
        }

        .directory-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .directory-name {
            font-weight: 600;
            color: #cccccc;
            font-size: 0.9em;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-right: 10px;
        }

        .directory-actions {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }

        .action-btn {
            background: none;
            border: none;
            color: #9cdcfe;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.3s ease;
            font-size: 0.9em;
        }

        .action-btn:hover {
            background: rgba(156, 220, 254, 0.1);
            color: #569cd6;
        }

        .rename-btn {
            color: #ffc107 !important;
        }

        .rename-btn:hover {
            background: rgba(255, 193, 7, 0.1) !important;
            color: #ffc107 !important;
        }

        .delete-btn {
            color: #ff6b6b !important;
        }

        .delete-btn:hover {
            background: rgba(255, 107, 107, 0.1) !important;
            color: #ff5252 !important;
        }

        .directory-info {
            font-size: 0.85em;
            color: #9cdcfe;
            margin-bottom: 10px;
        }

        .file-tree {
            display: none;
            margin-top: 8px; /* ä»10pxå‡å°‘åˆ°8px */
            padding: 6px; /* ä»10pxå‡å°‘åˆ°6px */
            border-top: 1px solid #3e3e42;
            background: #1e1e1e;
            border-radius: 4px;
            max-height: 400px; /* å¢åŠ é«˜åº¦ä»¥æ˜¾ç¤ºè‡³å°‘10ä¸ªæ–‡ä»¶ */
            overflow-y: auto; /* æ·»åŠ æ»šåŠ¨æ¡ */
        }

        .file-tree.show {
            display: block;
        }

        .sub-file-tree {
            display: none;
            margin-left: 20px;
        }

        .sub-file-tree.show {
            display: block;
        }

        .sub-folder-toggle {
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }

        .sub-folder-toggle:hover {
            opacity: 1;
            background: rgba(156, 220, 254, 0.2) !important;
            border-radius: 3px;
        }

        .file-item.directory > div[onclick]:hover {
            background: rgba(156, 220, 254, 0.1);
            border-radius: 4px;
            padding: 2px 6px;
            margin: -2px -6px;
        }

        .file-item {
            padding: 2px 0; /* ä»5pxå‡å°‘åˆ°2px */
            margin-left: 20px;
            font-size: 0.9em;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 6px; /* ä»8pxå‡å°‘åˆ°6px */
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-item:hover {
            background: rgba(156, 220, 254, 0.2);
            border-radius: 4px;
            padding-left: 5px;
        }

        .file-item.directory {
            font-weight: 500;
            color: #9cdcfe;
        }

        .file-item.previewable {
            color: #ffffff;
        }

        .file-item.previewable:hover {
            color: #ffffff;
            font-weight: 500;
        }

        .file-item i {
            width: 16px;
            text-align: center;
        }

        .file-item.grayed {
            color: #888888 !important;
        }

        .file-item.grayed:hover {
            color: #aaaaaa !important;
        }

        .file-item.grayed.previewable {
            cursor: pointer;
        }

        .file-item.grayed.previewable:hover {
            color: #cccccc !important;
            background: rgba(156, 220, 254, 0.1);
            border-radius: 4px;
            padding-left: 5px;
        }



        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #9cdcfe;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 3px solid #3e3e42;
            border-top: 3px solid #007acc;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .scrollbar-custom {
            scrollbar-width: thin;
            scrollbar-color: #569cd6 #2d2d30;
        }

        .scrollbar-custom::-webkit-scrollbar {
            width: 8px;
        }

        .scrollbar-custom::-webkit-scrollbar-track {
            background: #2d2d30;
            border-radius: 4px;
        }

        .scrollbar-custom::-webkit-scrollbar-thumb {
            background: #569cd6;
            border-radius: 4px;
        }

        .scrollbar-custom::-webkit-scrollbar-thumb:hover {
            background: #007acc;
        }

        /* Responsive design for mobile devices */
        @media (max-width: 768px) {
            body {
                overflow: auto;
                height: auto; /* å…è®¸é¡µé¢è‡ªç„¶ä¼¸å±• */
            }
            
            /* Header optimization */
            .user-auth-area {
                padding: 5px 8px;
                flex-direction: column;
                gap: 5px;
                min-height: auto;
                overflow-x: hidden;
            }
            
            .user-auth-left {
                width: 100%;
                min-width: unset;
                justify-content: center;
                margin-bottom: 5px;
            }
            
            .logo-group {
                flex-direction: column;
                align-items: center;
                gap: 2px;
            }
            
            .logo-group img {
                height: 1.8em !important;
            }
            
            .logo-group span {
                font-size: 1em !important;
            }
            
            .user-auth-right {
                width: 100%;
                flex-direction: column;
                align-items: center;
                gap: 6px;
                overflow-x: hidden;
            }
            
            .api-key-group {
                flex-direction: column;
                align-items: center;
                gap: 3px;
                width: 100%;
                max-width: none;
                overflow: hidden;
            }
            
            .api-key-group label {
                font-size: 0.8em;
                text-align: center;
                white-space: nowrap;
            }
            
            .api-key-input {
                width: calc(100vw - 20px);
                max-width: calc(100vw - 20px);
                font-size: 16px; /* Prevent zoom on iOS */
                padding: 6px 8px;
                box-sizing: border-box;
            }
            
            .connect-btn {
                width: calc(100vw - 20px);
                max-width: calc(100vw - 20px);
                padding: 8px 12px;
                font-size: 0.9em;
                justify-content: center;
                box-sizing: border-box;
            }
            
            .user-info {
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
                gap: 8px;
                font-size: 0.8em;
            }
            
            .user-status {
                justify-content: center;
            }
            
            /* Container layout */
            .container {
                flex-direction: column;
                height: auto; /* æ”¹ä¸ºè‡ªåŠ¨é«˜åº¦ï¼Œé¿å…å›ºå®šé™åˆ¶ */
                min-height: calc(100vh - 220px); /* è®¾ç½®æœ€å°é«˜åº¦ */
                overflow-y: visible; /* å…è®¸å†…å®¹è‡ªç„¶æº¢å‡º */
            }
            
            .sidebar {
                width: 100%;
                height: auto; /* æ”¹ä¸ºè‡ªåŠ¨é«˜åº¦ */
                min-height: 300px; /* å¢åŠ æœ€å°é«˜åº¦ç¡®ä¿æœ‰è¶³å¤Ÿç©ºé—´ */
                max-height: 60vh; /* è®¾ç½®æœ€å¤§é«˜åº¦ï¼Œæ”¯æŒæ›´é•¿çš„ä¸‹æ‹‰ */
                border-radius: 0;
                border-left: none;
                border-bottom: 1px solid #3e3e42;
                order: 2;
                overflow-y: auto; /* å†…å®¹è¶…å‡ºæ—¶å¯æ»šåŠ¨ */
            }
            
            .main-content {
                height: auto; /* æ”¹ä¸ºè‡ªåŠ¨é«˜åº¦ */
                min-height: 400px; /* è®¾ç½®æœ€å°é«˜åº¦ */
                padding: 10px;
                min-width: unset;
                order: 1;
                flex: 1; /* å ç”¨å‰©ä½™ç©ºé—´ */
            }
            
            /* Hide resizer on mobile */
            #resizer {
                display: none;
            }
            
            /* Chat container optimization */
            .chat-container {
                margin-bottom: 10px;
                flex: 1;
                min-height: 300px; /* è®¾ç½®æœ€å°é«˜åº¦ç¡®ä¿æœ‰è¶³å¤Ÿçš„æ˜¾ç¤ºç©ºé—´ */
            }
            
            .chat-header {
                padding: 8px 12px;
                flex-shrink: 0;
            }
            
            .chat-header h3 {
                font-size: 0.85em;
            }
            
            .chat-messages {
                padding: 10px;
                flex: 1;
                min-height: 200px; /* æ¶ˆæ¯åŒºåŸŸæœ€å°é«˜åº¦ */
                max-height: 400px; /* å›ºå®šæœ€å¤§é«˜åº¦é¿å…è¿‡åº¦æ‹‰ä¼¸ */
            }
            
            .message {
                margin-bottom: 10px;
                padding: 8px 12px;
                font-size: 0.85em;
            }
            
            /* Input optimization */
            .input-container {
                padding: 10px;
                flex-shrink: 0;
            }
            
            .input-group {
                flex-direction: column; /* å‚ç›´å¸ƒå±€ï¼ŒæŒ‰é’®æ”¾åˆ°ä¸‹ä¸€è¡Œ */
                gap: 8px;
                align-items: stretch;
            }
            
            .button-row {
                flex-direction: row !important; /* ç¡®ä¿æŒ‰é’®è¡Œå§‹ç»ˆæ¨ªæ’ */
                flex-wrap: wrap; /* å…è®¸æ¢è¡Œä»¥é€‚åº”å°å±å¹• */
            }
            
            .input-wrapper {
                width: 100%;
                min-width: 0;
            }
            
            #userInput {
                font-size: 16px; /* Prevent zoom on iOS */
                min-height: 60px;
                max-height: 120px;
                padding: 10px 12px;
                width: 100%;
                min-width: 280px; /* è®¾ç½®æœ€å°å®½åº¦ */
                box-sizing: border-box;
            }
            
            /* æŒ‰é’®è¡Œå®¹å™¨ */
            .button-row {
                display: flex;
                gap: 8px;
                width: 100%;
            }
            
            .send-button {
                flex: 1; /* æŒ‰é’®å¹³åˆ†å®½åº¦ */
                height: 45px;
                font-size: 0.9em;
                min-width: 60px;
            }
            
            /* Sidebar optimization */
            .sidebar-header {
                padding: 8px 12px;
                flex-shrink: 0;
            }
            
            .directory-list {
                flex: 1;
                min-height: 200px; /* å¢åŠ ç›®å½•åˆ—è¡¨æœ€å°é«˜åº¦ */
                max-height: calc(60vh - 80px); /* åŒ¹é…æ–°çš„sidebaræœ€å¤§é«˜åº¦ */
                overflow-y: auto;
                padding: 8px;
            }
            
            .directory-item {
                margin-bottom: 8px;
                padding: 10px;
            }
            
            .directory-name {
                font-size: 0.8em;
            }
            
            .directory-info {
                font-size: 0.75em;
                margin-bottom: 8px;
            }
            
            .directory-actions {
                gap: 6px;
            }
            
            .action-btn {
                padding: 4px 6px;
                font-size: 0.8em;
            }
            
            .file-tree {
                max-height: 300px; /* æ‰‹æœºç«¯ä¹Ÿå¢åŠ é«˜åº¦ */
                overflow-y: auto;
            }
            
            .file-item {
                padding: 1px 0; /* è¿›ä¸€æ­¥å‡å°‘æ‰‹æœºç«¯é—´è· */
                font-size: 0.8em;
            }
            
            /* GitHub button mobile optimization */
            .github-link-container {
                bottom: 10px !important;
                right: 10px !important;
            }
            
            .github-link-container a {
                font-size: 0.8em !important;
                padding: 6px 8px !important;
            }
        }
        
        /* Smaller mobile devices */
        @media (max-width: 480px) {
            .user-auth-area {
                padding: 4px 6px;
            }
            
            .main-content {
                padding: 8px;
                height: auto; /* æ”¹ä¸ºè‡ªåŠ¨é«˜åº¦ */
                min-height: 350px; /* å¢åŠ å°å±è®¾å¤‡ä¸»å†…å®¹åŒºæœ€å°é«˜åº¦ */
            }
            
            .sidebar {
                height: auto; /* æ”¹ä¸ºè‡ªåŠ¨é«˜åº¦ */
                min-height: 250px; /* å¢åŠ å°å±è®¾å¤‡ä¾§è¾¹æ æœ€å°é«˜åº¦ */
                max-height: 50vh; /* å°å±è®¾å¤‡æœ€å¤§é«˜åº¦ */
            }
            
            .chat-container {
                min-height: 220px; /* å°å±è®¾å¤‡èŠå¤©å®¹å™¨æœ€å°é«˜åº¦ */
            }
            
            .chat-messages {
                padding: 8px;
                min-height: 150px; /* å°å±è®¾å¤‡æ¶ˆæ¯åŒºåŸŸæœ€å°é«˜åº¦ */
                max-height: 300px; /* å›ºå®šæœ€å¤§é«˜åº¦ */
            }
            
            .message {
                padding: 6px 10px;
                font-size: 0.8em;
                margin-bottom: 8px;
            }
            
            .input-container {
                padding: 8px;
            }
            
            #userInput {
                min-height: 50px;
                padding: 8px 10px;
                font-size: 16px;
                min-width: 250px; /* å°å±è®¾å¤‡è¾“å…¥æ¡†æœ€å°å®½åº¦ */
            }
            
            .button-row {
                flex-wrap: wrap; /* å°å±ä¸‹å…è®¸æŒ‰é’®æ¢è¡Œ */
            }
            
            .send-button {
                height: 40px;
                font-size: 0.8em;
                min-width: 45px;
            }
            
            .directory-list {
                min-height: 150px; /* å¢åŠ å°å±è®¾å¤‡ç›®å½•åˆ—è¡¨æœ€å°é«˜åº¦ */
                max-height: calc(50vh - 60px); /* åŒ¹é…å°å±sidebaræœ€å¤§é«˜åº¦ */
                padding: 6px;
            }
            
            .directory-item {
                padding: 8px;
                margin-bottom: 6px;
            }
            
            .directory-name {
                font-size: 0.75em;
            }
            
            .directory-info {
                font-size: 0.7em;
            }
            
            .sidebar-header {
                padding: 6px 10px;
            }
            
            .sidebar-header .action-btn {
                padding: 3px 5px;
                font-size: 0.75em;
            }
            
            .file-tree {
                max-height: 250px; /* å°å±è®¾å¤‡ä¹Ÿå¢åŠ é«˜åº¦ */
                overflow-y: auto;
            }
            
            .file-item {
                padding: 1px 0; /* å°å±è®¾å¤‡ä¹Ÿå‡å°‘é—´è· */
                font-size: 0.75em;
            }
            
            /* GitHub button small mobile optimization */
            .github-link-container {
                bottom: 8px !important;
                right: 8px !important;
            }
            
            .github-link-container a {
                font-size: 0.75em !important;
                padding: 4px 6px !important;
            }
            
            .github-link-container a span {
                display: none; /* å°å±å¹•åªæ˜¾ç¤ºå›¾æ ‡ */
            }
            
            /* Modal optimization for mobile */
            .modal-content {
                width: 95%;
                height: 95vh;
                margin: 2.5vh auto;
                border-radius: 6px;
            }
            
            .modal-header {
                padding: 10px 15px;
            }
            
            .modal-header h3 {
                font-size: 1em;
            }
            
            .close {
                font-size: 24px;
            }
            
            .modal-body {
                padding: 15px;
            }
            
            /* Preview content iframe optimization */
            #previewContent iframe {
                height: calc(95vh - 100px);
            }
            
            /* Upload area optimization */
            .upload-area {
                padding: 20px 15px;
            }
            
            .upload-icon {
                font-size: 36px;
                margin-bottom: 15px;
            }
            
            .upload-text p {
                font-size: 14px;
                margin: 8px 0;
            }
            
            .upload-hint {
                font-size: 16px !important;
            }
            
            .upload-btn {
                padding: 10px 20px;
                font-size: 14px;
                margin-top: 15px;
            }
        }

        /* Touch-friendly improvements for mobile */
        @media (max-width: 768px) {
            /* Increase touch targets */
            .action-btn {
                min-width: 44px;
                min-height: 44px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .file-item {
                min-height: 36px; /* å‡å°‘æœ€å°é«˜åº¦ä½†ä¿æŒå¯ç‚¹å‡» */
                padding: 4px 0; /* å‡å°‘paddingä½†ä¿æŒè§¦æ‘¸å‹å¥½ */
            }
            
            .directory-item {
                cursor: pointer;
                -webkit-tap-highlight-color: rgba(0, 122, 204, 0.2);
            }
            
            /* Smooth scrolling */
            .chat-messages {
                -webkit-overflow-scrolling: touch;
                scroll-behavior: smooth;
            }
            
            .directory-list {
                -webkit-overflow-scrolling: touch;
                scroll-behavior: smooth;
            }
            
            /* Prevent text selection on interactive elements */
            .action-btn,
            .connect-btn,
            .send-button,
            .directory-item {
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }
            
            /* Improve button press feedback */
            .send-button:active,
            .connect-btn:active,
            .action-btn:active {
                transform: scale(0.95);
                transition: transform 0.1s;
            }
            
            /* Scroll to bottom button mobile optimization */
            .scroll-to-bottom-hint {
                bottom: 80px;
                right: 15px;
                width: 45px;
                height: 45px;
                z-index: 100;
            }
            
            /* New message indicator mobile optimization */
            .new-message-indicator {
                bottom: 135px;
                right: 15px;
                padding: 8px 12px;
                font-size: 0.85em;
            }
        }

        /* Tablet optimization (768px to 1024px) */
        @media (min-width: 769px) and (max-width: 1024px) {
            .sidebar {
                width: 350px;
            }
            
            .main-content {
                padding: 18px;
            }
            
            .chat-messages {
                padding: 18px;
            }
            
            .input-container {
                padding: 18px;
            }
            
            #userInput {
                font-size: 16px;
            }
            
            .user-auth-area {
                padding: 10px 18px;
            }
            
            .api-key-input {
                font-size: 16px;
            }
        }

        /* Landscape phone optimization */
        @media (max-width: 768px) and (orientation: landscape) {
            .container {
                flex-direction: row;
                height: calc(100vh - 80px);
            }
            
            .sidebar {
                width: 40%;
                height: 100%;
                border-left: 1px solid #3e3e42;
                border-bottom: none;
                order: 2;
            }
            
            .main-content {
                width: 60%;
                height: 100%;
                order: 1;
            }
            
            #resizer {
                display: block;
            }
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: #2d2d30;
            margin: 2% auto;
            border: 1px solid #3e3e42;
            border-radius: 8px;
            width: 90%;
            max-width: 1200px;
            height: 90vh;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            background: #007acc;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #3e3e42;
            flex-shrink: 0;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.2em;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            opacity: 0.7;
        }

        .modal-body {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
            background: #1e1e1e;
            color: #cccccc;
            min-height: 0;
        }

        /* Special handling for preview modal */
        #previewModal .modal-content {
            width: 65%;
            max-width: none;
            height: 95%;
            max-height: none;
        }
        
        /* Mobile preview modal optimization */
        @media (max-width: 768px) {
            #previewModal .modal-content {
                width: 95% !important;
                min-width: 350px;
                max-width: 95% !important;
                height: 95vh !important;
            }
            
            /* ä¸­ç­‰å±å¹•ä¼˜åŒ–é¢„è§ˆæ¨¡æ€æ¡†ä¸­çš„æŒ‰é’®å¸ƒå±€ */
            #previewModal .preview-button-group {
                justify-content: center !important;
                flex-wrap: wrap !important;
                gap: 8px !important;
            }
            
            #previewModal .preview-button-group a,
            #previewModal .preview-button-group button {
                flex: 1 1 calc(50% - 4px) !important;
                min-width: 120px !important;
                max-width: 200px !important;
                font-size: 16px !important;
                padding: 10px 8px !important;
            }
            
            /* ä¸­ç­‰å±å¹•ä¼˜åŒ–Markdownå·¥å…·æ æŒ‰é’®å¸ƒå±€ */
            #previewModal .markdown-toolbar-header {
                flex-direction: column !important;
                align-items: stretch !important;
                gap: 10px !important;
            }
            
            #previewModal .markdown-toolbar-buttons {
                flex-wrap: wrap !important;
                gap: 6px !important;
                justify-content: center !important;
            }
            
            #previewModal .markdown-toolbar-buttons button {
                min-width: 70px !important;
                max-width: calc(33.33% - 4px) !important;
                padding: 6px 8px !important;
                font-size: 14px !important;
                height: 32px !important;
                flex: 1 1 calc(33.33% - 4px) !important;
            }
        }
        
        /* Small mobile preview modal optimization */
        @media (max-width: 480px) {
            #previewModal .modal-content {
                width: 98% !important;
                min-width: 320px;
                max-width: 98% !important;
                height: 95vh !important;
            }
            
            #previewModal .modal-body {
                padding: 5px !important;
            }
            
            #previewContent iframe {
                height: calc(95vh - 80px) !important;
            }
            
            /* ä¼˜åŒ–é¢„è§ˆæ¨¡æ€æ¡†ä¸­çš„æŒ‰é’®å¸ƒå±€ - å¼ºåˆ¶ä¸¤è¡Œæ˜¾ç¤º */
            #previewModal .preview-button-group {
                flex-direction: column !important;
                align-items: stretch !important;
                gap: 8px !important;
            }
            
            #previewModal .preview-button-group a,
            #previewModal .preview-button-group button {
                width: 100% !important;
                min-width: unset !important;
                text-align: center !important;
                font-size: 16px !important;
                padding: 10px 12px !important;
            }
            
            /* ä¼˜åŒ–Markdownå·¥å…·æ æŒ‰é’®å¸ƒå±€ */
            #previewModal .markdown-toolbar-header {
                flex-direction: column !important;
                align-items: stretch !important;
                gap: 10px !important;
            }
            
            #previewModal .markdown-toolbar-buttons {
                flex-wrap: wrap !important;
                gap: 4px !important;
                justify-content: center !important;
            }
            
            #previewModal .markdown-toolbar-buttons button {
                min-width: unset !important;
                padding: 6px 8px !important;
                font-size: 14px !important;
                height: 32px !important;
                flex: 1 1 calc(50% - 2px) !important;
                max-width: calc(50% - 2px) !important;
            }
        }
        
        /* Tablet preview modal optimization */
        @media (min-width: 769px) and (max-width: 1024px) {
            #previewModal .modal-content {
                width: 80%;
                min-width: 600px;
            }
        }

        #previewModal .modal-body {
            padding: 10px;
        }

        /* iframe style optimization */
        #previewContent iframe {
            width: 100%;
            height: calc(95vh - 120px);
            border: none;
            border-radius: 4px;
        }

        /* Upload area styles */
        .upload-area {
            border: 2px dashed #569cd6;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            background: #1e1e1e;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #007acc;
            background: #2d2d30;
        }

        .upload-area.dragover {
            border-color: #007acc;
            background: #2d2d30;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 48px;
            color: #569cd6;
            margin-bottom: 20px;
        }

        .upload-text p {
            margin: 10px 0;
            font-size: 16px;
        }

        .upload-hint {
            font-size: 21px !important;
            color: #9cdcfe !important;
            opacity: 0.8;
        }

        .upload-btn {
            background: #007acc;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
            transition: background 0.3s ease;
        }

        .upload-btn:hover {
            background: #005a9e;
        }

        /* Progress bar styles */
        .upload-progress {
            margin-top: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #3e3e42;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #007acc;
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            text-align: center;
            margin-top: 10px;
            color: #9cdcfe;
        }

        /* Upload result styles */
        .upload-result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }

        .upload-result .success {
            color: #75b798;
            background: #0f5132;
            padding: 10px;
            border-radius: 4px;
            border-left: 3px solid #198754;
        }

        .upload-result .error {
            color: #f48771;
            background: #5a1d1d;
            padding: 10px;
            border-radius: 4px;
            border-left: 3px solid #f14c4c;
        }

        /* Scroll to bottom hint */
        .scroll-to-bottom-hint {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: #007acc;
            color: white;
            border: none;
            border-radius: 25px;
            width: 50px;
            height: 50px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            box-shadow: 0 4px 12px rgba(0, 122, 204, 0.4);
            transition: all 0.3s ease;
            z-index: 100;
            animation: bounceIn 0.3s ease;
        }

        .scroll-to-bottom-hint:hover {
            background: #005a9e;
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 122, 204, 0.6);
        }

        .scroll-to-bottom-hint.show {
            display: flex;
        }

        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* New message indicator */
        .new-message-indicator {
            position: absolute;
            bottom: 80px;
            right: 20px;
            background: #007acc;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 18px;
            display: none;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(0, 122, 204, 0.4);
            animation: slideInRight 0.3s ease;
            z-index: 99;
            cursor: pointer;
        }

        .new-message-indicator.show {
            display: flex;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }



        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-3px);
            }
            60% {
                transform: translateY(-2px);
            }
        }

        /* Markdowné¢„è§ˆæ ·å¼ */
        #markdownPreview {
            background: #ffffff !important;
            color: #000000 !important;
            font-size: 18px !important;
            line-height: 1.6 !important;
        }
        
        #markdownPreview img {
            width: 85% !important;
            height: auto !important;
            max-width: none !important;
            max-height: none !important;
            object-fit: contain !important;
        }
        
        #markdownPreview h1,
        #markdownPreview h2,
        #markdownPreview h3,
        #markdownPreview h4,
        #markdownPreview h5,
        #markdownPreview h6 {
            color: #000000 !important;
            margin: 24px 0 16px 0;
            font-weight: 600;
            line-height: 1.25;
        }

        #markdownPreview h1 {
            font-size: 2em;
            border-bottom: 1px solid #d0d7de;
            padding-bottom: 0.3em;
        }

        #markdownPreview h2 {
            font-size: 1.5em;
            border-bottom: 1px solid #d0d7de;
            padding-bottom: 0.3em;
        }

        #markdownPreview h3 {
            font-size: 1.25em;
        }

        #markdownPreview p {
            margin: 16px 0;
            line-height: 1.6;
            color: #000000 !important;
            font-size: inherit !important;
        }

        #markdownPreview a {
            color: #0066cc;
            text-decoration: none;
        }

        #markdownPreview a:hover {
            text-decoration: underline;
        }

        #markdownPreview ul,
        #markdownPreview ol {
            margin: 16px 0;
            padding-left: 32px;
        }

        #markdownPreview li {
            margin: 4px 0;
            color: #000000 !important;
            font-size: inherit !important;
        }

        #markdownPreview blockquote {
            margin: 16px 0;
            padding: 0 16px;
            border-left: 4px solid #666666;
            color: #333333;
            font-size: inherit !important;
        }

        #markdownPreview table {
            border-collapse: collapse;
            margin: 16px 0;
            width: 100%;
        }

        #markdownPreview th,
        #markdownPreview td {
            border: 1px solid #dddddd;
            padding: 8px 12px;
            text-align: left;
            color: #000000 !important;
            font-size: inherit !important;
        }

        #markdownPreview th {
            background-color: #e9ecef;
            font-weight: 600;
        }

        #markdownPreview tr:nth-child(even) {
            background-color: #f6f8fa;
        }

        #markdownPreview code {
            background-color: #2d2d2d;
            border-radius: 3px;
            padding: 2px 4px;
            font-size: inherit !important;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            color: #ffffff !important;
            font-weight: 500 !important;
        }

        #markdownPreview hr {
            border: none;
            height: 1px;
            background-color: #dddddd;
            margin: 24px 0;
        }

        /* MathJaxæ ·å¼ */
        .MathJax {
            color: #000000 !important;
        }

        .MathJax_Display {
            margin: 16px 0 !important;
        }

        /* ä»£ç å—æ ·å¼å¢å¼º */
        #markdownPreview pre {
            background-color: #1e1e1e !important;
            border: 1px solid #404040;
            border-radius: 6px;
            padding: 16px;
            overflow-x: auto;
            margin: 16px 0;
            font-size: inherit !important;
        }

        #markdownPreview pre code {
            background: transparent;
            padding: 0;
            border-radius: 0;
            color: #ffffff !important;
            font-size: inherit !important;
            font-weight: 500 !important;
        }

        /* è¦†ç›–Prism.jsè¯­æ³•é«˜äº®é¢œè‰²ï¼Œé€‚é…æ·±è‰²ä¸»é¢˜ */
        #markdownPreview .token.comment,
        #markdownPreview .token.prolog,
        #markdownPreview .token.doctype,
        #markdownPreview .token.cdata {
            color: #6a9955 !important;
        }

        #markdownPreview .token.punctuation {
            color: #d4d4d4 !important;
        }

        #markdownPreview .token.property,
        #markdownPreview .token.tag,
        #markdownPreview .token.boolean,
        #markdownPreview .token.number,
        #markdownPreview .token.constant,
        #markdownPreview .token.symbol {
            color: #569cd6 !important;
        }

        #markdownPreview .token.selector,
        #markdownPreview .token.attr-name,
        #markdownPreview .token.string,
        #markdownPreview .token.char,
        #markdownPreview .token.builtin {
            color: #ce9178 !important;
        }

        #markdownPreview .token.operator,
        #markdownPreview .token.entity,
        #markdownPreview .token.url,
        #markdownPreview .language-css .token.string,
        #markdownPreview .style .token.string {
            color: #d4d4d4 !important;
        }

        #markdownPreview .token.atrule,
        #markdownPreview .token.attr-value,
        #markdownPreview .token.keyword {
            color: #c586c0 !important;
        }

        #markdownPreview .token.function,
        #markdownPreview .token.class-name {
            color: #dcdcaa !important;
        }

        #markdownPreview .token.regex,
        #markdownPreview .token.important,
        #markdownPreview .token.variable {
            color: #9cdcfe !important;
        }
    </style>
</head>
<body>
    <!-- User Authentication Area -->
    <div class="user-auth-area">
        <div class="user-auth-left">
            <div class="logo-group">
                <img src="{{ url_for('static', filename='logo.png') }}" style="height: 2.2em; margin-right: 10px;" alt="Logo">
                <span style="font-size: 1.2em; font-weight: 700; color: #569cd6;">{{ i18n.app_title.replace(' GUI', '') }}</span>
            </div>
        </div>
        <div class="user-auth-right">
            <div class="api-key-group">
                <label for="modelSelect">
                    <i class="fas fa-brain"></i>
                    {{ i18n.model_label }}
                </label>
                <select id="modelSelect" class="api-key-input" title="{{ i18n.model_tooltip }}" style="width: 220px;">
                    <option value="" disabled selected>{{ 'åŠ è½½ä¸­...' if lang == 'zh' else 'Loading...' }}</option>
                </select>
            </div>
            <div class="api-key-group">
                <label for="apiKeyInput">
                    <i class="fas fa-key"></i>
                    {{ i18n.api_key_label }}
                </label>
                <div style="position: relative;">
                    <input type="password" id="apiKeyInput" class="api-key-input" 
                           placeholder="{{ i18n.api_key_placeholder }}" 
                           title="{{ i18n.api_key_tooltip }}" 
                           style="padding-right: 40px;">
                    <button type="button" id="apiKeyToggle" onclick="togglePasswordVisibility('apiKeyInput')" 
                            style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #9cdcfe; cursor: pointer; font-size: 21px; padding: 5px;" 
                            title="{{ 'æ˜¾ç¤ºå¯†ç ' if lang == 'zh' else 'Show password' }}">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>
            <button id="connectBtn" class="connect-btn connect">
                <i class="fas fa-plug"></i>
                <span>{{ i18n.connect_btn }}</span>
            </button>
            <div class="user-info">
                <div class="user-status">
                    <div class="user-status-indicator" id="userStatusIndicator"></div>
                    <span id="userStatusText">{{ i18n.user_disconnected }}</span>
                </div>
                <span id="userIdentity" style="margin-left: 10px;"></span>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="main-content">
            <div class="header" style="display: none;">
                <h1><img src="{{ url_for('static', filename='logo.png') }}" style="height: 1.8em; vertical-align: middle;" alt="Logo"> {{ i18n.app_title.replace(' GUI', '') }}</h1>
                <p>{{ i18n.app_subtitle }}</p>
            </div>

            <div class="chat-container">
                <div class="chat-header">
                    <h3>
                        <i class="fas fa-comments"></i>
                        {{ i18n.chat_title }}
                    </h3>
                    <div class="status-indicator" id="statusIndicator"></div>
                </div>
                <div class="chat-messages scrollbar-custom" id="chatMessages">
                    <div class="message system">
                        <strong><i class="fas fa-info-circle"></i> {{ i18n.get('system_message', 'ç³»ç»Ÿæ¶ˆæ¯' if lang == 'zh' else 'System Message') }}</strong><br>
                        {{ i18n.get('welcome_message', 'æ¬¢è¿ä½¿ç”¨ AGI Agentï¼è¯·åœ¨ä¸‹æ–¹è¾“å…¥æ‚¨çš„éœ€æ±‚ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ä¸ºæ‚¨å¤„ç†ä»»åŠ¡ã€‚' if lang == 'zh' else 'Welcome to AGI Agent! Please enter your requirements below, and the system will automatically process tasks for you.') }}
                    </div>
                </div>
                
                <!-- Scroll to bottom button -->
                <button class="scroll-to-bottom-hint" id="scrollToBottomBtn" title="{{ i18n.get('scroll_to_bottom', 'æ»šåŠ¨åˆ°åº•éƒ¨' if lang == 'zh' else 'Scroll to Bottom') }}">
                    <i class="fas fa-chevron-down"></i>
                </button>
                
                <!-- New message indicator -->
                <div class="new-message-indicator" id="newMessageIndicator">
                    <i class="fas fa-bell"></i>
                    <span id="newMessageCount">1</span> {{ i18n.get('new_messages', 'æ¡æ–°æ¶ˆæ¯' if lang == 'zh' else 'new messages') }}
                </div>
                

            </div>

            <div class="input-container">
                <div class="input-group">
                    <div class="input-wrapper">
                        <textarea 
                            id="userInput" 
                            placeholder="{{ i18n.input_placeholder }}"
                            rows="1"
                        ></textarea>
                    </div>
                    <div class="button-row">
                        <button class="send-button" id="sendButton" title="{{ i18n.direct_tooltip }}">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                        <button class="send-button" id="planButton" style="background-color: #ff9800;" title="{{ i18n.plan_tooltip }}">
                            <i class="fas fa-list-ul"></i>
                        </button>
                        <button class="send-button" id="newTaskButton" style="background-color: #4caf50;" title="{{ i18n.new_tooltip }}">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="send-button" id="configToggleBtn" style="background-color: #3e3e42;" title="{{ i18n.get('show_config_options', 'æ˜¾ç¤ºé…ç½®é€‰é¡¹' if lang == 'zh' else 'Show Configuration') }}">
                            <i class="fas fa-cog" id="configToggleIcon"></i>
                        </button>
                        <button class="send-button" id="stopButton" style="display: none; background-color: #f44336;">
                            <i class="fas fa-stop"></i>
                        </button>
                        <button class="send-button" id="clearChatButton" style="background-color: #6c757d;" title="{{ i18n.clear_chat_tooltip }}">
                            <i class="fas fa-broom"></i>
                        </button>
                    </div>
                </div>
                
                <!-- GUI Configuration Options -->
                <div id="configContainer" class="config-container" style="margin-top: 10px; padding: 15px; background: #2d2d30; border: 1px solid #3e3e42; border-radius: 8px; display: none;">
                    <div style="margin-bottom: 10px; font-weight: 500; color: #cccccc; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-cog"></i>
                        <span>{{ i18n.get('config_options', 'é…ç½®é€‰é¡¹' if lang == 'zh' else 'Configuration Options') }}</span>
                    </div>
                    <div class="config-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.85em;">
                        <label class="config-option" style="display: flex; align-items: center; gap: 6px; color: #cccccc; cursor: pointer;">
                            <input type="checkbox" id="enableWebSearch" checked style="margin: 0;">
                            <span>{{ i18n.get('enable_web_search', 'æœç´¢ç½‘ç»œ' if lang == 'zh' else 'Web Search') }}</span>
                        </label>
                        <label class="config-option" style="display: flex; align-items: center; gap: 6px; color: #cccccc; cursor: pointer;">
                            <input type="checkbox" id="enableKnowledgeBase" checked style="margin: 0;">
                            <span>{{ i18n.get('enable_knowledge_base', 'æœç´¢çŸ¥è¯†åº“' if lang == 'zh' else 'Knowledge Base') }}</span>
                        </label>
                        <label class="config-option" style="display: flex; align-items: center; gap: 6px; color: #cccccc; cursor: pointer;">
                            <input type="checkbox" id="enableMultiAgent" style="margin: 0;">
                            <span>{{ i18n.get('enable_multi_agent', 'å¯åŠ¨å¤šæ™ºèƒ½ä½“' if lang == 'zh' else 'Multi-Agent') }}</span>
                        </label>
                        <label class="config-option" style="display: flex; align-items: center; gap: 6px; color: #cccccc; cursor: pointer;">
                            <input type="checkbox" id="enableLongTermMemory" checked style="margin: 0;">
                            <span>{{ i18n.get('enable_long_term_memory', 'å¯åŠ¨é•¿æœŸè®°å¿†' if lang == 'zh' else 'Long-term Memory') }}</span>
                        </label>
                        <label class="config-option" style="display: flex; align-items: center; gap: 6px; color: #cccccc; cursor: pointer;">
                            <input type="checkbox" id="enableMCP" style="margin: 0;">
                            <span>{{ i18n.get('enable_mcp', 'å¯åŠ¨MCP' if lang == 'zh' else 'Enable MCP') }}</span>
                        </label>
                        <label class="config-option" style="display: flex; align-items: center; gap: 6px; color: #cccccc; cursor: pointer;">
                            <input type="checkbox" id="enableJieba" checked style="margin: 0;">
                            <span>{{ i18n.get('enable_jieba', 'å¯ç”¨ä¸­æ–‡åˆ†è¯' if lang == 'zh' else 'Chinese Segmentation') }}</span>
                        </label>

                    </div>
                </div>
                
                <!-- Routine file selection (moved from config panel) -->
                <div style="margin-top: 10px; padding: 10px; background: #2d2d30; border: 1px solid #3e3e42; border-radius: 8px; display: flex; align-items: center; gap: 10px; font-size: 0.9em;">
                    <label for="routineSelect" style="color: #cccccc; white-space: nowrap; display: flex; align-items: center; gap: 6px;">
                        <i class="fas fa-file-text"></i>
                        {{ i18n.get('routine_file', 'æŒ‡å¯¼æ–‡ä»¶' if lang == 'zh' else 'Routine File') }}:
                    </label>
                    <select id="routineSelect" style="flex: 1; padding: 6px 10px; border: 1px solid #3e3e42; border-radius: 4px; background: #1e1e1e; color: #cccccc; font-size: 0.9em; min-width: 150px;">
                        <option value="">{{ i18n.get('no_routine', 'æ— ' if lang == 'zh' else 'None') }}</option>
                    </select>
                </div>
                
                <div id="taskModeInfo" style="margin-top: 10px; font-size: 0.9em; color: #666; text-align: center;">
                    <!-- Task mode information will be displayed here -->
                </div>
            </div>
            
            <!-- GitHub Link - moved to bottom right corner -->
            <div class="github-link-container" style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
                <a href="https://github.com/agi-hub/AGIAgent" target="_blank" rel="noopener noreferrer" 
                   style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 12px; 
                          background: #333; color: #fff; text-decoration: none; border-radius: 6px; 
                          font-size: 0.9em; border: 1px solid #555; transition: all 0.3s ease;
                          box-shadow: 0 2px 4px rgba(0,0,0,0.3);"
                   onmouseover="this.style.background='#444'; this.style.borderColor='#777'; this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.4)'"
                   onmouseout="this.style.background='#333'; this.style.borderColor='#555'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.3)'"
                   title="è®¿é—®AGIAgenté¡¹ç›®ä¸»é¡µ">
                    <i class="fab fa-github" style="font-size: 1.1em;"></i>
                    <span>{{ 'GitHub' if lang == 'en' else 'GitHub' }}</span>
                </a>
            </div>
        </div>

        <div class="resizer" id="resizer"></div>

        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-folder-open"></i>
                <h3>{{ i18n.get('workspace_title', 'å·¥ä½œç›®å½•' if lang == 'zh' else 'Workspace') }}</h3>
                <button class="action-btn" onclick="manualRefresh()" title="{{ i18n.refresh_tooltip }}">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            
            <div class="loading" id="sidebarLoading">
                <div class="spinner"></div>
                <p>{{ i18n.loading }}</p>
            </div>
            
            <div class="directory-list scrollbar-custom" id="directoryList">
                <!-- Directory list will be dynamically generated through JavaScript -->
            </div>
        </div>
    </div>

    <!-- File preview modal -->
    <div id="previewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="previewTitle">{{ i18n.get('file_preview', 'æ–‡ä»¶é¢„è§ˆ' if lang == 'zh' else 'File Preview') }}</h3>
                <span class="close" id="previewClose">&times;</span>
            </div>
            <div class="modal-body">
                <div id="previewContent"></div>
            </div>
        </div>
    </div>

    <!-- File upload modal -->
    <div id="uploadModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="uploadTitle">{{ i18n.upload_title }}</h3>
                <span class="close" id="uploadClose">&times;</span>
            </div>
            <div class="modal-body">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <div class="upload-text">
                        <p>{{ i18n.get('drag_files', 'æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶' if lang == 'zh' else 'Drag files here or click to select files') }}</p>
                        <p class="upload-hint">{{ i18n.get('upload_hint', 'æ”¯æŒå¤šæ–‡ä»¶ä¸Šä¼ ï¼Œæ–‡ä»¶å°†ä¿å­˜åˆ°é€‰å®šç›®å½•çš„workspaceæ–‡ä»¶å¤¹ä¸­' if lang == 'zh' else 'Supports multiple file upload, files will be saved to the workspace folder of the selected directory') }}</p>
                    </div>
                    <input type="file" id="fileInput" multiple style="display: none;">
                    <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-folder-open"></i> {{ i18n.get('select_files', 'é€‰æ‹©æ–‡ä»¶' if lang == 'zh' else 'Select Files') }}
                    </button>
                </div>
                <div class="upload-progress" id="uploadProgress" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">{{ i18n.get('uploading', 'ä¸Šä¼ ä¸­...' if lang == 'zh' else 'Uploading...') }}</div>
                </div>
                <div class="upload-result" id="uploadResult"></div>
            </div>
        </div>
    </div>



    <!-- Rename Directory Modal -->
    <div id="renameModal" class="modal">
        <div class="modal-content" style="width: 80%; max-width: 500px; height: auto;">
            <div class="modal-header">
                <h3><i class="fas fa-edit"></i> {{ i18n.rename_title }}</h3>
                <span class="close" id="renameClose">&times;</span>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #cccccc; font-weight: 500;">{{ i18n.current_name }}</label>
                    <div id="currentDirName" style="background: #2d2d30; padding: 10px; border-radius: 4px; color: #9cdcfe; font-family: monospace;"></div>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; color: #cccccc; font-weight: 500;">{{ i18n.new_name }}</label>
                    <input type="text" id="newDirName" placeholder="{{ i18n.get('rename_placeholder', 'Enter new directory name...' if lang == 'en' else 'è¾“å…¥æ–°çš„ç›®å½•åç§°...') }}" 
                           style="width: 100%; padding: 10px; background: #1e1e1e; border: 1px solid #3e3e42; border-radius: 4px; color: #cccccc; font-family: monospace;">
                    <div style="margin-top: 5px; font-size: 0.9em; color: #9cdcfe;">
                        <i class="fas fa-info-circle"></i> {{ i18n.rename_info }}
                    </div>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button id="renameCancel" class="action-btn" style="background: #6c757d; color: white; padding: 10px 20px;">
                        <i class="fas fa-times"></i> {{ i18n.cancel }}
                    </button>
                    <button id="renameConfirm" class="action-btn" style="background: #007acc; color: white; padding: 10px 20px;">
                        <i class="fas fa-check"></i> {{ i18n.confirm_rename }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Model Configuration Modal -->
    <div id="customConfigModal" class="modal">
        <div class="modal-content" style="width: 80%; max-width: 600px; height: auto;">
            <div class="modal-header">
                <h3><i class="fas fa-cog"></i> {{ i18n.custom_config_title }}</h3>
                <span class="close" id="customConfigClose">&times;</span>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; color: #cccccc; font-weight: 500;">{{ i18n.custom_api_key_label }}</label>
                    <div style="position: relative;">
                        <input type="password" id="customApiKey" placeholder="{{ i18n.custom_api_key_placeholder }}" 
                               style="width: 100%; padding: 10px 40px 10px 10px; background: #1e1e1e; border: 1px solid #3e3e42; border-radius: 4px; color: #cccccc; font-family: monospace;">
                        <button type="button" id="customApiKeyToggle" onclick="togglePasswordVisibility('customApiKey')" 
                                style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #9cdcfe; cursor: pointer; font-size: 21px; padding: 5px;" 
                                title="{{ 'æ˜¾ç¤ºå¯†ç ' if lang == 'zh' else 'Show password' }}">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; color: #cccccc; font-weight: 500;">{{ i18n.custom_api_base_label }}</label>
                    <input type="text" id="customApiBase" placeholder="{{ i18n.custom_api_base_placeholder }}" 
                           style="width: 100%; padding: 10px; background: #1e1e1e; border: 1px solid #3e3e42; border-radius: 4px; color: #cccccc; font-family: monospace;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; color: #cccccc; font-weight: 500;">{{ i18n.custom_model_label }}</label>
                    <input type="text" id="customModel" placeholder="{{ i18n.custom_model_placeholder }}" 
                           style="width: 100%; padding: 10px; background: #1e1e1e; border: 1px solid #3e3e42; border-radius: 4px; color: #cccccc; font-family: monospace;">
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; color: #cccccc; font-weight: 500;">{{ i18n.custom_max_tokens_label }}</label>
                    <input type="number" id="customMaxTokens" placeholder="{{ i18n.custom_max_tokens_placeholder }}" value="8192" min="1" max="1000000"
                           style="width: 100%; padding: 10px; background: #1e1e1e; border: 1px solid #3e3e42; border-radius: 4px; color: #cccccc; font-family: monospace;">
                </div>
                <div id="customConfigError" style="display: none; color: #ff6b6b; margin-bottom: 15px;">
                    <i class="fas fa-exclamation-triangle"></i> <span id="customConfigErrorText"></span>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button id="customConfigCancel" class="action-btn" style="background: #6c757d; color: white; padding: 10px 20px;">
                        <i class="fas fa-times"></i> {{ i18n.custom_config_cancel }}
                    </button>
                    <button id="customConfigSave" class="action-btn" style="background: #007acc; color: white; padding: 10px 20px;">
                        <i class="fas fa-save"></i> {{ i18n.custom_config_save }}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/socket.io.js') }}"></script>
    <script src="{{ url_for('static', filename='js/marked.min.js') }}"></script>
    <script id="i18nData" type="application/json">{{ i18n | tojson }}</script>
    <script>
        // Internationalization configuration
        const I18N = JSON.parse(document.getElementById('i18nData').textContent);
        const CURRENT_LANG = '{{ lang }}';
    </script>
    <script>
        // User connection management
        let socket = null;
        let currentUser = null;
        let isConnected = false;
        
        // Socket.IO connection configuration (will be initialized when user connects)
        function createSocket(apiKey) {
            return io({
                reconnection: false,  // ç¦ç”¨è‡ªåŠ¨é‡è¿
                timeout: 60000,                 // è¿æ¥è¶…æ—¶60ç§’
                forceNew: true,
                // ğŸ”§ ä¿®å¤ä¼ è¾“é…ç½®ï¼šä¼˜å…ˆä½¿ç”¨WebSocketï¼Œfallbackåˆ°polling
                transports: ['websocket', 'polling'],
                upgrade: true,                  // å…è®¸ä¼ è¾“å‡çº§
                rememberUpgrade: true,          // è®°ä½å‡çº§çŠ¶æ€
                // ğŸ”§ æ·»åŠ WebSocketç‰¹å®šé…ç½®
                transportOptions: {
                    websocket: {
                        maxHttpBufferSize: 1e8      // å¢åŠ ç¼“å†²åŒºå¤§å°
                    }
                },
                auth: {
                    api_key: apiKey || null
                }
            });
        }
        
        // DOM elements
        const chatMessages = document.getElementById('chatMessages');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const planButton = document.getElementById('planButton');

        const newTaskButton = document.getElementById('newTaskButton');
        const stopButton = document.getElementById('stopButton');
        const clearChatButton = document.getElementById('clearChatButton');
        const statusIndicator = document.getElementById('statusIndicator');
        const directoryList = document.getElementById('directoryList');
        const sidebarLoading = document.getElementById('sidebarLoading');
        
        // User authentication elements
        const apiKeyInput = document.getElementById('apiKeyInput');
        const connectBtn = document.getElementById('connectBtn');
        const userStatusIndicator = document.getElementById('userStatusIndicator');
        const userStatusText = document.getElementById('userStatusText');
        const userIdentity = document.getElementById('userIdentity');
        
        // State management
        let isTaskRunning = false;
        let selectedDirectory = null;
        let taskMode = 'new'; // 'new', 'continue', 'selected' - é»˜è®¤ä¸ºæ–°å»ºæ¨¡å¼
        let expandedDirectories = new Set();
        let collapsedSubDirectories = new Set(); // Save collapsed subdirectory state
        let isUserScrolling = false; // Whether user is manually scrolling
        let autoScrollEnabled = true; // Whether auto-scroll is enabled
        let refreshTimeout = null; // Debounce timer
        let scrollDirection = 'down'; // 'up' or 'down'
        let lastScrollTop = 0;
        let isGuest = false; // æ·»åŠ guestçŠ¶æ€è·Ÿè¸ª
        let newMessageCount = 0; // New message counter
        let lastMessageTime = 0;
        let pendingUserInput = ''; // ä¿å­˜ç­‰å¾…æ‰§è¡Œçš„ç”¨æˆ·è¾“å…¥

        // User connection management functions
        function updateUserStatus(status, message, identity = '', isGuest = false) {
            const statusClasses = {
                'disconnected': '',
                'connecting': 'connecting',
                'connected': 'connected',
                'error': 'error'
            };
            
            let className = 'user-status-indicator ' + (statusClasses[status] || '');
            if (status === 'connected' && isGuest) {
                className += ' guest';
                message = I18N.temporary_connection || 'ä¸´æ—¶è¿æ¥';
            }
            
            userStatusIndicator.className = className;
            userStatusText.textContent = message;
            userIdentity.textContent = identity;
            
            // Update connect button
            if (status === 'connected') {
                connectBtn.className = 'connect-btn disconnect';
                connectBtn.innerHTML = `<i class="fas fa-unlink"></i><span>${I18N.disconnect_btn}</span>`;
                connectBtn.disabled = false;
                isConnected = true;
                
                // Enable UI controls
                enableUI(true);
            } else if (status === 'connecting') {
                connectBtn.disabled = true;
                connectBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i><span>${I18N.connecting}</span>`;
                
                // Disable UI controls
                enableUI(false);
            } else {
                connectBtn.className = 'connect-btn connect';
                connectBtn.innerHTML = `<i class="fas fa-plug"></i><span>${I18N.connect_btn}</span>`;
                connectBtn.disabled = false;
                isConnected = false;
                
                // Disable UI controls
                enableUI(false);
            }
        }
        
        function enableUI(enabled) {
            userInput.disabled = !enabled || isTaskRunning;
            sendButton.disabled = !enabled || isTaskRunning;
            planButton.disabled = !enabled || isTaskRunning;
            newTaskButton.disabled = !enabled || isTaskRunning;
            
            // Enable/disable directory operations
            const actionBtns = document.querySelectorAll('.directory-item .action-btn');
            actionBtns.forEach(btn => {
                btn.disabled = !enabled;
            });
        }
        
        function connectUser() {
            const apiKey = apiKeyInput.value.trim();
            
            updateUserStatus('connecting', I18N.connecting);
            
            // Create socket connection
            socket = createSocket(apiKey);
            currentUser = apiKey || 'default';
            
            // Setup socket event listeners
            setupSocketListeners();
            
            // Attempt to connect
            socket.connect();
        }
        
        function disconnectUser() {
            if (socket) {
                socket.disconnect();
                socket = null;
            }
            
            currentUser = null;
            updateUserStatus('disconnected', I18N.user_disconnected);
            
            // Clear saved session from localStorage
            try {
                localStorage.removeItem('agia_api_key');
                console.log('ğŸ—‘ï¸ Cleared saved session from localStorage');
            } catch (error) {
                console.warn('âš ï¸ Failed to clear session from localStorage:', error);
            }
            
            // Clear chat messages
            chatMessages.innerHTML = `
                <div class="message system">
                    <strong><i class="fas fa-info-circle"></i> ${I18N.system_message || 'ç³»ç»Ÿæ¶ˆæ¯'}</strong><br>
                    ${I18N.welcome_message || 'æ¬¢è¿ä½¿ç”¨ AGI Agentï¼è¯·åœ¨ä¸‹æ–¹è¾“å…¥æ‚¨çš„éœ€æ±‚ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ä¸ºæ‚¨å¤„ç†ä»»åŠ¡ã€‚'}
                </div>
            `;
            
            // Clear directory list
            directoryList.innerHTML = '';
            selectedDirectory = null;
            taskMode = 'new';
            updateTaskModeInfo();
        }

        // File preview functionality
        const previewModal = document.getElementById('previewModal');
        const previewTitle = document.getElementById('previewTitle');
        const previewContent = document.getElementById('previewContent');
        const previewClose = document.getElementById('previewClose');

        // File upload functionality
        const uploadModal = document.getElementById('uploadModal');
        const uploadTitle = document.getElementById('uploadTitle');
        const uploadClose = document.getElementById('uploadClose');
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const uploadProgress = document.getElementById('uploadProgress');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const uploadResult = document.getElementById('uploadResult');
        
        let currentUploadDir = null;
        
        // Setup socket event listeners
        function setupSocketListeners() {
            if (!socket) return;
            
            socket.on('connect', function() {
                const identity = currentUser === 'default' ? I18N.default_user : `${I18N.user_prefix}: ${currentUser}`;
                updateUserStatus('connected', I18N.user_connected, identity);
                addMessage(I18N.connected, 'system');
                updateStatus('connected');
                updateTaskModeInfo(); // Initialize task mode info display

                // Save API key to localStorage for session restoration
                try {
                    if (currentUser && currentUser !== 'default') {
                        localStorage.setItem('agia_api_key', currentUser);
                        console.log('ğŸ’¾ API key saved to localStorage for session restoration');
                    } else {
                        // For default user, save a special marker
                        localStorage.setItem('agia_api_key', '');
                        console.log('ğŸ’¾ Default user session saved to localStorage');
                    }
                } catch (error) {
                    console.warn('âš ï¸ Failed to save session to localStorage:', error);
                }
                
                // Refresh directories for this user
                refreshDirectories();
                
                // Ensure scroll to bottom after connection
                setTimeout(() => {
                    scrollToBottom(false);
                }, 100);
                console.log('âœ… Socket connected for user:', currentUser);
            });
            
            socket.on('status', function(data) {
                isGuest = data.is_guest || false; // ä¿å­˜åˆ°å…¨å±€å˜é‡
                const userName = data.user_name || 'unknown';
                let identity = '';
                
                if (isGuest) {
                    identity = I18N.guest_user || 'è®¿å®¢ç”¨æˆ·';
                } else {
                    identity = currentUser === 'default' ? I18N.default_user : `${I18N.user_prefix}: ${currentUser}`;
                }
                
                updateUserStatus('connected', I18N.user_connected, identity, isGuest);
                console.log('âœ… Socket status updated:', data);
            });

            socket.on('disconnect', function(reason) {
                updateUserStatus('disconnected', I18N.user_disconnected);
                addMessage(`ğŸ”Œ ${I18N.disconnected} (${reason})`, 'warning');
                updateStatus('disconnected');
                
                                 // If task is running, give special prompt
                if (isTaskRunning) {
                    addMessage('âš ï¸ è¿æ¥ä¸­æ–­ï¼Œä»»åŠ¡å¯èƒ½å·²åœæ­¢ã€‚è¯·æ‰‹åŠ¨åˆ·æ–°é¡µé¢ã€‚', 'warning');
                }
                
                console.log('âŒ Socket disconnected:', reason);
            });

            socket.on('auth_failed', function(data) {
                updateUserStatus('error', 'è®¤è¯å¤±è´¥');
                addMessage('è®¤è¯å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                console.log('âŒ Authentication failed:', data);
            });

            
            socket.on('connect_error', function(error) {
                updateUserStatus('error', 'è¿æ¥é”™è¯¯');
                addMessage('è¿æ¥é”™è¯¯: ' + error.message, 'error');
                console.log('âŒ Connection error:', error);
            });

            socket.on('task_started', function(data) {
                // ä»»åŠ¡å¼€å§‹æ—¶é‡ç½®æ¶ˆæ¯çŠ¶æ€ï¼Œç¡®ä¿æ–°çš„ä»»åŠ¡ä»æ–°çš„infoæ¶ˆæ¯æ¡†å¼€å§‹
                lastMessageType = null;
                lastMessageDiv = null;
                
                addMessage(data.message, 'info');
                setTaskRunning(true);
                // ä»»åŠ¡çœŸæ­£å¼€å§‹æ—¶æ‰æ¸…ç©ºè¾“å…¥æ¡†å’Œå¾…æ‰§è¡Œå†…å®¹
                userInput.value = '';
                pendingUserInput = '';
                resizeTextarea();
            });

            socket.on('output', function(data) {
                addMessage(data.message, data.type || 'info');
            });

            socket.on('task_completed', function(data) {
                addMessage(data.message, data.success ? 'success' : 'error');
                setTaskRunning(false);
                // ä»»åŠ¡å®Œæˆæ—¶æ¸…ç†å¾…æ‰§è¡Œå†…å®¹
                pendingUserInput = '';
                
                // After task completion, if there's a selected directory, keep selection state, otherwise switch to continue mode
                if (selectedDirectory) {
                    taskMode = 'selected';
                    // If the completed task directory is the selected directory, auto-expand it
                    if (data.output_dir && data.output_dir === selectedDirectory) {
                        expandedDirectories.add(selectedDirectory);
                    }
                } else {
                    taskMode = 'continue';
                    // If there's a working directory, auto-expand the latest directory
                    if (data.output_dir) {
                        expandedDirectories.add(data.output_dir);
                    }
                }
                updateTaskModeInfo();
                
                // Refresh directory list with longer delay to ensure files are generated
                setTimeout(() => {
                    refreshDirectories();
                }, 2000);
            });

            socket.on('task_stopped', function(data) {
                addMessage(data.message, data.type || 'error');
                setTaskRunning(false);
                // ä»»åŠ¡åœæ­¢æ—¶ï¼Œå¦‚æœæœ‰å¾…æ‰§è¡Œçš„ç”¨æˆ·è¾“å…¥ï¼Œæ¢å¤åˆ°è¾“å…¥æ¡†
                if (pendingUserInput) {
                    userInput.value = pendingUserInput;
                    pendingUserInput = '';
                    resizeTextarea();
                }
                // Keep current task mode
                updateTaskModeInfo();
                // Refresh directories after stopping task
                setTimeout(refreshDirectories, 1000);
            });

            socket.on('error', function(data) {
                addMessage(data.message, 'error');
                setTaskRunning(false);
                // å¦‚æœæœ‰å¾…æ‰§è¡Œçš„ç”¨æˆ·è¾“å…¥ï¼Œæ¢å¤åˆ°è¾“å…¥æ¡†
                if (pendingUserInput) {
                    userInput.value = pendingUserInput;
                    pendingUserInput = '';
                    resizeTextarea();
                }
            });

            socket.on('directory_selected', function(data) {
                selectedDirectory = data.dir_name;
                if (selectedDirectory) {
                    taskMode = 'selected';
                    updateTaskModeInfo();
                    refreshDirectories();
                }
            });

            socket.on('directory_created', function(data) {
                if (data.success) {
                    selectedDirectory = data.dir_name;
                    taskMode = 'selected';
                    addMessage(data.message, 'success');
                    updateTaskModeInfo();
                    refreshDirectories();
                } else {
                    addMessage(`${I18N.create_directory_failed}: ${data.error}`, 'error');
                }
            });

            socket.on('chat_cleared', function(data) {
                if (data.success) {
                    addMessage(data.message, 'success');
                } else {
                    addMessage(`${I18N.chat_cleared}: ${data.error}`, 'error');
                }
            });
        }

        // Message handling
        let lastMessageType = null;
        let lastMessageDiv = null;
        
        // æ‰¹é‡æ¶ˆæ¯å¤„ç†ç›¸å…³å˜é‡
        let messageBatchQueue = [];
        let batchProcessingTimer = null;
        let isBatchProcessing = false;
        const BATCH_DELAY = 50; // æ‰¹é‡å¤„ç†å»¶è¿Ÿæ—¶é—´(æ¯«ç§’)
        const MAX_BATCH_SIZE = 20; // æœ€å¤§æ‰¹å¤„ç†æ¶ˆæ¯æ•°é‡
        let batchScrollPending = false;
        
        /**
         * æ£€æŸ¥æ˜¯å¦åº”è¯¥æ‰§è¡Œè‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
         * @returns {boolean} æ˜¯å¦åº”è¯¥è‡ªåŠ¨æ»šåŠ¨
         * @description æ™ºèƒ½åˆ¤æ–­è‡ªåŠ¨æ»šåŠ¨æ¡ä»¶ï¼š
         * 1. è‡ªåŠ¨æ»šåŠ¨åŠŸèƒ½å¿…é¡»å¯ç”¨
         * 2. å¦‚æœç”¨æˆ·æ­£åœ¨å‘ä¸Šæ»šåŠ¨ä¸”ä¸åœ¨åº•éƒ¨é™„è¿‘ï¼Œåˆ™ä¸è‡ªåŠ¨æ»šåŠ¨
         * 3. å…¶ä»–æƒ…å†µä¸‹å…è®¸è‡ªåŠ¨æ»šåŠ¨
         */
        function shouldAutoScroll() {
            // å¦‚æœè‡ªåŠ¨æ»šåŠ¨è¢«ç¦ç”¨ï¼Œç›´æ¥è¿”å›false
            if (!autoScrollEnabled) {
                console.log('ğŸš« Auto-scroll disabled');
                return false;
            }
            
            // ä½¿ç”¨ç»Ÿä¸€çš„é˜ˆå€¼æ£€æŸ¥æ˜¯å¦å·²ç»æ¥è¿‘åº•éƒ¨
            const isNearBottom = chatMessages.scrollTop + chatMessages.clientHeight >= chatMessages.scrollHeight - SCROLL_THRESHOLD;
            
            // å¦‚æœç”¨æˆ·æ­£åœ¨å‘ä¸Šæ»šåŠ¨ä¸”ä¸åœ¨åº•éƒ¨é™„è¿‘ï¼Œåˆ™ä¸æ‰§è¡Œè‡ªåŠ¨æ»šåŠ¨
            if (isUserScrolling && scrollDirection === 'up' && !isNearBottom) {
                console.log('ğŸš« User scrolling up away from bottom');
                return false;
            }
            
            // å…¶ä»–æƒ…å†µä¸‹ï¼Œåªè¦è‡ªåŠ¨æ»šåŠ¨å¯ç”¨å°±å…è®¸æ»šåŠ¨
            console.log('âœ… Auto-scroll allowed', {
                autoScrollEnabled,
                isUserScrolling,
                scrollDirection,
                isNearBottom
            });
            return autoScrollEnabled;
        }
        
        // HTML escape function
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        /**
         * æ‰¹é‡å¤„ç†æ¶ˆæ¯é˜Ÿåˆ—
         * @description å°†é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰æ¶ˆæ¯ä¸€æ¬¡æ€§æ·»åŠ åˆ°DOMï¼Œç„¶åæ‰§è¡Œä¸€æ¬¡æ»šåŠ¨
         */
        function processBatchMessages() {
            if (messageBatchQueue.length === 0) {
                return;
            }
            
            isBatchProcessing = true;
            const shouldScroll = shouldAutoScroll();
            
            // åˆ›å»ºæ–‡æ¡£ç‰‡æ®µä»¥ä¼˜åŒ–DOMæ“ä½œæ€§èƒ½
            const fragment = document.createDocumentFragment();
            
            // å¤„ç†é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰æ¶ˆæ¯
            for (const messageData of messageBatchQueue) {
                const { message, type } = messageData;
                
                // å¯¹äºinfoç±»å‹çš„æ¶ˆæ¯ï¼Œæ€»æ˜¯å°è¯•åˆå¹¶åˆ°ä¸Šä¸€ä¸ªinfoæ¶ˆæ¯æ¡†ä¸­
                if (type === 'info' && 
                    lastMessageType === 'info' && 
                    lastMessageDiv && 
                    lastMessageDiv.parentNode === chatMessages) {
                    
                    // åˆå¹¶åˆ°ç°æœ‰infoæ¶ˆæ¯
                    const textSpan = lastMessageDiv.querySelector('.message-text');
                    if (textSpan) {
                        textSpan.innerHTML += '<br>' + escapeHtml(message);
                    } else {
                        lastMessageDiv.innerHTML += '<br>' + escapeHtml(message);
                    }
                } else if (['error', 'success'].includes(type) && 
                    lastMessageType === type && 
                    lastMessageDiv && 
                    lastMessageDiv.parentNode === chatMessages) {
                    
                    // å¯¹äºerrorå’Œsuccessç±»å‹ï¼Œä¿æŒåŸæœ‰åˆå¹¶é€»è¾‘
                    const textSpan = lastMessageDiv.querySelector('.message-text');
                    if (textSpan) {
                        textSpan.innerHTML += '<br>' + escapeHtml(message);
                    } else {
                        lastMessageDiv.innerHTML += '<br>' + escapeHtml(message);
                    }
                } else {
                    // åˆ›å»ºæ–°çš„æ¶ˆæ¯å…ƒç´ 
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${type}`;
                    
                    const textSpan = document.createElement('span');
                    textSpan.className = 'message-text';
                    textSpan.textContent = message;
                    
                    messageDiv.appendChild(textSpan);
                    fragment.appendChild(messageDiv);
                    
                    // æ›´æ–°lastMessageå¼•ç”¨
                    if (['info', 'error', 'success'].includes(type)) {
                        lastMessageType = type;
                        lastMessageDiv = messageDiv;
                    } else {
                        lastMessageType = null;
                        lastMessageDiv = null;
                    }
                }
            }
            
            // ä¸€æ¬¡æ€§æ·»åŠ æ‰€æœ‰æ–°æ¶ˆæ¯åˆ°DOM
            if (fragment.children.length > 0) {
                chatMessages.appendChild(fragment);
            }
            
            // æ¸…ç©ºé˜Ÿåˆ—
            messageBatchQueue = [];
            isBatchProcessing = false;
            
            // æ‰¹é‡å¤„ç†å®Œæˆåæ‰§è¡Œä¸€æ¬¡æ»šåŠ¨
            if (shouldScroll && batchScrollPending) {
                // ä½¿ç”¨requestAnimationFrameç¡®ä¿DOMæ›´æ–°å®Œæˆåå†æ»šåŠ¨
                requestAnimationFrame(() => {
                    throttledAutoScroll(true);
                    batchScrollPending = false;
                });
            } else if (!shouldScroll && batchScrollPending) {
                // å¦‚æœä¸èƒ½è‡ªåŠ¨æ»šåŠ¨ï¼Œæ˜¾ç¤ºæ–°æ¶ˆæ¯æŒ‡ç¤ºå™¨
                showNewMessageIndicator();
                batchScrollPending = false;
            }
        }
        
        /**
         * è°ƒåº¦æ‰¹é‡æ¶ˆæ¯å¤„ç†
         * @description è®¾ç½®å®šæ—¶å™¨æ¥å»¶è¿Ÿå¤„ç†æ¶ˆæ¯ï¼Œå¦‚æœé˜Ÿåˆ—æ»¡äº†åˆ™ç«‹å³å¤„ç†
         */
        function scheduleBatchProcessing() {
            // å¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼Œç«‹å³å¤„ç†
            if (messageBatchQueue.length >= MAX_BATCH_SIZE) {
                clearTimeout(batchProcessingTimer);
                processBatchMessages();
                return;
            }
            
            // å¦åˆ™è®¾ç½®å»¶è¿Ÿå¤„ç†
            if (batchProcessingTimer) {
                clearTimeout(batchProcessingTimer);
            }
            
            batchProcessingTimer = setTimeout(() => {
                processBatchMessages();
                batchProcessingTimer = null;
            }, BATCH_DELAY);
        }
        
        function addMessage(message, type = 'info') {
            // Special filtering: hide lines containing specific content
            if (message.trim() === '```' || message.trim() === '```xml') {
                return; // Don't display these lines
            }
            
            // Check if message contains warning and treat it as normal text
            const messageLower = message.toLowerCase();
            if (type === 'info' && (messageLower.includes('warning') || messageLower.includes('userwarning') || messageLower.includes('warnings.warn'))) {
                type = 'normal'; // Use normal style for warning messages
            }
            
            // å¯¹äºç”¨æˆ·æ¶ˆæ¯æˆ–é‡è¦æ¶ˆæ¯ï¼Œç«‹å³å¤„ç†ä¸è¿›å…¥æ‰¹å¤„ç†é˜Ÿåˆ—
            if (type === 'user' || type === 'system' || isBatchProcessing) {
                addMessageImmediate(message, type);
                return;
            }
            
            // å°†æ¶ˆæ¯æ·»åŠ åˆ°æ‰¹å¤„ç†é˜Ÿåˆ—
            messageBatchQueue.push({ message, type });
            
            // æ ‡è®°éœ€è¦æ»šåŠ¨ï¼ˆå¦‚æœæ»¡è¶³æ¡ä»¶ï¼‰
            if (shouldAutoScroll()) {
                batchScrollPending = true;
            }
            
            // è°ƒåº¦æ‰¹é‡å¤„ç†
            scheduleBatchProcessing();
        }
        
        /**
         * ç«‹å³æ·»åŠ æ¶ˆæ¯ï¼ˆä¸ä½¿ç”¨æ‰¹å¤„ç†ï¼‰
         * @param {string} message æ¶ˆæ¯å†…å®¹
         * @param {string} type æ¶ˆæ¯ç±»å‹
         * @description ç”¨äºå¤„ç†ç”¨æˆ·æ¶ˆæ¯ã€ç³»ç»Ÿæ¶ˆæ¯æˆ–æ‰¹å¤„ç†è¿‡ç¨‹ä¸­çš„æ¶ˆæ¯
         */
        function addMessageImmediate(message, type = 'info') {
            const shouldScroll = shouldAutoScroll();
            
            // å¯¹äºinfoç±»å‹çš„æ¶ˆæ¯ï¼Œæ€»æ˜¯å°è¯•è¿½åŠ åˆ°ä¸Šä¸€ä¸ªinfoæ¶ˆæ¯æ¡†ä¸­
            if (type === 'info' && lastMessageType === 'info' && lastMessageDiv && lastMessageDiv.parentNode === chatMessages) {
                // è¿½åŠ åˆ°ç°æœ‰çš„infoæ¶ˆæ¯æ¡†
                const textSpan = lastMessageDiv.querySelector('.message-text');
                if (textSpan) {
                    textSpan.innerHTML += '<br>' + escapeHtml(message);
                } else {
                    // If no text span found, fallback to original method but with escaping
                    lastMessageDiv.innerHTML += '<br>' + escapeHtml(message);
                }
                if (shouldScroll) {
                    // ä½¿ç”¨èŠ‚æµçš„è‡ªåŠ¨æ»šåŠ¨å‡½æ•°ï¼Œå‡å°‘è·³åŠ¨
                    throttledAutoScroll(true);
                } else {
                    // If can't auto-scroll, show new message indicator
                    showNewMessageIndicator();
                }
                return;
            }
            
            // å¯¹äºå…¶ä»–ç±»å‹çš„æ¶ˆæ¯ï¼Œä¿æŒåŸæœ‰é€»è¾‘
            if (['error', 'success'].includes(type) && lastMessageType === type && lastMessageDiv) {
                // For consecutive messages of the same type, safely add content
                const textSpan = lastMessageDiv.querySelector('.message-text');
                if (textSpan) {
                    textSpan.innerHTML += '<br>' + escapeHtml(message);
                } else {
                    // If no text span found, fallback to original method but with escaping
                    lastMessageDiv.innerHTML += '<br>' + escapeHtml(message);
                }
                if (shouldScroll) {
                    // ä½¿ç”¨èŠ‚æµçš„è‡ªåŠ¨æ»šåŠ¨å‡½æ•°ï¼Œå‡å°‘è·³åŠ¨
                    throttledAutoScroll(true);
                } else {
                    // If can't auto-scroll, show new message indicator
                    showNewMessageIndicator();
                }
                return;
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            // Create text element, use textContent to ensure safe display
            const textSpan = document.createElement('span');
            textSpan.className = 'message-text';
            textSpan.textContent = message;
            
            // Directly add text, no icons
            messageDiv.appendChild(textSpan);
            
            chatMessages.appendChild(messageDiv);
            
            // Only scroll when auto-scroll is enabled
            if (shouldScroll) {
                // ä½¿ç”¨èŠ‚æµçš„è‡ªåŠ¨æ»šåŠ¨å‡½æ•°ï¼Œå‡å°‘è·³åŠ¨
                throttledAutoScroll(true);
            } else {
                // If can't auto-scroll, show new message indicator (except for user messages)
                if (type !== 'user') {
                    showNewMessageIndicator();
                }
            }

            if (['info', 'error', 'success'].includes(type)) {
                lastMessageType = type;
                lastMessageDiv = messageDiv;
            } else {
                lastMessageType = null;
                lastMessageDiv = null;
            }
        }

















        // Status update
        function updateStatus(status) {
            const indicator = statusIndicator;
            indicator.className = 'status-indicator';
            
            if (status === 'connected') {
                indicator.style.background = '#4CAF50';
            } else if (status === 'running') {
                indicator.style.background = '#007acc';
            } else if (status === 'disconnected') {
                indicator.style.background = '#F44336';
            }
        }

        function setTaskRunning(running) {
            isTaskRunning = running;
            userInput.disabled = running;
            
            if (running) {
                sendButton.style.display = 'none';
                planButton.style.display = 'none';
                newTaskButton.style.display = 'none';
                stopButton.style.display = 'flex';
                updateStatus('running');
            } else {
                sendButton.style.display = 'flex';
                planButton.style.display = 'flex';
                newTaskButton.style.display = 'flex';
                stopButton.style.display = 'none';
                updateStatus('connected');
            }
        }

        // Input handling
        async function sendMessage(planMode = false) {
            const message = userInput.value.trim();
            if (!message || isTaskRunning || !socket || !isConnected) return;

            // ä¿å­˜å½“å‰è¾“å…¥å†…å®¹ï¼Œä»¥é˜²å‡ºé”™æ—¶éœ€è¦æ¢å¤
            pendingUserInput = message;

            // æ£€æŸ¥guestç”¨æˆ·æƒé™
            if (isGuest) {
                addMessage('guestç”¨æˆ·ä¸ºæ¼”ç¤ºè´¦æˆ·ï¼Œæ— æ³•æ‰§è¡Œæ–°ä»»åŠ¡ã€‚', 'error');
                return;
            }

            // In new mode, prompt user to create or select directory first
            if (taskMode === 'new') {
                addMessage(I18N.create_or_select_directory, 'error');
                return;
            }

            // Get selected model configuration
            const modelConfig = getSelectedModelConfig();
            if (!modelConfig) {
                addMessage('è¯·é€‰æ‹©æœ‰æ•ˆçš„æ¨¡å‹é…ç½®', 'error');
                return;
            }
            
            // Validate configuration before execution
            try {
                const response = await fetch('/api/validate-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        config: modelConfig
                    })
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    addMessage(`${I18N.config_error_title}: ${result.error}`, 'error');
                    return;
                }
                
                // Configuration is valid, proceed with execution
                
                // Display execution mode information
                let modeInfo = '';
                if (planMode) {
                    modeInfo = I18N.plan_mode_suffix;
                    addMessage(`${message}${modeInfo}`, 'user');
                    addMessage(I18N.plan_mode_info, 'info');
                } else {
                    addMessage(message, 'user');
                    addMessage(I18N.direct_mode_info, 'info');
                }
                
                // Get GUI configuration options
                const guiConfig = {
                    enable_web_search: document.getElementById('enableWebSearch').checked,
                    enable_knowledge_base: document.getElementById('enableKnowledgeBase').checked,
                    enable_multi_agent: document.getElementById('enableMultiAgent').checked,
                    enable_long_term_memory: document.getElementById('enableLongTermMemory').checked,
                    enable_mcp: document.getElementById('enableMCP').checked,
                    enable_jieba: document.getElementById('enableJieba').checked,
                    routine_file: document.getElementById('routineSelect').value,
                    // Add model configuration
                    selected_model: modelConfig.model,
                    model_api_key: result.config.api_key,
                    model_api_base: result.config.api_base,
                    model_max_tokens: result.config.max_tokens
                };
                
                if (taskMode === 'selected' && selectedDirectory) {
                    socket.emit('execute_task', {
                        requirement: message,
                        type: 'selected',
                        plan_mode: planMode,
                        gui_config: guiConfig
                    });
                } else {
                    socket.emit('execute_task', {
                        requirement: message,
                        type: 'continue',
                        plan_mode: planMode,
                        gui_config: guiConfig
                    });
                }
                
            } catch (error) {
                console.error('Configuration validation error:', error);
                addMessage(`${I18N.config_error_title}: é…ç½®éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥`, 'error');
            }
        }

        function createNewDirectory() {
            if (isTaskRunning || !socket || !isConnected) return;
            
            // æ£€æŸ¥guestç”¨æˆ·æƒé™
            if (isGuest) {
                addMessage('guestç”¨æˆ·ä¸ºæ¼”ç¤ºè´¦æˆ·ï¼Œæ— æ³•åˆ›å»ºæ–°ç›®å½•ã€‚', 'error');
                return;
            }
            
            socket.emit('create_new_directory');
        }

        function clearChat() {
            if (!socket || !isConnected) return;
            
            // Show confirmation dialog
            if (confirm(I18N.confirm_clear_chat)) {
                // æ¸…ç†æ‰¹å¤„ç†é˜Ÿåˆ—å’Œå®šæ—¶å™¨
                clearTimeout(batchProcessingTimer);
                batchProcessingTimer = null;
                messageBatchQueue = [];
                isBatchProcessing = false;
                batchScrollPending = false;
                
                // Clear the chat messages immediately for better user experience
                chatMessages.innerHTML = `
                    <div class="message system">
                        <strong><i class="fas fa-info-circle"></i> ${I18N.system_message || 'ç³»ç»Ÿæ¶ˆæ¯'}</strong><br>
                        ${I18N.welcome_message || 'æ¬¢è¿ä½¿ç”¨ AGI Agentï¼è¯·åœ¨ä¸‹æ–¹è¾“å…¥æ‚¨çš„éœ€æ±‚ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ä¸ºæ‚¨å¤„ç†ä»»åŠ¡ã€‚'}
                    </div>
                `;
                
                // Reset message tracking variables
                lastMessageType = null;
                lastMessageDiv = null;
                
                // Reset scroll state
                autoScrollEnabled = true;
                updateAutoScrollIndicator();
                
                // Scroll to bottom
                scrollToBottom(false);
                
                // Notify server
                socket.emit('clear_chat');
            }
        }

        /**
         * æ£€æŸ¥URLå‚æ•°å¹¶è‡ªåŠ¨ç™»å½•
         * æ”¯æŒçš„URLå‚æ•°ï¼šuser, username, apikey, api_key
         * ä¾‹å¦‚ï¼šhttp://localhost:5001/?user=testuser
         *      http://localhost:5001/?apikey=abc123
         */
        function checkUrlAutoLogin() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                let apiKey = null;
                
                // æ£€æŸ¥å¤šç§å¯èƒ½çš„å‚æ•°å
                const possibleKeys = ['apikey', 'api_key', 'user', 'username', 'key'];
                for (const key of possibleKeys) {
                    if (urlParams.has(key)) {
                        apiKey = urlParams.get(key);
                        console.log(`ğŸ”‘ Found URL parameter '${key}': ${apiKey.substring(0, 8)}...`);
                        break;
                    }
                }
                
                if (apiKey) {
                    // å¡«å…¥API Keyè¾“å…¥æ¡†
                    apiKeyInput.value = apiKey;
                    
                    // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ç¡®ä¿DOMå®Œå…¨åŠ è½½
                    setTimeout(() => {
                        console.log('ğŸš€ Auto-connecting with URL parameter...');
                        connectUser();
                        
                        // æ˜¾ç¤ºè‡ªåŠ¨ç™»å½•æç¤º
                        setTimeout(() => {
                            addMessage(`ğŸ”— ${I18N.auto_login_from_url || 'å·²é€šè¿‡URLå‚æ•°è‡ªåŠ¨ç™»å½•'}`, 'info');
                        }, 1000);
                    }, 500);
                    
                    return true; // è¿”å›trueè¡¨ç¤ºæ‰¾åˆ°äº†å‚æ•°å¹¶å°è¯•è‡ªåŠ¨ç™»å½•
                }
            } catch (error) {
                console.error('âŒ Error parsing URL parameters:', error);
            }
            
            return false; // è¿”å›falseè¡¨ç¤ºæ²¡æœ‰æ‰¾åˆ°URLå‚æ•°
        }

        /**
         * æ£€æŸ¥å¹¶æ¢å¤localStorageä¸­ä¿å­˜çš„ä¼šè¯
         * å½“é¡µé¢åˆ·æ–°æ—¶è‡ªåŠ¨æ¢å¤ä¸Šæ¬¡çš„ç™»å½•çŠ¶æ€
         */
        function checkSessionRestore() {
            try {
                const savedApiKey = localStorage.getItem('agia_api_key');
                
                if (savedApiKey !== null) { // null means no item, empty string is valid for default user
                    console.log('ğŸ”„ Found saved session in localStorage');
                    
                    // å¡«å…¥API Keyè¾“å…¥æ¡†
                    apiKeyInput.value = savedApiKey;
                    
                    // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ç¡®ä¿DOMå®Œå…¨åŠ è½½
                    setTimeout(() => {
                        console.log('ğŸš€ Auto-connecting with saved session...');
                        connectUser();
                        
                        // æ˜¾ç¤ºä¼šè¯æ¢å¤æç¤º
                        setTimeout(() => {
                            addMessage(`ğŸ”„ ${I18N.session_restored || 'å·²æ¢å¤ä¸Šæ¬¡ç™»å½•ä¼šè¯'}`, 'info');
                        }, 1000);
                    }, 500);
                    
                    return true; // è¿”å›trueè¡¨ç¤ºæ‰¾åˆ°äº†ä¿å­˜çš„ä¼šè¯å¹¶å°è¯•æ¢å¤
                }
            } catch (error) {
                console.error('âŒ Error restoring session from localStorage:', error);
            }
            
            return false; // è¿”å›falseè¡¨ç¤ºæ²¡æœ‰æ‰¾åˆ°ä¿å­˜çš„ä¼šè¯
        }

        async function executeSelectedTask() {
            const message = userInput.value.trim();
            if (!message || isTaskRunning) return;

            // ä¿å­˜å½“å‰è¾“å…¥å†…å®¹ï¼Œä»¥é˜²å‡ºé”™æ—¶éœ€è¦æ¢å¤
            pendingUserInput = message;

            if (!selectedDirectory) {
                addMessage(I18N.select_directory_first, 'error');
                return;
            }

            // Get selected model configuration
            const modelConfig = getSelectedModelConfig();
            if (!modelConfig) {
                addMessage('è¯·é€‰æ‹©æœ‰æ•ˆçš„æ¨¡å‹é…ç½®', 'error');
                return;
            }
            
            // Validate configuration before execution
            try {
                const response = await fetch('/api/validate-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        config: modelConfig
                    })
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    addMessage(`${I18N.config_error_title}: ${result.error}`, 'error');
                    return;
                }
                
                // Configuration is valid, proceed with execution
                addMessage(message, 'user');
                
                // Get GUI configuration options
                const guiConfig = {
                    enable_web_search: document.getElementById('enableWebSearch').checked,
                    enable_knowledge_base: document.getElementById('enableKnowledgeBase').checked,
                    enable_multi_agent: document.getElementById('enableMultiAgent').checked,
                    enable_long_term_memory: document.getElementById('enableLongTermMemory').checked,
                    enable_mcp: document.getElementById('enableMCP').checked,
                    enable_jieba: document.getElementById('enableJieba').checked,
                    routine_file: document.getElementById('routineSelect').value,
                    // Add model configuration
                    selected_model: modelConfig.model,
                    model_api_key: result.config.api_key,
                    model_api_base: result.config.api_base,
                    model_max_tokens: result.config.max_tokens
                };
                
                socket.emit('execute_task', {
                    requirement: message,
                    type: 'selected',
                    gui_config: guiConfig
                });
                
            } catch (error) {
                console.error('Configuration validation error:', error);
                addMessage(`${I18N.config_error_title}: é…ç½®éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥`, 'error');
            }
        }

        function selectDirectory(dirName) {
            if (!socket || !isConnected) return;
            
            console.log(`ğŸ¯ Selecting directory: ${dirName}`);
            
            // æ€»æ˜¯æ›´æ–°é€‰æ‹©çš„ç›®å½•ï¼Œå³ä½¿æ˜¯åŒä¸€ä¸ªç›®å½•
            selectedDirectory = dirName;
            
            // Switch to selected directory mode
            taskMode = 'selected';
            
            // å‘é€é€‰æ‹©ç›®å½•çš„è¯·æ±‚
            socket.emit('select_directory', {
                dir_name: dirName
            });
            
            // Update UI to show selected state, but don't refresh entire list
            document.querySelectorAll('.directory-item').forEach(item => {
                item.classList.remove('selected');
            });
            const selectedItem = document.querySelector(`[data-dir="${dirName}"]`);
            if (selectedItem) {
                selectedItem.classList.add('selected');
            }
            
            // Update task mode information
            updateTaskModeInfo();
            
            console.log(`âœ… Directory selected: ${dirName}, mode: ${taskMode}`);
        }

        function selectAndToggleDirectory(dirName) {
            // å…ˆé€‰æ‹©ç›®å½•
            selectDirectory(dirName);
            
            // ç„¶ååˆ‡æ¢å±•å¼€çŠ¶æ€
            toggleDirectory(dirName, null);
        }

        function updateTaskModeInfo() {
            const taskModeInfo = document.getElementById('taskModeInfo');
            let baseInfo = '';
            
            if (taskMode === 'selected' && selectedDirectory) {
                baseInfo = `<i class="fas fa-info-circle"></i> ${I18N.selected_dir_info}: <strong>${selectedDirectory}</strong>`;
                taskModeInfo.style.color = '#569cd6';
            } else if (taskMode === 'continue') {
                baseInfo = `<i class="fas fa-info-circle"></i> ${I18N.continue_mode_info}`;
                taskModeInfo.style.color = '#9cdcfe';
            } else if (taskMode === 'new') {
                baseInfo = `<i class="fas fa-plus-circle"></i> ${I18N.new_mode_info}`;
                taskModeInfo.style.color = '#4CAF50';
            } else {
                baseInfo = `<i class="fas fa-plus-circle"></i> ${I18N.create_or_select_directory}`;
                taskModeInfo.style.color = '#9cdcfe';
            }
            
            taskModeInfo.innerHTML = baseInfo;
        }

        function resizeTextarea() {
            userInput.style.height = 'auto';
            userInput.style.height = Math.min(userInput.scrollHeight, 120) + 'px';
        }

        // Event listeners
        connectBtn.addEventListener('click', function() {
            if (isConnected) {
                disconnectUser();
            } else {
                connectUser();
            }
        });

        apiKeyInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                if (!isConnected) {
                    connectUser();
                }
            }
        });

        sendButton.addEventListener('click', () => sendMessage(false));

        planButton.addEventListener('click', () => sendMessage(true));

        newTaskButton.addEventListener('click', createNewDirectory);

        stopButton.addEventListener('click', function() {
            if (socket) {
                socket.emit('stop_task');
            }
        });

        clearChatButton.addEventListener('click', clearChat);

        userInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                // ç§»é™¤è‡ªåŠ¨æ‰§è¡Œï¼Œç”¨æˆ·éœ€è¦ç‚¹å‡»æŒ‰é’®æ¥æ‰§è¡Œä»»åŠ¡
                // sendMessage(false); // Default to direct execution mode
            }
        });

        userInput.addEventListener('input', resizeTextarea);

        // Chat scroll behavior management
        let scrollTimeout;
        let scrollThrottleTimeout;
        let lastScrollHandlerTime = 0;
        const SCROLL_THRESHOLD = 50; // ç»Ÿä¸€ä½¿ç”¨50pxé˜ˆå€¼
        const SCROLL_DEBOUNCE_TIME = 300; // å¢åŠ é˜²æŠ–æ—¶é—´åˆ°300ms
        const SCROLL_THROTTLE_TIME = 100; // æ·»åŠ 100msèŠ‚æµæ—¶é—´
        
        let autoScrollPending = false;
        let lastAutoScrollTime = 0;
        const AUTO_SCROLL_THROTTLE_TIME = 150; // è‡ªåŠ¨æ»šåŠ¨èŠ‚æµæ—¶é—´150ms
        
        // èŠ‚æµçš„è‡ªåŠ¨æ»šåŠ¨å‡½æ•°
        function throttledAutoScroll(smooth = true) {
            const now = Date.now();
            if (autoScrollPending || (now - lastAutoScrollTime < AUTO_SCROLL_THROTTLE_TIME)) {
                return; // å¦‚æœå·²æœ‰æ»šåŠ¨åœ¨ç­‰å¾…æˆ–è·ç¦»ä¸Šæ¬¡æ»šåŠ¨æ—¶é—´å¤ªçŸ­ï¼Œåˆ™è·³è¿‡
            }
            
            autoScrollPending = true;
            lastAutoScrollTime = now;
            
            requestAnimationFrame(() => {
                if (smooth) {
                    chatMessages.scrollTo({
                        top: chatMessages.scrollHeight,
                        behavior: 'smooth'
                    });
                } else {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
                autoScrollPending = false;
            });
        }
        
        chatMessages.addEventListener('scroll', function() {
            const now = Date.now();
            
            // èŠ‚æµï¼šé™åˆ¶æ»šåŠ¨å¤„ç†é¢‘ç‡
            if (now - lastScrollHandlerTime < SCROLL_THROTTLE_TIME) {
                return;
            }
            lastScrollHandlerTime = now;
            
            // Clear previous timeout
            clearTimeout(scrollTimeout);
            
            // Detect scroll direction
            const currentScrollTop = chatMessages.scrollTop;
            scrollDirection = currentScrollTop > lastScrollTop ? 'down' : 'up';
            lastScrollTop = currentScrollTop;
            
            // Mark user is scrolling
            isUserScrolling = true;
            
            // Check if scrolled near bottom - ä½¿ç”¨ç»Ÿä¸€é˜ˆå€¼
            const isNearBottom = chatMessages.scrollTop + chatMessages.clientHeight >= chatMessages.scrollHeight - SCROLL_THRESHOLD;
            
            // æ™ºèƒ½è‡ªåŠ¨æ»šåŠ¨æ§åˆ¶é€»è¾‘ - å‡å°‘çŠ¶æ€åˆ‡æ¢é¢‘ç‡
            if (isNearBottom) {
                // ç”¨æˆ·æ»šåŠ¨åˆ°åº•éƒ¨é™„è¿‘ï¼Œè‡ªåŠ¨å¯ç”¨è‡ªåŠ¨æ»šåŠ¨åŠŸèƒ½
                if (!autoScrollEnabled) {
                    autoScrollEnabled = true;
                    updateAutoScrollIndicator();
                    console.log('ğŸ”„ User scrolled to bottom, enabling auto-scroll');
                }
                hideScrollToBottomHint();
            } else {
                // å½“ç”¨æˆ·ä¸»åŠ¨å‘ä¸Šæ»šåŠ¨ä¸”è·ç¦»åº•éƒ¨è¾ƒè¿œæ—¶ï¼Œç¦ç”¨è‡ªåŠ¨æ»šåŠ¨
                const farFromBottom = chatMessages.scrollTop + chatMessages.clientHeight < chatMessages.scrollHeight - (SCROLL_THRESHOLD * 3);
                if (autoScrollEnabled && scrollDirection === 'up' && farFromBottom) {
                    autoScrollEnabled = false;
                    updateAutoScrollIndicator();
                    console.log('â¬†ï¸ User scrolled up away from bottom, disabling auto-scroll');
                }
                
                // ä»…åœ¨éè‡ªåŠ¨æ»šåŠ¨çŠ¶æ€ä¸‹æ˜¾ç¤ºæ»šåŠ¨æç¤º
                if (!autoScrollEnabled) {
                    showScrollToBottomHint();
                }
            }
            
            // å¢åŠ é˜²æŠ–æ—¶é—´ï¼Œå‡å°‘çŠ¶æ€é‡ç½®é¢‘ç‡
            scrollTimeout = setTimeout(() => {
                isUserScrolling = false;
            }, SCROLL_DEBOUNCE_TIME);
        });

        // Scroll hint management
        function showScrollToBottomHint() {
            const scrollBtn = document.getElementById('scrollToBottomBtn');
            if (scrollBtn && !scrollBtn.classList.contains('show')) {
                scrollBtn.classList.add('show');
            }
        }

        function hideScrollToBottomHint() {
            const scrollBtn = document.getElementById('scrollToBottomBtn');
            if (scrollBtn && scrollBtn.classList.contains('show')) {
                scrollBtn.classList.remove('show');
            }
            hideNewMessageIndicator(); // Also hide new message indicator
        }

        function showNewMessageIndicator() {
            if (!autoScrollEnabled) {
                newMessageCount++;
                const indicator = document.getElementById('newMessageIndicator');
                const countSpan = document.getElementById('newMessageCount');
                if (indicator && countSpan) {
                    countSpan.textContent = newMessageCount;
                    indicator.classList.add('show');
                }
            }
        }

        function hideNewMessageIndicator() {
            newMessageCount = 0;
            const indicator = document.getElementById('newMessageIndicator');
            if (indicator && indicator.classList.contains('show')) {
                indicator.classList.remove('show');
            }
        }

        /**
         * æ›´æ–°è‡ªåŠ¨æ»šåŠ¨çŠ¶æ€æŒ‡ç¤ºå™¨ (å·²ç§»é™¤UIæŒ‡ç¤ºå™¨)
         * æ ¹æ®å½“å‰è‡ªåŠ¨æ»šåŠ¨çŠ¶æ€æ›´æ–°UIæŒ‡ç¤ºå™¨çš„æ˜¾ç¤ºå’Œæ ·å¼
         * @description å½“è‡ªåŠ¨æ»šåŠ¨å¯ç”¨æ—¶æ˜¾ç¤ºå‘ä¸‹ç®­å¤´ï¼Œç¦ç”¨æ—¶æ˜¾ç¤ºæš‚åœå›¾æ ‡
         */
        function updateAutoScrollIndicator() {
            // Auto-scroll indicator UI has been removed
            // Only keep console logging for debugging
            console.log(`ğŸ”„ Auto-scroll status updated: ${autoScrollEnabled ? 'ENABLED' : 'DISABLED'}`);
        }

        /**
         * æ»šåŠ¨åˆ°èŠå¤©çª—å£åº•éƒ¨
         * @param {boolean} smooth - æ˜¯å¦ä½¿ç”¨å¹³æ»‘æ»šåŠ¨åŠ¨ç”»ï¼Œé»˜è®¤ä¸ºtrue
         * @description æ‰§è¡Œæ»šåŠ¨æ“ä½œåä¼šè‡ªåŠ¨å¯ç”¨è‡ªåŠ¨æ»šåŠ¨åŠŸèƒ½å¹¶éšè—æ»šåŠ¨æç¤º
         */
        function scrollToBottom(smooth = true) {
            if (smooth) {
                throttledAutoScroll(true);
            } else {
                throttledAutoScroll(false);
            }
            autoScrollEnabled = true;
            updateAutoScrollIndicator();
            hideScrollToBottomHint();
        }

        /**
         * ç»‘å®šæ»šåŠ¨åˆ°åº•éƒ¨æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
         * @description ç”¨æˆ·ç‚¹å‡»æ»šåŠ¨æŒ‰é’®æ—¶ï¼Œå¹³æ»‘æ»šåŠ¨åˆ°èŠå¤©çª—å£åº•éƒ¨
         */
        document.getElementById('scrollToBottomBtn').addEventListener('click', () => {
            scrollToBottom(true);
        });

        /**
         * ç»‘å®šæ–°æ¶ˆæ¯æç¤ºçš„ç‚¹å‡»äº‹ä»¶  
         * @description ç”¨æˆ·ç‚¹å‡»æ–°æ¶ˆæ¯æç¤ºæ—¶ï¼Œå¹³æ»‘æ»šåŠ¨åˆ°èŠå¤©çª—å£åº•éƒ¨
         */
        document.getElementById('newMessageIndicator').addEventListener('click', () => {
            scrollToBottom(true);
        });
        
        /**
         * é¡µé¢ç¦»å¼€æ—¶æ¸…ç†æ‰¹å¤„ç†èµ„æº
         * @description ç¡®ä¿åœ¨é¡µé¢å¸è½½å‰å¤„ç†å®Œæ‰€æœ‰æ’é˜Ÿçš„æ¶ˆæ¯å¹¶æ¸…ç†å®šæ—¶å™¨
         */
        window.addEventListener('beforeunload', function() {
            // å¼ºåˆ¶å¤„ç†å‰©ä½™çš„æ‰¹å¤„ç†æ¶ˆæ¯
            if (messageBatchQueue.length > 0) {
                processBatchMessages();
            }
            
            // æ¸…ç†å®šæ—¶å™¨
            clearTimeout(batchProcessingTimer);
        });
        
        /**
         * æµ‹è¯•æ‰¹é‡æ¶ˆæ¯å¤„ç†æ€§èƒ½
         * @description å¼€å‘è°ƒè¯•ç”¨å‡½æ•°ï¼Œæ¨¡æ‹Ÿé«˜é¢‘æ¶ˆæ¯åœºæ™¯
         */
        window.testBatchMessagePerformance = function(messageCount = 100, interval = 10) {
            console.log(`ğŸ§ª å¼€å§‹æµ‹è¯•æ‰¹é‡æ¶ˆæ¯æ€§èƒ½ï¼š${messageCount}æ¡æ¶ˆæ¯ï¼Œé—´éš”${interval}ms`);
            const startTime = performance.now();
            
            let count = 0;
            const testInterval = setInterval(() => {
                addMessage(`æµ‹è¯•æ¶ˆæ¯ ${count + 1}/${messageCount} - ${new Date().toLocaleTimeString()}`, 'info');
                count++;
                
                if (count >= messageCount) {
                    clearInterval(testInterval);
                    
                    // ç­‰å¾…æ‰¹å¤„ç†å®Œæˆåæµ‹é‡ç»“æœ
                    setTimeout(() => {
                        const endTime = performance.now();
                        const duration = endTime - startTime;
                        console.log(`âœ… æµ‹è¯•å®Œæˆï¼æ€»ç”¨æ—¶ï¼š${duration.toFixed(2)}msï¼Œå¹³å‡æ¯æ¡æ¶ˆæ¯ï¼š${(duration / messageCount).toFixed(2)}ms`);
                        console.log(`ğŸ“Š æ‰¹å¤„ç†é˜Ÿåˆ—å½“å‰çŠ¶æ€ï¼š${messageBatchQueue.length}æ¡æ¶ˆæ¯ç­‰å¾…å¤„ç†`);
                    }, BATCH_DELAY + 100);
                }
            }, interval);
        };

        /**
         * ç›®å½•ç®¡ç† - åˆ·æ–°ç›®å½•åˆ—è¡¨
         * @description ä»åç«¯è·å–æœ€æ–°çš„å·¥ä½œç›®å½•åˆ—è¡¨å¹¶æ›´æ–°UIæ˜¾ç¤º
         * ä¿æŒç”¨æˆ·çš„å±•å¼€/æ”¶èµ·çŠ¶æ€ã€ç›®å½•åˆ—è¡¨æ»šåŠ¨ä½ç½®å’Œæ¯ä¸ªå±•å¼€ç›®å½•çš„æ–‡ä»¶æ ‘æ»šåŠ¨ä½ç½®ï¼Œç›´æ¥æ›´æ–°åˆ—è¡¨ä¸æ˜¾ç¤ºåŠ è½½çŠ¶æ€
         */
                        function refreshDirectories() {
            // ä¿å­˜å½“å‰å±•å¼€çŠ¶æ€ï¼Œé¿å…åˆ·æ–°åç”¨æˆ·å±•å¼€çš„ç›®å½•è¢«é‡ç½®
            const currentExpanded = new Set(expandedDirectories);

            // ä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®
            const currentScrollTop = directoryList.scrollTop;

            // ä¿å­˜æ‰€æœ‰å±•å¼€ç›®å½•çš„æ–‡ä»¶æ ‘æ»šåŠ¨ä½ç½®
            const fileTreeScrollPositions = {};
            currentExpanded.forEach(dirName => {
                const treeElement = document.getElementById(`tree-${dirName}`);
                if (treeElement) {
                    fileTreeScrollPositions[dirName] = treeElement.scrollTop;
                }
            });

            // Include current user info in API call
            const params = new URLSearchParams();
            if (currentUser && currentUser !== 'default') {
                params.set('api_key', currentUser);
            }

            const headers = {};
            if (currentUser && currentUser !== 'default') {
                headers['X-API-Key'] = currentUser;
            }

            fetch(`/api/output-dirs?${params}`, {
                headers: headers
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // æ¸…ç©ºåˆ—è¡¨å¹¶æ¸²æŸ“æ–°æ•°æ®ï¼ˆæ•°æ®å‡†å¤‡å¥½åä¸€æ¬¡æ€§æ›´æ–°ï¼‰
                        directoryList.innerHTML = '';
                        // æ¢å¤å±•å¼€çŠ¶æ€
                        expandedDirectories = currentExpanded;
                        renderDirectories(data.directories);

                        // æ¢å¤æ»šåŠ¨ä½ç½®
                        setTimeout(() => {
                            directoryList.scrollTop = currentScrollTop;

                            // æ¢å¤æ¯ä¸ªå±•å¼€ç›®å½•çš„æ–‡ä»¶æ ‘æ»šåŠ¨ä½ç½®
                            Object.keys(fileTreeScrollPositions).forEach(dirName => {
                                const treeElement = document.getElementById(`tree-${dirName}`);
                                if (treeElement && fileTreeScrollPositions[dirName] !== undefined) {
                                    treeElement.scrollTop = fileTreeScrollPositions[dirName];
                                }
                            });
                        }, 0);
                    } else {
                        directoryList.innerHTML = `
                            <div class="message error">
                                <i class="fas fa-exclamation-triangle"></i>
                                ${I18N.load_directory_failed}: ${data.error}
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    directoryList.innerHTML = `
                        <div class="message error">
                            <i class="fas fa-exclamation-triangle"></i>
                            ${I18N.network_error}: ${error.message}
                        </div>
                    `;
                });
        }

        /**
         * æ¸²æŸ“ç›®å½•åˆ—è¡¨åˆ°UI
         * @param {Array} directories - ç›®å½•æ•°æ®æ•°ç»„
         * @description æ ¹æ®ç›®å½•æ•°æ®ç”ŸæˆHTMLç»“æ„ï¼ŒåŒ…æ‹¬ï¼š
         * - ç›®å½•çŠ¶æ€æ ‡è¯†ï¼ˆå½“å‰æ‰§è¡Œã€å·²é€‰æ‹©ã€ä¸Šæ¬¡ä½¿ç”¨ï¼‰
         * - ç›®å½•æ“ä½œæŒ‰é’®ï¼ˆå±•å¼€/æ”¶èµ·ã€ä¸Šä¼ ã€ä¸‹è½½ã€é‡å‘½åã€åˆ é™¤ï¼‰
         * - æ–‡ä»¶æ ‘å±•å¼€çŠ¶æ€ç®¡ç†
         */
        function renderDirectories(directories) {
            if (directories.length === 0) {
                directoryList.innerHTML = `
                    <div class="message system">
                        <i class="fas fa-folder-open"></i>
                        æš‚æ— å·¥ä½œç›®å½•ï¼ˆåŒ…å«workspaceå­ç›®å½•çš„ç›®å½•ï¼‰
                    </div>
                `;
                return;
            }

            directoryList.innerHTML = directories.map(dir => {
                let classes = ['directory-item'];
                let statusText = '';
                
                // æ ¹æ®ç›®å½•çŠ¶æ€æ·»åŠ ç›¸åº”çš„CSSç±»å’ŒçŠ¶æ€æ–‡æœ¬
                if (dir.is_current) {
                    classes.push('current');
                    statusText += '<span style="font-size: 0.8em; margin-left: 8px;">(å½“å‰æ‰§è¡Œ)</span>';
                }
                
                // ä¼˜å…ˆä½¿ç”¨å‰ç«¯çš„selectedDirectoryå˜é‡ï¼Œè¿™æ ·å¯ä»¥ç¡®ä¿æ–°å»ºç›®å½•åç«‹å³é«˜äº®æ­£ç¡®
                const isSelectedByFrontend = selectedDirectory === dir.name;
                const isSelectedByBackend = dir.is_selected;
                
                if (isSelectedByFrontend || isSelectedByBackend) {
                    classes.push('selected');
                    statusText += '<span style="font-size: 0.8em; margin-left: 8px;">(å·²é€‰æ‹©)</span>';
                }
                
                if (dir.is_last && !dir.is_current && !isSelectedByFrontend && !isSelectedByBackend) {
                    classes.push('last');
                    statusText += '<span style="font-size: 0.8em; margin-left: 8px;">(ä¸Šæ¬¡ä½¿ç”¨)</span>';
                }
                
                // æ£€æŸ¥è¯¥ç›®å½•æ˜¯å¦åº”è¯¥å±•å¼€æ˜¾ç¤ºæ–‡ä»¶æ ‘
                const isExpanded = expandedDirectories.has(dir.name);
                if (isExpanded) {
                    classes.push('expanded');
                }
                
                return `
                    <div class="${classes.join(' ')}" data-dir="${dir.name}">
                        <div class="directory-header">
                            <div class="directory-name" onclick="selectAndToggleDirectory('${dir.name}')">
                                <i class="fas fa-folder"></i>
                                ${dir.name}
                                ${statusText}
                            </div>
                            <div class="directory-actions">
                                <button class="action-btn" onclick="return toggleDirectory('${dir.name}', event)" title="å±•å¼€/æ”¶èµ·">
                                    <i class="fas fa-chevron-${isExpanded ? 'up' : 'down'}"></i>
                                </button>
                                <button class="action-btn" onclick="event.stopPropagation(); showUploadModal('${dir.name}')" title="ä¸Šä¼ æ–‡ä»¶åˆ°Workspace">
                                    <i class="fas fa-upload"></i>
                                </button>
                                <button class="action-btn" onclick="event.stopPropagation(); downloadDirectory('${dir.name}')" title="ä¸‹è½½ç›®å½•ä¸ºZIPï¼ˆæ’é™¤code_indexï¼‰">
                                    <i class="fas fa-download"></i>
                                </button>
                                <button class="action-btn rename-btn" onclick="event.stopPropagation(); showRenameDialog('${dir.name}')" title="é‡å‘½åç›®å½•">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn delete-btn" onclick="event.stopPropagation(); confirmDeleteDirectory('${dir.name}')" title="åˆ é™¤ç›®å½•">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="directory-info" onclick="selectAndToggleDirectory('${dir.name}')">
                            <div><i class="fas fa-clock"></i> ${dir.modified_time}</div>
                            <div><i class="fas fa-hdd"></i> ${dir.size}</div>
                        </div>
                        <div class="file-tree ${isExpanded ? 'show' : ''}" id="tree-${dir.name}">
                            ${renderFileTree(dir.files, dir.name)}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderFileTree(files, dirName, indent = 0) {
            return files.map(file => {
                const icon = file.type === 'directory' ? 'fas fa-folder' : getFileIcon(file.name);
                const className = file.type === 'directory' ? 'file-item directory' : 'file-item';
                const sizeInfo = file.size ? ` (${file.size})` : '';
                const isPreviewable = file.type === 'file' && isFilePreviewable(file.name);
                const previewClass = isPreviewable ? ' previewable' : '';
                
                // æ£€æŸ¥æ˜¯å¦åœ¨ç‰¹å®šç›®å½•ä¸‹ï¼Œå¦‚æœæ˜¯åˆ™æ·»åŠ ç°è‰²æ ·å¼
                const isInSpecialDir = file.path && (
                    file.path.includes('/web_search_result/') || 
                    file.path.includes('/code_index/') ||
                    file.path.includes('\\web_search_result\\') || 
                    file.path.includes('\\code_index\\')
                );
                const grayedClass = (file.type === 'file' && isInSpecialDir) ? ' grayed' : '';
                
                // æ„é€ æ–‡ä»¶è·¯å¾„ - åç«¯ç°åœ¨è¿”å›ç›¸å¯¹è·¯å¾„
                let relativePath = '';
                if (file.path) {
                    // ç›´æ¥ä½¿ç”¨åç«¯è¿”å›çš„ç›¸å¯¹è·¯å¾„
                    relativePath = file.path;
                } else {
                    // å¦‚æœæ²¡æœ‰è·¯å¾„ï¼Œæ„é€ è·¯å¾„
                    relativePath = `${dirName}/${file.name}`;
                }
                
                // ä¸ºå­æ–‡ä»¶å¤¹ç”Ÿæˆå”¯ä¸€ID
                const subDirId = `${dirName}-${file.name}`;
                const hasChildren = file.children && file.children.length > 0;
                // å­æ–‡ä»¶å¤¹é»˜è®¤å±•å¼€ï¼Œåªæœ‰åœ¨collapsedSubDirectoriesä¸­çš„æ‰æ”¶èµ·
                const isSubDirExpanded = !collapsedSubDirectories.has(subDirId);
                
                let html = '';
                
                if (file.type === 'directory' && hasChildren) {
                    // å­æ–‡ä»¶å¤¹ï¼šå¸¦å±•å¼€/æ”¶èµ·åŠŸèƒ½
                    html = `
                        <div class="file-item directory" style="margin-left: ${indent * 20}px; display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 8px; flex: 1; cursor: pointer;" 
                                 onclick="toggleSubDirectory('${subDirId}', event)">
                                <i class="${icon}"></i>
                                ${file.name}${sizeInfo}
                            </div>
                            <button class="sub-folder-toggle" onclick="toggleSubDirectory('${subDirId}', event)" 
                                    style="background: none; border: none; color: #9cdcfe; cursor: pointer; padding: 2px 6px; margin-right: 10px;">
                                <i class="fas fa-chevron-${isSubDirExpanded ? 'up' : 'down'}" style="font-size: 18px;"></i>
                            </button>
                        </div>
                        <div class="sub-file-tree ${isSubDirExpanded ? 'show' : ''}" id="subtree-${subDirId}">
                            ${renderFileTree(file.children, dirName, indent + 1)}
                        </div>
                    `;
                } else if (file.type === 'directory') {
                    // ç©ºæ–‡ä»¶å¤¹
                    html = `
                        <div class="${className}" style="margin-left: ${indent * 20}px">
                            <i class="${icon}"></i>
                            ${file.name}${sizeInfo}
                        </div>
                    `;
                } else {
                    // æ–‡ä»¶
                    html = `
                        <div class="${className}${previewClass}${grayedClass}" style="margin-left: ${indent * 20}px" 
                             ${isPreviewable ? `onclick="previewFile('${relativePath.replace(/'/g, "\\'")}', '${file.name.replace(/'/g, "\\'")}')"` : ''}>
                            <i class="${icon}"></i>
                            ${file.name}${sizeInfo}
                        </div>
                    `;
                }
                
                return html;
            }).join('');
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const iconMap = {
                'html': 'fab fa-html5',
                'htm': 'fab fa-html5',
                'css': 'fab fa-css3-alt',
                'js': 'fab fa-js-square',
                'py': 'fab fa-python',
                'md': 'fab fa-markdown',
                'json': 'fas fa-code',
                'txt': 'fas fa-file-alt',
                'log': 'fas fa-file-alt',
                'yaml': 'fas fa-code',
                'yml': 'fas fa-code',
                'png': 'fas fa-image',
                'jpg': 'fas fa-image',
                'jpeg': 'fas fa-image',
                'gif': 'fas fa-image',
                'svg': 'fas fa-image',
                'bmp': 'fas fa-image',
                'webp': 'fas fa-image',
                'ico': 'fas fa-image'
            };
            return iconMap[ext] || 'fas fa-file';
        }

        function isFilePreviewable(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            return ['html', 'htm', 'md', 'markdown', 'py', 'js', 'jsx', 'ts', 'tsx', 'css', 'json',
                    'txt', 'log', 'yaml', 'yml', 'pdf', 'c', 'cpp', 'cc', 'cxx', 'h', 'hpp',
                    'java', 'go', 'rs', 'php', 'rb', 'sh', 'bash', 'zsh', 'fish', 'ps1', 'bat',
                    'cmd', 'xml', 'sql', 'r', 'scala', 'kt', 'swift', 'dart', 'lua', 'perl', 'pl',
                    'vim', 'dockerfile', 'makefile', 'cmake', 'gradle', 'properties', 'ini', 'cfg',
                    'conf', 'toml', 'mmd', 'out', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'csv',
                    'png', 'jpg', 'jpeg', 'gif', 'svg', 'bmp', 'webp', 'ico'].includes(ext);
        }

        function toggleDirectory(dirName, event) {
            // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼ˆä»…å½“æœ‰eventæ—¶ï¼‰
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            
            console.log(`ğŸ”„ Toggle directory: ${dirName}`);
            console.log(`ğŸ” Event details:`, event);
            
            // è·å–DOMå…ƒç´ 
            const tree = document.getElementById(`tree-${dirName}`);
            const directoryItem = document.querySelector(`[data-dir="${dirName}"]`);
            const button = document.querySelector(`[data-dir="${dirName}"] .directory-actions button[title="å±•å¼€/æ”¶èµ·"]`);
            const icon = button ? button.querySelector('i') : null;
            
            console.log(`ğŸ” DOM elements:`, {
                tree: tree,
                treeId: `tree-${dirName}`,
                directoryItem: directoryItem,
                button: button,
                icon: icon,
                treeClasses: tree ? tree.className : 'null',
                treeStyle: tree ? tree.style.cssText : 'null'
            });
            
            if (!tree) {
                console.error(`âŒ Tree element not found: tree-${dirName}`);
                // å°è¯•æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„treeå…ƒç´ 
                const allTrees = document.querySelectorAll('[id^="tree-"]');
                console.log(`ğŸ” All tree elements found:`, Array.from(allTrees).map(t => t.id));
                return false;
            }
            
            // æ£€æŸ¥å½“å‰çŠ¶æ€
            const isCurrentlyExpanded = tree.classList.contains('show');
            console.log(`ğŸ“Š Current state: ${dirName} expanded = ${isCurrentlyExpanded}`);
            console.log(`ğŸ“Š Tree computed style:`, window.getComputedStyle(tree).display);
            
            if (isCurrentlyExpanded) {
                // æ”¶èµ·
                tree.classList.remove('show');
                expandedDirectories.delete(dirName);
                if (directoryItem) {
                    directoryItem.classList.remove('expanded');
                }
                if (icon) {
                    icon.className = 'fas fa-chevron-down';
                }
                console.log(`ğŸ“¥ Collapsed: ${dirName}`);
                console.log(`ğŸ“¥ After collapse - display:`, window.getComputedStyle(tree).display);
            } else {
                // å±•å¼€
                tree.classList.add('show');
                expandedDirectories.add(dirName);
                if (directoryItem) {
                    directoryItem.classList.add('expanded');
                }
                if (icon) {
                    icon.className = 'fas fa-chevron-up';
                }
                console.log(`ğŸ“¤ Expanded: ${dirName}`);
                console.log(`ğŸ“¤ After expand - display:`, window.getComputedStyle(tree).display);
            }
            
            console.log(`âœ… Toggle complete. Tree classes: ${tree.className}`);
            console.log(`âœ… Expanded dirs: [${Array.from(expandedDirectories).join(', ')}]`);
            return false;
        }

        function toggleSubDirectory(subDirId, event) {
            // é˜»æ­¢äº‹ä»¶å†’æ³¡
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            
            console.log(`ğŸ”„ Toggle sub-directory: ${subDirId}`);
            
            // è·å–DOMå…ƒç´ 
            const subTree = document.getElementById(`subtree-${subDirId}`);
            const button = event.target.closest('.sub-folder-toggle');
            const icon = button ? button.querySelector('i') : null;
            
            console.log(`ğŸ” Sub-directory DOM elements:`, {
                subTree: subTree,
                subTreeId: `subtree-${subDirId}`,
                button: button,
                icon: icon,
                subTreeClasses: subTree ? subTree.className : 'null'
            });
            
            if (!subTree) {
                console.error(`âŒ Sub-tree element not found: subtree-${subDirId}`);
                return false;
            }
            
            // æ£€æŸ¥å½“å‰çŠ¶æ€
            const isCurrentlyExpanded = subTree.classList.contains('show');
            console.log(`ğŸ“Š Sub-directory current state: ${subDirId} expanded = ${isCurrentlyExpanded}`);
            
            if (isCurrentlyExpanded) {
                // æ”¶èµ·å­æ–‡ä»¶å¤¹
                subTree.classList.remove('show');
                collapsedSubDirectories.add(subDirId);
                if (icon) {
                    icon.className = 'fas fa-chevron-down';
                }
                console.log(`ğŸ“¥ Collapsed sub-directory: ${subDirId}`);
            } else {
                // å±•å¼€å­æ–‡ä»¶å¤¹
                subTree.classList.add('show');
                collapsedSubDirectories.delete(subDirId);
                if (icon) {
                    icon.className = 'fas fa-chevron-up';
                }
                console.log(`ğŸ“¤ Expanded sub-directory: ${subDirId}`);
            }
            
            console.log(`âœ… Sub-directory toggle complete. Classes: ${subTree.className}`);
            console.log(`âœ… Collapsed sub-dirs: [${Array.from(collapsedSubDirectories).join(', ')}]`);
            return false;
        }

        function downloadDirectory(dirName) {
            // Build URL with API key parameter - use currentUser like other API calls
            let downloadUrl = `/api/download/${dirName}`;
            if (currentUser && currentUser !== 'default') {
                downloadUrl += `?api_key=${encodeURIComponent(currentUser)}`;
            }
            
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.download = `${dirName}.zip`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }



        function confirmDeleteDirectory(dirName) {
            const isCurrentDir = document.querySelector(`[data-dir="${dirName}"]`).classList.contains('current');
            const isSelectedDir = document.querySelector(`[data-dir="${dirName}"]`).classList.contains('selected');
            
            let warningMessage = `ç¡®å®šè¦åˆ é™¤ç›®å½• "${dirName}" å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œå°†æ°¸ä¹…åˆ é™¤è¯¥ç›®å½•åŠå…¶æ‰€æœ‰å†…å®¹ã€‚`;
            
            if (isCurrentDir) {
                warningMessage += '\n\nâš ï¸ è­¦å‘Šï¼šè¿™æ˜¯å½“å‰æ­£åœ¨æ‰§è¡Œçš„ç›®å½•ï¼';
            }
            if (isSelectedDir) {
                warningMessage += '\n\nâš ï¸ è­¦å‘Šï¼šè¿™æ˜¯å½“å‰é€‰æ‹©çš„ç›®å½•ï¼';
            }
            
            if (confirm(warningMessage)) {
                deleteDirectory(dirName);
            }
        }

        function deleteDirectory(dirName) {
            // æ£€æŸ¥guestç”¨æˆ·æƒé™
            if (isGuest) {
                alert('guestç”¨æˆ·ä¸ºæ¼”ç¤ºè´¦æˆ·ï¼Œæ— æ³•åˆ é™¤ç›®å½•ã€‚');
                return;
            }
            
            console.log(`ğŸ—‘ï¸ Deleting directory: ${dirName}`);
            
            // æ˜¾ç¤ºåˆ é™¤ä¸­çŠ¶æ€
            const dirElement = document.querySelector(`[data-dir="${dirName}"]`);
            if (dirElement) {
                dirElement.style.opacity = '0.5';
                dirElement.style.pointerEvents = 'none';
                
                // åœ¨ç›®å½•ååæ·»åŠ åˆ é™¤ä¸­æç¤º
                const nameElement = dirElement.querySelector('.directory-name');
                if (nameElement && !nameElement.querySelector('.deleting-indicator')) {
                    const indicator = document.createElement('span');
                    indicator.className = 'deleting-indicator';
                    indicator.style.cssText = 'color: #ff6b6b; font-size: 0.8em; margin-left: 8px;';
                    indicator.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${I18N.deleting}`;
                    nameElement.appendChild(indicator);
                }
            }
            
            const headers = {};
            if (currentUser && currentUser !== 'default') {
                headers['X-API-Key'] = currentUser;
            }
            
            fetch(`/api/delete-directory/${dirName}`, {
                method: 'DELETE',
                headers: headers
            })
            .then(response => response.json())
            .then(data => {
                console.log('ğŸ—‘ï¸ Delete response:', data);
                if (data.success) {
                    console.log(`âœ… Directory deleted successfully: ${dirName}`);
                    // ä»DOMä¸­ç§»é™¤ç›®å½•å…ƒç´ 
                    if (dirElement) {
                        dirElement.remove();
                    }
                    // æ¸…ç†ç›¸å…³çŠ¶æ€
                    expandedDirectories.delete(dirName);
                    // æ¸…ç†å­ç›®å½•çŠ¶æ€
                    Array.from(collapsedSubDirectories).forEach(subDirId => {
                        if (subDirId.startsWith(dirName + '-')) {
                            collapsedSubDirectories.delete(subDirId);
                        }
                    });
                    // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é€‰æ‹©çš„ç›®å½•ï¼Œæ¸…ç†çŠ¶æ€
                    if (selectedDirectory === dirName) {
                        selectedDirectory = null;
                        taskMode = 'new';
                        updateTaskModeInfo();
                    }
                    
                    alert(`ç›®å½• "${dirName}" å·²æˆåŠŸåˆ é™¤`);
                } else {
                    console.error('âŒ Delete failed:', data.error);
                    alert(`åˆ é™¤å¤±è´¥: ${data.error}`);
                    // æ¢å¤ç›®å½•å…ƒç´ çŠ¶æ€
                    if (dirElement) {
                        dirElement.style.opacity = '1';
                        dirElement.style.pointerEvents = 'auto';
                        const indicator = dirElement.querySelector('.deleting-indicator');
                        if (indicator) {
                            indicator.remove();
                        }
                    }
                }
            })
            .catch(error => {
                console.error('âŒ Delete error:', error);
                alert(`åˆ é™¤å‡ºé”™: ${error.message}`);
                // æ¢å¤ç›®å½•å…ƒç´ çŠ¶æ€
                if (dirElement) {
                    dirElement.style.opacity = '1';
                    dirElement.style.pointerEvents = 'auto';
                    const indicator = dirElement.querySelector('.deleting-indicator');
                    if (indicator) {
                        indicator.remove();
                    }
                }
            });
        }

        // æ–‡ä»¶é¢„è§ˆåŠŸèƒ½
        function previewFile(filePath, fileName) {
            console.log('ğŸ” Preview file called with:', filePath, fileName);
            console.log('ğŸ” Preview modal elements:', {
                previewModal: previewModal,
                previewTitle: previewTitle,
                previewContent: previewContent
            });
            
            if (!previewModal || !previewTitle || !previewContent) {
                console.error('âŒ Preview modal elements not found');
                return;
            }
            
            // å­˜å‚¨å½“å‰æ–‡ä»¶è·¯å¾„ï¼Œç”¨äºOfficeé¢„è§ˆè¿”å›åŠŸèƒ½
            currentFilePath = filePath;
            
            previewTitle.textContent = `${I18N.preview}: ${fileName}`;
            previewContent.innerHTML = `<div style="text-align: center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> ${I18N.loading}</div>`;
            previewModal.style.display = 'block';
            
            console.log('ğŸ” Making API request to:', `/api/file/${filePath}`);

            const headers = {};
            if (currentUser && currentUser !== 'default') {
                headers['X-API-Key'] = currentUser;
            }

            // æ£€æŸ¥æ–‡ä»¶æ‰©å±•åæ¥å†³å®šå¦‚ä½•å¤„ç†å“åº”
            const fileExt = fileName.toLowerCase().split('.').pop();
            const imageExtensions = ['png', 'jpg', 'jpeg', 'gif', 'bmp', 'webp', 'svg'];
            const isImageFile = imageExtensions.includes(fileExt);

            fetch(`/api/file/${filePath}`, {
                headers: headers
            })
                .then(response => {
                    console.log('ğŸ” API response status:', response.status, response.statusText);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    // å¯¹äºå›¾åƒæ–‡ä»¶ï¼Œæ£€æŸ¥å“åº”ç±»å‹
                    if (isImageFile) {
                        const contentType = response.headers.get('content-type');
                        console.log('ğŸ” Content-Type:', contentType);
                        
                        if (contentType && contentType.startsWith('image/')) {
                            // ç›´æ¥æ˜¾ç¤ºå›¾åƒ
                            return response.blob().then(blob => {
                                const imageUrl = URL.createObjectURL(blob);
                                displayImageContent(imageUrl, fileName, filePath);
                            });
                        } else {
                            // å¦‚æœè¿”å›çš„æ˜¯JSONæ ¼å¼çš„å›¾åƒæ•°æ®ï¼Œåˆ™è§£æJSON
                            return response.json().then(data => {
                                if (data.success && data.type === 'image') {
                                    displayFileContent(data, fileName);
                                } else {
                                    throw new Error('Invalid image data format');
                                }
                            });
                        }
                    }
                    
                    // å¯¹äºå…¶ä»–æ–‡ä»¶ç±»å‹ï¼Œå°è¯•è§£æJSON
                    return response.json();
                })
                .then(data => {
                    if (isImageFile) {
                        // å›¾åƒå·²ç»å¤„ç†å®Œæˆ
                        return;
                    }
                    
                    console.log('ğŸ” Preview response data:', data);
                    if (data.success) {
                        displayFileContent(data, fileName);
                    } else {
                        console.error('âŒ Preview failed:', data.error);
                        previewContent.innerHTML = `<div style="color: red; text-align: center; padding: 20px;">
                            <i class="fas fa-exclamation-triangle"></i> 
                            é¢„è§ˆå¤±è´¥: ${data.error}
                        </div>`;
                    }
                })
                .catch(error => {
                    console.error('âŒ Preview error:', error);
                    previewContent.innerHTML = `<div style="color: red; text-align: center; padding: 20px;">
                        <i class="fas fa-exclamation-triangle"></i> 
                        ${I18N.network_error}: ${error.message}
                    </div>`;
                });
        }

        function displayImageContent(imageUrl, fileName, filePath) {
            // è®¾ç½®å…¨å±€å˜é‡ä»¥ä¾¿ä¸‹è½½ä½¿ç”¨
            window.currentActualFilePath = filePath;
            window.currentOriginalFilePath = filePath;
            
            // è·å–æ–‡ä»¶å¤§å°ä¿¡æ¯ï¼ˆå¦‚æœéœ€è¦çš„è¯ï¼‰
            const fileSize = 'æœªçŸ¥å¤§å°';
            
            previewContent.innerHTML = `
                <div style="background: #f8f8f8; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 18px; color: #666;">
                    æ–‡ä»¶å¤§å°: ${fileSize} | ç±»å‹: å›¾ç‰‡
                </div>
                <div style="text-align: center; padding: 20px; max-height: calc(90vh - 160px); overflow: auto;">
                    <img src="${imageUrl}" 
                         alt="${fileName}" 
                         style="max-width: 100%; max-height: calc(90vh - 200px); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); background: white; padding: 10px;"
                         onerror="this.style.display='none'; this.parentNode.innerHTML='<div style=&quot;color: red; padding: 40px;&quot;><i class=&quot;fas fa-exclamation-triangle&quot;></i><br/>å›¾ç‰‡åŠ è½½å¤±è´¥</div>';" />
                    <div class="preview-button-group" style="margin-top: 15px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                        <a href="/api/download-file/${filePath}${(currentUser && currentUser !== 'default') ? '?api_key=' + currentUser : ''}" download style="padding: 8px 16px; background: #007acc; color: white; text-decoration: none; border-radius: 4px; font-size: 18px;">
                            <i class="fas fa-download"></i> ä¸‹è½½å›¾ç‰‡
                        </a>
                        <button onclick="window.open('${imageUrl}', '_blank')" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; font-size: 18px; cursor: pointer;">
                            <i class="fas fa-external-link-alt"></i> æ–°çª—å£æ‰“å¼€
                        </button>
                    </div>
                </div>
            `;
        }

        function displayFileContent(data, fileName) {
            const { content, type, language, size, file_path } = data;
            // å¦‚æœAPIæ²¡æœ‰è¿”å›file_pathï¼Œåˆ™ä½¿ç”¨å…¨å±€å˜é‡currentFilePathä½œä¸ºå¤‡ç”¨
            let actualFilePath = file_path || currentFilePath;
            
            // é‡è¦ä¿®å¤ï¼šç¡®ä¿actualFilePathåŒ…å«ç”¨æˆ·ç›®å½•å‰ç¼€ï¼ˆä»…ç”¨äºä¸‹è½½ï¼‰
            if (actualFilePath && currentUser && currentUser !== 'default') {
                // ç›´æ¥ä½¿ç”¨å·²çŸ¥çš„ç”¨æˆ·ç›®å½•ï¼ˆä»åç«¯è®¡ç®—å¾—å‡ºï¼‰
                const userDirName = KNOWN_USER_DIRECTORY;
                
                // æ£€æŸ¥è·¯å¾„æ˜¯å¦å·²ç»åŒ…å«ç”¨æˆ·ç›®å½•
                if (!actualFilePath.startsWith(userDirName + '/') && !actualFilePath.startsWith('user_')) {
                    actualFilePath = userDirName + '/' + actualFilePath;
                }
            }
            
            // è®¾ç½®å…¨å±€å˜é‡ä»¥ä¾¿PDFä¸‹è½½ä½¿ç”¨
            window.currentActualFilePath = actualFilePath;
            // åŒæ—¶ä¿å­˜åŸå§‹è·¯å¾„ç”¨äºé¢„è§ˆ
            window.currentOriginalFilePath = file_path || currentFilePath;
            
            console.log('ğŸ” displayFileContentè°ƒè¯•ä¿¡æ¯:');
            console.log('  APIè¿”å›çš„file_path:', file_path);
            console.log('  å½“å‰çš„currentFilePath:', currentFilePath);
            console.log('  å½“å‰ç”¨æˆ·:', currentUser);
            console.log('  ä½¿ç”¨çš„ç”¨æˆ·ç›®å½•:', currentUser && currentUser !== 'default' ? KNOWN_USER_DIRECTORY : 'N/A');
            console.log('  æœ€ç»ˆçš„actualFilePathï¼ˆç”¨äºä¸‹è½½ï¼‰:', actualFilePath);
            console.log('  åŸå§‹æ–‡ä»¶è·¯å¾„ï¼ˆç”¨äºé¢„è§ˆï¼‰:', window.currentOriginalFilePath);
            console.log('  æ–‡ä»¶ç±»å‹:', type);
            console.log('  è®¾ç½®çš„å…¨å±€å˜é‡window.currentActualFilePath:', window.currentActualFilePath);
            
            if (type === 'html') {
                // å¤„ç†è½¬ä¹‰å­—ç¬¦ï¼Œç„¶åè½¬ä¹‰å¼•å·
                const processedContent = processFileContent(content).replace(/"/g, '&quot;');
                previewContent.innerHTML = `
                    <div style="background: #f8f8f8; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 18px; color: #666;">
                        æ–‡ä»¶å¤§å°: ${size} | ç±»å‹: HTML
                    </div>
                    <iframe srcdoc="${processedContent}" style="width: 100%; height: calc(90vh - 160px); border: none; border-radius: 4px; background: white;"></iframe>
                `;
            } else if (type === 'markdown') {
                // å¤„ç†è½¬ä¹‰å­—ç¬¦
                const processedContent = processFileContent(content);
                
                // é…ç½®marked.jsä»¥æ”¯æŒæ›´å¥½çš„æ¸²æŸ“
                const renderer = new marked.Renderer();
                // æ¸²æŸ“å‰é‡ç½®å›¾ç‰‡è®¡æ•°æ˜ å°„ï¼ˆç”¨äºç²¾ç¡®æ›¿æ¢ç¬¬Næ¬¡å‡ºç°çš„é“¾æ¥ï¼‰
                window._mdHrefOccurrenceMap = {};
                
                // è‡ªå®šä¹‰å›¾åƒæ¸²æŸ“ï¼Œå¤„ç†ç›¸å¯¹è·¯å¾„
                renderer.image = function(href, title, text) {
                    let src = href;
                    
                    // ä½¿ç”¨åŸå§‹æ–‡ä»¶è·¯å¾„è¿›è¡Œå›¾ç‰‡è·¯å¾„è®¡ç®—ï¼ˆä¸åŒ…å«ç”¨æˆ·ç›®å½•å‰ç¼€ï¼‰
                    const originalFilePath = window.currentOriginalFilePath || file_path || currentFilePath;
                    
                    // åªæœ‰åœ¨originalFilePathå­˜åœ¨æ—¶æ‰è¿›è¡Œè·¯å¾„è½¬æ¢
                    if (originalFilePath && href && !href.startsWith('http') && !href.startsWith('data:') && !href.startsWith('/api/')) {
                        // è·å–markdownæ–‡ä»¶çš„ç›®å½•è·¯å¾„
                        const currentDir = originalFilePath.substring(0, originalFilePath.lastIndexOf('/'));
                        
                        let imagePath;
                        if (href.startsWith('./')) {
                            imagePath = `${currentDir}/${href.substring(2)}`;
                        } else if (href.startsWith('../')) {
                            const pathParts = currentDir.split('/');
                            let relativeParts = href.split('/');
                            for (let part of relativeParts) {
                                if (part === '..') {
                                    pathParts.pop();
                                } else if (part !== '.' && part !== '') {
                                    pathParts.push(part);
                                }
                            }
                            imagePath = pathParts.join('/');
                        } else {
                            // æ™®é€šç›¸å¯¹è·¯å¾„ï¼Œç›´æ¥æ‹¼æ¥
                            imagePath = `${currentDir}/${href}`;
                        }
                        
                        // Add API key parameter if available
                        const apiKeyParam = (currentUser && currentUser !== 'default') ? `?api_key=${currentUser}` : '';
                        src = `/api/file/${imagePath}${apiKeyParam}`;
                        console.log('Markdown image converted:', href, 'to:', src);
                    }
                    
                    const titleAttr = title ? ` title="${title}"` : '';
                    // è®¡ç®—å½“å‰hrefåœ¨markdownæ–‡æœ¬ä¸­çš„å‡ºç°åºå·ï¼Œç”¨äºåç»­ä»…æ›¿æ¢å¯¹åº”ä¸€æ¬¡
                    let occIndex = 0;
                    if (href) {
                        occIndex = window._mdHrefOccurrenceMap[href] || 0;
                        window._mdHrefOccurrenceMap[href] = occIndex + 1;
                    }

                    // ä»…å½“åŸå§‹markdowné“¾æ¥ä»¥ web_search_result/images å¼€å¤´æ—¶ï¼Œå³ä¾§æ·»åŠ å›¾ç‰‡å¯¼èˆªæŒ‰é’®
                    if (href && href.startsWith('web_search_result/images')) {
                        const originalFilePath = window.currentOriginalFilePath || file_path || currentFilePath || '';
                        const currentDir = originalFilePath && originalFilePath.includes('/') ? originalFilePath.substring(0, originalFilePath.lastIndexOf('/')) : '';
                        const containerStyle = 'display: flex; align-items: flex-start; gap: 8px; position: relative; width: 100%;';
                        const imgStyle = 'width: 85%; height: auto; border-radius: 4px; margin: 10px 0; object-fit: contain;';
                        const btnStyle = 'background: #007acc; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 18px; white-space: nowrap; height: fit-content; transition: background-color 0.2s;';
                        const btnDangerStyle = 'background: #d32f2f; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 18px; white-space: nowrap; height: fit-content; transition: background-color 0.2s;';
                        return `<div class=\"md-img-switch\" style=\"${containerStyle}\">`
                             + `<img src=\"${src}\" alt=\"${text || ''}\"${titleAttr} style=\"${imgStyle}\" data-md-href=\"${href}\" data-md-occurrence=\"${occIndex}\">`
                             + `<div class=\"md-img-actions\" style=\"display: flex; flex-direction: column; gap: 8px; margin: 10px 0; flex: 1; padding: 8px; max-width: 15%;\">`
                             +   `<button class=\"md-prev-btn\" style=\"${btnStyle}\" title=\"ä¸Šä¸€å¼ \" onclick=\"prevWebSearchImage(this)\" data-md-href=\"${href}\" data-md-occurrence=\"${occIndex}\" data-md-basedir=\"${currentDir}\" onmouseover=\"this.style.backgroundColor='#005a9e'\" onmouseout=\"this.style.backgroundColor='#007acc'\"><i class=\\\"fas fa-chevron-left\\\"></i> ä¸Šä¸€å¼ </button>`
                             +   `<button class=\"md-next-btn\" style=\"${btnStyle}\" title=\"ä¸‹ä¸€å¼ \" onclick=\"nextWebSearchImage(this)\" data-md-href=\"${href}\" data-md-occurrence=\"${occIndex}\" data-md-basedir=\"${currentDir}\" onmouseover=\"this.style.backgroundColor='#005a9e'\" onmouseout=\"this.style.backgroundColor='#007acc'\"><i class=\\\"fas fa-chevron-right\\\"></i> ä¸‹ä¸€å¼ </button>`
                             +   `<button class=\"md-remove-btn\" style=\"${btnDangerStyle}\" title=\"åˆ é™¤æ­¤å›¾\" onclick=\"removeWebSearchImage(this)\" data-md-href=\"${href}\" data-md-occurrence=\"${occIndex}\" onmouseover=\"this.style.backgroundColor='#b71c1c'\" onmouseout=\"this.style.backgroundColor='#d32f2f'\"><i class=\\\"fas fa-trash\\\"></i> åˆ é™¤</button>`
                             + `</div>`
                             + `</div>`;
                    }

                    return `<img src="${src}" alt="${text || ''}"${titleAttr} style="width: 85%; height: auto; border-radius: 4px; margin: 10px 0; object-fit: contain;">`;
                };
                
                // è‡ªå®šä¹‰ä»£ç å—æ¸²æŸ“
                renderer.code = function(code, language) {
                    const validLanguage = language && typeof language === 'string' ? language : 'text';
                    const escapedCode = escapeHtml(code);
                    return `<pre class="language-${validLanguage}" style="background: #1e1e1e; border: 1px solid #404040; border-radius: 6px; padding: 16px; overflow-x: auto; margin: 16px 0;"><code class="language-${validLanguage}" style="color: #ffffff !important; font-weight: normal !important; font-size: 21px !important; background: transparent !important;">${escapedCode}</code></pre>`;
                };
                
                // é…ç½®markedé€‰é¡¹
                marked.setOptions({
                    renderer: renderer,
                    highlight: function(code, lang) {
                        if (typeof Prism !== 'undefined' && lang && Prism.languages[lang]) {
                            try {
                                return Prism.highlight(code, Prism.languages[lang], lang);
                            } catch (e) {
                                console.warn('Prism highlighting failed:', e);
                                return escapeHtml(code);
                            }
                        }
                        return escapeHtml(code);
                    },
                    breaks: true,
                    gfm: true
                });
                
                let htmlContent = marked.parse(processedContent);
                
                // å¤„ç†HTMLä¸­çš„imgæ ‡ç­¾è·¯å¾„ï¼ˆå¤„ç†HTMLæ ¼å¼çš„å›¾åƒå¼•ç”¨ï¼‰
                const originalFilePath = window.currentOriginalFilePath || file_path || currentFilePath;
                if (originalFilePath) {
                    htmlContent = htmlContent.replace(/<img([^>]*)\ssrc=["']([^"']+)["']([^>]*)>/g, function(match, beforeSrc, src, afterSrc) {
                        let newSrc = src;
                        
                        console.log('Processing image src:', src, 'in file:', originalFilePath);
                        
                        // å¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œç›´æ¥åŸºäºmarkdownæ–‡ä»¶è·¯å¾„è¿›è¡Œæ‹¼æ¥
                        if (src && !src.startsWith('http') && !src.startsWith('data:') && !src.startsWith('/api/')) {
                            // è·å–markdownæ–‡ä»¶çš„ç›®å½•è·¯å¾„
                            const currentDir = originalFilePath.substring(0, originalFilePath.lastIndexOf('/'));
                            
                            let imagePath;
                            if (src.startsWith('./')) {
                                imagePath = `${currentDir}/${src.substring(2)}`;
                            } else if (src.startsWith('../')) {
                                const pathParts = currentDir.split('/');
                                let relativeParts = src.split('/');
                                for (let part of relativeParts) {
                                    if (part === '..') {
                                        pathParts.pop();
                                    } else if (part !== '.' && part !== '') {
                                        pathParts.push(part);
                                    }
                                }
                                imagePath = pathParts.join('/');
                            } else {
                                // æ™®é€šç›¸å¯¹è·¯å¾„ï¼Œç›´æ¥æ‹¼æ¥
                                imagePath = `${currentDir}/${src}`;
                            }
                            
                            // Add API key parameter if available
                            const apiKeyParam = (currentUser && currentUser !== 'default') ? `?api_key=${currentUser}` : '';
                            newSrc = `/api/file/${imagePath}${apiKeyParam}`;
                            console.log('Converted image path:', src, 'to:', newSrc);
                        }
                        
                        return `<img${beforeSrc} src="${newSrc}"${afterSrc} style="width: 100%; height: auto; object-fit: contain;">`;
                    });
                } else {
                    console.warn('originalFilePath is not available, image paths will not be converted');
                }
                
                const escapedContent = escapeHtml(processedContent);
                
                previewContent.innerHTML = `
                    <div class="markdown-toolbar-header" style="background: #2d2d30; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 18px; color: #9cdcfe; display: flex; justify-content: space-between; align-items: center;">
                        <span>æ–‡ä»¶å¤§å°: ${size} | ç±»å‹: Markdown</span>
                        <div class="markdown-toolbar-buttons" style="display: flex; gap: 8px; align-items: center;">
                            <button id="reloadMarkdownBtn" onclick="reloadCurrentMarkdown()" style="background: #455a64; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 16px; height: 36px; min-width: 100px; display: inline-flex; align-items: center; justify-content: center; vertical-align: middle;" title="é‡æ–°ä»æ–‡ä»¶åŠ è½½">
                                <i class="fas fa-sync" style="margin-right: 5px;"></i> é‡æ–°åŠ è½½
                            </button>
                            <button id="saveMarkdownBtn" onclick="saveCurrentMarkdown()" style="background: #ff9800; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 16px; height: 36px; min-width: 80px; display: inline-flex; align-items: center; justify-content: center; vertical-align: middle;" title="ä¿å­˜å½“å‰Markdownæ–‡æœ¬">
                                <i class="fas fa-save" style="margin-right: 5px;"></i> ä¿å­˜
                            </button>
                            <button id="convertWordBtn" onclick="convertMarkdownToWord()" style="background: #2e7d32; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 16px; height: 36px; min-width: 80px; display: inline-flex; align-items: center; justify-content: center; vertical-align: middle;" title="è½¬æ¢ä¸ºWordæ–‡æ¡£">
                                <i class="fas fa-file-word" style="margin-right: 5px;"></i> Word
                            </button>
                            <button id="convertPdfBtn" onclick="convertMarkdownToPdf()" style="background: #d32f2f; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 16px; height: 36px; min-width: 70px; display: inline-flex; align-items: center; justify-content: center; vertical-align: middle;" title="è½¬æ¢ä¸ºPDFæ–‡æ¡£">
                                <i class="fas fa-file-pdf" style="margin-right: 5px;"></i> PDF
                            </button>
                            <button id="markdownToggleBtn" onclick="toggleMarkdownMode()" style="background: #569cd6; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 16px; height: 36px; min-width: 110px; display: inline-flex; align-items: center; justify-content: center; vertical-align: middle;">
                                <i class="fas fa-eye" style="margin-right: 5px;"></i> æºç æ¨¡å¼
                            </button>
                        </div>
                    </div>
                    <div id="markdownPreview" class="tex2jax_process" style="background: #ffffff; color: #000000; padding: 10px; border-radius: 5px; line-height: 1.6; overflow: visible; border: 1px solid #dddddd;">
                        ${htmlContent}
                    </div>
                    <div id="markdownSource" style="background: #1e1e1e; color: #ffffff; padding: 20px; border-radius: 5px; overflow: visible; display: none; border: 1px solid #404040;">
                        <textarea id="markdownEditor" style="width: 100%; height: calc(90vh - 200px); background: #1e1e1e; color: #ffffff; border: none; font-size: 18px; line-height: 1.5; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; resize: none; outline: none; padding: 0; margin: 0; white-space: pre-wrap;" placeholder="ç¼–è¾‘Markdownå†…å®¹...">${escapedContent}</textarea>
                    </div>
                `;
                
                // å­˜å‚¨åŸå§‹å†…å®¹ä»¥ä¾¿åˆ‡æ¢
                window.currentMarkdownContent = {
                    processed: processedContent,
                    html: htmlContent,
                    escaped: escapedContent
                };
                
                // åº”ç”¨ç”¨æˆ·ä¿å­˜çš„æ˜¾ç¤ºæ¨¡å¼åå¥½
                setTimeout(() => {
                    applyMarkdownModePreference();
                    
                    // è§¦å‘Prism.jsè¯­æ³•é«˜äº®
                    if (typeof Prism !== 'undefined') {
                        Prism.highlightAll();
                    }
                    
                    // è§¦å‘æ•°å­¦å…¬å¼æ¸²æŸ“ï¼ˆæ™ºèƒ½fallbackï¼‰
                    renderMath(document.getElementById('markdownPreview'));
                }, 100);
            } else if (type === 'pdf') {
                previewContent.innerHTML = `
                    <div style="background: #f8f8f8; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 18px; color: #666;">
                        æ–‡ä»¶å¤§å°: ${size} | ç±»å‹: PDF
                    </div>
                    <div id="pdfContainer" style="width: 100%; min-height: calc(90vh - 160px); border: 1px solid #ddd; border-radius: 4px; overflow: visible; background: #f5f5f5;">
                        <div style="text-align: center; padding: 20px;">
                            <i class="fas fa-spinner fa-spin"></i> æ­£åœ¨åŠ è½½PDF...
                        </div>
                    </div>
                `;
                // PDFé¢„è§ˆä½¿ç”¨åŸå§‹è·¯å¾„ï¼ˆä¸åŒ…å«ç”¨æˆ·ç›®å½•å‰ç¼€ï¼‰
                loadPDF(file_path || currentFilePath);
            } else if (type === 'office') {
                const { file_ext } = data;
                previewContent.innerHTML = `
                    <div style="background: #f8f8f8; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 18px; color: #666;">
                        æ–‡ä»¶å¤§å°: ${size} | ç±»å‹: ${file_ext.toUpperCase()} Officeæ–‡æ¡£
                    </div>
                    <div id="officeContainer" style="width: 100%; height: calc(90vh - 160px); border: 1px solid #ddd; border-radius: 4px; overflow: auto; background: #f5f5f5;">
                        <div style="text-align: center; padding: 40px; color: #666;">
                            <i class="fas fa-file-alt" style="font-size: 48px; margin-bottom: 20px; color: #007acc;"></i>
                            <h3 style="margin-bottom: 20px;">Officeæ–‡æ¡£é¢„è§ˆ</h3>
                            <p style="margin-bottom: 20px;">Officeæ–‡æ¡£éœ€è¦ä¸‹è½½åˆ°æœ¬åœ°æŸ¥çœ‹ï¼š</p>
                            <div style="display: flex; flex-direction: column; gap: 15px; align-items: center;">
                                <a href="/api/download-file/${file_path || currentFilePath}${(currentUser && currentUser !== 'default') ? '?api_key=' + currentUser : ''}" download style="padding: 12px 24px; background: #007acc; color: white; text-decoration: none; border-radius: 5px; font-size: 21px; min-width: 200px; text-align: center; display: inline-block;">
                                    <i class="fas fa-download"></i> ä¸‹è½½æ–‡ä»¶
                                </a>
                            </div>
                            <div style="margin-top: 30px; padding: 20px; background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 5px; text-align: left; max-width: 600px;">
                                <h4 style="color: #0c5460; margin-bottom: 10px;"><i class="fas fa-info-circle"></i> ä½¿ç”¨è¯´æ˜</h4>
                                <ul style="color: #0c5460; margin: 0; padding-left: 20px;">
                                    <li>ç‚¹å‡»"ä¸‹è½½æ–‡ä»¶"æŒ‰é’®å°†æ–‡ä»¶ä¿å­˜åˆ°æœ¬åœ°</li>
                                    <li>ä½¿ç”¨Microsoft Officeã€WPSæˆ–å…¶ä»–å…¼å®¹è½¯ä»¶æ‰“å¼€</li>
                                    <li>æ”¯æŒ.docã€.docxã€.xlsã€.xlsxã€.pptã€.pptxç­‰æ ¼å¼</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
            } else if (type === 'csv') {
                // CSVæ–‡ä»¶è¡¨æ ¼é¢„è§ˆ
                const { headers, data: csvRows, total_rows, displayed_rows, truncated, encoding } = data;
                
                // åˆ›å»ºè¡¨æ ¼HTML
                let tableHtml = '<table id="csvTable" style="width: 100%; border-collapse: collapse; background: white; font-size: 18px; color: #333;">';
                
                // è¡¨å¤´
                if (headers && headers.length > 0) {
                    tableHtml += '<thead><tr style="background: #f8f9fa; position: sticky; top: 0; z-index: 10;">';
                    headers.forEach((header, index) => {
                        const escapedHeader = escapeHtml(header || `åˆ—${index + 1}`);
                        tableHtml += `<th onclick="sortCSVTable(${index})" style="border: 1px solid #dee2e6; padding: 12px 8px; text-align: left; font-weight: 600; cursor: pointer; user-select: none; position: relative; min-width: 120px; color: #333;" title="ç‚¹å‡»æ’åº">${escapedHeader}<span style="margin-left: 5px; color: #6c757d;">â‡…</span></th>`;
                    });
                    tableHtml += '</tr></thead>';
                }
                
                // è¡¨æ ¼æ•°æ®
                tableHtml += '<tbody id="csvTableBody">';
                if (csvRows && csvRows.length > 0) {
                    csvRows.forEach((row, rowIndex) => {
                        const rowStyle = rowIndex % 2 === 0 ? 'background: #ffffff;' : 'background: #f8f9fa;';
                        tableHtml += `<tr style="${rowStyle}">`;
                        
                        // ç¡®ä¿æ¯è¡Œéƒ½æœ‰è¶³å¤Ÿçš„åˆ—
                        const maxCols = Math.max(headers.length, row.length);
                        for (let i = 0; i < maxCols; i++) {
                            const cellValue = row[i] || '';
                            const escapedValue = escapeHtml(cellValue);
                            tableHtml += `<td style="border: 1px solid #dee2e6; padding: 8px; vertical-align: top; word-break: break-word; max-width: 300px; color: #333;" title="${escapedValue}">${escapedValue}</td>`;
                        }
                        tableHtml += '</tr>';
                    });
                } else {
                    tableHtml += `<tr><td colspan="${headers.length}" style="text-align: center; padding: 40px; color: #6c757d; font-style: italic;">æš‚æ— æ•°æ®</td></tr>`;
                }
                tableHtml += '</tbody></table>';
                
                // åˆ›å»ºæœç´¢å’Œå·¥å…·æ 
                const searchHtml = `
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 5px 5px 0 0; border-bottom: 1px solid #dee2e6; display: flex; align-items: center; flex-wrap: wrap; gap: 10px;">
                        <div style="flex: 1; min-width: 200px;">
                            <input type="text" id="csvSearchInput" placeholder="æœç´¢è¡¨æ ¼å†…å®¹..." 
                                style="width: 100%; padding: 8px 12px; border: 1px solid #ced4da; border-radius: 4px; font-size: 21px;"
                                oninput="filterCSVTable()">
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                            <button onclick="exportCSVTable()" style="padding: 8px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 18px; display: flex; align-items: center; gap: 5px;">
                                <i class="fas fa-download"></i> å¯¼å‡º
                            </button>
                            <span style="font-size: 18px; color: #6c757d;">
                                æ˜¾ç¤º ${displayed_rows}/${total_rows} è¡Œ
                                ${truncated ? '(å·²æˆªæ–­)' : ''}
                                ${encoding ? `| ç¼–ç : ${encoding.toUpperCase()}` : ''}
                            </span>
                        </div>
                    </div>
                `;
                
                previewContent.innerHTML = `
                    <div style="background: #f8f8f8; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 18px; color: #666;">
                        æ–‡ä»¶å¤§å°: ${size} | ç±»å‹: CSVè¡¨æ ¼ | æ€»è¡Œæ•°: ${total_rows} | åˆ—æ•°: ${headers.length}
                        ${truncated ? ' | âš ï¸ å¤§æ–‡ä»¶å·²æˆªæ–­æ˜¾ç¤º' : ''}
                    </div>
                    <div style="border: 1px solid #dee2e6; border-radius: 5px; overflow: hidden; max-height: calc(90vh - 160px); display: flex; flex-direction: column;">
                        ${searchHtml}
                        <div style="flex: 1; overflow: auto;">
                            ${tableHtml}
                        </div>
                    </div>
                `;
                
                // å­˜å‚¨åŸå§‹æ•°æ®ç”¨äºæœç´¢å’Œæ’åº
                window.csvData = {
                    headers: headers,
                    originalData: csvRows,
                    currentData: csvRows,
                    sortColumn: -1,
                    sortDirection: 'asc'
                };
                
            } else if (type === 'code') {
                // ç‰¹æ®Šå¤„ç†txtå’Œlogæ–‡ä»¶ï¼Œæä¾›æ›´å¥½çš„é˜…è¯»ä½“éªŒ
                if (language === 'text' || language === 'log') {
                    // å…ˆå¤„ç†è½¬ä¹‰å­—ç¬¦ï¼Œå†è¿›è¡ŒHTMLè½¬ä¹‰
                    const processedContent = escapeHtml(processFileContent(content));
                    previewContent.innerHTML = `
                        <div style="background: #f8f8f8; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 18px; color: #666;">
                            æ–‡ä»¶å¤§å°: ${size} | ç±»å‹: ${language.toUpperCase()}
                        </div>
                        <div style="background: #1e1e1e; color: #ffffff; padding: 20px; border-radius: 5px; overflow: auto; font-size: 21px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word; font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; max-height: calc(90vh - 160px); border: 1px solid #404040; font-weight: 500;">${processedContent}</div>
                    `;
                } else {
                    // ä½¿ç”¨Prism.jsè¿›è¡Œè¯­æ³•é«˜äº®
                    // å…ˆå¤„ç†è½¬ä¹‰å­—ç¬¦ï¼Œå†è¿›è¡ŒHTMLè½¬ä¹‰
                    const processedContent = escapeHtml(processFileContent(content));
                    
                    // ä¸ºmermaidæ–‡ä»¶æä¾›ç‰¹æ®Šçš„æ ·å¼å¤„ç†
                    if (language === 'mermaid') {
                        previewContent.innerHTML = `
                            <div style="background: #f8f8f8; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 18px; color: #666; display: flex; justify-content: space-between; align-items: center;">
                                <span>æ–‡ä»¶å¤§å°: ${size} | è¯­è¨€: ${language}</span>
                                <div style="display: flex; gap: 10px;">
                                    <button onclick="saveMermaidFile()" style="padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 18px;" title="ä¿å­˜å½“å‰Mermaidæ–‡ä»¶">
                                        <i class="fas fa-save"></i> ä¿å­˜
                                    </button>
                                    <button onclick="toggleMermaidView()" style="padding: 6px 12px; background: #007acc; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 18px;">
                                        <i class="fas fa-eye"></i> <span id="mermaid-view-btn-text">æ˜¾ç¤ºå›¾è¡¨</span>
                                    </button>
                                    <button onclick="convertMermaidToImages()" style="padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 18px;" title="å°†mermaidè½¬æ¢ä¸ºPNGå’ŒSVGå›¾åƒ">
                                        <i class="fas fa-image"></i> è½¬æ¢ä¸ºå›¾åƒ
                                    </button>
                                </div>
                            </div>
                            <div id="mermaid-source-view" style="max-height: calc(90vh - 160px); overflow: auto; border-radius: 5px;">
                                <textarea id="mermaid-editor" style="width: 100%; height: calc(90vh - 200px); background: #1e1e1e; color: #ffffff; border: 1px solid #404040; font-size: 21px; line-height: 1.4; font-family: 'Consolas', 'Monaco', 'Courier New', monospace; resize: none; outline: none; padding: 15px; border-radius: 5px;" placeholder="ç¼–è¾‘Mermaidå†…å®¹...">${content}</textarea>
                            </div>
                            <div id="mermaid-chart-view" style="display: none; max-height: calc(90vh - 160px); overflow: auto; border-radius: 5px; background: white; border: 1px solid #ddd; padding: 20px; text-align: center;">
                                <div id="mermaid-chart-container">æ­£åœ¨æ¸²æŸ“å›¾è¡¨...</div>
                            </div>
                        `;
                        
                        // Store the mermaid content and file path for later use
                        window.currentMermaidContent = content;
                        window.currentFilePath = actualFilePath;
                        
                        // é»˜è®¤èšç„¦åˆ°ç¼–è¾‘å™¨å¹¶æ·»åŠ é”®ç›˜äº‹ä»¶ç›‘å¬
                        setTimeout(() => {
                            const editor = document.getElementById('mermaid-editor');
                            if (editor) {
                                editor.focus();
                                // æ·»åŠ Ctrl+Sä¿å­˜å¿«æ·é”®
                                editor.addEventListener('keydown', function(e) {
                                    if (e.ctrlKey && e.key === 's') {
                                        e.preventDefault();
                                        saveMermaidFile();
                                    }
                                });
                            }
                        }, 100);
                    } else {
                        previewContent.innerHTML = `
                            <div style="background: #f8f8f8; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 18px; color: #666;">
                                æ–‡ä»¶å¤§å°: ${size} | è¯­è¨€: ${language}
                            </div>
                            <div style="max-height: calc(90vh - 160px); overflow: auto; border-radius: 5px;">
                                <pre class="language-${language}" style="margin: 0; font-size: 21px; line-height: 1.4; background: #1e1e1e !important; border: 1px solid #404040;"><code class="language-${language}" style="color: #ffffff !important; font-weight: normal !important; background: transparent !important;">${processedContent}</code></pre>
                            </div>
                        `;
                    }
                    
                    // è§¦å‘Prism.jsè¯­æ³•é«˜äº®
                    setTimeout(() => {
                        if (typeof Prism !== 'undefined') {
                            Prism.highlightAll();
                        }
                    }, 100);
                }
            } else if (type === 'image') {
                // Image file preview
                const { data: imageData, image_info } = data;
                const { width, height, format } = image_info;
                
                previewContent.innerHTML = `
                    <div style="background: #f8f8f8; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-size: 18px; color: #666;">
                        æ–‡ä»¶å¤§å°: ${size} | ç±»å‹: å›¾ç‰‡ (${format}) | å°ºå¯¸: ${width} Ã— ${height}
                    </div>
                    <div style="text-align: center; padding: 20px; max-height: calc(90vh - 160px); overflow: auto;">
                        <img src="${imageData}" 
                             alt="${fileName}" 
                             style="max-width: 100%; max-height: calc(90vh - 200px); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); background: white; padding: 10px;"
                             onerror="this.style.display='none'; this.parentNode.innerHTML='<div style=&quot;color: red; padding: 40px;&quot;><i class=&quot;fas fa-exclamation-triangle&quot;></i><br/>å›¾ç‰‡åŠ è½½å¤±è´¥</div>';" />
                        <div class="preview-button-group" style="margin-top: 15px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                            <a href="/api/download-file/${file_path || currentFilePath}${(currentUser && currentUser !== 'default') ? '?api_key=' + currentUser : ''}" download style="padding: 8px 16px; background: #007acc; color: white; text-decoration: none; border-radius: 4px; font-size: 18px; display: flex; align-items: center; gap: 5px;">
                                <i class="fas fa-download"></i> ä¸‹è½½å›¾ç‰‡
                            </a>
                            <button onclick="zoomImage()" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 18px; display: flex; align-items: center; gap: 5px;">
                                <i class="fas fa-search-plus"></i> æ”¾å¤§æŸ¥çœ‹
                            </button>
                        </div>
                    </div>
                `;
            }
        }
        
        function zoomImage() {
            const img = previewContent.querySelector('img');
            if (!img) return;
            
            // Create fullscreen overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(255,255,255,0.95); z-index: 10000; display: flex; 
                align-items: center; justify-content: center; cursor: zoom-out;
            `;
            
            const fullImg = document.createElement('img');
            fullImg.src = img.src;
            fullImg.style.cssText = `
                max-width: 95%; max-height: 95%; object-fit: contain;
                border-radius: 8px; box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            `;
            
            overlay.appendChild(fullImg);
            overlay.onclick = () => document.body.removeChild(overlay);
            
            document.body.appendChild(overlay);
        }

        function loadPDF(filePath) {
            if (typeof pdfjsLib === 'undefined') {
                document.getElementById('pdfContainer').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: red;">
                        <i class="fas fa-exclamation-triangle"></i> PDF.js æœªåŠ è½½ï¼Œæ— æ³•é¢„è§ˆPDFæ–‡ä»¶
                    </div>
                `;
                return;
            }

            // æ·»åŠ APIå¯†é’¥å‚æ•°
            const apiKeyParam = (currentUser && currentUser !== 'default') ? `?api_key=${currentUser}` : '';
            const pdfUrl = `/api/pdf/${filePath}${apiKeyParam}`;
            
            // PDFä¸‹è½½ä½¿ç”¨åŸå§‹è·¯å¾„ï¼ˆåç«¯ä¼šè‡ªåŠ¨æ·»åŠ ç”¨æˆ·ç›®å½•å‰ç¼€ï¼‰
            const downloadFilePath = window.currentOriginalFilePath || filePath;
            
            console.log('ğŸ” PDF loadPDFè°ƒè¯•ä¿¡æ¯:');
            console.log('  ä¼ å…¥çš„filePath:', filePath);
            console.log('  ç”¨äºä¸‹è½½çš„downloadFilePath:', downloadFilePath);
            console.log('  å…¨å±€currentOriginalFilePath:', window.currentOriginalFilePath);
            console.log('  PDF URL:', pdfUrl);
            console.log('  å°†ç”¨äºä¸‹è½½çš„è·¯å¾„:', downloadFilePath);
            
            // é…ç½®PDF.jsåŠ è½½é€‰é¡¹
            const loadingTask = pdfjsLib.getDocument({
                url: pdfUrl,
                disableWorker: false,
                verbosity: 1,  // å¯ç”¨è¯¦ç»†æ—¥å¿—ä»¥ä¾¿è°ƒè¯•
                cMapUrl: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/cmaps/',
                cMapPacked: true,
                standardFontDataUrl: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/standard_fonts/'
            });
            
            loadingTask.promise.then(function(pdf) {
                const container = document.getElementById('pdfContainer');
                container.innerHTML = '';
                
                // åˆ›å»ºé¡µé¢å¯¼èˆª
                const nav = document.createElement('div');
                nav.style.cssText = 'background: #333; color: white; padding: 10px; text-align: center; position: sticky; top: 0; z-index: 10;';
                const apiKeyParam = (currentUser && currentUser !== 'default') ? `?api_key=${currentUser}` : '';
                const downloadUrl = `/api/download-file/${downloadFilePath}${apiKeyParam}`;
                
                nav.innerHTML = `
                    <span id="pageInfo">å…± ${pdf.numPages} é¡µ</span>
                    <a href="${downloadUrl}" download style="margin-left: 15px; padding: 5px 10px; background: #28a745; color: white; text-decoration: none; border-radius: 3px; font-size: 18px;">
                        <i class="fas fa-download"></i> ä¸‹è½½PDF
                    </a>
                `;
                container.appendChild(nav);
                
                // åˆ›å»ºé¡µé¢å®¹å™¨
                const pagesContainer = document.createElement('div');
                pagesContainer.id = 'pdfPages';
                pagesContainer.style.cssText = 'padding: 20px; text-align: center; width: 100%; max-width: none;';
                container.appendChild(pagesContainer);
                
                // å­˜å‚¨PDFå¯¹è±¡
                window.currentPDF = pdf;
                
                // æ¸²æŸ“æ‰€æœ‰é¡µé¢
                renderAllPDFPages();
                
            }).catch(function(error) {
                console.error('PDFåŠ è½½å¤±è´¥:', error);
                console.error('PDF URL:', pdfUrl);
                console.error('Error details:', {
                    name: error.name,
                    message: error.message,
                    stack: error.stack
                });
                
                // å¦‚æœæ˜¯InvalidPDFExceptionï¼Œå°è¯•ä½¿ç”¨ç®€åŒ–é…ç½®é‡æ–°åŠ è½½
                if (error.name === 'InvalidPDFException') {
                    console.log('å°è¯•ä½¿ç”¨ç®€åŒ–é…ç½®é‡æ–°åŠ è½½PDF...');
                    const simpleLoadingTask = pdfjsLib.getDocument({
                        url: pdfUrl,
                        disableWorker: true,  // ç¦ç”¨worker
                        verbosity: 0
                    });
                    
                    simpleLoadingTask.promise.then(function(pdf) {
                        const container = document.getElementById('pdfContainer');
                        container.innerHTML = '';
                        
                        // åˆ›å»ºé¡µé¢å¯¼èˆª
                        const nav = document.createElement('div');
                        nav.style.cssText = 'background: #333; color: white; padding: 10px; text-align: center; position: sticky; top: 0; z-index: 10;';
                        const apiKeyParam = (currentUser && currentUser !== 'default') ? `?api_key=${currentUser}` : '';
                        const downloadUrl = `/api/download-file/${downloadFilePath}${apiKeyParam}`;
                        
                        nav.innerHTML = `
                            <span id="pageInfo">å…± ${pdf.numPages} é¡µ (ç®€åŒ–æ¨¡å¼)</span>
                            <a href="${downloadUrl}" download style="margin-left: 15px; padding: 5px 10px; background: #28a745; color: white; text-decoration: none; border-radius: 3px; font-size: 18px;">
                                <i class="fas fa-download"></i> ä¸‹è½½PDF
                            </a>
                        `;
                        container.appendChild(nav);
                        
                                            // åˆ›å»ºé¡µé¢å®¹å™¨
                    const pagesContainer = document.createElement('div');
                    pagesContainer.id = 'pdfPages';
                    pagesContainer.style.cssText = 'padding: 20px; text-align: center; width: 100%; max-width: none;';
                    container.appendChild(pagesContainer);
                        
                        // å­˜å‚¨PDFå¯¹è±¡
                        window.currentPDF = pdf;
                        
                        // æ¸²æŸ“æ‰€æœ‰é¡µé¢
                        renderAllPDFPages();
                    }).catch(function(simpleError) {
                        console.error('ç®€åŒ–é…ç½®ä¹Ÿå¤±è´¥:', simpleError);
                        showPDFError('PDFæ–‡ä»¶æ ¼å¼æ— æ•ˆæˆ–å·²æŸå', error);
                    });
                } else {
                    let errorMessage = error.message;
                    if (error.name === 'MissingPDFException') {
                        errorMessage = 'PDFæ–‡ä»¶æœªæ‰¾åˆ°';
                    } else if (error.name === 'UnexpectedResponseException') {
                        errorMessage = 'æœåŠ¡å™¨å“åº”å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„å’Œæƒé™';
                    }
                    showPDFError(errorMessage, error);
                }
            });
            
            function showPDFError(errorMessage, error) {
                document.getElementById('pdfContainer').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: red;">
                        <i class="fas fa-exclamation-triangle"></i> PDFåŠ è½½å¤±è´¥: ${errorMessage}
                        <br><small style="color: #666; margin-top: 10px; display: block;">
                            æŠ€æœ¯è¯¦æƒ…: ${error.name || 'Unknown'} - ${error.message}
                        </small>
                        <br><button onclick="retryPDFLoad('${filePath}')" style="margin-top: 10px; padding: 5px 15px; background: #007acc; color: white; border: none; border-radius: 3px; cursor: pointer;">
                            é‡è¯•åŠ è½½
                        </button>
                    </div>
                `;
            }
        }

        // ä»…ç”¨äº Markdown ä¸­ web_search_result/images çš„å›¾ç‰‡å¯¼èˆªé€»è¾‘
        function _extractPrevImagePathInFolder(originalHref, baseDir) {
            try {
                // originalHref ä¾‹å¦‚: web_search_result/images/xxx_YYYYMMDD_001.png
                if (!originalHref || !originalHref.includes('/')) return null;
                const lastSlash = originalHref.lastIndexOf('/');
                const folder = originalHref.substring(0, lastSlash); // web_search_result/images
                const filename = originalHref.substring(lastSlash + 1); // xxx_YYYYMMDD_001.png

                // æå–å‰ç¼€ï¼šå»æ‰æ–‡ä»¶åæœ€å9ä¸ªå­—ç¬¦ï¼ˆå«æ‰©å±•åå‰çš„åˆ†éš”ç¬¦è®¡å…¥9ä¸ªè®¡æ•°çº¦æŸç”±çº¦å®šè´Ÿè´£ï¼‰
                // ä¾‹å¦‚: name_part + '_' + 9ä½ç¼–å·ï¼ˆå¦‚ _000000123 æˆ– _202501001ï¼‰
                const dotIdx = filename.lastIndexOf('.');
                if (dotIdx <= 0) return null;
                const nameNoExt = filename.substring(0, dotIdx);
                const ext = filename.substring(dotIdx); // .png/.jpg
                if (nameNoExt.length <= 9) return null;
                const prefix = nameNoExt.substring(0, nameNoExt.length - 9);
                const tailNine = nameNoExt.substring(nameNoExt.length - 9); // ç¼–å·å­—æ®µ

                // è°ƒç”¨åç«¯åˆ—å‡ºç›®å½•
                let folderPath = folder;
                if (baseDir && !folder.startsWith('/')) {
                    folderPath = baseDir + '/' + folder;
                }

                // ç§»é™¤å¯èƒ½é‡å¤çš„ //
                folderPath = folderPath.replace(/\/+/, '/');

                const headers = { 'Content-Type': 'application/json' };
                const body = { path: folderPath };
                if (currentUser && currentUser !== 'default') {
                    headers['X-API-Key'] = currentUser;
                    body.api_key = currentUser;
                }

                return fetch('/api/list-directory', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(body)
                }).then(r => r.json()).then(data => {
                    if (!data.success) throw new Error(data.error || 'list failed');
                    // è¿‡æ»¤åŒå‰ç¼€ + åŒæ‰©å±•åçš„æ–‡ä»¶
                    const files = (data.files || []).filter(f => {
                        if (!f || !f.name) return false;
                        const fname = f.name;
                        const dIdx = fname.lastIndexOf('.');
                        if (dIdx <= 0) return false;
                        const nNoExt = fname.substring(0, dIdx);
                        if (nNoExt.length <= 9) return false;
                        const pfx = nNoExt.substring(0, nNoExt.length - 9);
                        const tn = nNoExt.substring(nNoExt.length - 9);
                        return pfx === prefix && /^[-_0-9A-Za-z]{9}$/.test(tn);
                    }).map(f => f.name);

                    // æ’åºä¾æ®ï¼šæ–‡ä»¶åå9ä½çš„å­—å…¸åº
                    files.sort((a, b) => {
                        const aNoExt = a.substring(0, a.lastIndexOf('.'));
                        const bNoExt = b.substring(0, b.lastIndexOf('.'));
                        const aTail = aNoExt.substring(aNoExt.length - 9);
                        const bTail = bNoExt.substring(bNoExt.length - 9);
                        return aTail.localeCompare(bTail);
                    });

                    if (!files.length) return null;

                    // ä¼˜å…ˆç²¾ç¡®åŒ¹é…å½“å‰æ–‡ä»¶åï¼Œå¦åˆ™æŒ‰å°¾9ä½åŒ¹é…ï¼›éƒ½åŒ¹é…ä¸åˆ°åˆ™ä»æœ€åä¸€å¼ å¼€å§‹
                    let idx = files.findIndex(n => n === filename);
                    if (idx < 0) {
                        const idx2 = files.findIndex(n => {
                            const nNoExt = n.substring(0, n.lastIndexOf('.'));
                            return nNoExt.endsWith(tailNine);
                        });
                        idx = idx2; // å¯èƒ½ä»ä¸º -1
                    }

                    const prevIndex = idx <= 0 ? files.length - 1 : idx - 1;
                    const prevName = files[prevIndex];
                    return folder + '/' + prevName;
                }).catch(e => {
                    console.warn('list prev image failed:', e);
                    return null;
                });
            } catch (e) {
                console.warn('parse prev image failed:', e);
                return Promise.resolve(null);
            }
        }

        function _extractNextImagePathInFolder(originalHref, baseDir) {
            try {
                // originalHref ä¾‹å¦‚: web_search_result/images/xxx_YYYYMMDD_001.png
                if (!originalHref || !originalHref.includes('/')) return null;
                const lastSlash = originalHref.lastIndexOf('/');
                const folder = originalHref.substring(0, lastSlash); // web_search_result/images
                const filename = originalHref.substring(lastSlash + 1); // xxx_YYYYMMDD_001.png

                // æå–å‰ç¼€ï¼šå»æ‰æ–‡ä»¶åæœ€å9ä¸ªå­—ç¬¦ï¼ˆå«æ‰©å±•åå‰çš„åˆ†éš”ç¬¦è®¡å…¥9ä¸ªè®¡æ•°çº¦æŸç”±çº¦å®šè´Ÿè´£ï¼‰
                // ä¾‹å¦‚: name_part + '_' + 9ä½ç¼–å·ï¼ˆå¦‚ _000000123 æˆ– _202501001ï¼‰
                const dotIdx = filename.lastIndexOf('.');
                if (dotIdx <= 0) return null;
                const nameNoExt = filename.substring(0, dotIdx);
                const ext = filename.substring(dotIdx); // .png/.jpg
                if (nameNoExt.length <= 9) return null;
                const prefix = nameNoExt.substring(0, nameNoExt.length - 9);
                const tailNine = nameNoExt.substring(nameNoExt.length - 9); // ç¼–å·å­—æ®µ

                // è°ƒç”¨åç«¯åˆ—å‡ºç›®å½•
                // æ³¨æ„ï¼šåç«¯ /api/list-directory ä¼šåœ¨ç”¨æˆ·ç›®å½•ä¸‹è§£æè·¯å¾„
                // è¿™é‡Œä¼ å…¥ baseDir + '/' + folder ä½œä¸º markdown æ‰€åœ¨ç›®å½•çš„ç›¸å¯¹è·¯å¾„
                // å®é™… originalHref æ˜¯ç›¸å¯¹ markdown æ–‡ä»¶çš„ç›¸å¯¹è·¯å¾„ï¼Œå› æ­¤æ‹¼æ¥ baseDir åå†è§„èŒƒåŒ–
                let folderPath = folder;
                // å¦‚æœ originalHref éç»å¯¹ä¸”ä¸ä»¥ /api/ å¼€å¤´ï¼Œåˆ™ä½¿ç”¨ markdown æ‰€åœ¨ç›®å½•ä¸ºåŸºå‡†
                if (baseDir && !folder.startsWith('/')) {
                    folderPath = baseDir + '/' + folder;
                }

                // ç§»é™¤å¯èƒ½é‡å¤çš„ //
                folderPath = folderPath.replace(/\/+/, '/');

                const headers = { 'Content-Type': 'application/json' };
                const body = { path: folderPath };
                if (currentUser && currentUser !== 'default') {
                    headers['X-API-Key'] = currentUser;
                    body.api_key = currentUser;
                }

                return fetch('/api/list-directory', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(body)
                }).then(r => r.json()).then(data => {
                    if (!data.success) throw new Error(data.error || 'list failed');
                    // è¿‡æ»¤åŒå‰ç¼€ + åŒæ‰©å±•åçš„æ–‡ä»¶
                    const files = (data.files || []).filter(f => {
                        if (!f || !f.name) return false;
                        const fname = f.name;
                        const dIdx = fname.lastIndexOf('.');
                        if (dIdx <= 0) return false;
                        const nNoExt = fname.substring(0, dIdx);
                        if (nNoExt.length <= 9) return false;
                        const pfx = nNoExt.substring(0, nNoExt.length - 9);
                        const tn = nNoExt.substring(nNoExt.length - 9);
                        return pfx === prefix && /^[-_0-9A-Za-z]{9}$/.test(tn);
                    }).map(f => f.name);

                    // æ’åºä¾æ®ï¼šæ–‡ä»¶åå9ä½çš„å­—å…¸åº
                    files.sort((a, b) => {
                        const aNoExt = a.substring(0, a.lastIndexOf('.'));
                        const bNoExt = b.substring(0, b.lastIndexOf('.'));
                        const aTail = aNoExt.substring(aNoExt.length - 9);
                        const bTail = bNoExt.substring(bNoExt.length - 9);
                        return aTail.localeCompare(bTail);
                    });

                    if (!files.length) return null;

                    // ä¼˜å…ˆç²¾ç¡®åŒ¹é…å½“å‰æ–‡ä»¶åï¼Œå¦åˆ™æŒ‰å°¾9ä½åŒ¹é…ï¼›éƒ½åŒ¹é…ä¸åˆ°åˆ™ä»ç¬¬ä¸€å¼ å¼€å§‹
                    let idx = files.findIndex(n => n === filename);
                    if (idx < 0) {
                        const idx2 = files.findIndex(n => {
                            const nNoExt = n.substring(0, n.lastIndexOf('.'));
                            return nNoExt.endsWith(tailNine);
                        });
                        idx = idx2; // å¯èƒ½ä»ä¸º -1
                    }

                    const nextIndex = ((idx >= 0 ? idx + 1 : 0) % files.length);
                    const nextName = files[nextIndex];
                    return folder + '/' + nextName;
                }).catch(e => {
                    console.warn('list next image failed:', e);
                    return null;
                });
            } catch (e) {
                console.warn('parse next image failed:', e);
                return Promise.resolve(null);
            }
        }

        function nextWebSearchImage(btnEl) {
            try {
                if (!window.currentMarkdownContent || !window.currentMarkdownContent.processed) return;
                const mdText = window.currentMarkdownContent.processed;
                const href = btnEl?.getAttribute('data-md-href');
                const occStr = btnEl?.getAttribute('data-md-occurrence') || '0';
                const occIndex = parseInt(occStr, 10) || 0;
                const baseDir = btnEl?.getAttribute('data-md-basedir') || '';

                if (!href || !href.startsWith('web_search_result/images')) return;

                _extractNextImagePathInFolder(href, baseDir).then(nextHref => {
                    if (!nextHref) return; // æ— ä¸‹ä¸€å¼ 

                    // åœ¨ Markdown åŸæ–‡ä¸­ä»…æ›¿æ¢ç¬¬ occIndex æ¬¡å‡ºç°çš„è¯¥ href
                    let count = 0;
                    const replaced = mdText.replace(new RegExp(escapeRegExp(href), 'g'), (m) => {
                        const cur = count;
                        count += 1;
                        return (cur === occIndex) ? nextHref : m;
                    });

                    window.currentMarkdownContent.processed = replaced;
                    // é‡æ–°æ¸²æŸ“ï¼šå¤ç”¨ displayFileContent çš„ markdown æµç¨‹
                    // è¿™é‡Œé€šè¿‡æ„é€  data å¯¹è±¡è°ƒç”¨ä¸€æ¬¡æ¸²æŸ“è·¯å¾„
                    const fake = { content: replaced, type: 'markdown', size: 'N/A', file_path: window.currentOriginalFilePath || currentFilePath };
                    displayFileContent(fake, '');
                    
                    // å›¾ç‰‡åˆ‡æ¢æˆåŠŸåè‡ªåŠ¨ä¿å­˜æ–‡ä»¶
                    autoSaveMarkdown().then(saved => {
                        if (saved) {
                            console.log('å›¾ç‰‡åˆ‡æ¢åå·²è‡ªåŠ¨ä¿å­˜markdownæ–‡ä»¶');
                        }
                    }).catch(e => {
                        console.warn('è‡ªåŠ¨ä¿å­˜æ—¶å‡ºé”™:', e);
                    });
                });
            } catch (e) {
                console.warn('next image failed:', e);
            }
        }

        function prevWebSearchImage(btnEl) {
            try {
                if (!window.currentMarkdownContent || !window.currentMarkdownContent.processed) return;
                const mdText = window.currentMarkdownContent.processed;
                const href = btnEl?.getAttribute('data-md-href');
                const occStr = btnEl?.getAttribute('data-md-occurrence') || '0';
                const occIndex = parseInt(occStr, 10) || 0;
                const baseDir = btnEl?.getAttribute('data-md-basedir') || '';

                if (!href || !href.startsWith('web_search_result/images')) return;

                _extractPrevImagePathInFolder(href, baseDir).then(prevHref => {
                    if (!prevHref) return; // æ— ä¸Šä¸€å¼ 

                    // åœ¨ Markdown åŸæ–‡ä¸­ä»…æ›¿æ¢ç¬¬ occIndex æ¬¡å‡ºç°çš„è¯¥ href
                    let count = 0;
                    const replaced = mdText.replace(new RegExp(escapeRegExp(href), 'g'), (m) => {
                        const cur = count;
                        count += 1;
                        return (cur === occIndex) ? prevHref : m;
                    });

                    window.currentMarkdownContent.processed = replaced;
                    // é‡æ–°æ¸²æŸ“ï¼šå¤ç”¨ displayFileContent çš„ markdown æµç¨‹
                    // è¿™é‡Œé€šè¿‡æ„é€  data å¯¹è±¡è°ƒç”¨ä¸€æ¬¡æ¸²æŸ“è·¯å¾„
                    const fake = { content: replaced, type: 'markdown', size: 'N/A', file_path: window.currentOriginalFilePath || currentFilePath };
                    displayFileContent(fake, '');
                    
                    // å›¾ç‰‡åˆ‡æ¢æˆåŠŸåè‡ªåŠ¨ä¿å­˜æ–‡ä»¶
                    autoSaveMarkdown().then(saved => {
                        if (saved) {
                            console.log('å›¾ç‰‡åˆ‡æ¢åå·²è‡ªåŠ¨ä¿å­˜markdownæ–‡ä»¶');
                        }
                    }).catch(e => {
                        console.warn('è‡ªåŠ¨ä¿å­˜æ—¶å‡ºé”™:', e);
                    });
                });
            } catch (e) {
                console.warn('prev image failed:', e);
            }
        }

        function removeWebSearchImage(btnEl) {
            try {
                if (!window.currentMarkdownContent || !window.currentMarkdownContent.processed) return;
                const mdText = window.currentMarkdownContent.processed;
                const href = btnEl?.getAttribute('data-md-href');
                const occStr = btnEl?.getAttribute('data-md-occurrence') || '0';
                const occIndex = parseInt(occStr, 10) || 0;
                if (!href) return;

                // ç²¾ç¡®åˆ é™¤ç¬¬ occIndex æ¬¡å‡ºç°çš„è¯¥å›¾ç‰‡è¯­æ³•ï¼š
                // å…¼å®¹ä¸¤ç§å†™æ³•ï¼š
                // 1) Markdown: ![alt](href "title") æˆ– ![alt](href)
                // 2) HTML: <img ... src="href" ...>

                // ä¼˜å…ˆå¤„ç† Markdown è¯­æ³•
                let count = 0;
                // åŒ¹é… ![...](...) ä¸­ href çš„ä½ç½®ï¼ˆç®€åŒ–å¤„ç†ï¼šåŒ¹é…æ‹¬å·å†…æ•´ä½“å†å†³å®šæ˜¯å¦æ›¿æ¢ï¼‰
                const mdPattern = /!\[[^\]]*\]\(([^)]+)\)/g;
                let replaced = mdText.replace(mdPattern, (full, inner) => {
                    // inner å¯èƒ½åŒ…å« href ä¸ titleï¼Œå¦‚: href "title"
                    // æˆ‘ä»¬æå–ç¬¬ä¸€ä¸ªç©ºç™½å‰çš„éƒ¨åˆ†ä½œä¸º url
                    const url = inner.split(/\s+/)[0].trim();
                    const cur = count;
                    if (url === href) {
                        count += 1;
                        if (cur === occIndex) {
                            return '';
                        }
                    }
                    return full;
                });

                if (count === 0 || (count <= occIndex)) {
                    // å¯èƒ½æ˜¯ HTML <img> å†™æ³•ï¼Œæ‰§è¡Œç¬¬äºŒè½®æ›¿æ¢
                    let htmlCount = 0;
                    const imgPattern = /<img([^>]*)\ssrc=["']([^"']+)["']([^>]*)>/g;
                    replaced = replaced.replace(imgPattern, (full, beforeSrc, src, afterSrc) => {
                        const cur = htmlCount;
                        if (src === href) {
                            htmlCount += 1;
                            if (cur === occIndex) {
                                return '';
                            }
                        }
                        return full;
                    });
                }

                window.currentMarkdownContent.processed = replaced;
                const fake = { content: replaced, type: 'markdown', size: 'N/A', file_path: window.currentOriginalFilePath || currentFilePath };
                displayFileContent(fake, '');
                
                // å›¾ç‰‡åˆ é™¤æˆåŠŸåè‡ªåŠ¨ä¿å­˜æ–‡ä»¶
                autoSaveMarkdown().then(saved => {
                    if (saved) {
                        console.log('å›¾ç‰‡åˆ é™¤åå·²è‡ªåŠ¨ä¿å­˜markdownæ–‡ä»¶');
                    }
                }).catch(e => {
                    console.warn('è‡ªåŠ¨ä¿å­˜æ—¶å‡ºé”™:', e);
                });
            } catch (e) {
                console.warn('remove image failed:', e);
            }
        }

        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        async function saveCurrentMarkdown() {
            try {
                // æ£€æŸ¥guestç”¨æˆ·æƒé™
                if (isGuest) {
                    alert('guestç”¨æˆ·ä¸ºæ¼”ç¤ºè´¦æˆ·ï¼Œæ— æ³•ä¿å­˜ã€‚');
                    return;
                }
                
                // ä¼˜å…ˆä»ç¼–è¾‘å™¨è·å–å†…å®¹
                const editor = document.getElementById('markdownEditor');
                let contentToSave;
                if (editor && editor.parentElement.style.display !== 'none') {
                    contentToSave = editor.value;
                    // æ›´æ–°å½“å‰å†…å®¹
                    if (window.currentMarkdownContent) {
                        window.currentMarkdownContent.processed = contentToSave;
                    }
                } else if (window.currentMarkdownContent && window.currentMarkdownContent.processed) {
                    contentToSave = window.currentMarkdownContent.processed;
                } else {
                    alert('æœªæ£€æµ‹åˆ°å¯ä¿å­˜çš„Markdownå†…å®¹');
                    return;
                }
                
                if (!window.currentOriginalFilePath && !currentFilePath) {
                    alert('æ— æ³•ç¡®å®šå½“å‰Markdownæ–‡ä»¶è·¯å¾„');
                    return;
                }
                const headers = { 'Content-Type': 'application/json' };
                const body = {
                    path: window.currentOriginalFilePath || currentFilePath,
                    content: contentToSave
                };
                if (currentUser && currentUser !== 'default') {
                    headers['X-API-Key'] = currentUser;
                    body.api_key = currentUser;
                }
                const resp = await fetch('/api/save-markdown', { method: 'POST', headers, body: JSON.stringify(body) });
                const data = await resp.json();
                if (data && data.success) {
                    addMessage('Markdownå·²ä¿å­˜', 'success');
                } else {
                    addMessage(`ä¿å­˜å¤±è´¥: ${data && data.error ? data.error : 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (e) {
                console.error('ä¿å­˜Markdownå¤±è´¥:', e);
                addMessage('ä¿å­˜å¤±è´¥: ç½‘ç»œæˆ–æœåŠ¡å™¨é”™è¯¯', 'error');
            }
        }

        // æ›´æ–°Markdowné¢„è§ˆå†…å®¹
        async function updateMarkdownPreview(markdownContent) {
            try {
                const headers = { 'Content-Type': 'application/json' };
                const body = { content: markdownContent };
                if (currentUser && currentUser !== 'default') {
                    headers['X-API-Key'] = currentUser;
                    body.api_key = currentUser;
                }
                
                const response = await fetch('/api/render-markdown', { 
                    method: 'POST', 
                    headers, 
                    body: JSON.stringify(body) 
                });
                const data = await response.json();
                
                if (data && data.html) {
                    const previewDiv = document.getElementById('markdownPreview');
                    if (previewDiv) {
                        previewDiv.innerHTML = data.html;
                        
                        // é‡æ–°è§¦å‘æ¸²æŸ“
                        setTimeout(() => {
                            // è§¦å‘Prism.jsè¯­æ³•é«˜äº®
                            if (typeof Prism !== 'undefined') {
                                Prism.highlightAll();
                            }
                            
                            // è§¦å‘æ•°å­¦å…¬å¼æ¸²æŸ“
                            renderMath(previewDiv);
                        }, 50);
                    }
                }
            } catch (e) {
                console.error('æ›´æ–°é¢„è§ˆå¤±è´¥:', e);
            }
        }

        // è‡ªåŠ¨ä¿å­˜Markdownå†…å®¹ï¼ˆé™é»˜ä¿å­˜ï¼Œç”¨äºå›¾ç‰‡åˆ‡æ¢åï¼‰
        async function autoSaveMarkdown() {
            try {
                // æ£€æŸ¥guestç”¨æˆ·æƒé™ - guestç”¨æˆ·è·³è¿‡ä¿å­˜
                if (isGuest) {
                    console.log('Guestç”¨æˆ·è·³è¿‡è‡ªåŠ¨ä¿å­˜');
                    return false;
                }
                
                // æ£€æŸ¥æ˜¯å¦æœ‰å¯ä¿å­˜çš„å†…å®¹
                if (!window.currentMarkdownContent || !window.currentMarkdownContent.processed) {
                    console.log('æ— Markdownå†…å®¹å¯è‡ªåŠ¨ä¿å­˜');
                    return false;
                }
                if (!window.currentOriginalFilePath && !currentFilePath) {
                    console.log('æ— æ³•ç¡®å®šMarkdownæ–‡ä»¶è·¯å¾„ï¼Œè·³è¿‡è‡ªåŠ¨ä¿å­˜');
                    return false;
                }

                const headers = { 'Content-Type': 'application/json' };
                const body = {
                    path: window.currentOriginalFilePath || currentFilePath,
                    content: window.currentMarkdownContent.processed
                };
                if (currentUser && currentUser !== 'default') {
                    headers['X-API-Key'] = currentUser;
                    body.api_key = currentUser;
                }
                
                const resp = await fetch('/api/save-markdown', { method: 'POST', headers, body: JSON.stringify(body) });
                const data = await resp.json();
                
                if (data && data.success) {
                    console.log('Markdownå·²è‡ªåŠ¨ä¿å­˜');
                    return true;
                } else {
                    console.warn('è‡ªåŠ¨ä¿å­˜å¤±è´¥:', data && data.error ? data.error : 'æœªçŸ¥é”™è¯¯');
                    return false;
                }
            } catch (e) {
                console.error('è‡ªåŠ¨ä¿å­˜Markdownå¤±è´¥:', e);
                return false;
            }
        }

        // Mermaidç¼–è¾‘ç›¸å…³å‡½æ•°
        // ç®€åŒ–çš„å‡½æ•°ï¼Œä¸å†éœ€è¦ç¼–è¾‘æ¨¡å¼åˆ‡æ¢
        function updateMermaidContent() {
            const editor = document.getElementById('mermaid-editor');
            if (editor) {
                window.currentMermaidContent = editor.value;
            }
        }

        async function saveMermaidFile() {
            try {
                if (isGuest) {
                    alert('guestç”¨æˆ·ä¸ºæ¼”ç¤ºè´¦æˆ·ï¼Œæ— æ³•ä¿å­˜ã€‚');
                    return;
                }
                
                // ä»ç¼–è¾‘å™¨è·å–å†…å®¹
                const editor = document.getElementById('mermaid-editor');
                if (!editor) {
                    alert('æœªæ‰¾åˆ°Mermaidç¼–è¾‘å™¨');
                    return;
                }
                
                const contentToSave = editor.value;
                // æ›´æ–°å½“å‰å†…å®¹
                window.currentMermaidContent = contentToSave;
                
                if (!window.currentFilePath) {
                    alert('æ— æ³•ç¡®å®šå½“å‰Mermaidæ–‡ä»¶è·¯å¾„');
                    return;
                }
                
                const headers = { 'Content-Type': 'application/json' };
                const body = {
                    path: window.currentFilePath,
                    content: contentToSave
                };
                if (currentUser && currentUser !== 'default') {
                    headers['X-API-Key'] = currentUser;
                    body.api_key = currentUser;
                }
                
                const resp = await fetch('/api/save-markdown', { 
                    method: 'POST', 
                    headers, 
                    body: JSON.stringify(body) 
                });
                const data = await resp.json();
                
                if (data && data.success) {
                    addMessage('Mermaidæ–‡ä»¶å·²ä¿å­˜', 'success');
                } else {
                    addMessage(`ä¿å­˜å¤±è´¥: ${data && data.error ? data.error : 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (e) {
                console.error('ä¿å­˜Mermaidå¤±è´¥:', e);
                addMessage('ä¿å­˜å¤±è´¥: ç½‘ç»œæˆ–æœåŠ¡å™¨é”™è¯¯', 'error');
            }
        }

        async function reloadCurrentMarkdown() {
            try {
                const path = window.currentOriginalFilePath || currentFilePath;
                if (!path) {
                    alert('æ— æ³•ç¡®å®šå½“å‰Markdownæ–‡ä»¶è·¯å¾„');
                    return;
                }
                const apiKeyParam = (currentUser && currentUser !== 'default') ? `?api_key=${currentUser}` : '';
                const resp = await fetch(`/api/file/${encodeURIComponent(path)}${apiKeyParam}`);
                const data = await resp.json();
                if (!data || !data.success) {
                    addMessage(`é‡æ–°åŠ è½½å¤±è´¥: ${data && data.error ? data.error : 'æœªçŸ¥é”™è¯¯'}`, 'error');
                    return;
                }
                // ç›´æ¥èµ°ç°æœ‰æ¸²æŸ“è·¯å¾„
                displayFileContent(data, '');
                addMessage('å·²ä»æ–‡ä»¶é‡æ–°åŠ è½½', 'success');
            } catch (e) {
                console.error('é‡æ–°åŠ è½½å¤±è´¥:', e);
                addMessage('é‡æ–°åŠ è½½å¤±è´¥: ç½‘ç»œæˆ–æœåŠ¡å™¨é”™è¯¯', 'error');
            }
        }

        function renderAllPDFPages() {
            if (!window.currentPDF) return;
            
            const pagesContainer = document.getElementById('pdfPages');
            pagesContainer.innerHTML = '<div style="text-align: center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> æ­£åœ¨åŠ è½½æ‰€æœ‰é¡µé¢...</div>';
            
            const scale = 2.5;
            const promises = [];
            
            // ä¸ºæ¯ä¸€é¡µåˆ›å»ºæ¸²æŸ“ä»»åŠ¡
            for (let pageNum = 1; pageNum <= window.currentPDF.numPages; pageNum++) {
                promises.push(
                    window.currentPDF.getPage(pageNum).then(function(page) {
                        const viewport = page.getViewport({ scale: scale });
                        
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;
                        canvas.style.cssText = 'width: 95%; height: auto; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 20px;';
                        
                        const renderContext = {
                            canvasContext: context,
                            viewport: viewport
                        };
                        
                        // å¤„ç†page.render()å¯èƒ½è¿”å›Promiseæˆ–ç›´æ¥æ¸²æŸ“çš„æƒ…å†µ
                        const renderResult = page.render(renderContext);
                        if (renderResult && typeof renderResult.then === 'function') {
                            // å¦‚æœè¿”å›Promiseï¼Œç­‰å¾…å®Œæˆ
                            return renderResult.then(() => {
                                return { canvas, pageNum };
                            });
                        } else {
                            // å¦‚æœç›´æ¥æ¸²æŸ“ï¼Œç«‹å³è¿”å›ç»“æœ
                            return Promise.resolve({ canvas, pageNum });
                        }
                    })
                );
            }
            
            // ç­‰å¾…æ‰€æœ‰é¡µé¢æ¸²æŸ“å®Œæˆ
            Promise.all(promises).then(function(results) {
                pagesContainer.innerHTML = '';
                
                // æŒ‰é¡µç é¡ºåºæ·»åŠ æ‰€æœ‰é¡µé¢
                results.forEach(function(result) {
                    const pageDiv = document.createElement('div');
                    pageDiv.style.cssText = 'margin-bottom: 20px; text-align: center; background: #f5f5f5; padding: 10px; width: 100%;';
                    
                    pageDiv.appendChild(result.canvas);
                    pagesContainer.appendChild(pageDiv);
                });
                
                // æ›´æ–°é¡µé¢ä¿¡æ¯
                document.getElementById('pageInfo').textContent = `å…± ${window.currentPDF.numPages} é¡µ`;
            }).catch(function(error) {
                console.error('PDFé¡µé¢æ¸²æŸ“å¤±è´¥:', error);
                pagesContainer.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: red;">
                        <i class="fas fa-exclamation-triangle"></i> PDFé¡µé¢æ¸²æŸ“å¤±è´¥: ${error.message}
                    </div>
                `;
            });
        }

        // Officeæ–‡æ¡£é¢„è§ˆå‡½æ•° - äº‘å­˜å‚¨é¢„è§ˆåŠŸèƒ½å·²ç§»é™¤ï¼Œä»…æ”¯æŒä¸‹è½½
        function previewOfficeCloud(filePath) {
            const container = document.getElementById('officeContainer');
            
            // ä½¿ç”¨åŸå§‹è·¯å¾„ç”¨äºä¸‹è½½ï¼ˆåç«¯ä¼šè‡ªåŠ¨æ·»åŠ ç”¨æˆ·ç›®å½•å‰ç¼€ï¼‰
            const downloadFilePath = window.currentOriginalFilePath || filePath;
            
            // æ˜¾ç¤ºä¸æ”¯æŒåœ¨çº¿é¢„è§ˆçš„æç¤º
            container.innerHTML = `
                <div style="background: #ffc107; color: #856404; padding: 10px; text-align: center; position: sticky; top: 0; z-index: 10;">
                    <span>Officeæ–‡æ¡£é¢„è§ˆ</span>
                    <button onclick="resetOfficePreview()" style="float: right; padding: 5px 10px; background: rgba(0,0,0,0.1); color: #856404; border: none; border-radius: 3px; cursor: pointer;">è¿”å›</button>
                </div>
                <div style="text-align: center; padding: 40px; color: #666;">
                    <div style="margin-bottom: 20px;">
                        <i class="fas fa-info-circle" style="font-size: 48px; color: #ffc107;"></i>
                    </div>
                    <h3 style="margin-bottom: 20px; color: #856404;">åœ¨çº¿é¢„è§ˆåŠŸèƒ½å·²ç¦ç”¨</h3>
                    <p style="margin-bottom: 20px; color: #666;">ä¸ºäº†æ”¯æŒç¦»çº¿éƒ¨ç½²ï¼Œäº‘å­˜å‚¨é¢„è§ˆåŠŸèƒ½å·²è¢«ç§»é™¤ã€‚è¯·ä¸‹è½½æ–‡ä»¶åˆ°æœ¬åœ°æŸ¥çœ‹ã€‚</p>
                    <div class="preview-button-group" style="display: flex; justify-content: center; gap: 15px;">
                        <a href="/api/download-file/${downloadFilePath}${(currentUser && currentUser !== 'default') ? '?api_key=' + currentUser : ''}" download style="padding: 12px 24px; background: #007acc; color: white; text-decoration: none; border-radius: 5px; font-size: 21px; display: inline-block;">
                            <i class="fas fa-download"></i> ä¸‹è½½æ–‡ä»¶
                        </a>
                    </div>
                </div>
            `;
        }

        // é‡ç½®Officeé¢„è§ˆç•Œé¢
        function resetOfficePreview() {
            const container = document.getElementById('officeContainer');
            if (container) {
                // ä½¿ç”¨åŸå§‹è·¯å¾„ç”¨äºä¸‹è½½ï¼ˆåç«¯ä¼šè‡ªåŠ¨æ·»åŠ ç”¨æˆ·ç›®å½•å‰ç¼€ï¼‰
                const downloadFilePath = window.currentOriginalFilePath || currentFilePath;
                
                // é‡æ–°æ˜¾ç¤ºé€‰æ‹©ç•Œé¢
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-file-alt" style="font-size: 48px; margin-bottom: 20px; color: #007acc;"></i>
                        <h3 style="margin-bottom: 20px;">Officeæ–‡æ¡£é¢„è§ˆ</h3>
                        <p style="margin-bottom: 20px;">é€‰æ‹©ä»¥ä¸‹æ–¹å¼é¢„è§ˆOfficeæ–‡æ¡£ï¼š</p>
                        <div style="display: flex; flex-direction: column; gap: 15px; align-items: center;">
                            <button onclick="previewOfficeCloud('${downloadFilePath}')" style="padding: 12px 24px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 21px; min-width: 200px;" disabled>
                                <i class="fas fa-ban"></i> åœ¨çº¿é¢„è§ˆå·²ç¦ç”¨
                            </button>
                            <a href="/api/download-file/${downloadFilePath}${(currentUser && currentUser !== 'default') ? '?api_key=' + currentUser : ''}" download style="padding: 12px 24px; background: #6c757d; color: white; text-decoration: none; border-radius: 5px; font-size: 21px; min-width: 200px; text-align: center; display: inline-block;">
                                <i class="fas fa-download"></i> ä¸‹è½½æ–‡ä»¶
                            </a>
                        </div>
                    </div>
                `;
            }
        }

        // Mermaidç›¸å…³å‡½æ•°
        let mermaidShowingChart = false;
        
        function toggleMermaidView() {
            const sourceView = document.getElementById('mermaid-source-view');
            const chartView = document.getElementById('mermaid-chart-view');
            const btnText = document.getElementById('mermaid-view-btn-text');
            
            if (!mermaidShowingChart) {
                // æ›´æ–°å½“å‰å†…å®¹
                updateMermaidContent();
                
                // åˆ‡æ¢åˆ°å›¾è¡¨è§†å›¾
                sourceView.style.display = 'none';
                chartView.style.display = 'block';
                btnText.textContent = 'æ˜¾ç¤ºæºç ';
                mermaidShowingChart = true;
                
                // æ¸²æŸ“mermaidå›¾è¡¨
                renderMermaidChart();
            } else {
                // åˆ‡æ¢åˆ°æºç è§†å›¾
                sourceView.style.display = 'block';
                chartView.style.display = 'none';
                btnText.textContent = 'æ˜¾ç¤ºå›¾è¡¨';
                mermaidShowingChart = false;
            }
        }
        
        function renderMermaidChart() {
            const container = document.getElementById('mermaid-chart-container');
            if (!container || !window.currentMermaidContent) return;
            
            // ç¡®ä¿mermaidåº“å·²åŠ è½½
            if (typeof mermaid === 'undefined') {
                // åŠ¨æ€åŠ è½½mermaidåº“
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/mermaid@10/dist/mermaid.min.js';
                script.onload = function() {
                    mermaid.initialize({ 
                        startOnLoad: false,
                        theme: 'default',
                        fontFamily: 'Microsoft YaHei, SimHei, SimSun, Arial, sans-serif'
                    });
                    doRenderMermaidChart();
                };
                script.onerror = function() {
                    container.innerHTML = '<div style="color: red; padding: 20px;"><i class="fas fa-exclamation-triangle"></i><br/>Mermaidåº“åŠ è½½å¤±è´¥ï¼Œæ— æ³•æ¸²æŸ“å›¾è¡¨</div>';
                };
                document.head.appendChild(script);
            } else {
                doRenderMermaidChart();
            }
        }
        
        function doRenderMermaidChart() {
            const container = document.getElementById('mermaid-chart-container');
            if (!container || !window.currentMermaidContent) return;
            
            try {
                // æ¸…ç©ºå®¹å™¨
                container.innerHTML = '';
                
                // åˆ›å»ºmermaid div
                const mermaidDiv = document.createElement('div');
                mermaidDiv.className = 'mermaid';
                mermaidDiv.textContent = window.currentMermaidContent;
                container.appendChild(mermaidDiv);
                
                // æ¸²æŸ“å›¾è¡¨
                mermaid.init(undefined, mermaidDiv);
            } catch (error) {
                console.error('Mermaidæ¸²æŸ“é”™è¯¯:', error);
                container.innerHTML = '<div style="color: red; padding: 20px;"><i class="fas fa-exclamation-triangle"></i><br/>å›¾è¡¨æ¸²æŸ“å¤±è´¥: ' + error.message + '</div>';
            }
        }
        
        function convertMermaidToImages() {
            // æ£€æŸ¥guestç”¨æˆ·æƒé™
            if (isGuest) {
                alert('guestç”¨æˆ·ä¸ºæ¼”ç¤ºè´¦æˆ·ï¼Œæ— æ³•è½¬æ¢å›¾è¡¨ã€‚');
                return;
            }
            
            if (!window.currentMermaidContent) {
                alert('æ²¡æœ‰æ‰¾åˆ°Mermaidå†…å®¹');
                return;
            }
            
            // è·å–å½“å‰æ–‡ä»¶è·¯å¾„
            const filePath = window.currentFilePath || '';
            if (!filePath) {
                alert('æ— æ³•è·å–æ–‡ä»¶è·¯å¾„');
                return;
            }
            
            // æ˜¾ç¤ºloadingçŠ¶æ€
            const convertBtn = event.target;
            const originalText = convertBtn.innerHTML;
            convertBtn.disabled = true;
            convertBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> è½¬æ¢ä¸­...';
            
            // å‘é€è½¬æ¢è¯·æ±‚åˆ°åç«¯
            const headers = {
                'Content-Type': 'application/json'
            };
            
            if (currentUser && currentUser !== 'default') {
                headers['X-API-Key'] = currentUser;
            }
            
            fetch('/api/convert-mermaid-to-images', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({
                    file_path: filePath,
                    mermaid_content: window.currentMermaidContent
                })
            })
            .then(response => response.json())
            .then(data => {
                convertBtn.disabled = false;
                convertBtn.innerHTML = originalText;
                
                if (data.success) {
                    let message = 'âœ… Mermaidå›¾è¡¨è½¬æ¢æˆåŠŸï¼\n\n';
                    if (data.svg_path) {
                        message += `SVGæ–‡ä»¶: ${data.svg_path}\n`;
                    }
                    if (data.png_path) {
                        message += `PNGæ–‡ä»¶: ${data.png_path}\n`;
                    }
                    if (data.message) {
                        message += `\n${data.message}`;
                    }
                    alert(message);
                } else {
                    alert('âŒ è½¬æ¢å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            })
            .catch(error => {
                convertBtn.disabled = false;
                convertBtn.innerHTML = originalText;
                console.error('è½¬æ¢è¯·æ±‚å¤±è´¥:', error);
                alert('âŒ è½¬æ¢è¯·æ±‚å¤±è´¥: ' + error.message);
            });
        }

        // å­˜å‚¨å½“å‰æ–‡ä»¶è·¯å¾„ï¼Œç”¨äºè¿”å›æ—¶é‡æ–°æ„å»ºç•Œé¢
        let currentFilePath = '';

        // ç”¨æˆ·ç›®å½•åç§°ï¼ˆä»åç«¯å·²çŸ¥ï¼‰
        const KNOWN_USER_DIRECTORY = 'user_77e6f2deceb7dbf1';

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // å¤„ç†æ–‡ä»¶å†…å®¹ä¸­çš„è½¬ä¹‰å­—ç¬¦
        function processFileContent(content) {
            return content
                .replace(/\\n/g, '\n')      // æ¢è¡Œç¬¦
                .replace(/\\t/g, '\t')      // åˆ¶è¡¨ç¬¦
                .replace(/\\r/g, '\r')      // å›è½¦ç¬¦
                .replace(/\\\\/g, '\\');    // åæ–œæ 
        }

        // å…³é—­é¢„è§ˆæ¨¡æ€æ¡†
        previewClose.onclick = function() {
            previewModal.style.display = 'none';
        }

        // é‡å‘½ååŠŸèƒ½
        const renameModal = document.getElementById('renameModal');
        const renameClose = document.getElementById('renameClose');
        const currentDirName = document.getElementById('currentDirName');
        const newDirName = document.getElementById('newDirName');
        const renameConfirm = document.getElementById('renameConfirm');
        const renameCancel = document.getElementById('renameCancel');
        
        let currentRenamingDir = null;

        function showRenameDialog(dirName) {
            currentRenamingDir = dirName;
            currentDirName.textContent = dirName;
            newDirName.value = dirName; // ç›´æ¥ä½¿ç”¨åŸåç§°ï¼Œä¸åšä»»ä½•å¤„ç†
            newDirName.focus();
            newDirName.select();
            renameModal.style.display = 'block';
        }

        function hideRenameDialog() {
            renameModal.style.display = 'none';
            currentRenamingDir = null;
            newDirName.value = '';
        }

        function performRename() {
            if (!currentRenamingDir) return;
            
            // æ£€æŸ¥guestç”¨æˆ·æƒé™
            if (isGuest) {
                alert('guestç”¨æˆ·ä¸ºæ¼”ç¤ºè´¦æˆ·ï¼Œæ— æ³•é‡å‘½åç›®å½•ã€‚');
                return;
            }
            
            const newName = newDirName.value.trim();
            if (!newName) {
                alert('è¯·è¾“å…¥æ–°çš„ç›®å½•åç§°');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            renameConfirm.disabled = true;
            renameConfirm.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${I18N.renaming}`;
            
            const headers = {
                'Content-Type': 'application/json'
            };
            
            const body = {
                new_name: newName
            };
            
            if (currentUser && currentUser !== 'default') {
                headers['X-API-Key'] = currentUser;
                body.api_key = currentUser;
            }
            
            fetch(`/api/rename-directory/${encodeURIComponent(currentRenamingDir)}`, {
                method: 'PUT',
                headers: headers,
                body: JSON.stringify(body)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addMessage(data.message, 'success');
                    
                    // æ›´æ–°å‰ç«¯çŠ¶æ€
                    if (selectedDirectory === currentRenamingDir) {
                        selectedDirectory = data.new_name;
                        updateTaskModeInfo();
                    }
                    
                    // åˆ·æ–°ç›®å½•åˆ—è¡¨
                    refreshDirectories();
                    hideRenameDialog();
                } else {
                    addMessage(`${I18N.rename_failed}: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('âŒ Rename error:', error);
                addMessage(`${I18N.rename_error}: ${error.message}`, 'error');
            })
            .finally(() => {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                renameConfirm.disabled = false;
                renameConfirm.innerHTML = `<i class="fas fa-check"></i> ${I18N.confirm_rename}`;
            });
        }

        // é‡å‘½åäº‹ä»¶ç›‘å¬
        renameConfirm.onclick = performRename;
        renameCancel.onclick = hideRenameDialog;
        renameClose.onclick = hideRenameDialog;

        newDirName.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                performRename();
            } else if (e.key === 'Escape') {
                e.preventDefault();
                hideRenameDialog();
            }
        });

        window.onclick = function(event) {
            if (event.target === previewModal) {
                previewModal.style.display = 'none';
            }
            if (event.target === uploadModal) {
                uploadModal.style.display = 'none';
            }

            if (event.target === renameModal) {
                hideRenameDialog();
            }
        }

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(e) {
            // Ctrl+R æˆ– F5 åˆ·æ–°ç›®å½•
            if ((e.ctrlKey && e.key === 'r') || e.key === 'F5') {
                e.preventDefault();
                manualRefresh();
            }
            
            // Esc é”®å…³é—­é¢„è§ˆæ¨¡æ€æ¡†
            if (e.key === 'Escape' && previewModal.style.display === 'block') {
                previewModal.style.display = 'none';
            }
            
            // End é”®æ»šåŠ¨åˆ°åº•éƒ¨
            if (e.key === 'End' && e.target === chatMessages) {
                e.preventDefault();
                scrollToBottom(true);
            }
            
            // Ctrl+End å¼ºåˆ¶æ»šåŠ¨åˆ°åº•éƒ¨å¹¶å¯ç”¨è‡ªåŠ¨æ»šåŠ¨
            if (e.ctrlKey && e.key === 'End') {
                e.preventDefault();
                scrollToBottom(true);
            }
        });

        /**
         * é¡µé¢åˆå§‹åŒ–å‡½æ•°
         * @description é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œçš„åˆå§‹åŒ–æ“ä½œï¼š
         * - åˆå§‹åŒ–ç”¨æˆ·ç•Œé¢çŠ¶æ€
         * - è®¾ç½®è¾“å…¥æ¡†ç„¦ç‚¹
         * - æ›´æ–°ä»»åŠ¡æ¨¡å¼ä¿¡æ¯
         * - åˆå§‹åŒ–åˆ†éš”æ¡æ‹–æ‹½åŠŸèƒ½
         * - å¯åŠ¨è‡ªåŠ¨åˆ·æ–°å®šæ—¶å™¨
         * - æ»šåŠ¨åˆ°èŠå¤©çª—å£åº•éƒ¨
         */
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–ç”¨æˆ·çŠ¶æ€
            updateUserStatus('disconnected', I18N.user_disconnected);
            enableUI(false);
            
            // æ£€æŸ¥URLå‚æ•°å¹¶è‡ªåŠ¨ç™»å½•ï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
            const urlAutoLogin = checkUrlAutoLogin();
            
            // å¦‚æœæ²¡æœ‰URLå‚æ•°ï¼Œæ£€æŸ¥localStorageä¸­çš„ä¿å­˜ä¼šè¯
            if (!urlAutoLogin) {
                const sessionRestored = checkSessionRestore();
                
                // åªæœ‰åœ¨æ²¡æœ‰è‡ªåŠ¨ç™»å½•å’Œä¼šè¯æ¢å¤æ—¶æ‰è®¾ç½®è¾“å…¥æ¡†ç„¦ç‚¹
                if (!sessionRestored && !isConnected) {
                    setTimeout(() => {
                        apiKeyInput.focus();
                    }, 100);
                }
            }
            
            updateTaskModeInfo();
            initResizer();
            
            // è®¾ç½®GUIé…ç½®é€‰é¡¹çš„é»˜è®¤å€¼
            document.getElementById('enableWebSearch').checked = true;       // æœç´¢ç½‘ç»œé»˜è®¤é€‰æ‹©
            document.getElementById('enableKnowledgeBase').checked = true;   // æœç´¢çŸ¥è¯†åº“é»˜è®¤é€‰æ‹©
            
            document.getElementById('enableMultiAgent').checked = false;     // å¯åŠ¨å¤šæ™ºèƒ½ä½“é»˜è®¤ä¸é€‰æ‹©
            document.getElementById('enableLongTermMemory').checked = true;  // å¯åŠ¨é•¿æœŸè®°å¿†é»˜è®¤é€‰æ‹©
            document.getElementById('enableMCP').checked = false;            // å¯åŠ¨MCPé»˜è®¤ä¸é€‰æ‹©
            document.getElementById('enableJieba').checked = true;           // å¯ç”¨ä¸­æ–‡åˆ†è¯é»˜è®¤é€‰æ‹©
            
            // è‡ªåŠ¨ä»¥Guestèº«ä»½è¿æ¥ (ä¸´æ—¶ç¦ç”¨ç”¨äºè°ƒè¯•)
            console.log('ğŸ” Page loaded, auto-connect disabled for debugging');
            // connectUser();
            
            // åˆå§‹åŒ–é…ç½®é€‰é¡¹åˆ‡æ¢åŠŸèƒ½
            initConfigToggle();
            
            // åŠ è½½æ¨¡å‹é…ç½®é€‰é¡¹
            loadModelConfigs();
            
            // åˆå§‹åŒ–æ—¶æ»šåŠ¨åˆ°åº•éƒ¨ï¼ˆå»¶è¿Ÿ100msç¡®ä¿DOMæ¸²æŸ“å®Œæˆï¼‰
            setTimeout(() => {
                scrollToBottom(false);
            }, 100);
        });

        /**
         * åˆå§‹åŒ–é…ç½®é€‰é¡¹åˆ‡æ¢åŠŸèƒ½
         */
        function initConfigToggle() {
            const toggleBtn = document.getElementById('configToggleBtn');
            const configContainer = document.getElementById('configContainer');
            const toggleIcon = document.getElementById('configToggleIcon');
            
            let isConfigVisible = false;
            
            toggleBtn.addEventListener('click', function() {
                isConfigVisible = !isConfigVisible;
                
                if (isConfigVisible) {
                    configContainer.style.display = 'block';
                    toggleBtn.style.backgroundColor = '#569cd6';
                    toggleBtn.title = I18N.hide_config_options || 'éšè—é…ç½®é€‰é¡¹';
                    toggleIcon.style.transform = 'rotate(180deg)';
                } else {
                    configContainer.style.display = 'none';
                    toggleBtn.style.backgroundColor = '#3e3e42';
                    toggleBtn.title = I18N.show_config_options || 'æ˜¾ç¤ºé…ç½®é€‰é¡¹';
                    toggleIcon.style.transform = 'rotate(0deg)';
                }
            });
            
            // è®¾ç½®å›¾æ ‡è¿‡æ¸¡æ•ˆæœ
            toggleIcon.style.transition = 'transform 0.3s ease';
            
            // åŠ è½½routineæ–‡ä»¶åˆ—è¡¨
            loadRoutineFiles();
        }

        /**
         * åŠ è½½routineæ–‡ä»¶åˆ—è¡¨
         */
        function loadRoutineFiles() {
            fetch('/api/routine-files')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const routineSelect = document.getElementById('routineSelect');
                        // æ¸…é™¤ç°æœ‰é€‰é¡¹ï¼ˆé™¤äº†"æ— "é€‰é¡¹ï¼‰
                        routineSelect.innerHTML = '<option value="">' + (I18N.no_routine || 'æ— ') + '</option>';
                        
                        // æ·»åŠ routineæ–‡ä»¶é€‰é¡¹
                        data.files.forEach(file => {
                            const option = document.createElement('option');
                            option.value = file.filename;
                            option.textContent = file.name;
                            routineSelect.appendChild(option);
                        });
                    } else {
                        console.error('Failed to load routine files:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error loading routine files:', error);
                });
        }

        /**
         * åˆ‡æ¢Markdownæ˜¾ç¤ºæ¨¡å¼ï¼ˆé¢„è§ˆæ¨¡å¼ vs æºç æ¨¡å¼ï¼‰
         */
        function toggleMarkdownMode() {
            const previewDiv = document.getElementById('markdownPreview');
            const sourceDiv = document.getElementById('markdownSource');
            const toggleBtn = document.getElementById('markdownToggleBtn');
            const editor = document.getElementById('markdownEditor');
            
            if (!previewDiv || !sourceDiv || !toggleBtn) {
                console.error('Markdown toggle elements not found');
                return;
            }
            
            const isPreviewMode = previewDiv.style.display !== 'none';
            
            if (isPreviewMode) {
                // åˆ‡æ¢åˆ°æºç ç¼–è¾‘æ¨¡å¼
                previewDiv.style.display = 'none';
                sourceDiv.style.display = 'block';
                toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i> é¢„è§ˆæ¨¡å¼';
                toggleBtn.title = 'åˆ‡æ¢åˆ°é¢„è§ˆæ¨¡å¼';
                // ä¿å­˜ç”¨æˆ·åå¥½
                localStorage.setItem('markdownDisplayMode', 'source');
                
                // èšç„¦åˆ°ç¼–è¾‘å™¨
                if (editor) {
                    setTimeout(() => editor.focus(), 100);
                }
            } else {
                // ä»ç¼–è¾‘æ¨¡å¼åˆ‡æ¢åˆ°é¢„è§ˆæ¨¡å¼ï¼Œéœ€è¦æ›´æ–°å†…å®¹
                if (editor && window.currentMarkdownContent) {
                    const editedContent = editor.value;
                    // æ›´æ–°å½“å‰å†…å®¹
                    window.currentMarkdownContent.processed = editedContent;
                    
                    // é‡æ–°æ¸²æŸ“HTML
                    updateMarkdownPreview(editedContent);
                }
                
                previewDiv.style.display = 'block';
                sourceDiv.style.display = 'none';
                toggleBtn.innerHTML = '<i class="fas fa-eye"></i> æºç æ¨¡å¼';
                toggleBtn.title = 'åˆ‡æ¢åˆ°æºç æ¨¡å¼';
                // ä¿å­˜ç”¨æˆ·åå¥½
                localStorage.setItem('markdownDisplayMode', 'preview');
            }
        }

        /**
         * è½¬æ¢Markdownæ–‡ä»¶ä¸ºWordæ–‡æ¡£
         */
        function convertMarkdownToWord() {
            // æ£€æŸ¥guestç”¨æˆ·æƒé™
            if (isGuest) {
                alert('guestç”¨æˆ·ä¸ºæ¼”ç¤ºè´¦æˆ·ï¼Œæ— æ³•è½¬æ¢æ–‡æ¡£ã€‚');
                return;
            }
            
            if (!currentFilePath) {
                alert('æ— æ³•è·å–å½“å‰æ–‡ä»¶è·¯å¾„');
                return;
            }
            
            const wordBtn = document.getElementById('convertWordBtn');
            if (wordBtn) {
                wordBtn.disabled = true;
                wordBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> è½¬æ¢ä¸­...';
            }
            
            const headers = {};
            if (currentUser && currentUser !== 'default') {
                headers['X-API-Key'] = currentUser;
            }
            
            fetch('/api/convert-markdown', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    ...headers
                },
                body: JSON.stringify({
                    file_path: currentFilePath,
                    format: 'word'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const wordConversion = data.conversions?.word;
                    if (wordConversion && wordConversion.status === 'success') {
                        // è½¬æ¢æˆåŠŸï¼Œè‡ªåŠ¨ä¸‹è½½æ–‡ä»¶
                        const fileName = wordConversion.file;
                        const downloadUrl = `/api/download-file/${fileName}${(currentUser && currentUser !== 'default') ? '?api_key=' + currentUser : ''}`;
                        
                        // åˆ›å»ºéšè—çš„ä¸‹è½½é“¾æ¥å¹¶è§¦å‘ä¸‹è½½
                        const downloadLink = document.createElement('a');
                        downloadLink.href = downloadUrl;
                        downloadLink.download = fileName.split('/').pop(); // è·å–æ–‡ä»¶å
                        downloadLink.style.display = 'none';
                        document.body.appendChild(downloadLink);
                        downloadLink.click();
                        document.body.removeChild(downloadLink);
                        
                        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                        addMessage(`âœ… Wordæ–‡æ¡£è½¬æ¢æˆåŠŸå¹¶å¼€å§‹ä¸‹è½½ï¼æ–‡ä»¶: ${fileName.split('/').pop()}, å¤§å°: ${wordConversion.size_kb}KB`, 'success');
                    } else {
                        alert(`âŒ Wordæ–‡æ¡£è½¬æ¢å¤±è´¥: ${wordConversion?.error || 'æœªçŸ¥é”™è¯¯'}`);
                    }
                } else {
                    alert(`âŒ è½¬æ¢å¤±è´¥: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('è½¬æ¢é”™è¯¯:', error);
                alert(`âŒ è½¬æ¢è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}`);
            })
            .finally(() => {
                if (wordBtn) {
                    wordBtn.disabled = false;
                    wordBtn.innerHTML = '<i class="fas fa-file-word"></i> Word';
                }
            });
        }

        /**
         * è½¬æ¢Markdownæ–‡ä»¶ä¸ºPDFæ–‡æ¡£
         */
        function convertMarkdownToPdf() {
            // æ£€æŸ¥guestç”¨æˆ·æƒé™
            if (isGuest) {
                alert('guestç”¨æˆ·ä¸ºæ¼”ç¤ºè´¦æˆ·ï¼Œæ— æ³•è½¬æ¢æ–‡æ¡£ã€‚');
                return;
            }
            
            if (!currentFilePath) {
                alert('æ— æ³•è·å–å½“å‰æ–‡ä»¶è·¯å¾„');
                return;
            }
            
            const pdfBtn = document.getElementById('convertPdfBtn');
            if (pdfBtn) {
                pdfBtn.disabled = true;
                pdfBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> è½¬æ¢ä¸­...';
            }
            
            const headers = {};
            if (currentUser && currentUser !== 'default') {
                headers['X-API-Key'] = currentUser;
            }
            
            fetch('/api/convert-markdown', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    ...headers
                },
                body: JSON.stringify({
                    file_path: currentFilePath,
                    format: 'pdf'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const pdfConversion = data.conversions?.pdf;
                    if (pdfConversion && pdfConversion.status === 'success') {
                        // è½¬æ¢æˆåŠŸï¼Œè‡ªåŠ¨ä¸‹è½½æ–‡ä»¶
                        const fileName = pdfConversion.file;
                        const downloadUrl = `/api/download-file/${fileName}${(currentUser && currentUser !== 'default') ? '?api_key=' + currentUser : ''}`;
                        
                        // åˆ›å»ºéšè—çš„ä¸‹è½½é“¾æ¥å¹¶è§¦å‘ä¸‹è½½
                        const downloadLink = document.createElement('a');
                        downloadLink.href = downloadUrl;
                        downloadLink.download = fileName.split('/').pop(); // è·å–æ–‡ä»¶å
                        downloadLink.style.display = 'none';
                        document.body.appendChild(downloadLink);
                        downloadLink.click();
                        document.body.removeChild(downloadLink);
                        
                        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                        addMessage(`âœ… PDFæ–‡æ¡£è½¬æ¢æˆåŠŸå¹¶å¼€å§‹ä¸‹è½½ï¼æ–‡ä»¶: ${fileName.split('/').pop()}, å¤§å°: ${pdfConversion.size_kb}KB`, 'success');
                    } else {
                        alert(`âŒ PDFæ–‡æ¡£è½¬æ¢å¤±è´¥: ${pdfConversion?.error || 'æœªçŸ¥é”™è¯¯'}`);
                    }
                } else {
                    alert(`âŒ è½¬æ¢å¤±è´¥: ${data.error}`);
                }
            })
            .catch(error => {
                console.error('è½¬æ¢é”™è¯¯:', error);
                alert(`âŒ è½¬æ¢è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}`);
            })
            .finally(() => {
                if (pdfBtn) {
                    pdfBtn.disabled = false;
                    pdfBtn.innerHTML = '<i class="fas fa-file-pdf"></i> PDF';
                }
            });
        }

        /**
         * åº”ç”¨ç”¨æˆ·ä¿å­˜çš„Markdownæ˜¾ç¤ºæ¨¡å¼åå¥½
         */
        function applyMarkdownModePreference() {
            const savedMode = localStorage.getItem('markdownDisplayMode');
            
            // é»˜è®¤ä¸ºé¢„è§ˆæ¨¡å¼ï¼Œå¦‚æœç”¨æˆ·ä¹‹å‰é€‰æ‹©äº†æºç æ¨¡å¼ï¼Œåˆ™åˆ‡æ¢åˆ°æºç æ¨¡å¼
            if (savedMode === 'source') {
                const previewDiv = document.getElementById('markdownPreview');
                const sourceDiv = document.getElementById('markdownSource');
                const toggleBtn = document.getElementById('markdownToggleBtn');
                
                if (previewDiv && sourceDiv && toggleBtn) {
                    previewDiv.style.display = 'none';
                    sourceDiv.style.display = 'block';
                    toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i> é¢„è§ˆæ¨¡å¼';
                    toggleBtn.title = 'åˆ‡æ¢åˆ°é¢„è§ˆæ¨¡å¼';
                }
            }
        }

        // åˆ†éš”æ¡æ‹–æ‹½åŠŸèƒ½
        function initResizer() {
            const resizer = document.getElementById('resizer');
            const sidebar = document.getElementById('sidebar');
            const container = document.querySelector('.container');
            let isResizing = false;
            let startX = 0;
            let startWidth = 0;

            resizer.addEventListener('mousedown', function(e) {
                e.preventDefault();
                isResizing = true;
                startX = e.clientX;
                startWidth = parseInt(document.defaultView.getComputedStyle(sidebar).width, 10);
                
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
                
                // æ·»åŠ è§†è§‰åé¦ˆ
                resizer.style.background = '#007acc';
            });

            function handleMouseMove(e) {
                if (!isResizing) return;
                e.preventDefault();
                
                const dx = startX - e.clientX; // å‘å·¦æ‹–æ‹½ä¸ºæ­£å€¼
                const newWidth = startWidth + dx;
                
                // é™åˆ¶ä¾§è¾¹æ å®½åº¦
                const minWidth = 250;
                const maxWidth = 600;
                const constrainedWidth = Math.max(minWidth, Math.min(maxWidth, newWidth));
                
                sidebar.style.width = constrainedWidth + 'px';
            }

            function handleMouseUp(e) {
                if (!isResizing) return;
                e.preventDefault();
                
                isResizing = false;
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
                
                // ç§»é™¤è§†è§‰åé¦ˆ
                resizer.style.background = '';
            }
        }

        // æ‰‹åŠ¨åˆ·æ–°ç›®å½• - ä¿æŒå±•å¼€çŠ¶æ€å’Œæ»šåŠ¨ä½ç½®
        function manualRefresh() {
            const refreshBtn = document.querySelector('.sidebar-header .action-btn');
            const icon = refreshBtn.querySelector('i');

            // æ·»åŠ æ—‹è½¬åŠ¨ç”»
            icon.classList.add('fa-spin');
            refreshBtn.disabled = true;

            // ä¿å­˜å½“å‰å±•å¼€çŠ¶æ€
            const currentExpanded = new Set(expandedDirectories);

            // ä¿å­˜å½“å‰æ»šåŠ¨ä½ç½®
            const currentScrollTop = directoryList.scrollTop;

            // ä¿å­˜æ‰€æœ‰å±•å¼€ç›®å½•çš„æ–‡ä»¶æ ‘æ»šåŠ¨ä½ç½®
            const fileTreeScrollPositions = {};
            currentExpanded.forEach(dirName => {
                const treeElement = document.getElementById(`tree-${dirName}`);
                if (treeElement) {
                    fileTreeScrollPositions[dirName] = treeElement.scrollTop;
                }
            });

            const headers = {
                'Content-Type': 'application/json'
            };

            const body = {};
            if (currentUser && currentUser !== 'default') {
                headers['X-API-Key'] = currentUser;
                body.api_key = currentUser;
            }

            fetch('/api/refresh-dirs', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(body)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // æ¢å¤å±•å¼€çŠ¶æ€
                    expandedDirectories = currentExpanded;
                    renderDirectories(data.directories);

                    // æ¢å¤æ»šåŠ¨ä½ç½®
                    setTimeout(() => {
                        directoryList.scrollTop = currentScrollTop;

                        // æ¢å¤æ¯ä¸ªå±•å¼€ç›®å½•çš„æ–‡ä»¶æ ‘æ»šåŠ¨ä½ç½®
                        Object.keys(fileTreeScrollPositions).forEach(dirName => {
                            const treeElement = document.getElementById(`tree-${dirName}`);
                            if (treeElement && fileTreeScrollPositions[dirName] !== undefined) {
                                treeElement.scrollTop = fileTreeScrollPositions[dirName];
                            }
                        });
                    }, 0);

                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯ï¼ˆæ›´ç®€æ´ï¼‰
                    console.log('Directory refreshed');
                } else {
                    addMessage(`${I18N.refresh_failed}: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                addMessage(`${I18N.refresh_failed}: ${error.message}`, 'error');
            })
            .finally(() => {
                // ç§»é™¤æ—‹è½¬åŠ¨ç”»
                icon.classList.remove('fa-spin');
                refreshBtn.disabled = false;
            });
        }

        // ä¸Šä¼ åŠŸèƒ½
        function showUploadModal(dirName) {
            currentUploadDir = dirName;
            uploadTitle.textContent = `${I18N.upload_to} ${dirName}${I18N.workspace}`;
            uploadResult.innerHTML = '';
            uploadProgress.style.display = 'none';
            progressFill.style.width = '0%';
            uploadModal.style.display = 'block';
        }

        // å…³é—­ä¸Šä¼ æ¨¡æ€æ¡†
        uploadClose.onclick = function() {
            uploadModal.style.display = 'none';
        }

        // æ–‡ä»¶é€‰æ‹©å¤„ç†
        fileInput.addEventListener('change', function(e) {
            if (e.target.files.length > 0) {
                uploadFiles(Array.from(e.target.files));
            }
        });

        // æ‹–æ‹½åŠŸèƒ½
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = Array.from(e.dataTransfer.files);
            if (files.length > 0) {
                uploadFiles(files);
            }
        });

        // ä¸Šä¼ æ–‡ä»¶å‡½æ•°
        function uploadFiles(files) {
            // æ£€æŸ¥guestç”¨æˆ·æƒé™
            if (isGuest) {
                uploadResult.innerHTML = `<div class="error">guestç”¨æˆ·ä¸ºæ¼”ç¤ºè´¦æˆ·ï¼Œæ— æ³•ä¸Šä¼ æ–‡ä»¶ã€‚</div>`;
                return;
            }
            
            if (!currentUploadDir) {
                uploadResult.innerHTML = `<div class="error">${I18N.select_directory_error}</div>`;
                return;
            }

            const formData = new FormData();
            files.forEach(file => {
                formData.append('files', file);
            });
            
            // Add API key to form data
            if (currentUser && currentUser !== 'default') {
                formData.append('api_key', currentUser);
            }

            // æ˜¾ç¤ºè¿›åº¦æ¡
            uploadProgress.style.display = 'block';
            uploadResult.innerHTML = '';
            progressText.textContent = I18N.uploading_files.replace('{0}', files.length);

            // åˆ›å»ºXMLHttpRequestä»¥æ”¯æŒè¿›åº¦ç›‘æ§
            const xhr = new XMLHttpRequest();
            
            xhr.upload.addEventListener('progress', function(e) {
                if (e.lengthComputable) {
                    const percentComplete = (e.loaded / e.total) * 100;
                    progressFill.style.width = percentComplete + '%';
                    if (percentComplete >= 100) {
                        progressText.textContent = I18N.upload_completed;
                    } else {
                        progressText.textContent = I18N.upload_progress.replace('{0}', Math.round(percentComplete));
                    }
                }
            });

            xhr.addEventListener('load', function() {
                if (xhr.status === 200) {
                    const response = JSON.parse(xhr.responseText);
                    if (response.success) {
                        // æ˜¾ç¤ºä¸Šä¼ å®Œæˆä¿¡æ¯
                        progressText.textContent = I18N.upload_completed;
                        uploadResult.innerHTML = `
                            <div class="success">
                                <i class="fas fa-check-circle"></i> ${response.message}
                                <br><small>æ–‡ä»¶: ${response.files.join(', ')}</small>
                            </div>
                        `;
                        
                        // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
                        fileInput.value = '';
                        
                        // 2ç§’åè‡ªåŠ¨å…³é—­å¯¹è¯æ¡†å¹¶åˆ·æ–°ç›®å½•
                        setTimeout(() => {
                            uploadModal.style.display = 'none';
                            uploadProgress.style.display = 'none';
                            uploadResult.innerHTML = '';
                            progressFill.style.width = '0%';
                            refreshDirectories();
                        }, 2000);
                    } else {
                        uploadProgress.style.display = 'none';
                        uploadResult.innerHTML = `<div class="error"><i class="fas fa-exclamation-triangle"></i> ${response.error}</div>`;
                    }
                } else {
                    uploadProgress.style.display = 'none';
                    uploadResult.innerHTML = `<div class="error"><i class="fas fa-exclamation-triangle"></i> ${I18N.upload_failed_http.replace('{0}', xhr.status)}</div>`;
                }
            });

            xhr.addEventListener('error', function() {
                uploadProgress.style.display = 'none';
                uploadResult.innerHTML = `<div class="error"><i class="fas fa-exclamation-triangle"></i> ${I18N.upload_network_error}</div>`;
            });

            xhr.open('POST', `/api/upload/${currentUploadDir}`);
            xhr.send(formData);
        }

        // CSVè¡¨æ ¼ç›¸å…³åŠŸèƒ½
        function sortCSVTable(columnIndex) {
            if (!window.csvData) return;
            
            const { headers, currentData, sortColumn, sortDirection } = window.csvData;
            
            // ç¡®å®šæ’åºæ–¹å‘
            let newDirection = 'asc';
            if (sortColumn === columnIndex) {
                newDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            }
            
            // æ’åºæ•°æ®
            const sortedData = [...currentData].sort((a, b) => {
                const aVal = (a[columnIndex] || '').toString().toLowerCase();
                const bVal = (b[columnIndex] || '').toString().toLowerCase();
                
                // å°è¯•æ•°å­—æ¯”è¾ƒ
                const aNum = parseFloat(aVal);
                const bNum = parseFloat(bVal);
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return newDirection === 'asc' ? aNum - bNum : bNum - aNum;
                }
                
                // å­—ç¬¦ä¸²æ¯”è¾ƒ
                if (newDirection === 'asc') {
                    return aVal.localeCompare(bVal);
                } else {
                    return bVal.localeCompare(aVal);
                }
            });
            
            // æ›´æ–°çŠ¶æ€
            window.csvData.currentData = sortedData;
            window.csvData.sortColumn = columnIndex;
            window.csvData.sortDirection = newDirection;
            
            // é‡æ–°æ¸²æŸ“è¡¨æ ¼
            renderCSVTableBody(sortedData);
            
            // æ›´æ–°è¡¨å¤´æ’åºæŒ‡ç¤ºå™¨
            updateSortIndicators(columnIndex, newDirection);
        }
        
        function updateSortIndicators(sortColumn, sortDirection) {
            const headers = document.querySelectorAll('#csvTable th');
            headers.forEach((th, index) => {
                const span = th.querySelector('span');
                if (span) {
                    if (index === sortColumn) {
                        span.textContent = sortDirection === 'asc' ? 'â†‘' : 'â†“';
                        span.style.color = '#007acc';
                    } else {
                        span.textContent = 'â‡…';
                        span.style.color = '#6c757d';
                    }
                }
            });
        }
        
        function renderCSVTableBody(data) {
            if (!window.csvData) return;
            
            const tbody = document.getElementById('csvTableBody');
            const { headers } = window.csvData;
            
            if (!tbody || !headers) return;
            
            let html = '';
            if (data && data.length > 0) {
                data.forEach((row, rowIndex) => {
                    const rowStyle = rowIndex % 2 === 0 ? 'background: #ffffff;' : 'background: #f8f9fa;';
                    html += `<tr style="${rowStyle}">`;
                    
                    const maxCols = Math.max(headers.length, row.length);
                    for (let i = 0; i < maxCols; i++) {
                        const cellValue = row[i] || '';
                        const escapedValue = escapeHtml(cellValue);
                        html += `<td style="border: 1px solid #dee2e6; padding: 8px; vertical-align: top; word-break: break-word; max-width: 300px; color: #333;" title="${escapedValue}">${escapedValue}</td>`;
                    }
                    html += '</tr>';
                });
            } else {
                html = `<tr><td colspan="${headers.length}" style="text-align: center; padding: 40px; color: #6c757d; font-style: italic;">æ— åŒ¹é…ç»“æœ</td></tr>`;
            }
            
            tbody.innerHTML = html;
        }
        
        function filterCSVTable() {
            if (!window.csvData) return;
            
            const searchInput = document.getElementById('csvSearchInput');
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            if (!searchTerm) {
                // æ˜¾ç¤ºæ‰€æœ‰æ•°æ®
                window.csvData.currentData = window.csvData.originalData;
                renderCSVTableBody(window.csvData.originalData);
                return;
            }
            
            // è¿‡æ»¤æ•°æ®
            const filteredData = window.csvData.originalData.filter(row => {
                return row.some(cell => {
                    const cellValue = (cell || '').toString().toLowerCase();
                    return cellValue.includes(searchTerm);
                });
            });
            
            window.csvData.currentData = filteredData;
            renderCSVTableBody(filteredData);
        }
        
        function exportCSVTable() {
            if (!window.csvData) return;
            
            const { headers, currentData } = window.csvData;
            
            // åˆ›å»ºCSVå†…å®¹
            let csvContent = '';
            
            // æ·»åŠ è¡¨å¤´
            if (headers && headers.length > 0) {
                csvContent += headers.map(header => `"${(header || '').replace(/"/g, '""')}"`).join(',') + '\n';
            }
            
            // æ·»åŠ æ•°æ®è¡Œ
            currentData.forEach(row => {
                const csvRow = row.map(cell => {
                    const cellValue = (cell || '').toString();
                    return `"${cellValue.replace(/"/g, '""')}"`;
                }).join(',');
                csvContent += csvRow + '\n';
            });
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'exported_data.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                // åå¤‡æ–¹æ¡ˆï¼šæ‰“å¼€æ–°çª—å£æ˜¾ç¤ºCSVå†…å®¹
                const newWindow = window.open();
                newWindow.document.write('<pre>' + escapeHtml(csvContent) + '</pre>');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateTaskModeInfo(); // ç¡®ä¿ä»»åŠ¡æ¨¡å¼ä¿¡æ¯æ­£ç¡®æ˜¾ç¤º
            updateAutoScrollIndicator(); // åˆå§‹åŒ–è‡ªåŠ¨æ»šåŠ¨çŠ¶æ€æŒ‡ç¤ºå™¨
        });

        // å…¨å±€å˜é‡å­˜å‚¨æ‰€æœ‰é…ç½®ä¿¡æ¯
        let allModelConfigs = [];
        let customModelConfig = null; // å­˜å‚¨ç”¨æˆ·è‡ªå®šä¹‰é…ç½®

        /**
         * åŠ è½½æ¨¡å‹é…ç½®é€‰é¡¹
         */
        function loadModelConfigs() {
            const modelSelect = document.getElementById('modelSelect');
            
            if (!modelSelect) {
                console.error('Model select element not found');
                return;
            }

            fetch('/api/gui-configs')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.configs && data.configs.length > 0) {
                        // ä¿å­˜æ‰€æœ‰é…ç½®ä¿¡æ¯åˆ°å…¨å±€å˜é‡
                        allModelConfigs = data.configs;
                        
                        // æ¸…ç©ºç°æœ‰é€‰é¡¹
                        modelSelect.innerHTML = '';
                        
                        // æ·»åŠ æ‰€æœ‰é…ç½®é€‰é¡¹
                        data.configs.forEach((config, index) => {
                            const option = document.createElement('option');
                            option.value = config.value;
                            option.textContent = config.label;
                            
                            // è®¾ç½®ç¬¬ä¸€ä¸ªé€‰é¡¹ä¸ºé»˜è®¤é€‰æ‹©
                            if (index === 0) {
                                option.selected = true;
                            }
                            
                            modelSelect.appendChild(option);
                        });
                        
                        // ç§»é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                        modelSelect.removeEventListener('change', handleModelSelectionChange);
                        modelSelect.removeEventListener('click', handleModelSelectClick);
                        
                        // æ·»åŠ æ¨¡å‹é€‰æ‹©å˜æ›´äº‹ä»¶ç›‘å¬å™¨
                        modelSelect.addEventListener('change', handleModelSelectionChange);
                        
                        // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨æ¥å¤„ç†é‡å¤é€‰æ‹©è‡ªå®šä¹‰é€‰é¡¹çš„æƒ…å†µ
                        modelSelect.addEventListener('click', handleModelSelectClick);
                        
                        console.log(`å·²åŠ è½½ ${data.configs.length} ä¸ªæ¨¡å‹é…ç½®`);
                    } else {
                        // å¦‚æœæ²¡æœ‰é…ç½®æˆ–åŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºé»˜è®¤é€‰é¡¹
                        allModelConfigs = [];
                        modelSelect.innerHTML = '<option value="" disabled selected>' + (I18N && I18N.lang === 'zh' ? 'æ— å¯ç”¨é…ç½®' : 'No configurations available') + '</option>';
                        console.warn('No model configurations found or loading failed');
                    }
                })
                .catch(error => {
                    console.error('Error loading model configurations:', error);
                    allModelConfigs = [];
                    // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                    modelSelect.innerHTML = '<option value="" disabled selected>' + (I18N && I18N.lang === 'zh' ? 'é…ç½®åŠ è½½å¤±è´¥' : 'Failed to load configurations') + '</option>';
                });
        }

        /**
         * å¤„ç†æ¨¡å‹é€‰æ‹©å˜æ›´äº‹ä»¶
         */
        function handleModelSelectionChange() {
            const modelSelect = document.getElementById('modelSelect');
            const selectedValue = modelSelect.value;
            
            if (selectedValue === 'custom') {
                // å¦‚æœé€‰æ‹©äº†è‡ªå®šä¹‰ï¼Œæ˜¾ç¤ºè‡ªå®šä¹‰é…ç½®å¯¹è¯æ¡†
                showCustomConfigDialog();
            }
        }

        /**
         * å¤„ç†æ¨¡å‹é€‰æ‹©æ¡†ç‚¹å‡»äº‹ä»¶ï¼ˆç”¨äºå¤„ç†é‡å¤é€‰æ‹©è‡ªå®šä¹‰çš„æƒ…å†µï¼‰
         */
        function handleModelSelectClick() {
            // å»¶è¿Ÿæ£€æŸ¥ï¼Œç¡®ä¿é€‰æ‹©æ¡†çš„å€¼å·²ç»æ›´æ–°
            setTimeout(() => {
                const modelSelect = document.getElementById('modelSelect');
                const selectedValue = modelSelect.value;
                
                console.log('Model select clicked, value:', selectedValue);
                
                if (selectedValue === 'custom') {
                    // å¦‚æœç‚¹å‡»çš„æ˜¯è‡ªå®šä¹‰é€‰é¡¹ï¼Œæ˜¾ç¤ºé…ç½®å¯¹è¯æ¡†
                    // è¿™æ ·å³ä½¿ç”¨æˆ·é‡å¤é€‰æ‹©è‡ªå®šä¹‰é€‰é¡¹ï¼Œä¹Ÿä¼šå¼¹å‡ºå¯¹è¯æ¡†
                    console.log('Showing custom config dialog from click event');
                    showCustomConfigDialog();
                }
            }, 50);
        }

        /**
         * æ˜¾ç¤ºè‡ªå®šä¹‰é…ç½®å¯¹è¯æ¡†
         */
        function showCustomConfigDialog() {
            const modal = document.getElementById('customConfigModal');
            if (modal) {
                // æ¸…ç©ºé”™è¯¯ä¿¡æ¯
                hideCustomConfigError();
                
                // æ›´æ–°å¯¹è¯æ¡†æ ‡é¢˜
                const title = modal.querySelector('.modal-header h3');
                if (title) {
                    const hasExistingConfig = customModelConfig && customModelConfig.api_key;
                    if (hasExistingConfig) {
                        title.innerHTML = '<i class="fas fa-edit"></i> ' + (I18N.custom_config_title || 'è‡ªå®šä¹‰æ¨¡å‹é…ç½®') + ' (ç¼–è¾‘)';
                    } else {
                        title.innerHTML = '<i class="fas fa-cog"></i> ' + (I18N.custom_config_title || 'è‡ªå®šä¹‰æ¨¡å‹é…ç½®');
                    }
                }
                
                // å¦‚æœä¹‹å‰æœ‰è‡ªå®šä¹‰é…ç½®ï¼Œå¡«å……è¡¨å•
                if (customModelConfig) {
                    document.getElementById('customApiKey').value = customModelConfig.api_key || '';
                    document.getElementById('customApiBase').value = customModelConfig.api_base || '';
                    document.getElementById('customModel').value = customModelConfig.model || '';
                    document.getElementById('customMaxTokens').value = customModelConfig.max_tokens || 8192;
                } else {
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('customApiKey').value = '';
                    document.getElementById('customApiBase').value = '';
                    document.getElementById('customModel').value = '';
                    document.getElementById('customMaxTokens').value = 8192;
                }
                
                modal.style.display = 'block';
                
                // èšç„¦åˆ°ç¬¬ä¸€ä¸ªè¾“å…¥æ¡†
                const firstInput = customModelConfig ? 
                    document.getElementById('customApiKey') : 
                    document.getElementById('customApiKey');
                if (firstInput) {
                    setTimeout(() => firstInput.focus(), 100);
                }
            }
        }

        /**
         * éšè—è‡ªå®šä¹‰é…ç½®å¯¹è¯æ¡†
         */
        function hideCustomConfigDialog() {
            const modal = document.getElementById('customConfigModal');
            if (modal) {
                modal.style.display = 'none';
                
                // å¦‚æœç”¨æˆ·å–æ¶ˆäº†è‡ªå®šä¹‰é…ç½®ï¼Œä¸”æ²¡æœ‰ä¹‹å‰çš„è‡ªå®šä¹‰é…ç½®ï¼Œåˆ™é‡ç½®ä¸ºç¬¬ä¸€ä¸ªé€‰é¡¹
                if (!customModelConfig) {
                    const modelSelect = document.getElementById('modelSelect');
                    if (modelSelect && allModelConfigs.length > 0) {
                        modelSelect.value = allModelConfigs[0].value;
                    }
                }
            }
        }

        /**
         * ä¿å­˜è‡ªå®šä¹‰é…ç½®
         */
        function saveCustomConfig() {
            const apiKey = document.getElementById('customApiKey').value.trim();
            const apiBase = document.getElementById('customApiBase').value.trim();
            const model = document.getElementById('customModel').value.trim();
            let maxTokens = document.getElementById('customMaxTokens').value.trim();
            
            // éªŒè¯å¿…å¡«å­—æ®µ
            if (!apiKey || !apiBase || !model) {
                showCustomConfigError(I18N.custom_config_required || 'æ‰€æœ‰å­—æ®µéƒ½æ˜¯å¿…å¡«çš„');
                return;
            }
            
            // éªŒè¯å¹¶å¤„ç†max_tokens
            if (!maxTokens) {
                maxTokens = 8192;
            } else {
                maxTokens = parseInt(maxTokens);
                if (isNaN(maxTokens) || maxTokens <= 0) {
                    showCustomConfigError('Max Output Tokenså¿…é¡»æ˜¯å¤§äº0çš„æ•°å­—');
                    return;
                }
            }
            
            // ä¿å­˜è‡ªå®šä¹‰é…ç½®
            customModelConfig = {
                api_key: apiKey,
                api_base: apiBase,
                model: model,
                max_tokens: maxTokens,
                display_name: 'è‡ªå®šä¹‰'
            };
            
            console.log('å·²ä¿å­˜è‡ªå®šä¹‰æ¨¡å‹é…ç½®:', customModelConfig);
            hideCustomConfigDialog();
        }

        /**
         * æ˜¾ç¤ºè‡ªå®šä¹‰é…ç½®é”™è¯¯ä¿¡æ¯
         */
        function showCustomConfigError(message) {
            const errorDiv = document.getElementById('customConfigError');
            const errorText = document.getElementById('customConfigErrorText');
            if (errorDiv && errorText) {
                errorText.textContent = message;
                errorDiv.style.display = 'block';
            }
        }

        /**
         * éšè—è‡ªå®šä¹‰é…ç½®é”™è¯¯ä¿¡æ¯
         */
        function hideCustomConfigError() {
            const errorDiv = document.getElementById('customConfigError');
            if (errorDiv) {
                errorDiv.style.display = 'none';
            }
        }

        /**
         * æ ¹æ®é€‰æ‹©çš„é…ç½®IDè·å–é…ç½®ä¿¡æ¯
         */
        function getSelectedModelConfig() {
            const modelSelect = document.getElementById('modelSelect');
            if (!modelSelect || !modelSelect.value) {
                return null;
            }
            
            const selectedValue = modelSelect.value;
            
            // å¦‚æœé€‰æ‹©çš„æ˜¯è‡ªå®šä¹‰é…ç½®
            if (selectedValue === 'custom') {
                return customModelConfig;
            }
            
            // æŸ¥æ‰¾å†…ç½®é…ç½®
            const config = allModelConfigs.find(c => c.value === selectedValue);
            
            if (!config) {
                console.error('Selected model configuration not found:', selectedValue);
                return null;
            }
            
            return {
                api_key: config.api_key,
                api_base: config.api_base,
                model: config.model,
                max_tokens: config.max_tokens || 8192,
                display_name: config.display_name
            };
        }

        /**
         * åˆ‡æ¢å¯†ç è¾“å…¥æ¡†çš„å¯è§æ€§
         */
        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const toggleButton = document.getElementById(inputId + 'Toggle') || 
                                 document.querySelector(`button[onclick*="${inputId}"]`);
            
            if (!input || !toggleButton) {
                console.error('Password input or toggle button not found:', inputId);
                return;
            }
            
            const icon = toggleButton.querySelector('i');
            
            if (input.type === 'password') {
                // æ˜¾ç¤ºå¯†ç 
                input.type = 'text';
                icon.className = 'fas fa-eye-slash';
                toggleButton.title = (I18N && I18N.lang === 'zh') ? 'éšè—å¯†ç ' : 'Hide password';
            } else {
                // éšè—å¯†ç 
                input.type = 'password';
                icon.className = 'fas fa-eye';
                toggleButton.title = (I18N && I18N.lang === 'zh') ? 'æ˜¾ç¤ºå¯†ç ' : 'Show password';
            }
        }

        // å°†å‡½æ•°å£°æ˜ä¸ºå…¨å±€å‡½æ•°ï¼Œç¡®ä¿å¯ä»¥åœ¨æ§åˆ¶å°è®¿é—®
        window.loadModelConfigs = loadModelConfigs;
        window.getSelectedModelConfig = getSelectedModelConfig;
        window.showCustomConfigDialog = showCustomConfigDialog;
        window.hideCustomConfigDialog = hideCustomConfigDialog;
        window.saveCustomConfig = saveCustomConfig;
        window.togglePasswordVisibility = togglePasswordVisibility;

        // è®¾ç½®è‡ªå®šä¹‰é…ç½®å¯¹è¯æ¡†äº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('DOMContentLoaded', function() {
            // ä¿å­˜æŒ‰é’®
            const saveBtn = document.getElementById('customConfigSave');
            if (saveBtn) {
                saveBtn.addEventListener('click', saveCustomConfig);
            }
            
            // å–æ¶ˆæŒ‰é’®
            const cancelBtn = document.getElementById('customConfigCancel');
            if (cancelBtn) {
                cancelBtn.addEventListener('click', hideCustomConfigDialog);
            }
            
            // å…³é—­æŒ‰é’®
            const closeBtn = document.getElementById('customConfigClose');
            if (closeBtn) {
                closeBtn.addEventListener('click', hideCustomConfigDialog);
            }
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            const modal = document.getElementById('customConfigModal');
            if (modal) {
                window.addEventListener('click', function(event) {
                    if (event.target === modal) {
                        hideCustomConfigDialog();
                    }
                });
            }
            
            // ESCé”®å…³é—­
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape' && modal && modal.style.display === 'block') {
                    hideCustomConfigDialog();
                }
            });
        });

    </script>
</body>
</html> 